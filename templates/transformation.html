<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transformations | DataPilot AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
            height: 100vh;
            overflow: hidden;
        }
        
        .sidebar {
            transition: all 0.3s ease;
        }
        
        .card-hover {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .file-item.selected {
            background-color: #f1f5f9;
        }
        
        .workspace-panel {
            transition: all 0.3s ease;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .tab-active {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
        }
        
        .mobile-menu {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .mobile-menu.open {
            transform: translateX(0);
        }
        
        .backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        /* Chatbot improvements */
        .chat-container {
            height: 400px;
            min-height: 400px;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
        }
        
        /* Layout improvements */
        .main-content {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .table-container {
            flex: 1;
            overflow: auto;
        }
        
        .pipeline-container {
            flex-shrink: 0;
        }
        
        /* Transformation Modal */
        .transform-modal {
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .transform-modal.open {
            transform: scale(1);
            opacity: 1;
        }
        
        /* Query Card */
        .query-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        /* Join Preview */
        .join-preview {
            max-height: 300px;
            overflow-y: auto;
        }

        /* Pipeline step animations */
        .pipeline-step {
            transition: all 0.2s ease;
        }
        
        .pipeline-step:hover {
            background-color: #f8fafc;
        }
        
        .pipeline-step.dragging {
            opacity: 0.5;
        }
        
        /* Toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1002;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            border-left: 4px solid #10b981;
        }
        
        .toast.error {
            border-left: 4px solid #ef4444;
        }
        
        .toast.info {
            border-left: 4px solid #3b82f6;
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">
    {% csrf_token %}
    
    <!-- Toast Notifications -->
    <div id="toastContainer"></div>
    
    <!-- Top Navigation Bar -->
    <header class="bg-white border-b border-gray-200 py-3 px-4 flex items-center justify-between flex-shrink-0">
        <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2">
                <div class="bg-indigo-600 p-1.5 rounded">
                    <i class="fas fa-rocket text-white text-sm"></i>
                </div>
                <h1 class="text-lg font-semibold text-gray-800">DataPilot AI</h1>
                <span class="text-gray-400">/</span>
                <div class="flex items-center space-x-2">
                    <a href="{% url 'assistant_workspace' %}" class="text-gray-700 font-medium text-sm hover:text-indigo-600">Workspace</a>
                    <span class="text-gray-400">/</span>
                    <span class="text-gray-700 font-medium text-sm">Transformations</span>
                </div>
            </div>
            
            <div class="hidden md:flex items-center space-x-1">
                <button class="px-3 py-1.5 text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded">Save</button>
                <button class="px-3 py-1.5 text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded">Version History</button>
                <button class="px-3 py-1.5 text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded">Share</button>
            </div>
        </div>
        
        <div class="flex items-center space-x-3">
            <div class="relative hidden md:block">
                <input type="text" placeholder="Search datasets..." class="pl-9 pr-4 py-1.5 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 w-64">
                <i class="fas fa-search absolute left-3 top-2 text-gray-400 text-sm"></i>
            </div>
            
            <button class="relative p-1.5 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded">
                <i class="fas fa-bell text-sm"></i>
                <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
            </button>
            
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 text-sm font-semibold">
                    {{ user_initials }}
                </div>
                <span class="hidden md:inline text-sm text-gray-700">{{ user.username }}</span>
            </div>
        </div>
    </header>
    
    <!-- Main Content Area -->
    <div class="flex flex-1 overflow-hidden">
        <!-- Left Sidebar - File Navigator -->
        <div class="sidebar bg-white border-r border-gray-200 w-64 flex-col flex-shrink-0 hidden md:flex overflow-y-auto">
            <div class="p-4 border-b border-gray-200">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">Datasets</h2>
                    <a href="{% url 'upload_dataset' %}" class="text-xs text-indigo-600 hover:text-indigo-800 font-medium">Upload</a>
                </div>
                
                <a href="{% url 'upload_dataset' %}" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-3 rounded text-sm font-medium flex items-center justify-center mb-3">
                    <i class="fas fa-cloud-upload-alt mr-2"></i>
                    Upload Files
                </a>
                
                <div class="relative">
                    <input type="text" placeholder="Filter datasets..." class="pl-8 pr-3 py-1.5 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 w-full text-xs">
                    <i class="fas fa-filter absolute left-2.5 top-2 text-gray-400 text-xs"></i>
                </div>
            </div>
            
            <div class="flex-1 p-2 overflow-y-auto">
                <div class="mb-4">
                    <h3 class="text-xs font-medium text-gray-500 uppercase tracking-wide px-2 mb-2">Your Datasets</h3>
                    <ul class="space-y-1" id="datasetList">
                        {% for dataset in datasets %}
                        <li>
                            <div class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer dataset-item {% if selected_dataset and dataset.id == selected_dataset.id %}bg-indigo-50 border border-indigo-200{% endif %}" 
                                 data-dataset-id="{{ dataset.id }}">
                                <i class="fas fa-file-csv text-green-600 mr-2 text-sm"></i>
                                <span class="text-sm text-gray-700 truncate">{{ dataset.file_name }}</span>
                            </div>
                        </li>
                        {% empty %}
                        <li class="px-2 text-xs text-gray-500">No datasets uploaded yet</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            
            <div class="p-3 border-t border-gray-200 bg-gray-50">
                <div class="flex items-center justify-between text-xs text-gray-500">
                    <span>Storage: 4.2 GB / 10 GB</span>
                    <span>42%</span>
                </div>
                <div class="w-full bg-gray-200 h-1.5 mt-1 rounded-full">
                    <div class="bg-indigo-600 h-1.5 rounded-full" style="width: 42%"></div>
                </div>
            </div>
        </div>
        
        <!-- Center Panel - Transformations -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Toolbar -->
            <div class="bg-white border-b border-gray-200 p-3 flex-shrink-0">
                <div class="flex flex-wrap items-center justify-between gap-3">
                    <div class="flex items-center space-x-2">
                        <button class="bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 px-3 py-1.5 rounded text-sm font-medium inline-flex items-center">
                            <i class="fas fa-plus mr-1.5 text-xs"></i>
                            New View
                        </button>
                        
                        <button class="bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 px-3 py-1.5 rounded text-sm font-medium inline-flex items-center">
                            <i class="fas fa-download mr-1.5 text-xs"></i>
                            Export
                        </button>
                        
                        <button class="bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 px-3 py-1.5 rounded text-sm font-medium inline-flex items-center">
                            <i class="fas fa-share-alt mr-1.5 text-xs"></i>
                            Share
                        </button>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <button id="runPipelineBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded text-sm font-medium inline-flex items-center">
                            <i class="fas fa-play mr-1.5 text-xs"></i>
                            Run Pipeline
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="bg-white border-b border-gray-200 flex-shrink-0">
                <div class="flex overflow-x-auto">
                    <a href="{% url 'assistant_table_view' %}" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800 whitespace-nowrap">
                        <i class="fas fa-table mr-1.5"></i>
                        Table View
                    </a>
                    <a href="{% url 'assistant_schema' %}" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800 whitespace-nowrap">
                        <i class="fas fa-project-diagram mr-1.5"></i>
                        Schema
                    </a>
                    <a href="{% url 'assistant_transformation' %}" class="tab-active px-4 py-3 text-sm font-medium whitespace-nowrap">
                        <i class="fas fa-sync-alt mr-1.5"></i>
                        Transformations
                    </a>
                </div>
            </div>
            
            <!-- Main Content - Transformations View -->
            <div class="flex-1 overflow-hidden flex flex-col lg:flex-row">
                <!-- Transformations Panel -->
                <div class="flex-1 overflow-auto p-4 main-content">
                    <!-- Query Card -->
                    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden mb-6">
                        <div class="query-card p-4 text-white">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-semibold text-lg mb-2">SQL Query Editor</h3>
                                    <p class="text-indigo-100 text-sm">Write custom SQL queries or paste existing ones</p>
                                </div>
                                <button id="runQueryBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 p-2 rounded">
                                    <i class="fas fa-play text-sm"></i>
                                </button>
                            </div>
                        </div>
                        <div class="p-4">
                            <textarea id="sqlQuery" class="w-full h-32 border border-gray-300 rounded-lg p-3 text-sm font-mono focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" placeholder="SELECT * FROM sales_data WHERE salary > 50000 ORDER BY salary DESC">SELECT department, AVG(salary) as avg_salary 
FROM sales_data 
GROUP BY department 
ORDER BY avg_salary DESC</textarea>
                            <div class="flex justify-between items-center mt-3">
                                <div class="flex space-x-2">
                                    <button id="executeQueryBtn" class="text-xs bg-indigo-600 text-white px-3 py-1.5 rounded hover:bg-indigo-700">
                                        Run Query
                                    </button>
                                    <button id="saveViewBtn" class="text-xs bg-white border border-gray-300 text-gray-700 px-3 py-1.5 rounded hover:bg-gray-50">
                                        Save as View
                                    </button>
                                </div>
                                <div class="text-xs text-gray-500">
                                    <i class="fas fa-database mr-1"></i> 
                                    <span id="currentDataset">Connected to: {% if selected_dataset %}{{ selected_dataset.file_name }}{% else %}No dataset selected{% endif %}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Transformation Operations Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6" id="transformationsGrid">
                        <!-- Join Operations -->
                        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden card-hover">
                            <div class="bg-blue-50 p-4 border-b border-gray-200">
                                <div class="flex items-center">
                                    <div class="bg-blue-100 p-2 rounded-lg mr-3">
                                        <i class="fas fa-link text-blue-600"></i>
                                    </div>
                                    <h3 class="font-medium text-gray-800">Join Operations</h3>
                                </div>
                            </div>
                            <div class="p-4">
                                <p class="text-sm text-gray-600 mb-3">Combine data from multiple datasets based on common columns</p>
                                <div class="space-y-2">
                                    <button class="w-full text-left p-2 hover:bg-gray-50 rounded text-sm flex items-center justify-between transform-operation" data-type="join" data-operation="inner">
                                        <span>Inner Join</span>
                                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                                    </button>
                                    <button class="w-full text-left p-2 hover:bg-gray-50 rounded text-sm flex items-center justify-between transform-operation" data-type="join" data-operation="left">
                                        <span>Left Join</span>
                                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                                    </button>
                                    <button class="w-full text-left p-2 hover:bg-gray-50 rounded text-sm flex items-center justify-between transform-operation" data-type="join" data-operation="right">
                                        <span>Right Join</span>
                                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                                    </button>
                                    <button class="w-full text-left p-2 hover:bg-gray-50 rounded text-sm flex items-center justify-between transform-operation" data-type="join" data-operation="full">
                                        <span>Full Outer Join</span>
                                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Data Cleaning -->
                        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden card-hover">
                            <div class="bg-green-50 p-4 border-b border-gray-200">
                                <div class="flex items-center">
                                    <div class="bg-green-100 p-2 rounded-lg mr-3">
                                        <i class="fas fa-broom text-green-600"></i>
                                    </div>
                                    <h3 class="font-medium text-gray-800">Data Cleaning</h3>
                                </div>
                            </div>
                            <div class="p-4">
                                <p class="text-sm text-gray-600 mb-3">Fix data quality issues and prepare data for analysis</p>
                                <div class="space-y-2">
                                    <button class="w-full text-left p-2 hover:bg-gray-50 rounded text-sm flex items-center justify-between transform-operation" data-type="cleaning" data-operation="missing">
                                        <span>Handle Missing Values</span>
                                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                                    </button>
                                    <button class="w-full text-left p-2 hover:bg-gray-50 rounded text-sm flex items-center justify-between transform-operation" data-type="cleaning" data-operation="duplicates">
                                        <span>Remove Duplicates</span>
                                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                                    </button>
                                    <button class="w-full text-left p-2 hover:bg-gray-50 rounded text-sm flex items-center justify-between transform-operation" data-type="cleaning" data-operation="standardize">
                                        <span>Standardize Formats</span>
                                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                                    </button>
                                    <button class="w-full text-left p-2 hover:bg-gray-50 rounded text-sm flex items-center justify-between transform-operation" data-type="cleaning" data-operation="convert">
                                        <span>Data Type Conversion</span>
                                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Aggregation & Analysis -->
                        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden card-hover">
                            <div class="bg-purple-50 p-4 border-b border-gray-200">
                                <div class="flex items-center">
                                    <div class="bg-purple-100 p-2 rounded-lg mr-3">
                                        <i class="fas fa-chart-bar text-purple-600"></i>
                                    </div>
                                    <h3 class="font-medium text-gray-800">Aggregation</h3>
                                </div>
                            </div>
                            <div class="p-4">
                                <p class="text-sm text-gray-600 mb-3">Summarize and analyze data with statistical operations</p>
                                <div class="space-y-2">
                                    <button class="w-full text-left p-2 hover:bg-gray-50 rounded text-sm flex items-center justify-between transform-operation" data-type="aggregation" data-operation="group">
                                        <span>Group By & Summarize</span>
                                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                                    </button>
                                    <button class="w-full text-left p-2 hover:bg-gray-50 rounded text-sm flex items-center justify-between transform-operation" data-type="aggregation" data-operation="pivot">
                                        <span>Pivot Tables</span>
                                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                                    </button>
                                    <button class="w-full text-left p-2 hover:bg-gray-50 rounded text-sm flex items-center justify-between transform-operation" data-type="aggregation" data-operation="window">
                                        <span>Window Functions</span>
                                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                                    </button>
                                    <button class="w-full text-left p-2 hover:bg-gray-50 rounded text-sm flex items-center justify-between transform-operation" data-type="aggregation" data-operation="rollup">
                                        <span>Rollup & Cube</span>
                                        <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Filter & Sort -->
                        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden card-hover">
                            <div class="bg-yellow-50 p-4 border-b border-gray-200">
                                <div class="flex items-center">
                                    <div class="bg-yellow-100 p-2 rounded-lg mr-3">
                                        <i class="fas fa-filter text-yellow-600"></i>
                                    </div>
                                    <h3 class="font-medium text-gray-800">Filter & Sort</h3>
                                </div>
                            </div>
                            <div class="p-4">
    <p class="text-sm text-gray-600 mb-3">Focus on specific data subsets and organize results</p>
    <div class="space-y-2">
        <button class="w-full text-left p-2 hover:bg-gray-50 rounded text-sm flex items-center justify-between transform-operation" data-type="filter-sort" data-operation="filter">
            <span>Conditional Filtering</span>
            <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
        </button>
        <button class="w-full text-left p-2 hover:bg-gray-50 rounded text-sm flex items-center justify-between transform-operation" data-type="filter-sort" data-operation="sort">
            <span>Multi-column Sorting</span>
            <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
        </button>
        <button class="w-full text-left p-2 hover:bg-gray-50 rounded text-sm flex items-center justify-between transform-operation" data-type="filter-sort" data-operation="top_n">
            <span>Top N Records</span>
            <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
        </button>
        <button class="w-full text-left p-2 hover:bg-gray-50 rounded text-sm flex items-center justify-between transform-operation" data-type="filter-sort" data-operation="random_sample">
            <span>Random Sampling</span>
            <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
        </button>
    </div>
</div>

                        </div>

                        <!-- Feature Engineering -->
                        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden card-hover">
                            <div class="bg-red-50 p-4 border-b border-gray-200">
                                <div class="flex items-center">
                                    <div class="bg-red-100 p-2 rounded-lg mr-3">
                                        <i class="fas fa-cogs text-red-600"></i>
                                    </div>
                                    <h3 class="font-medium text-gray-800">Feature Engineering</h3>
                                </div>
                            </div>
                            <div class="p-4">
    <p class="text-sm text-gray-600 mb-3">Create new features and transform existing ones</p>
    <div class="space-y-2">
        <button class="w-full text-left p-2 hover:bg-gray-50 rounded text-sm flex items-center justify-between transform-operation" data-type="feature" data-operation="calculated">
            <span>Create Calculated Columns</span>
            <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
        </button>
        <button class="w-full text-left p-2 hover:bg-gray-50 rounded text-sm flex items-center justify-between transform-operation" data-type="feature" data-operation="date">
            <span>Date/Time Extraction</span>
            <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
        </button>
        <button class="w-full text-left p-2 hover:bg-gray-50 rounded text-sm flex items-center justify-between transform-operation" data-type="feature" data-operation="text">
            <span>Text Processing</span>
            <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
        </button>
        <button class="w-full text-left p-2 hover:bg-gray-50 rounded text-sm flex items-center justify-between transform-operation" data-type="feature" data-operation="encoding">
            <span>One-Hot Encoding</span>
            <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
        </button>
    </div>
</div>
                        </div>

                        <!-- ML Preparation -->
                        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden card-hover">
                            <div class="bg-indigo-50 p-4 border-b border-gray-200">
                                <div class="flex items-center">
                                    <div class="bg-indigo-100 p-2 rounded-lg mr-3">
                                        <i class="fas fa-robot text-indigo-600"></i>
                                    </div>
                                    <h3 class="font-medium text-gray-800">ML Preparation</h3>
                                </div>
                            </div>
<div class="p-4">
    <p class="text-sm text-gray-600 mb-3">Prepare data for machine learning models</p>
    <div class="space-y-2">
        <button class="w-full text-left p-2 hover:bg-gray-50 rounded text-sm flex items-center justify-between transform-operation" data-type="ml" data-operation="split">
            <span>Train-Test Split</span>
            <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
        </button>
        <button class="w-full text-left p-2 hover:bg-gray-50 rounded text-sm flex items-center justify-between transform-operation" data-type="ml" data-operation="scale">
            <span>Feature Scaling</span>
            <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
        </button>
        <button class="w-full text-left p-2 hover:bg-gray-50 rounded text-sm flex items-center justify-between transform-operation" data-type="ml" data-operation="outlier">
            <span>Outlier Detection</span>
            <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
        </button>
        <button class="w-full text-left p-2 hover:bg-gray-50 rounded text-sm flex items-center justify-between transform-operation" data-type="ml" data-operation="crossval">
            <span>Cross-Validation</span>
            <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
        </button>
    </div>
</div>

                        </div>
                    </div>

                    <!-- Transformation Pipeline -->
                    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden pipeline-container">
                        <div class="p-3 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="font-medium text-gray-800">Transformation Pipeline</h3>
                            <button id="addStepBtn" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium flex items-center">
                                <i class="fas fa-plus mr-1.5"></i>
                                Add Step
                            </button>
                        </div>
                        
                        <div id="pipelineSteps" class="p-4 space-y-3">
                            <!-- Pipeline steps will be added here dynamically -->
                            <div class="text-center text-gray-500 py-8" id="emptyPipeline">
                                <i class="fas fa-sync-alt text-3xl mb-2 opacity-50"></i>
                                <p>No transformation steps added yet</p>
                                <p class="text-sm">Click "Add Step" or select a transformation to get started</p>
                            </div>
                        </div>
                        
                        <div class="p-3 border-t border-gray-200 bg-gray-50 flex flex-col sm:flex-row justify-between items-center gap-2">
                            <div class="text-sm text-gray-600">
                                Pipeline status: <span id="pipelineStatus" class="font-medium text-green-600">Ready to run</span>
                            </div>
                            <div class="flex space-x-2">
                                <button id="resetPipelineBtn" class="px-3 py-1.5 border border-gray-300 rounded text-sm font-medium text-gray-700 hover:bg-gray-50">
                                    Reset
                                </button>
                                <button id="executePipelineBtn" class="px-3 py-1.5 bg-indigo-600 text-white rounded text-sm font-medium hover:bg-indigo-700">
                                    Run Pipeline
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Right Sidebar - Context + Chatbot -->
                <div class="w-full lg:w-80 bg-white border-l border-gray-200 flex flex-col overflow-hidden">
                    <!-- File Info Card -->
                    <div class="p-4 border-b border-gray-200">
                        <h3 class="font-medium text-gray-800 mb-3">Dataset Information</h3>
                        
                        <div class="space-y-3" id="datasetDetails">
                            {% if selected_dataset %}
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">File Name</span>
                                <span class="text-sm font-medium">{{ selected_dataset.file_name }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Type</span>
                                <span class="text-sm font-medium">{{ selected_dataset.file_type }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Uploaded</span>
                                <span class="text-sm font-medium">{{ selected_dataset.uploaded_at|date:"M d, Y" }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Owner</span>
                                <span class="text-sm font-medium">{{ user.username }}</span>
                            </div>
                            {% else %}
                            <div class="text-sm text-gray-500">No dataset selected</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="p-4 border-b border-gray-200">
                        <h3 class="font-medium text-gray-800 mb-3">Quick Actions</h3>
                        <div class="space-y-2">
                            <button class="w-full text-left text-sm text-gray-700 hover:bg-gray-50 p-2 rounded flex items-center">
                                <i class="fas fa-chart-bar text-indigo-600 mr-2"></i>
                                Analyze Data
                            </button>
                            <button class="w-full text-left text-sm text-gray-700 hover:bg-gray-50 p-2 rounded flex items-center">
                                <i class="fas fa-filter text-green-600 mr-2"></i>
                                Filter Data
                            </button>
                            <button class="w-full text-left text-sm text-gray-700 hover:bg-gray-50 p-2 rounded flex items-center">
                                <i class="fas fa-sync-alt text-blue-600 mr-2"></i>
                                Transform Data
                            </button>
                        </div>
                    </div>

                    <!-- Chatbot -->
                    <div class="flex-1 flex flex-col overflow-hidden chat-container">
                        <div class="p-3 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="font-medium text-gray-800">AI Assistant</h3>
                            <div class="flex items-center space-x-2">
                                <button class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-cog"></i>
                                </button>
                                <button class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex-1 overflow-y-auto p-3 space-y-4 chat-messages" id="chatMessages">
                            <div class="chat-message bg-white border border-gray-200 rounded-lg p-3">
                                <div class="text-xs text-gray-500 font-medium mb-1">DataPilot AI</div>
                                <p class="text-sm text-gray-800">Hi! I can help you transform your data. What would you like to do?</p>
                            </div>
                        </div>
                        
                        <div class="p-3 border-t border-gray-200">
                            <div class="flex space-x-2 mb-2">
                                <button class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded hover:bg-gray-200 suggest-transformation">
                                    Suggest Transformations
                                </button>
                                <button class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded hover:bg-gray-200 detect-outliers">
                                    Detect Outliers
                                </button>
                                <button class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded hover:bg-gray-200 fill-nulls">
                                    Fill Nulls
                                </button>
                            </div>
                            
                            <div class="flex">
                                <input type="text" id="chatInput" placeholder="Ask a question about your data..." class="flex-1 border border-gray-300 rounded-l-lg px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                                <button id="sendChatBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-r-lg hover:bg-indigo-700">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CSRF Token helper
        function getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]').value;
        }

        // Toast notification system
        function showToast(message, type = 'info', duration = 3000) {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.parentElement.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }

        // Pipeline state - FIXED: Use different variable names to avoid conflicts
        let pipelineStepsData = []; // Changed from pipelineSteps to avoid DOM element conflict
        let currentStepId = 1;

        // Dataset selection functionality
        document.addEventListener('DOMContentLoaded', function() {
            const datasetItems = document.querySelectorAll('.dataset-item');
            
            datasetItems.forEach(item => {
                item.addEventListener('click', function() {
                    const datasetId = this.getAttribute('data-dataset-id');
                    selectDataset(datasetId);
                    
                    // Update active state
                    datasetItems.forEach(i => i.classList.remove('bg-indigo-50', 'border', 'border-indigo-200'));
                    this.classList.add('bg-indigo-50', 'border', 'border-indigo-200');
                });
            });
        });

        // Select dataset
        async function selectDataset(datasetId) {
            try {
                const response = await fetch(`/datasets/${datasetId}/preview/`, {
                    headers: {
                        'X-CSRFToken': getCsrfToken(),
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showToast('Dataset selected successfully', 'success');
                    
                    // Update current dataset display
                    const currentDataset = document.getElementById('currentDataset');
                    const datasetName = document.querySelector(`[data-dataset-id="${datasetId}"] span`).textContent;
                    currentDataset.textContent = `Connected to: ${datasetName}`;
                    
                    // Reset pipeline when new dataset is selected
                    resetPipeline();
                }
            } catch (error) {
                console.error('Error selecting dataset:', error);
                showToast('Error selecting dataset', 'error');
            }
        }

        // Add transformation step - FIXED: Use different variable names
        function addPipelineStep(step) {
            const pipelineStepsContainer = document.getElementById('pipelineSteps'); // Changed variable name
            const emptyPipeline = document.getElementById('emptyPipeline');
            
            if (emptyPipeline) {
                emptyPipeline.style.display = 'none';
            }
            
            const stepId = `step-${currentStepId++}`;
            const stepElement = document.createElement('div');
            stepElement.className = 'pipeline-step bg-white border border-gray-200 rounded-lg p-3 flex items-start';
            stepElement.setAttribute('data-step-id', stepId);
            stepElement.innerHTML = `
                <div class="flex-shrink-0 w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center mr-3 mt-0.5">
                    <span class="text-blue-600 text-xs font-medium">${pipelineStepsContainer.children.length}</span>
                </div>
                <div class="flex-1">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-medium text-gray-800">${step.name}</h4>
                            <p class="text-sm text-gray-600 mt-1">${step.description}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button class="text-gray-500 hover:text-gray-700 view-step">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="text-gray-500 hover:text-gray-700 edit-step">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                            <button class="text-gray-500 hover:text-red-600 delete-step">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-gray-500">
                        ${step.details || 'Ready to execute'}
                    </div>
                </div>
            `;
            
            pipelineStepsContainer.appendChild(stepElement);
            
            // Add event listeners for step actions
            stepElement.querySelector('.delete-step').addEventListener('click', function() {
                deletePipelineStep(stepId);
            });
            
            stepElement.querySelector('.edit-step').addEventListener('click', function() {
                editPipelineStep(stepId, step);
            });
            
            // Add to pipeline state - FIXED: Use correct variable name
            pipelineStepsData.push({
                id: stepId,
                ...step
            });
            
            updatePipelineStatus();
        }

        // Delete pipeline step - FIXED: Use correct variable names
        function deletePipelineStep(stepId) {
            const stepElement = document.querySelector(`[data-step-id="${stepId}"]`);
            if (stepElement) {
                stepElement.remove();
            }
            
            // Remove from pipeline state - FIXED: Use correct variable name
            pipelineStepsData = pipelineStepsData.filter(step => step.id !== stepId);
            
            // Update step numbers
            updateStepNumbers();
            
            // Show empty message if no steps
            const pipelineStepsContainer = document.getElementById('pipelineSteps');
            if (pipelineStepsContainer.children.length === 1) { // Only empty message remains
                document.getElementById('emptyPipeline').style.display = 'block';
            }
            
            updatePipelineStatus();
        }

        // Update step numbers
        function updateStepNumbers() {
            const steps = document.querySelectorAll('.pipeline-step');
            steps.forEach((step, index) => {
                const numberElement = step.querySelector('.flex-shrink-0 span');
                if (numberElement) {
                    numberElement.textContent = index + 1;
                }
            });
        }

        // Edit pipeline step
        function editPipelineStep(stepId, step) {
            // Implementation for editing steps
            showToast('Edit functionality coming soon', 'info');
        }

        // Reset pipeline - FIXED: Use correct variable names
        function resetPipeline() {
            const pipelineStepsContainer = document.getElementById('pipelineSteps');
            pipelineStepsContainer.innerHTML = `
                <div class="text-center text-gray-500 py-8" id="emptyPipeline">
                    <i class="fas fa-sync-alt text-3xl mb-2 opacity-50"></i>
                    <p>No transformation steps added yet</p>
                    <p class="text-sm">Click "Add Step" or select a transformation to get started</p>
                </div>
            `;
            pipelineStepsData = []; // FIXED: Use correct variable name
            currentStepId = 1;
            updatePipelineStatus();
        }

        // Update pipeline status
        function updatePipelineStatus() {
            const statusElement = document.getElementById('pipelineStatus');
            let stepCount = document.querySelectorAll('.pipeline-step').length;
            
            if (stepCount === 0) {
                statusElement.textContent = 'Ready to run';
                statusElement.className = 'font-medium text-green-600';
            } else {
                statusElement.textContent = `${stepCount} steps ready`;
                statusElement.className = 'font-medium text-blue-600';
            }
        }

        // Transformation operations
        document.querySelectorAll('.transform-operation').forEach(button => {
            button.addEventListener('click', function() {
                const type = this.getAttribute('data-type');
                const operation = this.getAttribute('data-operation');
                const name = this.querySelector('span').textContent;
                
                // Create transformation step
                const step = {
                    name: name,
                    type: type,
                    operation: operation,
                    description: getTransformationDescription(type, operation),
                    details: 'Click to configure parameters'
                };
                
                addPipelineStep(step);
                showToast(`Added ${name} to pipeline`, 'success');
            });
        });

        // Get transformation description
        function getTransformationDescription(type, operation) {
            const descriptions = {
                join: {
                    inner: 'Combine rows with matching values in both datasets',
                    left: 'Include all rows from left dataset and matching rows from right',
                    right: 'Include all rows from right dataset and matching rows from left',
                    full: 'Include all rows from both datasets'
                },
                cleaning: {
                    missing: 'Handle missing or null values in selected columns',
                    duplicates: 'Remove duplicate rows based on selected criteria',
                    standardize: 'Standardize text formats and case sensitivity',
                    convert: 'Convert data types of selected columns'
                },
                aggregation: {
                    group: 'Group data and calculate summary statistics',
                    pivot: 'Reshape data from long to wide format',
                    window: 'Apply calculations over sliding windows of data',
                    rollup: 'Create multi-level summary aggregations'
                }
            };
            
            return descriptions[type]?.[operation] || 'Apply data transformation';
        }

        // Execute pipeline
        document.getElementById('executePipelineBtn').addEventListener('click', function() {
            const stepCount = document.querySelectorAll('.pipeline-step').length;
            
            if (stepCount === 0) {
                showToast('No transformation steps to execute', 'error');
                return;
            }
            
            showToast('Executing transformation pipeline...', 'info');
            
            // Simulate pipeline execution
            setTimeout(() => {
                showToast('Pipeline executed successfully!', 'success');
            }, 2000);
        });

        // Reset pipeline
        document.getElementById('resetPipelineBtn').addEventListener('click', function() {
            resetPipeline();
            showToast('Pipeline reset', 'info');
        });

        // Add step button
        document.getElementById('addStepBtn').addEventListener('click', function() {
            showToast('Select a transformation from the options above', 'info');
        });

        // Execute SQL query
        document.getElementById('executeQueryBtn').addEventListener('click', function() {
            const query = document.getElementById('sqlQuery').value;
            if (!query.trim()) {
                showToast('Please enter a SQL query', 'error');
                return;
            }
            
            showToast('Executing SQL query...', 'info');
            
            // Simulate query execution
            setTimeout(() => {
                showToast('Query executed successfully!', 'success');
                
                // Add to pipeline as a step
                const step = {
                    name: 'Custom SQL Query',
                    type: 'sql',
                    operation: 'custom',
                    description: 'Execute custom SQL transformation',
                    details: query.substring(0, 50) + '...'
                };
                
                addPipelineStep(step);
            }, 1500);
        });

        // Save as view
        document.getElementById('saveViewBtn').addEventListener('click', function() {
            const query = document.getElementById('sqlQuery').value;
            if (!query.trim()) {
                showToast('Please enter a SQL query', 'error');
                return;
            }
            
            showToast('Saved as new dataset view', 'success');
        });

        // Chat functionality
        document.getElementById('sendChatBtn').addEventListener('click', function() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addChatMessage(message, 'user');
            input.value = '';
            
            // Simulate AI response
            setTimeout(() => {
                const response = generateAIResponse(message);
                addChatMessage(response, 'ai');
            }, 1000);
        });

        // Quick action buttons
        document.querySelectorAll('.suggest-transformation').forEach(btn => {
            btn.addEventListener('click', function() {
                addChatMessage('Can you suggest some transformations for my data?', 'user');
                setTimeout(() => {
                    addChatMessage('Based on your dataset, I recommend:\n1. Handle missing values in numeric columns\n2. Remove duplicate customer records\n3. Create calculated columns for customer lifetime value\n4. Group by region and calculate average sales', 'ai');
                }, 1000);
            });
        });

        // Add chat message
        function addChatMessage(message, sender) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            
            if (sender === 'user') {
                messageDiv.className = 'chat-message bg-indigo-50 rounded-lg p-3 ml-auto';
                messageDiv.innerHTML = `
                    <div class="text-xs text-indigo-700 font-medium mb-1">You</div>
                    <p class="text-sm text-gray-800">${message}</p>
                `;
            } else {
                messageDiv.className = 'chat-message bg-white border border-gray-200 rounded-lg p-3';
                messageDiv.innerHTML = `
                    <div class="text-xs text-gray-500 font-medium mb-1">DataPilot AI</div>
                    <p class="text-sm text-gray-800 whitespace-pre-line">${message}</p>
                `;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Generate AI response
        function generateAIResponse(message) {
            const responses = {
                'hello': 'Hello! How can I help you with your data transformations today?',
                'help': 'I can help you with data cleaning, joins, aggregations, and more. Just tell me what you\'d like to do with your data!',
                'missing values': 'I can help you handle missing values. Common strategies include:\n Filling with mean/median/mode\n Forward/backward fill for time series\n Dropping rows with too many missing values\nWhich columns have missing values?',
                'join': 'I can help you join datasets. You\'ll need to specify:\n Which datasets to join\n The join type (inner, left, right, full)\n The key columns to join on\nWould you like me to suggest a join strategy?',
                'clean': 'For data cleaning, I recommend:\n1. Remove duplicates\n2. Handle missing values\n3. Standardize formats\n4. Validate data types\nWhich aspect would you like to focus on first?'
            };
            
            const lowerMessage = message.toLowerCase();
            for (const [key, response] of Object.entries(responses)) {
                if (lowerMessage.includes(key)) {
                    return response;
                }
            }
            
            return 'I understand you want help with data transformations. Could you provide more details about what you\'d like to achieve?';
        }

        // Initialize
        updatePipelineStatus();
    </script>
    <!-- Join Operation Modal -->
<div id="joinModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg w-full max-w-4xl mx-4 max-h-[90vh] overflow-hidden flex flex-col">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold text-gray-800">Create Join Operation</h3>
            <button id="closeJoinModal" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Left Dataset Selection -->
                <div class="space-y-3">
                    <label class="block text-sm font-medium text-gray-700">Left Dataset</label>
                    <select id="leftDataset" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Select a dataset</option>
                        {% for dataset in datasets %}
                        <option value="{{ dataset.id }}">{{ dataset.file_name }}</option>
                        {% endfor %}
                    </select>
                    
                    <div id="leftColumns" class="space-y-2 hidden">
                        <label class="block text-sm font-medium text-gray-700">Join Column</label>
                        <select id="leftColumn" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                            <option value="">Select column</option>
                        </select>
                        <div id="leftPreview" class="text-xs text-gray-500 mt-2"></div>
                    </div>
                </div>
                
                <!-- Right Dataset Selection -->
                <div class="space-y-3">
                    <label class="block text-sm font-medium text-gray-700">Right Dataset</label>
                    <select id="rightDataset" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Select a dataset</option>
                        {% for dataset in datasets %}
                        <option value="{{ dataset.id }}">{{ dataset.file_name }}</option>
                        {% endfor %}
                    </select>
                    
                    <div id="rightColumns" class="space-y-2 hidden">
                        <label class="block text-sm font-medium text-gray-700">Join Column</label>
                        <select id="rightColumn" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                            <option value="">Select column</option>
                        </select>
                        <div id="rightPreview" class="text-xs text-gray-500 mt-2"></div>
                    </div>
                </div>
            </div>
            
            <!-- Join Type Selection -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">Join Type</label>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <label class="join-type-option flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="joinType" value="inner" class="mr-2" checked>
                        <div>
                            <div class="font-medium text-sm">Inner Join</div>
                            <div class="text-xs text-gray-500">Matching rows only</div>
                        </div>
                    </label>
                    <label class="join-type-option flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="joinType" value="left" class="mr-2">
                        <div>
                            <div class="font-medium text-sm">Left Join</div>
                            <div class="text-xs text-gray-500">All left + matching right</div>
                        </div>
                    </label>
                    <label class="join-type-option flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="joinType" value="right" class="mr-2">
                        <div>
                            <div class="font-medium text-sm">Right Join</div>
                            <div class="text-xs text-gray-500">All right + matching left</div>
                        </div>
                    </label>
                    <label class="join-type-option flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="joinType" value="outer" class="mr-2">
                        <div>
                            <div class="font-medium text-sm">Full Outer Join</div>
                            <div class="text-xs text-gray-500">All rows from both</div>
                        </div>
                    </label>
                </div>
            </div>
            
            <!-- Join Name -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Join Name</label>
                <input type="text" id="joinName" placeholder="Enter a name for this join operation" 
                       class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500"
                       value="Joined_Dataset">
            </div>
            
            <!-- Preview Section -->
            <div id="joinPreview" class="hidden">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-medium text-gray-800">Join Preview</h4>
                    <button id="refreshPreview" class="text-sm text-indigo-600 hover:text-indigo-800">
                        <i class="fas fa-sync-alt mr-1"></i> Refresh
                    </button>
                </div>
                <div class="border border-gray-200 rounded-lg overflow-hidden">
                    <div class="bg-gray-50 px-4 py-2 border-b border-gray-200">
                        <div class="text-sm text-gray-600" id="previewInfo">Preview: 20 rows</div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200" id="previewTable">
                            <thead class="bg-gray-50">
                                <tr id="previewHeaders"></tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="previewBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="p-4 border-t border-gray-200 bg-gray-50 flex justify-between items-center">
            <div class="text-sm text-gray-600" id="joinStatus">Ready to create join</div>
            <div class="flex space-x-3">
                <button id="previewJoinBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50">
                    Preview Join
                </button>
                <button id="createJoinBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700">
                    Create Join
                </button>
            </div>
        </div>
    </div>
</div>


// Data Cleaning Modal
<div id="cleaningModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg w-full max-w-4xl mx-4 max-h-[90vh] overflow-hidden flex flex-col">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold text-gray-800" id="cleaningModalTitle">Data Cleaning Operation</h3>
            <button id="closeCleaningModal" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6">
            <!-- Operation Selection -->
            <div id="cleaningOperationSelection" class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">Select Cleaning Operation</label>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <button class="cleaning-op-btn p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 text-left" data-operation="missing_values">
                        <div class="font-medium text-sm">Missing Values</div>
                        <div class="text-xs text-gray-500">Handle null/missing data</div>
                    </button>
                    <button class="cleaning-op-btn p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 text-left" data-operation="remove_duplicates">
                        <div class="font-medium text-sm">Remove Duplicates</div>
                        <div class="text-xs text-gray-500">Eliminate duplicate rows</div>
                    </button>
                    <button class="cleaning-op-btn p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 text-left" data-operation="standardize_formats">
                        <div class="font-medium text-sm">Standardize Formats</div>
                        <div class="text-xs text-gray-500">Clean text and formats</div>
                    </button>
                    <button class="cleaning-op-btn p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 text-left" data-operation="convert_data_types">
                        <div class="font-medium text-sm">Data Type Conversion</div>
                        <div class="text-xs text-gray-500">Change column types</div>
                    </button>
                </div>
            </div>
            
            <!-- Dataset Selection -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Dataset</label>
                <select id="cleaningDataset" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">Select a dataset</option>
                    {% for dataset in datasets %}
                    <option value="{{ dataset.id }}">{{ dataset.file_name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Operation Configuration -->
            <div id="cleaningConfig"></div>
            
            <!-- Preview Section -->
            <div id="cleaningPreview" class="hidden mt-6">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-medium text-gray-800">Cleaning Preview</h4>
                    <button id="refreshCleaningPreview" class="text-sm text-indigo-600 hover:text-indigo-800">
                        <i class="fas fa-sync-alt mr-1"></i> Refresh Preview
                    </button>
                </div>
                <div class="border border-gray-200 rounded-lg overflow-hidden">
                    <div class="bg-gray-50 px-4 py-2 border-b border-gray-200">
                        <div class="text-sm text-gray-600" id="cleaningPreviewInfo">Preview: 20 rows</div>
                    </div>
                    <div class="overflow-x-auto max-h-64">
                        <table class="min-w-full divide-y divide-gray-200" id="cleaningPreviewTable">
                            <thead class="bg-gray-50">
                                <tr id="cleaningPreviewHeaders"></tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="cleaningPreviewBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="p-4 border-t border-gray-200 bg-gray-50 flex justify-between items-center">
            <div class="text-sm text-gray-600" id="cleaningStatus">Select an operation to begin</div>
            <div class="flex space-x-3">
                <button id="previewCleaningBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 hidden">
                    Preview
                </button>
                <button id="executeCleaningBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 hidden">
                    Execute Cleaning
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Data Cleaning Functionality
 currentCleaningOperation = null;
 currentDatasetColumns = [];

// Initialize data cleaning functionality
function initializeDataCleaning() {
    // Cleaning operation buttons
    document.querySelectorAll('.transform-operation[data-type="cleaning"]').forEach(button => {
        button.addEventListener('click', function() {
            const operation = this.getAttribute('data-operation');
            openCleaningModal(operation);
        });
    });
    
    // Modal events
    document.getElementById('closeCleaningModal').addEventListener('click', closeCleaningModal);
    document.getElementById('cleaningModal').addEventListener('click', function(e) {
        if (e.target === this) closeCleaningModal();
    });
    
    // Dataset selection
    document.getElementById('cleaningDataset').addEventListener('change', function() {
        loadDatasetColumnsForCleaning(this.value);
    });
    
    // Operation selection
    document.querySelectorAll('.cleaning-op-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const operation = this.getAttribute('data-operation');
            selectCleaningOperation(operation);
        });
    });
    
    // Action buttons
    document.getElementById('previewCleaningBtn').addEventListener('click', previewCleaningOperation);
    document.getElementById('executeCleaningBtn').addEventListener('click', executeCleaningOperation);
    document.getElementById('refreshCleaningPreview').addEventListener('click', previewCleaningOperation);
}

// Open cleaning modal
function openCleaningModal(operation) {
    const modal = document.getElementById('cleaningModal');
    modal.classList.remove('hidden');
    
    if (operation) {
        selectCleaningOperation(operation);
    }
}

// Close cleaning modal
function closeCleaningModal() {
    document.getElementById('cleaningModal').classList.add('hidden');
    resetCleaningForm();
}

// Reset cleaning form
function resetCleaningForm() {
    document.getElementById('cleaningDataset').value = '';
    document.getElementById('cleaningConfig').innerHTML = '';
    document.getElementById('cleaningPreview').classList.add('hidden');
    document.getElementById('previewCleaningBtn').classList.add('hidden');
    document.getElementById('executeCleaningBtn').classList.add('hidden');
    document.getElementById('cleaningStatus').textContent = 'Select an operation to begin';
    currentCleaningOperation = null;
    currentDatasetColumns = [];
}

// Select cleaning operation
function selectCleaningOperation(operation) {
    currentCleaningOperation = operation;
    
    // Update UI
    document.querySelectorAll('.cleaning-op-btn').forEach(btn => {
        btn.classList.remove('border-indigo-500', 'bg-indigo-50');
        if (btn.getAttribute('data-operation') === operation) {
            btn.classList.add('border-indigo-500', 'bg-indigo-50');
        }
    });
    
    // Show operation-specific configuration
    renderCleaningConfig(operation);
    
    // Update status
    document.getElementById('cleaningStatus').textContent = `Configure ${getCleaningOperationName(operation)}`;
    document.getElementById('cleaningModalTitle').textContent = `${getCleaningOperationName(operation)} - Data Cleaning`;
    
    // Show action buttons if dataset is selected
    if (document.getElementById('cleaningDataset').value) {
        document.getElementById('previewCleaningBtn').classList.remove('hidden');
        document.getElementById('executeCleaningBtn').classList.remove('hidden');
    }
}

// Render operation-specific configuration
function renderCleaningConfig(operation) {
    const configContainer = document.getElementById('cleaningConfig');
    
    switch(operation) {
        case 'missing_values':
            configContainer.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Columns to Process</label>
                        <div id="missingValuesColumns" class="space-y-2 max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-3">
                            <div class="text-sm text-gray-500">Select a dataset first to see columns</div>
                        </div>
                        <div class="mt-2">
                            <label class="inline-flex items-center">
                                <input type="checkbox" id="processAllColumns" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked>
                                <span class="ml-2 text-sm text-gray-600">Process all columns</span>
                            </label>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Handling Strategy</label>
                        <select id="missingValuesStrategy" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="fill">Fill with value</option>
                            <option value="drop">Drop rows with missing values</option>
                            <option value="interpolate">Interpolate (numeric only)</option>
                        </select>
                    </div>
                    
                    <div id="fillValueSection">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Fill Value</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <label class="flex items-center p-2 border border-gray-300 rounded cursor-pointer hover:bg-gray-50">
                                <input type="radio" name="fillValue" value="mean" class="mr-2">
                                <span class="text-sm">Mean</span>
                            </label>
                            <label class="flex items-center p-2 border border-gray-300 rounded cursor-pointer hover:bg-gray-50">
                                <input type="radio" name="fillValue" value="median" class="mr-2">
                                <span class="text-sm">Median</span>
                            </label>
                            <label class="flex items-center p-2 border border-gray-300 rounded cursor-pointer hover:bg-gray-50">
                                <input type="radio" name="fillValue" value="mode" class="mr-2">
                                <span class="text-sm">Mode</span>
                            </label>
                            <label class="flex items-center p-2 border border-gray-300 rounded cursor-pointer hover:bg-gray-50">
                                <input type="radio" name="fillValue" value="custom" class="mr-2">
                                <span class="text-sm">Custom</span>
                            </label>
                        </div>
                        <div id="customValueSection" class="mt-2 hidden">
                            <input type="text" id="customFillValue" placeholder="Enter custom value" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        </div>
                    </div>
                </div>
            `;
            break;
            
        case 'remove_duplicates':
            configContainer.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Columns to Check for Duplicates</label>
                        <div id="duplicateColumns" class="space-y-2 max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-3">
                            <div class="text-sm text-gray-500">Select a dataset first to see columns</div>
                        </div>
                        <div class="mt-2">
                            <label class="inline-flex items-center">
                                <input type="checkbox" id="checkAllColumns" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked>
                                <span class="ml-2 text-sm text-gray-600">Check all columns (consider entire row)</span>
                            </label>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Which Duplicates to Keep</label>
                        <select id="duplicateKeep" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="first">Keep first occurrence</option>
                            <option value="last">Keep last occurrence</option>
                            <option value="false">Remove all duplicates</option>
                        </select>
                    </div>
                </div>
            `;
            break;
            
        case 'standardize_formats':
            configContainer.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Columns to Standardize</label>
                        <div id="standardizeColumns" class="space-y-2 max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-3">
                            <div class="text-sm text-gray-500">Select a dataset first to see columns</div>
                        </div>
                        <div class="mt-2">
                            <label class="inline-flex items-center">
                                <input type="checkbox" id="standardizeAllColumns" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked>
                                <span class="ml-2 text-sm text-gray-600">Process all text columns</span>
                            </label>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Text Operations</label>
                        <div class="space-y-3">
                            <label class="inline-flex items-center">
                                <input type="checkbox" id="trimSpaces" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked>
                                <span class="ml-2 text-sm text-gray-600">Trim leading/trailing spaces</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" id="removeExtraSpaces" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                <span class="ml-2 text-sm text-gray-600">Remove extra spaces between words</span>
                            </label>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Case Conversion</label>
                                <select id="textCase" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                    <option value="">No change</option>
                                    <option value="lower">Convert to lowercase</option>
                                    <option value="upper">Convert to uppercase</option>
                                    <option value="title">Convert to title case</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            break;
            
        case 'convert_data_types':
            configContainer.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Column Type Conversions</label>
                        <div id="conversionColumns" class="space-y-3 max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-3">
                            <div class="text-sm text-gray-500">Select a dataset first to see columns and their current types</div>
                        </div>
                    </div>
                </div>
            `;
            break;
    }
    
    // Add event listeners for dynamic sections
    addCleaningConfigEventListeners(operation);
}

// Add event listeners for cleaning configuration
function addCleaningConfigEventListeners(operation) {
    switch(operation) {
        case 'missing_values':
            // Strategy change
            document.getElementById('missingValuesStrategy').addEventListener('change', function() {
                const showFillValue = this.value === 'fill';
                document.getElementById('fillValueSection').style.display = showFillValue ? 'block' : 'none';
            });
            
            // Fill value type change
            document.querySelectorAll('input[name="fillValue"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('customValueSection').style.display = 
                        this.value === 'custom' ? 'block' : 'none';
                });
            });
            break;
    }
}

// Load dataset columns for cleaning
async function loadDatasetColumnsForCleaning(datasetId) {
    if (!datasetId) {
        currentDatasetColumns = [];
        updateCleaningColumnLists();
        return;
    }
    
    try {
        showToast('Loading dataset columns...', 'info');
        
        const response = await fetch(`/api/assistant/api/dataset/${datasetId}/columns/`, {
            method: "GET",
            headers: {
                "X-CSRFToken": getCsrfToken(),
                "Content-Type": "application/json"
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            currentDatasetColumns = result.columns;
            
            updateCleaningColumnLists();
            showToast('Dataset columns loaded', 'success');
            
            // Show action buttons
            if (currentCleaningOperation) {
                document.getElementById('previewCleaningBtn').classList.remove('hidden');
                document.getElementById('executeCleaningBtn').classList.remove('hidden');
            }
            
        } else {
            throw new Error('Failed to load columns');
        }
        
    } catch (error) {
        console.error('Error loading columns:', error);
        showToast('Error loading dataset columns', 'error');
    }
}

// Update column lists in cleaning configuration
function updateCleaningColumnLists() {
    if (!currentCleaningOperation || currentDatasetColumns.length === 0) return;
    
    switch(currentCleaningOperation) {
        case 'missing_values':
            updateMissingValuesColumnList();
            break;
        case 'remove_duplicates':
            updateDuplicateColumnsList();
            break;
        case 'standardize_formats':
            updateStandardizeColumnsList();
            break;
        case 'convert_data_types':
            updateConversionColumnsList();
            break;
    }
}

// Update missing values column list
function updateMissingValuesColumnList() {
    const container = document.getElementById('missingValuesColumns');
    container.innerHTML = '';
    
    currentDatasetColumns.forEach(column => {
        const div = document.createElement('div');
        div.className = 'flex items-center';
        div.innerHTML = `
            <input type="checkbox" id="mv_${column}" value="${column}" class="mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked>
            <label for="mv_${column}" class="text-sm text-gray-700">${column}</label>
        `;
        container.appendChild(div);
    });
}

// Update duplicate columns list
function updateDuplicateColumnsList() {
    const container = document.getElementById('duplicateColumns');
    container.innerHTML = '';
    
    currentDatasetColumns.forEach(column => {
        const div = document.createElement('div');
        div.className = 'flex items-center';
        div.innerHTML = `
            <input type="checkbox" id="dup_${column}" value="${column}" class="mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
            <label for="dup_${column}" class="text-sm text-gray-700">${column}</label>
        `;
        container.appendChild(div);
    });
}

// Update standardize columns list
function updateStandardizeColumnsList() {
    const container = document.getElementById('standardizeColumns');
    container.innerHTML = '';
    
    currentDatasetColumns.forEach(column => {
        const div = document.createElement('div');
        div.className = 'flex items-center';
        div.innerHTML = `
            <input type="checkbox" id="std_${column}" value="${column}" class="mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked>
            <label for="std_${column}" class="text-sm text-gray-700">${column}</label>
        `;
        container.appendChild(div);
    });
}

// Update conversion columns list
function updateConversionColumnsList() {
    const container = document.getElementById('conversionColumns');
    container.innerHTML = '';
    
    currentDatasetColumns.forEach(column => {
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between p-2 border border-gray-200 rounded';
        div.innerHTML = `
            <div class="flex-1">
                <div class="text-sm font-medium text-gray-700">${column}</div>
                <div class="text-xs text-gray-500">Current type: <span id="type_${column}">Loading...</span></div>
            </div>
            <select id="conv_${column}" class="ml-3 border border-gray-300 rounded px-2 py-1 text-sm">
                <option value="">No change</option>
                <option value="string">String</option>
                <option value="numeric">Numeric</option>
                <option value="integer">Integer</option>
                <option value="float">Float</option>
                <option value="datetime">Date/Time</option>
                <option value="boolean">Boolean</option>
            </select>
        `;
        container.appendChild(div);
    });
}

// Preview cleaning operation
async function previewCleaningOperation() {
    const datasetId = document.getElementById('cleaningDataset').value;
    if (!datasetId || !currentCleaningOperation) {
        showToast('Please select a dataset and operation', 'error');
        return;
    }
    
    try {
        showToast('Generating cleaning preview...', 'info');
        document.getElementById('cleaningStatus').textContent = 'Generating preview...';
        
        const requestData = {
            dataset_id: datasetId,
            preview_only: true,
            operation_type: currentCleaningOperation,
            ...getCleaningParameters()
        };
        
        const response = await fetch('/api/assistant/api/cleaning/preview/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        if (response.ok) {
            const result = await response.json();
            displayCleaningPreview(result);
            document.getElementById('cleaningStatus').textContent = 'Preview ready';
            showToast('Cleaning preview generated', 'success');
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to generate preview');
        }
        
    } catch (error) {
        console.error('Error previewing cleaning:', error);
        showToast(`Error: ${error.message}`, 'error');
        document.getElementById('cleaningStatus').textContent = 'Error generating preview';
    }
}

// Get cleaning parameters based on current operation
function getCleaningParameters() {
    const params = {};
    
    switch(currentCleaningOperation) {
        case 'missing_values':
            params.strategy = document.getElementById('missingValuesStrategy').value;
            
            if (params.strategy === 'fill') {
                const fillValueRadio = document.querySelector('input[name="fillValue"]:checked');
                params.fill_value = fillValueRadio ? fillValueRadio.value : 'mean';
                
                if (params.fill_value === 'custom') {
                    params.fill_value = document.getElementById('customFillValue').value || '';
                }
            }
            
            if (!document.getElementById('processAllColumns').checked) {
                params.columns = Array.from(document.querySelectorAll('#missingValuesColumns input:checked'))
                    .map(cb => cb.value);
            }
            break;
            
        case 'remove_duplicates':
            params.keep = document.getElementById('duplicateKeep').value;
            
            if (!document.getElementById('checkAllColumns').checked) {
                params.subset = Array.from(document.querySelectorAll('#duplicateColumns input:checked'))
                    .map(cb => cb.value);
            }
            break;
            
        case 'standardize_formats':
            params.operations = {
                trim: document.getElementById('trimSpaces').checked,
                remove_extra_spaces: document.getElementById('removeExtraSpaces').checked,
                case: document.getElementById('textCase').value
            };
            
            if (!document.getElementById('standardizeAllColumns').checked) {
                params.columns = Array.from(document.querySelectorAll('#standardizeColumns input:checked'))
                    .map(cb => cb.value);
            }
            break;
            
        case 'convert_data_types':
            params.conversions = {};
            currentDatasetColumns.forEach(column => {
                const select = document.getElementById(`conv_${column}`);
                if (select && select.value) {
                    params.conversions[column] = select.value;
                }
            });
            break;
    }
    
    return params;
}

// Display cleaning preview
function displayCleaningPreview(result) {
    const previewSection = document.getElementById('cleaningPreview');
    const headersContainer = document.getElementById('cleaningPreviewHeaders');
    const bodyContainer = document.getElementById('cleaningPreviewBody');
    const previewInfo = document.getElementById('cleaningPreviewInfo');
    
    // Show preview section
    previewSection.classList.remove('hidden');
    
    // Update preview info
    let infoText = `Preview: ${result.preview_data.length} rows`;
    if (result.original_stats) {
        infoText += ` | Original: ${result.original_stats.total_rows} rows`;
    }
    if (result.result_stats) {
        infoText += ` | Result: ${result.result_stats.total_rows} rows`;
    }
    previewInfo.textContent = infoText;
    
    // Create headers
    headersContainer.innerHTML = '';
    result.columns.forEach(column => {
        const th = document.createElement('th');
        th.className = 'px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
        th.textContent = column;
        headersContainer.appendChild(th);
    });
    
    // Create rows
    bodyContainer.innerHTML = '';
    result.preview_data.forEach(row => {
        const tr = document.createElement('tr');
        result.columns.forEach(column => {
            const td = document.createElement('td');
            td.className = 'px-4 py-2 whitespace-nowrap text-sm text-gray-900 border-t';
            const value = row[column];
            td.textContent = value !== null && value !== undefined ? 
                (typeof value === 'object' ? JSON.stringify(value) : String(value)) : 
                'NULL';
            tr.appendChild(td);
        });
        bodyContainer.appendChild(tr);
    });
}

// Execute cleaning operation
async function executeCleaningOperation() {
    const datasetId = document.getElementById('cleaningDataset').value;
    if (!datasetId || !currentCleaningOperation) {
        showToast('Please select a dataset and operation', 'error');
        return;
    }
    
    try {
        showToast('Executing cleaning operation...', 'info');
        document.getElementById('cleaningStatus').textContent = 'Executing...';
        document.getElementById('executeCleaningBtn').disabled = true;
        
        const requestData = {
            dataset_id: datasetId,
            operation_type: currentCleaningOperation,
            ...getCleaningParameters()
        };
        
        const response = await fetch('/api/assistant/api/cleaning/execute/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        if (response.ok) {
            const result = await response.json();
            
            // Add to pipeline
            const step = {
                name: `Data Cleaning: ${getCleaningOperationName(currentCleaningOperation)}`,
                type: 'cleaning',
                operation: currentCleaningOperation,
                description: getCleaningOperationDescription(currentCleaningOperation),
                details: `Processed ${result.result_stats?.total_rows || 'unknown'} rows`
            };
            
            addPipelineStep(step);
            
            showToast('Cleaning operation completed successfully!', 'success');
            closeCleaningModal();
            
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to execute cleaning');
        }
        
    } catch (error) {
        console.error('Error executing cleaning:', error);
        showToast(`Error: ${error.message}`, 'error');
        document.getElementById('cleaningStatus').textContent = 'Error executing operation';
    } finally {
        document.getElementById('executeCleaningBtn').disabled = false;
    }
}

// Helper functions
function getCleaningOperationName(operation) {
    const names = {
        'missing_values': 'Handle Missing Values',
        'remove_duplicates': 'Remove Duplicates',
        'standardize_formats': 'Standardize Formats',
        'convert_data_types': 'Data Type Conversion'
    };
    return names[operation] || operation;
}

function getCleaningOperationDescription(operation) {
    const descriptions = {
        'missing_values': 'Handle null or missing values in dataset',
        'remove_duplicates': 'Remove duplicate rows based on selected criteria',
        'standardize_formats': 'Standardize text formats and case sensitivity',
        'convert_data_types': 'Convert data types of selected columns'
    };
    return descriptions[operation] || 'Apply data cleaning operation';
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeDataCleaning();
});
</script>

<script>
    // Join Operations Functionality
let currentJoinOperation = null;

// Initialize join functionality
function initializeJoinOperations() {
    // Join operation buttons
    document.querySelectorAll('.transform-operation[data-type="join"]').forEach(button => {
        button.addEventListener('click', function() {
            const operation = this.getAttribute('data-operation');
            openJoinModal(operation);
        });
    });
    
    // Modal events
    document.getElementById('closeJoinModal').addEventListener('click', closeJoinModal);
    document.getElementById('joinModal').addEventListener('click', function(e) {
        if (e.target === this) closeJoinModal();
    });
    
    // Dataset selection events
    document.getElementById('leftDataset').addEventListener('change', function() {
        loadDatasetColumns(this.value, 'left');
    });
    
    document.getElementById('rightDataset').addEventListener('change', function() {
        loadDatasetColumns(this.value, 'right');
    });
    
    // Join action buttons
    document.getElementById('previewJoinBtn').addEventListener('click', previewJoinOperation);
    document.getElementById('createJoinBtn').addEventListener('click', createJoinOperation);
    document.getElementById('refreshPreview').addEventListener('click', previewJoinOperation);
    
    // Join type selection styling
    document.querySelectorAll('.join-type-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.join-type-option').forEach(opt => {
                opt.classList.remove('border-indigo-500', 'bg-indigo-50');
            });
            this.classList.add('border-indigo-500', 'bg-indigo-50');
        });
    });
}

// Open join modal
function openJoinModal(operation) {
    const modal = document.getElementById('joinModal');
    modal.classList.remove('hidden');
    
    // Set the join type
    const joinTypeInput = document.querySelector(`input[name="joinType"][value="${operation}"]`);
    if (joinTypeInput) {
        joinTypeInput.checked = true;
        joinTypeInput.parentElement.classList.add('border-indigo-500', 'bg-indigo-50');
    }
    
    currentJoinOperation = operation;
    showToast(`Creating ${getJoinTypeName(operation)} operation`, 'info');
}

// Close join modal
function closeJoinModal() {
    document.getElementById('joinModal').classList.add('hidden');
    resetJoinForm();
}

// Reset join form
function resetJoinForm() {
    document.getElementById('leftDataset').value = '';
    document.getElementById('rightDataset').value = '';
    document.getElementById('leftColumns').classList.add('hidden');
    document.getElementById('rightColumns').classList.add('hidden');
    document.getElementById('joinPreview').classList.add('hidden');
    document.getElementById('joinName').value = 'Joined_Dataset';
    document.getElementById('joinStatus').textContent = 'Ready to create join';
}

// Load dataset columns - FIXED URL
async function loadDatasetColumns(datasetId, side) {
    if (!datasetId) {
        document.getElementById(`${side}Columns`).classList.add('hidden');
        return;
    }
    
    try {
        showToast(`Loading ${side} dataset columns...`, 'info');
        
        // FIXED: Correct URL based on your main urls.py
        const response = await fetch(`/api/assistant/api/dataset/${datasetId}/columns/`, {
            method: "GET",
            headers: {
                "X-CSRFToken": getCsrfToken(),
                "Content-Type": "application/json"
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            
            const columnSelect = document.getElementById(`${side}Column`);
            const previewDiv = document.getElementById(`${side}Preview`);
            
            // Clear existing options
            columnSelect.innerHTML = '<option value="">Select column</option>';
            
            // Add new options
            result.columns.forEach(column => {
                const option = document.createElement('option');
                option.value = column;
                option.textContent = column;
                columnSelect.appendChild(option);
            });
            
            // Show sample data
            if (result.sample_data && result.sample_data.length > 0) {
                const sampleValues = result.sample_data.map(row => row[result.columns[0]]).slice(0, 3);
                previewDiv.textContent = `Sample: ${sampleValues.join(', ')}...`;
            }
            
            // Show columns section
            document.getElementById(`${side}Columns`).classList.remove('hidden');
            showToast(`${side} dataset columns loaded`, 'success');
            
        } else {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to load columns');
        }
        
    } catch (error) {
        console.error('Error loading columns:', error);
        showToast(`Error loading ${side} dataset columns: ${error.message}`, 'error');
    }
}

// Preview join operation - FIXED URL
async function previewJoinOperation() {
    const leftDataset = document.getElementById('leftDataset').value;
    const rightDataset = document.getElementById('rightDataset').value;
    const leftColumn = document.getElementById('leftColumn').value;
    const rightColumn = document.getElementById('rightColumn').value;
    const joinType = document.querySelector('input[name="joinType"]:checked').value;
    
    // Validation
    if (!leftDataset || !rightDataset || !leftColumn || !rightColumn) {
        showToast('Please select both datasets and join columns', 'error');
        return;
    }
    
    if (leftDataset === rightDataset) {
        showToast('Please select two different datasets', 'error');
        return;
    }
    
    try {
        showToast('Generating join preview...', 'info');
        document.getElementById('joinStatus').textContent = 'Generating preview...';
        
        // FIXED: Correct URL based on your main urls.py
        const response = await fetch('/api/assistant/api/join/preview/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                left_dataset: leftDataset,
                right_dataset: rightDataset,
                left_column: leftColumn,
                right_column: rightColumn,
                join_type: joinType
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            displayJoinPreview(result);
            document.getElementById('joinStatus').textContent = `Preview ready: ${result.row_count} rows`;
            showToast('Join preview generated successfully', 'success');
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to generate preview');
        }
        
    } catch (error) {
        console.error('Error previewing join:', error);
        showToast(`Error: ${error.message}`, 'error');
        document.getElementById('joinStatus').textContent = 'Error generating preview';
    }
}

// Display join preview
function displayJoinPreview(result) {
    const previewSection = document.getElementById('joinPreview');
    const headersContainer = document.getElementById('previewHeaders');
    const bodyContainer = document.getElementById('previewBody');
    const previewInfo = document.getElementById('previewInfo');
    
    // Show preview section
    previewSection.classList.remove('hidden');
    
    // Update preview info
    previewInfo.textContent = `Preview: ${result.preview_data.length} rows (Total: ${result.row_count} rows, ${result.columns.length} columns)`;
    
    // Create headers
    headersContainer.innerHTML = '';
    result.columns.forEach(column => {
        const th = document.createElement('th');
        th.className = 'px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
        th.textContent = column;
        headersContainer.appendChild(th);
    });
    
    // Create rows
    bodyContainer.innerHTML = '';
    result.preview_data.forEach(row => {
        const tr = document.createElement('tr');
        result.columns.forEach(column => {
            const td = document.createElement('td');
            td.className = 'px-4 py-2 whitespace-nowrap text-sm text-gray-900 border-t';
            td.textContent = row[column] !== null && row[column] !== undefined ? row[column] : 'NULL';
            tr.appendChild(td);
        });
        bodyContainer.appendChild(tr);
    });
}

// Create join operation - FIXED URL
async function createJoinOperation() {
    const leftDataset = document.getElementById('leftDataset').value;
    const rightDataset = document.getElementById('rightDataset').value;
    const leftColumn = document.getElementById('leftColumn').value;
    const rightColumn = document.getElementById('rightColumn').value;
    const joinType = document.querySelector('input[name="joinType"]:checked').value;
    const joinName = document.getElementById('joinName').value;
    
    // Validation
    if (!leftDataset || !rightDataset || !leftColumn || !rightColumn || !joinName) {
        showToast('Please fill all required fields', 'error');
        return;
    }
    
    try {
        showToast('Creating join operation...', 'info');
        document.getElementById('joinStatus').textContent = 'Creating join...';
        document.getElementById('createJoinBtn').disabled = true;
        
        // FIXED: Correct URL based on your main urls.py
        const response = await fetch('/api/assistant/api/join/create/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                left_dataset: leftDataset,
                right_dataset: rightDataset,
                left_column: leftColumn,
                right_column: rightColumn,
                join_type: joinType,
                name: joinName
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            
            // Add to pipeline
            const step = {
                name: `Join: ${joinName}`,
                type: 'join',
                operation: joinType,
                description: `${getJoinTypeName(joinType)} between datasets`,
                details: `Left: ${leftColumn}, Right: ${rightColumn}, Rows: ${result.row_count}`
            };
            
            addPipelineStep(step);
            
            showToast(`Join operation created successfully! ${result.row_count} rows generated`, 'success');
            closeJoinModal();
            
            // Refresh dataset list
            setTimeout(() => {
                window.location.reload(); // Or update dataset list dynamically
            }, 1000);
            
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to create join');
        }
        
    } catch (error) {
        console.error('Error creating join:', error);
        showToast(`Error: ${error.message}`, 'error');
        document.getElementById('joinStatus').textContent = 'Error creating join';
    } finally {
        document.getElementById('createJoinBtn').disabled = false;
    }
}

// Helper function to get join type name
function getJoinTypeName(joinType) {
    const names = {
        'inner': 'Inner Join',
        'left': 'Left Join',
        'right': 'Right Join',
        'outer': 'Full Outer Join'
    };
    return names[joinType] || joinType;
}

// Multi-join support
function createMultiJoinPipeline(steps) {
    // This function can be extended to support multiple sequential joins
    console.log('Creating multi-join pipeline:', steps);
    // Implementation for chaining multiple joins
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeJoinOperations();
    
    // Add keyboard shortcut for join modal
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'j') {
            e.preventDefault();
            openJoinModal('inner');
        }
    });
});
</script>
// Aggregation Modal
<div id="aggregationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg w-full max-w-6xl mx-4 max-h-[90vh] overflow-hidden flex flex-col">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold text-gray-800" id="aggregationModalTitle">Aggregation Operation</h3>
            <button id="closeAggregationModal" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6">
            <!-- Operation Selection -->
            <div id="aggregationOperationSelection" class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">Select Aggregation Operation</label>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <button class="aggregation-op-btn p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 text-left" data-operation="groupby">
                        <div class="font-medium text-sm">Group By & Summarize</div>
                        <div class="text-xs text-gray-500">Group data and calculate statistics</div>
                    </button>
                    <button class="aggregation-op-btn p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 text-left" data-operation="pivot">
                        <div class="font-medium text-sm">Pivot Tables</div>
                        <div class="text-xs text-gray-500">Reshape data from long to wide</div>
                    </button>
                    <button class="aggregation-op-btn p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 text-left" data-operation="window">
                        <div class="font-medium text-sm">Window Functions</div>
                        <div class="text-xs text-gray-500">Calculate running totals, ranks</div>
                    </button>
                    <button class="aggregation-op-btn p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 text-left" data-operation="rollup">
                        <div class="font-medium text-sm">Rollup & Cube</div>
                        <div class="text-xs text-gray-500">Multi-level aggregations</div>
                    </button>
                </div>
            </div>
            
            <!-- Dataset Selection -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Dataset</label>
                <select id="aggregationDataset" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">Select a dataset</option>
                    {% for dataset in datasets %}
                    <option value="{{ dataset.id }}">{{ dataset.file_name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Column Statistics -->
            <div id="columnStats" class="mb-6 hidden">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-medium text-gray-800">Column Statistics</h4>
                    <button id="refreshStats" class="text-sm text-indigo-600 hover:text-indigo-800">
                        <i class="fas fa-sync-alt mr-1"></i> Refresh
                    </button>
                </div>
                <div id="statsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-64 overflow-y-auto p-3 border border-gray-200 rounded-lg">
                    <!-- Statistics will be loaded here -->
                </div>
            </div>
            
            <!-- Operation Configuration -->
            <div id="aggregationConfig"></div>
            
            <!-- Preview Section -->
            <div id="aggregationPreview" class="hidden mt-6">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-medium text-gray-800">Aggregation Preview</h4>
                    <button id="refreshAggregationPreview" class="text-sm text-indigo-600 hover:text-indigo-800">
                        <i class="fas fa-sync-alt mr-1"></i> Refresh Preview
                    </button>
                </div>
                <div class="border border-gray-200 rounded-lg overflow-hidden">
                    <div class="bg-gray-50 px-4 py-2 border-b border-gray-200">
                        <div class="text-sm text-gray-600" id="aggregationPreviewInfo">Preview: 20 rows</div>
                    </div>
                    <div class="overflow-x-auto max-h-64">
                        <table class="min-w-full divide-y divide-gray-200" id="aggregationPreviewTable">
                            <thead class="bg-gray-50">
                                <tr id="aggregationPreviewHeaders"></tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="aggregationPreviewBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="p-4 border-t border-gray-200 bg-gray-50 flex justify-between items-center">
            <div class="text-sm text-gray-600" id="aggregationStatus">Select an operation to begin</div>
            <div class="flex space-x-3">
                <button id="previewAggregationBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 hidden">
                    Preview
                </button>
                <button id="executeAggregationBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 hidden">
                    Execute Aggregation
                </button>
            </div>
        </div>
    </div>
</div>
// Aggregation Modal
<div id="aggregationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg w-full max-w-6xl mx-4 max-h-[90vh] overflow-hidden flex flex-col">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold text-gray-800" id="aggregationModalTitle">Aggregation Operation</h3>
            <button id="closeAggregationModal" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6">
            <!-- Operation Selection -->
            <div id="aggregationOperationSelection" class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">Select Aggregation Operation</label>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <button class="aggregation-op-btn p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 text-left" data-operation="groupby">
                        <div class="font-medium text-sm">Group By & Summarize</div>
                        <div class="text-xs text-gray-500">Group data and calculate statistics</div>
                    </button>
                    <button class="aggregation-op-btn p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 text-left" data-operation="pivot">
                        <div class="font-medium text-sm">Pivot Tables</div>
                        <div class="text-xs text-gray-500">Reshape data from long to wide</div>
                    </button>
                    <button class="aggregation-op-btn p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 text-left" data-operation="window">
                        <div class="font-medium text-sm">Window Functions</div>
                        <div class="text-xs text-gray-500">Calculate running totals, ranks</div>
                    </button>
                    <button class="aggregation-op-btn p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 text-left" data-operation="rollup">
                        <div class="font-medium text-sm">Rollup & Cube</div>
                        <div class="text-xs text-gray-500">Multi-level aggregations</div>
                    </button>
                </div>
            </div>
            
            <!-- Dataset Selection -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Dataset</label>
                <select id="aggregationDataset" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">Select a dataset</option>
                    {% for dataset in datasets %}
                    <option value="{{ dataset.id }}">{{ dataset.file_name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Column Statistics -->
            <div id="columnStats" class="mb-6 hidden">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-medium text-gray-800">Column Statistics</h4>
                    <button id="refreshStats" class="text-sm text-indigo-600 hover:text-indigo-800">
                        <i class="fas fa-sync-alt mr-1"></i> Refresh
                    </button>
                </div>
                <div id="statsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-64 overflow-y-auto p-3 border border-gray-200 rounded-lg">
                    <!-- Statistics will be loaded here -->
                </div>
            </div>
            
            <!-- Operation Configuration -->
            <div id="aggregationConfig"></div>
            
            <!-- Preview Section -->
            <div id="aggregationPreview" class="hidden mt-6">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-medium text-gray-800">Aggregation Preview</h4>
                    <button id="refreshAggregationPreview" class="text-sm text-indigo-600 hover:text-indigo-800">
                        <i class="fas fa-sync-alt mr-1"></i> Refresh Preview
                    </button>
                </div>
                <div class="border border-gray-200 rounded-lg overflow-hidden">
                    <div class="bg-gray-50 px-4 py-2 border-b border-gray-200">
                        <div class="text-sm text-gray-600" id="aggregationPreviewInfo">Preview: 20 rows</div>
                    </div>
                    <div class="overflow-x-auto max-h-64">
                        <table class="min-w-full divide-y divide-gray-200" id="aggregationPreviewTable">
                            <thead class="bg-gray-50">
                                <tr id="aggregationPreviewHeaders"></tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="aggregationPreviewBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="p-4 border-t border-gray-200 bg-gray-50 flex justify-between items-center">
            <div class="text-sm text-gray-600" id="aggregationStatus">Select an operation to begin</div>
            <div class="flex space-x-3">
                <button id="previewAggregationBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 hidden">
                    Preview
                </button>
                <button id="executeAggregationBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 hidden">
                    Execute Aggregation
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Aggregation Functionality
 currentAggregationOperation = null;
 currentDatasetColumns = [];
 currentColumnStats = {};

// Initialize aggregation functionality
function initializeAggregation() {
    // Aggregation operation buttons
    document.querySelectorAll('.transform-operation[data-type="aggregation"]').forEach(button => {
        button.addEventListener('click', function() {
            const operation = this.getAttribute('data-operation');
            openAggregationModal(operation);
        });
    });
    
    // Modal events
    document.getElementById('closeAggregationModal').addEventListener('click', closeAggregationModal);
    document.getElementById('aggregationModal').addEventListener('click', function(e) {
        if (e.target === this) closeAggregationModal();
    });
    
    // Dataset selection
    document.getElementById('aggregationDataset').addEventListener('change', function() {
        if (this.value) {
            loadDatasetColumnsForAggregation(this.value);
            loadColumnStatistics(this.value);
        } else {
            currentDatasetColumns = [];
            currentColumnStats = {};
            document.getElementById('columnStats').classList.add('hidden');
        }
    });
    
    // Operation selection
    document.querySelectorAll('.aggregation-op-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const operation = this.getAttribute('data-operation');
            selectAggregationOperation(operation);
        });
    });
    
    // Action buttons
    document.getElementById('previewAggregationBtn').addEventListener('click', previewAggregationOperation);
    document.getElementById('executeAggregationBtn').addEventListener('click', executeAggregationOperation);
    document.getElementById('refreshAggregationPreview').addEventListener('click', previewAggregationOperation);
    document.getElementById('refreshStats').addEventListener('click', function() {
        const datasetId = document.getElementById('aggregationDataset').value;
        if (datasetId) loadColumnStatistics(datasetId);
    });
}

// Open aggregation modal
function openAggregationModal(operation) {
    const modal = document.getElementById('aggregationModal');
    modal.classList.remove('hidden');
    
    if (operation) {
        selectAggregationOperation(operation);
    }
}

// Close aggregation modal
function closeAggregationModal() {
    document.getElementById('aggregationModal').classList.add('hidden');
    resetAggregationForm();
}

// Reset aggregation form
function resetAggregationForm() {
    document.getElementById('aggregationDataset').value = '';
    document.getElementById('aggregationConfig').innerHTML = '';
    document.getElementById('aggregationPreview').classList.add('hidden');
    document.getElementById('columnStats').classList.add('hidden');
    document.getElementById('previewAggregationBtn').classList.add('hidden');
    document.getElementById('executeAggregationBtn').classList.add('hidden');
    document.getElementById('aggregationStatus').textContent = 'Select an operation to begin';
    currentAggregationOperation = null;
    currentDatasetColumns = [];
    currentColumnStats = {};
}

// Select aggregation operation
function selectAggregationOperation(operation) {
    currentAggregationOperation = operation;
    
    // Update UI
    document.querySelectorAll('.aggregation-op-btn').forEach(btn => {
        btn.classList.remove('border-indigo-500', 'bg-indigo-50');
        if (btn.getAttribute('data-operation') === operation) {
            btn.classList.add('border-indigo-500', 'bg-indigo-50');
        }
    });
    
    // Show operation-specific configuration
    renderAggregationConfig(operation);
    
    // Update status
    document.getElementById('aggregationStatus').textContent = `Configure ${getAggregationOperationName(operation)}`;
    document.getElementById('aggregationModalTitle').textContent = `${getAggregationOperationName(operation)} - Data Aggregation`;
    
    // Show action buttons if dataset is selected
    if (document.getElementById('aggregationDataset').value) {
        document.getElementById('previewAggregationBtn').classList.remove('hidden');
        document.getElementById('executeAggregationBtn').classList.remove('hidden');
    }
}

// Render operation-specific configuration
function renderAggregationConfig(operation) {
    const configContainer = document.getElementById('aggregationConfig');
    
    switch(operation) {
        case 'groupby':
            configContainer.innerHTML = `
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Group By Columns</label>
                        <div class="mb-3">
                            <label class="flex items-center">
                                <input type="checkbox" id="noGrouping" class="mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                <span class="text-sm text-gray-700">No grouping (aggregate entire dataset)</span>
                            </label>
                        </div>
                        <div id="groupByColumns" class="space-y-2 max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-3">
                            <div class="text-sm text-gray-500">Select columns to group by (or check "No grouping" for entire dataset)</div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Aggregation Operations</label>
                        <div id="aggregationOperations" class="space-y-3">
                            <div class="text-sm text-gray-500">Select columns and operations for aggregation</div>
                        </div>
                        <button id="addAggregationColumn" class="mt-2 text-sm text-indigo-600 hover:text-indigo-800">
                            <i class="fas fa-plus mr-1"></i> Add Aggregation Column
                        </button>
                    </div>
                </div>
            `;
            break;
            
        case 'pivot':
            configContainer.innerHTML = `
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Index Columns (Rows)</label>
                        <div id="pivotIndexColumns" class="space-y-2 max-h-32 overflow-y-auto border border-gray-200 rounded-lg p-3">
                            <div class="text-sm text-gray-500">Select rows for pivot table</div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Column Columns (Columns)</label>
                        <div id="pivotColumnColumns" class="space-y-2 max-h-32 overflow-y-auto border border-gray-200 rounded-lg p-3">
                            <div class="text-sm text-gray-500">Select columns for pivot table headers (optional)</div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Value Columns</label>
                        <div id="pivotValueColumns" class="space-y-2 max-h-32 overflow-y-auto border border-gray-200 rounded-lg p-3">
                            <div class="text-sm text-gray-500">Select numeric columns to aggregate</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Aggregation Function</label>
                            <select id="pivotAggFunc" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                <option value="mean">Mean</option>
                                <option value="sum">Sum</option>
                                <option value="count">Count</option>
                                <option value="min">Minimum</option>
                                <option value="max">Maximum</option>
                                <option value="median">Median</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Fill Missing Values With</label>
                            <input type="text" id="pivotFillValue" value="0" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        </div>
                    </div>
                </div>
            `;
            break;
            
        case 'window':
            configContainer.innerHTML = `
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Partition By Columns (Optional)</label>
                        <div id="windowPartitionColumns" class="space-y-2 max-h-32 overflow-y-auto border border-gray-200 rounded-lg p-3">
                            <div class="text-sm text-gray-500">Split data into groups for window functions</div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Order By Columns (Optional)</label>
                        <div id="windowOrderColumns" class="space-y-2 max-h-32 overflow-y-auto border border-gray-200 rounded-lg p-3">
                            <div class="text-sm text-gray-500">Specify sort order within partitions</div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Window Functions</label>
                        <div id="windowFunctions" class="space-y-3">
                            <div class="text-sm text-gray-500">Add window functions to apply</div>
                        </div>
                        <button id="addWindowFunction" class="mt-2 text-sm text-indigo-600 hover:text-indigo-800">
                            <i class="fas fa-plus mr-1"></i> Add Window Function
                        </button>
                    </div>
                </div>
            `;
            break;
            
        case 'rollup':
            configContainer.innerHTML = `
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Group By Columns (2 or more required)</label>
                        <div id="rollupGroupColumns" class="space-y-2 max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-3">
                            <div class="text-sm text-gray-500">Select at least 2 columns for multi-level aggregation</div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Aggregation Columns</label>
                        <div id="rollupAggregationColumns" class="space-y-3">
                            <div class="text-sm text-gray-500">Select columns and operations for aggregation</div>
                        </div>
                        <button id="addRollupAggregation" class="mt-2 text-sm text-indigo-600 hover:text-indigo-800">
                            <i class="fas fa-plus mr-1"></i> Add Aggregation Column
                        </button>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Operation Type</label>
                        <div class="flex space-x-4">
                            <label class="flex items-center">
                                <input type="radio" name="rollupType" value="rollup" class="mr-2" checked>
                                <span class="text-sm">Rollup (Hierarchical)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="rollupType" value="cube" class="mr-2">
                                <span class="text-sm">Cube (All Combinations)</span>
                            </label>
                        </div>
                    </div>
                </div>
            `;
            break;
    }
    
    // Add event listeners for dynamic sections
    addAggregationConfigEventListeners(operation);
}

// Add event listeners for aggregation configuration
function addAggregationConfigEventListeners(operation) {
    switch(operation) {
        case 'groupby':
            document.getElementById('addAggregationColumn').addEventListener('click', addAggregationColumn);
            
            // Add event listener for no grouping checkbox
            setTimeout(() => {
                const noGroupingCheckbox = document.getElementById('noGrouping');
                if (noGroupingCheckbox) {
                    noGroupingCheckbox.addEventListener('change', function() {
                        const groupContainer = document.getElementById('groupByColumns');
                        if (this.checked) {
                            groupContainer.style.opacity = '0.5';
                            groupContainer.style.pointerEvents = 'none';
                            // Uncheck all group columns
                            document.querySelectorAll('#groupByColumns input[type="checkbox"]').forEach(cb => {
                                cb.checked = false;
                            });
                        } else {
                            groupContainer.style.opacity = '1';
                            groupContainer.style.pointerEvents = 'auto';
                        }
                    });
                }
            }, 100);
            break;
        case 'window':
            document.getElementById('addWindowFunction').addEventListener('click', addWindowFunction);
            break;
        case 'rollup':
            document.getElementById('addRollupAggregation').addEventListener('click', addRollupAggregation);
            break;
    }
}

// Load dataset columns for aggregation
async function loadDatasetColumnsForAggregation(datasetId) {
    if (!datasetId) {
        currentDatasetColumns = [];
        updateAggregationColumnLists();
        return;
    }
    
    try {
        showToast('Loading dataset columns...', 'info');
        
        const response = await fetch(`/api/assistant/api/dataset/${datasetId}/columns/`, {
            method: "GET",
            headers: {
                "X-CSRFToken": getCsrfToken(),
                "Content-Type": "application/json"
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            currentDatasetColumns = result.columns;
            
            updateAggregationColumnLists();
            showToast('Dataset columns loaded', 'success');
            
            // Show column statistics
            document.getElementById('columnStats').classList.remove('hidden');
            
            // Show action buttons
            if (currentAggregationOperation) {
                document.getElementById('previewAggregationBtn').classList.remove('hidden');
                document.getElementById('executeAggregationBtn').classList.remove('hidden');
            }
            
        } else {
            throw new Error('Failed to load columns');
        }
        
    } catch (error) {
        console.error('Error loading columns:', error);
        showToast('Error loading dataset columns', 'error');
    }
}

// Load column statistics
async function loadColumnStatistics(datasetId) {
    try {
        const response = await fetch('/api/assistant/api/aggregation/statistics/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ dataset_id: datasetId })
        });
        
        if (response.ok) {
            const result = await response.json();
            currentColumnStats = result.statistics;
            displayColumnStatistics();
        }
    } catch (error) {
        console.error('Error loading statistics:', error);
    }
}

// Display column statistics
function displayColumnStatistics() {
    const container = document.getElementById('statsContainer');
    container.innerHTML = '';
    
    Object.entries(currentColumnStats).forEach(([column, stats]) => {
        const card = document.createElement('div');
        card.className = 'bg-white border border-gray-200 rounded-lg p-3';
        card.innerHTML = `
            <div class="font-medium text-sm text-gray-800 mb-2">${column}</div>
            <div class="text-xs space-y-1">
                <div class="flex justify-between">
                    <span class="text-gray-500">Type:</span>
                    <span class="font-medium">${stats.dtype}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">Non-null:</span>
                    <span class="font-medium">${stats.non_null_count}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">Unique:</span>
                    <span class="font-medium">${stats.unique_count}</span>
                </div>
                ${stats.mean !== undefined ? `
                    <div class="flex justify-between">
                        <span class="text-gray-500">Mean:</span>
                        <span class="font-medium">${stats.mean?.toFixed(2) || 'N/A'}</span>
                    </div>
                ` : ''}
            </div>
        `;
        container.appendChild(card);
    });
}

// Update aggregation column lists when dataset is loaded
function updateAggregationColumnLists() {
    if (!currentAggregationOperation || currentDatasetColumns.length === 0) {
        console.warn('Cannot update aggregation columns: no operation or columns available');
        return;
    }
    
    const numericColumns = currentDatasetColumns.filter(col => {
        const stats = currentColumnStats[col];
        return stats && (stats.dtype.includes('int') || stats.dtype.includes('float'));
    });
    
    const textColumns = currentDatasetColumns.filter(col => {
        const stats = currentColumnStats[col];
        return stats && stats.dtype === 'object';
    });
    
    console.log('Numeric columns:', numericColumns);
    console.log('Text columns:', textColumns);
    
    switch(currentAggregationOperation) {
        case 'groupby':
            updateGroupByColumnLists(numericColumns, textColumns);
            break;
        case 'pivot':
            updatePivotColumnLists(numericColumns, textColumns);
            break;
        // Add other cases...
    }
}

// Update group by column lists with proper initialization
function updateGroupByColumnLists(numericColumns, textColumns) {
    // Group by columns (all columns)
    const groupContainer = document.getElementById('groupByColumns');
    if (groupContainer) {
        groupContainer.innerHTML = '';
        
        currentDatasetColumns.forEach(column => {
            const div = document.createElement('div');
            div.className = 'flex items-center';
            div.innerHTML = `
                <input type="checkbox" id="gb_${column}" value="${column}" class="mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                <label for="gb_${column}" class="text-sm text-gray-700">${column}</label>
                ${numericColumns.includes(column) ? '<span class="ml-2 text-xs text-green-600">(numeric)</span>' : ''}
                ${textColumns.includes(column) ? '<span class="ml-2 text-xs text-blue-600">(text)</span>' : ''}
            `;
            groupContainer.appendChild(div);
        });
    }
    
    // Aggregation operations - Clear and create with smart default
    const aggContainer = document.getElementById('aggregationOperations');
    if (aggContainer) {
        aggContainer.innerHTML = ''; // Clear existing
        
        // Always add at least one aggregation column
        const defaultColumn = numericColumns.length > 0 ? numericColumns[0] : 
                            currentDatasetColumns.length > 0 ? currentDatasetColumns[0] : '';
        
        if (defaultColumn) {
            addAggregationColumn(defaultColumn);
        } else {
            // If no columns available yet, add empty one
            addAggregationColumn();
        }
    }
}


// Update group by column lists
function updateGroupByColumnLists(numericColumns, textColumns) {
    // Group by columns (all columns)
    const groupContainer = document.getElementById('groupByColumns');
    groupContainer.innerHTML = '';
    
    currentDatasetColumns.forEach(column => {
        const div = document.createElement('div');
        div.className = 'flex items-center';
        div.innerHTML = `
            <input type="checkbox" id="gb_${column}" value="${column}" class="mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
            <label for="gb_${column}" class="text-sm text-gray-700">${column}</label>
        `;
        groupContainer.appendChild(div);
    });
    
    // Aggregation operations (numeric columns only)
    const aggContainer = document.getElementById('aggregationOperations');
    aggContainer.innerHTML = '';
    
    // Add one default aggregation column
    addAggregationColumn();
}

// Add aggregation column for groupby
function addAggregationColumn() {
    const container = document.getElementById('aggregationOperations');
    const id = Date.now();
    
    const div = document.createElement('div');
    div.className = 'border border-gray-200 rounded-lg p-3';
    div.innerHTML = `
        <div class="flex items-start space-x-3">
            <div class="flex-1">
                <label class="block text-xs font-medium text-gray-700 mb-1">Column</label>
                <select class="agg-column-select w-full border border-gray-300 rounded px-2 py-1 text-sm">
                    <option value="">Select column</option>
                    ${currentDatasetColumns.map(col => 
                        `<option value="${col}">${col}</option>`
                    ).join('')}
                </select>
            </div>
            <div class="flex-1">
                <label class="block text-xs font-medium text-gray-700 mb-1">Operations</label>
                <div class="space-y-1">
                    ${['sum', 'mean', 'count', 'min', 'max', 'median', 'std', 'unique_count'].map(op => `
                        <label class="flex items-center">
                            <input type="checkbox" value="${op}" class="mr-1 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <span class="text-xs">${op}</span>
                        </label>
                    `).join('')}
                </div>
            </div>
            <button class="remove-agg-column text-red-600 hover:text-red-800 mt-6">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    container.appendChild(div);
    
    // Add remove event listener
    div.querySelector('.remove-agg-column').addEventListener('click', function() {
        div.remove();
    });
}

// Update pivot column lists
function updatePivotColumnLists(numericColumns, textColumns) {
    // Index columns (typically text columns)
    const indexContainer = document.getElementById('pivotIndexColumns');
    indexContainer.innerHTML = '';
    
    textColumns.forEach(column => {
        const div = document.createElement('div');
        div.className = 'flex items-center';
        div.innerHTML = `
            <input type="checkbox" id="pivot_idx_${column}" value="${column}" class="mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
            <label for="pivot_idx_${column}" class="text-sm text-gray-700">${column}</label>
        `;
        indexContainer.appendChild(div);
    });
    
    // Column columns (typically text columns with few unique values)
    const colContainer = document.getElementById('pivotColumnColumns');
    colContainer.innerHTML = '';
    
    textColumns.forEach(column => {
        const stats = currentColumnStats[column];
        const div = document.createElement('div');
        div.className = 'flex items-center';
        div.innerHTML = `
            <input type="checkbox" id="pivot_col_${column}" value="${column}" class="mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
            <label for="pivot_col_${column}" class="text-sm text-gray-700">${column}</label>
            <span class="ml-2 text-xs text-gray-400">(${stats.unique_count} unique)</span>
        `;
        colContainer.appendChild(div);
    });
    
    // Value columns (numeric columns)
    const valueContainer = document.getElementById('pivotValueColumns');
    valueContainer.innerHTML = '';
    
    numericColumns.forEach(column => {
        const div = document.createElement('div');
        div.className = 'flex items-center';
        div.innerHTML = `
            <input type="checkbox" id="pivot_val_${column}" value="${column}" class="mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
            <label for="pivot_val_${column}" class="text-sm text-gray-700">${column}</label>
        `;
        valueContainer.appendChild(div);
    });
}

// Update window column lists
function updateWindowColumnLists(numericColumns, textColumns) {
    // Partition columns
    const partitionContainer = document.getElementById('windowPartitionColumns');
    partitionContainer.innerHTML = '';
    
    currentDatasetColumns.forEach(column => {
        const div = document.createElement('div');
        div.className = 'flex items-center';
        div.innerHTML = `
            <input type="checkbox" id="win_part_${column}" value="${column}" class="mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
            <label for="win_part_${column}" class="text-sm text-gray-700">${column}</label>
        `;
        partitionContainer.appendChild(div);
    });
    
    // Order columns
    const orderContainer = document.getElementById('windowOrderColumns');
    orderContainer.innerHTML = '';
    
    currentDatasetColumns.forEach(column => {
        const div = document.createElement('div');
        div.className = 'flex items-center';
        div.innerHTML = `
            <input type="checkbox" id="win_ord_${column}" value="${column}" class="mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
            <label for="win_ord_${column}" class="text-sm text-gray-700">${column}</label>
        `;
        orderContainer.appendChild(div);
    });
    
    // Add one default window function
    addWindowFunction();
}

// Add window function
function addWindowFunction() {
    const container = document.getElementById('windowFunctions');
    const id = Date.now();
    
    const div = document.createElement('div');
    div.className = 'border border-gray-200 rounded-lg p-3';
    div.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Target Column</label>
                <select class="win-target-select w-full border border-gray-300 rounded px-2 py-1 text-sm">
                    <option value="">Select column</option>
                    ${currentDatasetColumns.map(col => 
                        `<option value="${col}">${col}</option>`
                    ).join('')}
                </select>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Function Type</label>
                <select class="win-function-select w-full border border-gray-300 rounded px-2 py-1 text-sm">
                    <option value="cumsum">Cumulative Sum</option>
                    <option value="cummean">Cumulative Mean</option>
                    <option value="cummin">Cumulative Min</option>
                    <option value="cummax">Cumulative Max</option>
                    <option value="rank">Rank</option>
                    <option value="row_number">Row Number</option>
                    <option value="lag">Lag</option>
                    <option value="lead">Lead</option>
                    <option value="rolling_mean">Rolling Mean</option>
                    <option value="rolling_sum">Rolling Sum</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">New Column Name</label>
                <input type="text" class="win-new-col w-full border border-gray-300 rounded px-2 py-1 text-sm" placeholder="auto-generated">
            </div>
        </div>
        <div class="mt-2 flex justify-between items-center">
            <div class="win-params text-xs text-gray-500"></div>
            <button class="remove-win-function text-red-600 hover:text-red-800 text-sm">
                <i class="fas fa-times mr-1"></i> Remove
            </button>
        </div>
    `;
    container.appendChild(div);
    
    // Add event listeners
    const functionSelect = div.querySelector('.win-function-select');
    const targetSelect = div.querySelector('.win-target-select');
    const newColInput = div.querySelector('.win-new-col');
    const paramsDiv = div.querySelector('.win-params');
    
    function updateParams() {
        const funcType = functionSelect.value;
        const targetCol = targetSelect.value;
        
        if (targetCol) {
            newColInput.value = newColInput.value || `${targetCol}_${funcType}`;
        }
        
        // Show parameters based on function type
        let params = '';
        if (['lag', 'lead'].includes(funcType)) {
            params = 'Periods: <input type="number" value="1" min="1" class="w-12 border border-gray-300 rounded px-1 text-xs">';
        } else if (['rolling_mean', 'rolling_sum'].includes(funcType)) {
            params = 'Window Size: <input type="number" value="3" min="1" class="w-12 border border-gray-300 rounded px-1 text-xs">';
        }
        paramsDiv.innerHTML = params;
    }
    
    functionSelect.addEventListener('change', updateParams);
    targetSelect.addEventListener('change', updateParams);
    
    div.querySelector('.remove-win-function').addEventListener('click', function() {
        div.remove();
    });
    
    updateParams();
}

// Update rollup column lists
function updateRollupColumnLists(numericColumns, textColumns) {
    // Group columns (all columns)
    const groupContainer = document.getElementById('rollupGroupColumns');
    groupContainer.innerHTML = '';
    
    currentDatasetColumns.forEach(column => {
        const div = document.createElement('div');
        div.className = 'flex items-center';
        div.innerHTML = `
            <input type="checkbox" id="rollup_grp_${column}" value="${column}" class="mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
            <label for="rollup_grp_${column}" class="text-sm text-gray-700">${column}</label>
        `;
        groupContainer.appendChild(div);
    });
    
    // Add one default aggregation
    addRollupAggregation();
}

// Add rollup aggregation
function addRollupAggregation() {
    const container = document.getElementById('rollupAggregationColumns');
    const id = Date.now();
    
    const div = document.createElement('div');
    div.className = 'border border-gray-200 rounded-lg p-3';
    div.innerHTML = `
        <div class="flex items-start space-x-3">
            <div class="flex-1">
                <label class="block text-xs font-medium text-gray-700 mb-1">Column</label>
                <select class="rollup-column-select w-full border border-gray-300 rounded px-2 py-1 text-sm">
                    <option value="">Select column</option>
                    ${currentDatasetColumns.map(col => 
                        `<option value="${col}">${col}</option>`
                    ).join('')}
                </select>
            </div>
            <div class="flex-1">
                <label class="block text-xs font-medium text-gray-700 mb-1">Operations</label>
                <div class="space-y-1">
                    ${['sum', 'mean', 'count', 'min', 'max', 'median'].map(op => `
                        <label class="flex items-center">
                            <input type="checkbox" value="${op}" class="mr-1 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <span class="text-xs">${op}</span>
                        </label>
                    `).join('')}
                </div>
            </div>
            <button class="remove-rollup-agg text-red-600 hover:text-red-800 mt-6">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    container.appendChild(div);
    
    // Add remove event listener
    div.querySelector('.remove-rollup-agg').addEventListener('click', function() {
        div.remove();
    });
}

// Preview aggregation operation
// FIXED: Preview aggregation operation
async function previewAggregationOperation() {
    const datasetId = document.getElementById('aggregationDataset').value;
    
    if (!datasetId || !currentAggregationOperation) {
        alert('Please select a dataset and configure the operation first');
        return;
    }
    
    console.log('Preview aggregation - Dataset ID:', datasetId, 'Operation:', currentAggregationOperation);
    
    try {
        // Show loading state
        document.getElementById('aggregationStatus').textContent = 'Generating preview...';
        document.getElementById('previewAggregationBtn').disabled = true;
        
        let aggregationParams;
        try {
            aggregationParams = getAggregationParameters();
        } catch (paramError) {
            alert(`Configuration Error: ${paramError.message}`);
            document.getElementById('aggregationStatus').textContent = 'Configuration error';
            document.getElementById('previewAggregationBtn').disabled = false;
            return;
        }
        
        const requestData = {
            dataset_id: datasetId,
            preview_only: true,
            operation_type: currentAggregationOperation,
            ...aggregationParams
        };
        
        console.log('Sending aggregation preview request:', requestData);
        
        const response = await fetch('/api/assistant/api/aggregation/preview/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        if (response.ok) {
            const result = await response.json();
            displayAggregationPreview(result);
            document.getElementById('aggregationStatus').textContent = 'Preview ready';
        } else {
            const errorData = await response.json();
            throw new Error(errorData.error || `Server error: ${response.status}`);
        }
        
    } catch (error) {
        console.error('Error previewing aggregation:', error);
        alert(`Error generating preview: ${error.message}`);
        document.getElementById('aggregationStatus').textContent = 'Error generating preview';
    } finally {
        document.getElementById('previewAggregationBtn').disabled = false;
    }
}

// Get aggregation parameters based on current operation
// FIXED: Get aggregation parameters for preview/execution
function getAggregationParameters() {
    const params = {};
    
    switch(currentAggregationOperation) {
        case 'groupby':
            // Get group by columns
            const noGrouping = document.getElementById('noGrouping')?.checked;
            if (!noGrouping) {
                const groupColumns = Array.from(document.querySelectorAll('#groupByColumns input:checked'))
                    .map(cb => cb.value)
                    .filter(col => col && col !== 'undefined');
                
                if (groupColumns.length > 0) {
                    params.group_columns = groupColumns;
                }
            }
            
            // Get aggregation operations - FIXED: Properly collect from checkboxes
            params.aggregations = [];
            
            // Get all aggregation entries
            const aggregationEntries = document.querySelectorAll('#aggregationOperations .border-gray-200');
            
            aggregationEntries.forEach(entry => {
                const columnSelect = entry.querySelector('.agg-column-select');
                const column = columnSelect ? columnSelect.value : '';
                
                if (column && column !== '') {
                    // Get all checked operation checkboxes within this entry
                    const operationCheckboxes = entry.querySelectorAll('input[type="checkbox"]:checked');
                    const operations = Array.from(operationCheckboxes)
                        .map(cb => cb.value)
                        .filter(op => op && op !== 'undefined');
                    
                    console.log(`Column: ${column}, Operations found:`, operations);
                    
                    if (operations.length > 0) {
                        params.aggregations.push({
                            column: column,
                            operations: operations
                        });
                    } else {
                        // If no operations selected, default to count
                        params.aggregations.push({
                            column: column,
                            operations: ['count']
                        });
                    }
                }
            });
            
            // DEBUG: Log what we collected
            console.log('DEBUG - Aggregations collected:', params.aggregations);
            console.log('DEBUG - Number of aggregation entries found:', aggregationEntries.length);
            
            // If no aggregations found after processing, throw error
            if (!params.aggregations || params.aggregations.length === 0) {
                throw new Error('At least one aggregation operation is required. Please select a column and operations.');
            }
            
            console.log('Final Group By Parameters:', params);
            break;
            
        case 'pivot':
            params.index_columns = Array.from(document.querySelectorAll('#pivotIndexColumns input:checked'))
                .map(cb => cb.value)
                .filter(col => col && col !== 'undefined');
                
            params.column_columns = Array.from(document.querySelectorAll('#pivotColumnColumns input:checked'))
                .map(cb => cb.value)
                .filter(col => col && col !== 'undefined');
                
            params.value_columns = Array.from(document.querySelectorAll('#pivotValueColumns input:checked'))
                .map(cb => cb.value)
                .filter(col => col && col !== 'undefined');
                
            params.agg_func = document.getElementById('pivotAggFunc')?.value || 'mean';
            params.fill_value = document.getElementById('pivotFillValue')?.value || '0';
            
            // Add validation for pivot tables
            if (params.index_columns.length === 0) {
                throw new Error('Please select at least one index column for the pivot table');
            }
            if (params.value_columns.length === 0) {
                throw new Error('Please select at least one value column for the pivot table');
            }
            
            console.log('Pivot Table Parameters:', params);
            break;
            
        // Add other aggregation operations...
    }
    
    return params;
}
// FIXED: Add aggregation column with proper CSS classes
function addAggregationColumn(defaultColumn = '', defaultOperations = ['count']) {
    const container = document.getElementById('aggregationOperations');
    const id = Date.now();
    
    // If no default column provided, use smart selection
    if (!defaultColumn && currentDatasetColumns.length > 0) {
        const numericColumns = currentDatasetColumns.filter(col => {
            const stats = currentColumnStats[col];
            return stats && (stats.dtype.includes('int') || stats.dtype.includes('float'));
        });
        
        if (numericColumns.length > 0) {
            defaultColumn = numericColumns[0];
            defaultOperations = ['count', 'mean'];
        } else {
            defaultColumn = currentDatasetColumns[0];
            defaultOperations = ['count'];
        }
    }
    
    const div = document.createElement('div');
    div.className = 'border border-gray-200 rounded-lg p-3';
    div.innerHTML = `
        <div class="flex items-start space-x-3">
            <div class="flex-1">
                <label class="block text-xs font-medium text-gray-700 mb-1">Column *</label>
                <select class="agg-column-select w-full border border-gray-300 rounded px-2 py-1 text-sm" required>
                    <option value="">Select column</option>
                    ${currentDatasetColumns.map(col => {
                        const isNumeric = currentColumnStats[col] && 
                                         (currentColumnStats[col].dtype.includes('int') || 
                                          currentColumnStats[col].dtype.includes('float'));
                        return `<option value="${col}" ${col === defaultColumn ? 'selected' : ''}>
                                ${col} ${isNumeric ? '(numeric)' : '(text)'}
                            </option>`;
                    }).join('')}
                </select>
            </div>
            <div class="flex-1">
                <label class="block text-xs font-medium text-gray-700 mb-1">Operations *</label>
                <div class="space-y-1 max-h-32 overflow-y-auto border border-gray-200 rounded p-2" id="operations-container-${id}">
                    ${[
                        {value: 'count', label: 'Count', available: true},
                        {value: 'unique_count', label: 'Unique Count', available: true},
                        {value: 'sum', label: 'Sum', available: false},
                        {value: 'mean', label: 'Mean', available: false},
                        {value: 'median', label: 'Median', available: false},
                        {value: 'min', label: 'Minimum', available: false},
                        {value: 'max', label: 'Maximum', available: false},
                        {value: 'std', label: 'Standard Deviation', available: false}
                    ].map(op => `
                        <label class="flex items-center ${!op.available ? 'opacity-50' : ''}">
                            <input type="checkbox" value="${op.value}" 
                                   class="mr-1 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 agg-operation-checkbox" 
                                   ${defaultOperations.includes(op.value) ? 'checked' : ''}
                                   ${!op.available ? 'disabled' : ''}>
                            <span class="text-xs ${!op.available ? 'text-gray-400' : ''}">${op.label}</span>
                        </label>
                    `).join('')}
                </div>
                <div class="text-xs text-gray-500 mt-1">At least one operation required</div>
            </div>
            <button class="remove-agg-column text-red-600 hover:text-red-800 mt-6" type="button">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    container.appendChild(div);
    
    // Update available operations based on column type
    const columnSelect = div.querySelector('.agg-column-select');
    const operationsContainer = div.querySelector(`#operations-container-${id}`);
    
    function updateAvailableOperations() {
        const selectedColumn = columnSelect.value;
        const isNumeric = selectedColumn && currentColumnStats[selectedColumn] && 
                         (currentColumnStats[selectedColumn].dtype.includes('int') || 
                          currentColumnStats[selectedColumn].dtype.includes('float'));
        
        operationsContainer.querySelectorAll('.agg-operation-checkbox').forEach(checkbox => {
            const operation = checkbox.value;
            // Count and unique_count are always available
            const shouldBeAvailable = ['count', 'unique_count'].includes(operation) || isNumeric;
            
            checkbox.disabled = !shouldBeAvailable;
            checkbox.parentElement.classList.toggle('opacity-50', !shouldBeAvailable);
            checkbox.parentElement.querySelector('span').classList.toggle('text-gray-400', !shouldBeAvailable);
            
            // Uncheck disabled operations
            if (!shouldBeAvailable && checkbox.checked) {
                checkbox.checked = false;
            }
        });
    }
    
    // Initial update
    updateAvailableOperations();
    
    // Update when column changes
    columnSelect.addEventListener('change', updateAvailableOperations);
    
    // Add remove event listener
    const removeBtn = div.querySelector('.remove-agg-column');
    removeBtn.addEventListener('click', function() {
        if (container.children.length > 1) {
            div.remove();
        } else {
            alert('At least one aggregation column is required');
        }
    });
}

// Display aggregation preview
function displayAggregationPreview(result) {
    const previewSection = document.getElementById('aggregationPreview');
    const headersContainer = document.getElementById('aggregationPreviewHeaders');
    const bodyContainer = document.getElementById('aggregationPreviewBody');
    const previewInfo = document.getElementById('aggregationPreviewInfo');
    
    // Show preview section
    previewSection.classList.remove('hidden');
    
    // Update preview info
    let infoText = `Preview: ${result.preview_data.length} rows`;
    if (result.original_stats) {
        infoText += ` | Original: ${result.original_stats.total_rows} rows`;
    }
    if (result.result_stats) {
        infoText += ` | Result: ${result.result_stats.total_rows} rows`;
        if (result.result_stats.reduction_ratio) {
            infoText += ` | Reduction: ${result.result_stats.reduction_ratio}`;
        }
        if (result.result_stats.aggregation_type === 'whole_dataset') {
            infoText += ' | Whole Dataset Aggregation';
        }
    }
    previewInfo.textContent = infoText;
    
    // Create headers
    headersContainer.innerHTML = '';
    result.columns.forEach(column => {
        const th = document.createElement('th');
        th.className = 'px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
        th.textContent = column;
        headersContainer.appendChild(th);
    });
    
    // Create rows
    bodyContainer.innerHTML = '';
    result.preview_data.forEach(row => {
        const tr = document.createElement('tr');
        result.columns.forEach(column => {
            const td = document.createElement('td');
            td.className = 'px-4 py-2 whitespace-nowrap text-sm text-gray-900 border-t';
            const value = row[column];
            td.textContent = value !== null && value !== undefined ? 
                (typeof value === 'object' ? JSON.stringify(value) : String(value)) : 
                'NULL';
            tr.appendChild(td);
        });
        bodyContainer.appendChild(tr);
    });
}

// Execute aggregation operation
async function executeAggregationOperation() {
    const datasetId = document.getElementById('aggregationDataset').value;
    if (!datasetId || !currentAggregationOperation) {
        showToast('Please select a dataset and operation', 'error');
        return;
    }
    
    try {
        showToast('Executing aggregation operation...', 'info');
        document.getElementById('aggregationStatus').textContent = 'Executing...';
        document.getElementById('executeAggregationBtn').disabled = true;
        
        // ADD TRY-CATCH AROUND PARAMETER EXTRACTION
        let aggregationParams;
        try {
            aggregationParams = getAggregationParameters();
        } catch (paramError) {
            showToast(`Configuration error: ${paramError.message}`, 'error');
            document.getElementById('aggregationStatus').textContent = 'Configuration error';
            document.getElementById('executeAggregationBtn').disabled = false;
            return;
        }
        
        const requestData = {
            dataset_id: datasetId,
            operation_type: currentAggregationOperation,
            ...aggregationParams
        };
        
        const response = await fetch('/api/assistant/api/aggregation/execute/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        if (response.ok) {
            const result = await response.json();
            
            // Add to pipeline
            const stepName = currentAggregationOperation === 'groupby' && 
                            document.getElementById('noGrouping')?.checked ?
                            'Dataset Aggregation' : 
                            `Aggregation: ${getAggregationOperationName(currentAggregationOperation)}`;
            
            const step = {
                name: stepName,
                type: 'aggregation',
                operation: currentAggregationOperation,
                description: getAggregationOperationDescription(currentAggregationOperation),
                details: `Processed ${result.result_stats?.total_rows || 'unknown'} rows`
            };
            
            addPipelineStep(step);
            
            showToast('Aggregation operation completed successfully!', 'success');
            closeAggregationModal();
            
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to execute aggregation');
        }
        
    } catch (error) {
        console.error('Error executing aggregation:', error);
        showToast(`Error: ${error.message}`, 'error');
        document.getElementById('aggregationStatus').textContent = 'Error executing operation';
    } finally {
        document.getElementById('executeAggregationBtn').disabled = false;
    }
}

// Helper functions
function getAggregationOperationName(operation) {
    const names = {
        'groupby': 'Group By & Summarize',
        'pivot': 'Pivot Table',
        'window': 'Window Functions',
        'rollup': 'Rollup & Cube'
    };
    return names[operation] || operation;
}

function getAggregationOperationDescription(operation) {
    const descriptions = {
        'groupby': 'Group data and calculate summary statistics',
        'pivot': 'Reshape data from long to wide format',
        'window': 'Apply calculations over sliding windows of data',
        'rollup': 'Create multi-level summary aggregations'
    };
    return descriptions[operation] || 'Apply data aggregation';
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeAggregation();
});
</script>

<!-- Filter & Sort Modal -->
<div id="filterSortModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg w-full max-w-6xl mx-4 max-h-[90vh] overflow-hidden flex flex-col">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold text-gray-800" id="filterSortModalTitle">Filter & Sort Data</h3>
            <button id="closeFilterSortModal" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6">
            <!-- Operation Selection -->
            <div id="filterSortOperationSelection" class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">Select Operation</label>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <button class="filter-sort-op-btn p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 text-left" data-operation="filter">
                        <div class="font-medium text-sm">Conditional Filtering</div>
                        <div class="text-xs text-gray-500">Filter data based on conditions</div>
                    </button>
                    <button class="filter-sort-op-btn p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 text-left" data-operation="sort">
                        <div class="font-medium text-sm">Multi-column Sorting</div>
                        <div class="text-xs text-gray-500">Sort by multiple columns</div>
                    </button>
                    <button class="filter-sort-op-btn p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 text-left" data-operation="top_n">
                        <div class="font-medium text-sm">Top N Records</div>
                        <div class="text-xs text-gray-500">Get top/bottom records</div>
                    </button>
                    <button class="filter-sort-op-btn p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 text-left" data-operation="random_sample">
                        <div class="font-medium text-sm">Random Sampling</div>
                        <div class="text-xs text-gray-500">Get random data sample</div>
                    </button>
                </div>
            </div>
            
            <!-- Dataset Selection -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Dataset</label>
                <select id="filterSortDataset" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">Select a dataset</option>
                    {% for dataset in datasets %}
                    <option value="{{ dataset.id }}">{{ dataset.file_name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Column Statistics -->
            <div id="filterSortColumnStats" class="mb-6 hidden">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-medium text-gray-800">Column Statistics</h4>
                    <button id="refreshFilterSortStats" class="text-sm text-indigo-600 hover:text-indigo-800">
                        <i class="fas fa-sync-alt mr-1"></i> Refresh
                    </button>
                </div>
                <div id="filterSortStatsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-64 overflow-y-auto p-3 border border-gray-200 rounded-lg">
                    <!-- Statistics will be loaded here -->
                </div>
            </div>
            
            <!-- Operation Configuration -->
            <div id="filterSortConfig"></div>
            
            <!-- Preview Section -->
            <div id="filterSortPreview" class="hidden mt-6">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-medium text-gray-800">Preview</h4>
                    <button id="refreshFilterSortPreview" class="text-sm text-indigo-600 hover:text-indigo-800">
                        <i class="fas fa-sync-alt mr-1"></i> Refresh Preview
                    </button>
                </div>
                <div class="border border-gray-200 rounded-lg overflow-hidden">
                    <div class="bg-gray-50 px-4 py-2 border-b border-gray-200">
                        <div class="text-sm text-gray-600" id="filterSortPreviewInfo">Preview: 20 rows</div>
                    </div>
                    <div class="overflow-x-auto max-h-64">
                        <table class="min-w-full divide-y divide-gray-200" id="filterSortPreviewTable">
                            <thead class="bg-gray-50">
                                <tr id="filterSortPreviewHeaders"></tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="filterSortPreviewBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="p-4 border-t border-gray-200 bg-gray-50 flex justify-between items-center">
            <div class="text-sm text-gray-600" id="filterSortStatus">Select an operation to begin</div>
            <div class="flex space-x-3">
                <button id="previewFilterSortBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 hidden">
                    Preview
                </button>
                <button id="executeFilterSortBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 hidden">
                    Execute Operation
                </button>
            </div>
        </div>
    </div>
</div>
<script>
    // Filter & Sort Functionality
let currentFilterSortOperation = null;
let currentFilterSortDatasetColumns = [];
let currentFilterSortColumnStats = {};

// Initialize filter & sort functionality
function initializeFilterSort() {
    // Filter & sort operation buttons
    document.querySelectorAll('.transform-operation[data-type="filter-sort"]').forEach(button => {
        button.addEventListener('click', function() {
            const operation = this.getAttribute('data-operation');
            openFilterSortModal(operation);
        });
    });
    
    // Modal events
    document.getElementById('closeFilterSortModal').addEventListener('click', closeFilterSortModal);
    document.getElementById('filterSortModal').addEventListener('click', function(e) {
        if (e.target === this) closeFilterSortModal();
    });
    
    // Dataset selection
    document.getElementById('filterSortDataset').addEventListener('change', function() {
        if (this.value) {
            loadDatasetColumnsForFilterSort(this.value);
            loadFilterSortColumnStatistics(this.value);
        } else {
            currentFilterSortDatasetColumns = [];
            currentFilterSortColumnStats = {};
            document.getElementById('filterSortColumnStats').classList.add('hidden');
        }
    });
    
    // Operation selection
    document.querySelectorAll('.filter-sort-op-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const operation = this.getAttribute('data-operation');
            selectFilterSortOperation(operation);
        });
    });
    
    // Action buttons
    document.getElementById('previewFilterSortBtn').addEventListener('click', previewFilterSortOperation);
    document.getElementById('executeFilterSortBtn').addEventListener('click', executeFilterSortOperation);
    document.getElementById('refreshFilterSortPreview').addEventListener('click', previewFilterSortOperation);
    document.getElementById('refreshFilterSortStats').addEventListener('click', function() {
        const datasetId = document.getElementById('filterSortDataset').value;
        if (datasetId) loadFilterSortColumnStatistics(datasetId);
    });
}

// Open filter & sort modal
function openFilterSortModal(operation) {
    const modal = document.getElementById('filterSortModal');
    modal.classList.remove('hidden');
    
    if (operation) {
        selectFilterSortOperation(operation);
    }
}

// Close filter & sort modal
function closeFilterSortModal() {
    document.getElementById('filterSortModal').classList.add('hidden');
    resetFilterSortForm();
}

// Reset filter & sort form
function resetFilterSortForm() {
    document.getElementById('filterSortDataset').value = '';
    document.getElementById('filterSortConfig').innerHTML = '';
    document.getElementById('filterSortPreview').classList.add('hidden');
    document.getElementById('filterSortColumnStats').classList.add('hidden');
    document.getElementById('previewFilterSortBtn').classList.add('hidden');
    document.getElementById('executeFilterSortBtn').classList.add('hidden');
    document.getElementById('filterSortStatus').textContent = 'Select an operation to begin';
    currentFilterSortOperation = null;
    currentFilterSortDatasetColumns = [];
    currentFilterSortColumnStats = {};
}

// Select filter & sort operation
function selectFilterSortOperation(operation) {
    currentFilterSortOperation = operation;
    
    // Update UI
    document.querySelectorAll('.filter-sort-op-btn').forEach(btn => {
        btn.classList.remove('border-indigo-500', 'bg-indigo-50');
        if (btn.getAttribute('data-operation') === operation) {
            btn.classList.add('border-indigo-500', 'bg-indigo-50');
        }
    });
    
    // Show operation-specific configuration
    renderFilterSortConfig(operation);
    
    // Update status
    document.getElementById('filterSortStatus').textContent = `Configure ${getFilterSortOperationName(operation)}`;
    document.getElementById('filterSortModalTitle').textContent = `${getFilterSortOperationName(operation)} - Filter & Sort`;
    
    // Show action buttons if dataset is selected
    if (document.getElementById('filterSortDataset').value) {
        document.getElementById('previewFilterSortBtn').classList.remove('hidden');
        document.getElementById('executeFilterSortBtn').classList.remove('hidden');
    }
}

// Render operation-specific configuration
function renderFilterSortConfig(operation) {
    const configContainer = document.getElementById('filterSortConfig');
    
    switch(operation) {
        case 'filter':
            configContainer.innerHTML = `
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Filters</label>
                        <div id="filterConditions" class="space-y-3">
                            <div class="text-sm text-gray-500">Add conditions to filter your data</div>
                        </div>
                        <button id="addFilterCondition" class="mt-2 text-sm text-indigo-600 hover:text-indigo-800">
                            <i class="fas fa-plus mr-1"></i> Add Filter Condition
                        </button>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-start">
                            <i class="fas fa-info-circle text-blue-500 mt-1 mr-3"></i>
                            <div class="text-sm text-blue-700">
                                <strong>Tip:</strong> Filters are applied in the order they are added. 
                                Multiple conditions act as AND operations.
                            </div>
                        </div>
                    </div>
                </div>
            `;
            break;
            
        case 'sort':
            configContainer.innerHTML = `
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Sort Columns</label>
                        <div id="sortColumns" class="space-y-3">
                            <div class="text-sm text-gray-500">Add columns to sort by priority</div>
                        </div>
                        <button id="addSortColumn" class="mt-2 text-sm text-indigo-600 hover:text-indigo-800">
                            <i class="fas fa-plus mr-1"></i> Add Sort Column
                        </button>
                    </div>
                </div>
            `;
            break;
            
        case 'top_n':
            configContainer.innerHTML = `
                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Number of Records</label>
                            <input type="number" id="topNCount" value="10" min="1" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sort Order</label>
                            <select id="topNOrder" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                <option value="desc">Top (Descending)</option>
                                <option value="asc">Bottom (Ascending)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Sort By Column</label>
                        <select id="topNColumn" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                            <option value="">Select column</option>
                        </select>
                    </div>
                </div>
            `;
            break;
            
        case 'random_sample':
            configContainer.innerHTML = `
                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sample Size</label>
                            <input type="number" id="sampleSize" value="100" min="1" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sample Type</label>
                            <select id="sampleType" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                <option value="count">Fixed Count</option>
                                <option value="percentage">Percentage</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Random Seed (Optional)</label>
                        <input type="number" id="randomSeed" value="42" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm" placeholder="42">
                        <p class="text-xs text-gray-500 mt-1">Same seed produces same random sample for reproducibility</p>
                    </div>
                </div>
            `;
            break;
    }
    
    // Add event listeners for dynamic sections
    addFilterSortConfigEventListeners(operation);
}

// Add event listeners for filter & sort configuration
function addFilterSortConfigEventListeners(operation) {
    switch(operation) {
        case 'filter':
            document.getElementById('addFilterCondition').addEventListener('click', addFilterCondition);
            break;
        case 'sort':
            document.getElementById('addSortColumn').addEventListener('click', addSortColumn);
            break;
        case 'top_n':
            // Update column options when dataset changes
            updateTopNColumnOptions();
            break;
    }
}

// Load dataset columns for filter & sort
async function loadDatasetColumnsForFilterSort(datasetId) {
    if (!datasetId) {
        currentFilterSortDatasetColumns = [];
        updateFilterSortColumnLists();
        return;
    }
    
    try {
        showToast('Loading dataset columns...', 'info');
        
        const response = await fetch(`/api/assistant/api/dataset/${datasetId}/columns/`, {
            method: "GET",
            headers: {
                "X-CSRFToken": getCsrfToken(),
                "Content-Type": "application/json"
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            currentFilterSortDatasetColumns = result.columns;
            
            updateFilterSortColumnLists();
            showToast('Dataset columns loaded', 'success');
            
            // Show column statistics
            document.getElementById('filterSortColumnStats').classList.remove('hidden');
            
            // Show action buttons
            if (currentFilterSortOperation) {
                document.getElementById('previewFilterSortBtn').classList.remove('hidden');
                document.getElementById('executeFilterSortBtn').classList.remove('hidden');
            }
            
        } else {
            throw new Error('Failed to load columns');
        }
        
    } catch (error) {
        console.error('Error loading columns:', error);
        showToast('Error loading dataset columns', 'error');
    }
}

// Load column statistics for filter & sort
async function loadFilterSortColumnStatistics(datasetId) {
    try {
        const response = await fetch('/api/assistant/api/aggregation/statistics/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ dataset_id: datasetId })
        });
        
        if (response.ok) {
            const result = await response.json();
            currentFilterSortColumnStats = result.statistics;
            displayFilterSortColumnStatistics();
        }
    } catch (error) {
        console.error('Error loading statistics:', error);
    }
}

// Display column statistics for filter & sort
function displayFilterSortColumnStatistics() {
    const container = document.getElementById('filterSortStatsContainer');
    container.innerHTML = '';
    
    Object.entries(currentFilterSortColumnStats).forEach(([column, stats]) => {
        const card = document.createElement('div');
        card.className = 'bg-white border border-gray-200 rounded-lg p-3';
        card.innerHTML = `
            <div class="font-medium text-sm text-gray-800 mb-2">${column}</div>
            <div class="text-xs space-y-1">
                <div class="flex justify-between">
                    <span class="text-gray-500">Type:</span>
                    <span class="font-medium">${stats.dtype}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">Non-null:</span>
                    <span class="font-medium">${stats.non_null_count}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">Unique:</span>
                    <span class="font-medium">${stats.unique_count}</span>
                </div>
                ${stats.mean !== undefined ? `
                    <div class="flex justify-between">
                        <span class="text-gray-500">Mean:</span>
                        <span class="font-medium">${stats.mean?.toFixed(2) || 'N/A'}</span>
                    </div>
                ` : ''}
            </div>
        `;
        container.appendChild(card);
    });
}

// Update column lists in filter & sort configuration
function updateFilterSortColumnLists() {
    if (!currentFilterSortOperation || currentFilterSortDatasetColumns.length === 0) return;
    
    switch(currentFilterSortOperation) {
        case 'top_n':
            updateTopNColumnOptions();
            break;
    }
}

// Update top N column options
function updateTopNColumnOptions() {
    const select = document.getElementById('topNColumn');
    if (!select) return;
    
    select.innerHTML = '<option value="">Select column</option>';
    currentFilterSortDatasetColumns.forEach(column => {
        const option = document.createElement('option');
        option.value = column;
        option.textContent = column;
        select.appendChild(option);
    });
}

// Add filter condition
function addFilterCondition() {
    const container = document.getElementById('filterConditions');
    const id = Date.now();
    
    const div = document.createElement('div');
    div.className = 'border border-gray-200 rounded-lg p-4';
    div.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-end">
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Column</label>
                <select class="filter-column-select w-full border border-gray-300 rounded px-2 py-1 text-sm">
                    <option value="">Select column</option>
                    ${currentFilterSortDatasetColumns.map(col => {
                        const stats = currentFilterSortColumnStats[col];
                        const typeInfo = stats ? ` (${stats.dtype})` : '';
                        return `<option value="${col}">${col}${typeInfo}</option>`;
                    }).join('')}
                </select>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Operator</label>
                <select class="filter-operator-select w-full border border-gray-300 rounded px-2 py-1 text-sm">
                    <option value="equals">Equals</option>
                    <option value="not_equals">Not Equals</option>
                    <option value="contains">Contains</option>
                    <option value="starts_with">Starts With</option>
                    <option value="ends_with">Ends With</option>
                    <option value="greater_than">Greater Than</option>
                    <option value="less_than">Less Than</option>
                    <option value="greater_than_equal">Greater Than or Equal</option>
                    <option value="less_than_equal">Less Than or Equal</option>
                    <option value="is_null">Is Null</option>
                    <option value="not_null">Is Not Null</option>
                    <option value="in_list">In List</option>
                    <option value="not_in_list">Not In List</option>
                    <option value="between">Between</option>
                </select>
            </div>
            <div class="filter-value-container">
                <label class="block text-xs font-medium text-gray-700 mb-1">Value</label>
                <input type="text" class="filter-value-input w-full border border-gray-300 rounded px-2 py-1 text-sm" placeholder="Enter value">
                <div class="filter-value-help text-xs text-gray-500 mt-1 hidden"></div>
                <div class="filter-data-type text-xs text-blue-600 mt-1 hidden"></div>
            </div>
            <div>
                <button class="remove-filter-condition text-red-600 hover:text-red-800 text-sm w-full py-1">
                    <i class="fas fa-times mr-1"></i> Remove
                </button>
            </div>
        </div>
    `;
    container.appendChild(div);
    
    // Add event listeners
    const columnSelect = div.querySelector('.filter-column-select');
    const operatorSelect = div.querySelector('.filter-operator-select');
    const valueContainer = div.querySelector('.filter-value-container');
    const valueInput = div.querySelector('.filter-value-input');
    const helpText = div.querySelector('.filter-value-help');
    const dataTypeText = div.querySelector('.filter-data-type');
    
    function updateFilterValueVisibility() {
        const operator = operatorSelect.value;
        const showValue = !['is_null', 'not_null'].includes(operator);
        valueContainer.style.display = showValue ? 'block' : 'none';
        
        // Update help text
        if (operator === 'in_list' || operator === 'not_in_list') {
            helpText.textContent = 'Enter comma-separated values';
            helpText.classList.remove('hidden');
        } else if (operator === 'between') {
            helpText.textContent = 'Enter two values separated by comma';
            helpText.classList.remove('hidden');
        } else {
            helpText.classList.add('hidden');
        }
        
        // Update data type info
        const selectedColumn = columnSelect.value;
        if (selectedColumn && currentFilterSortColumnStats[selectedColumn]) {
            const stats = currentFilterSortColumnStats[selectedColumn];
            dataTypeText.textContent = `Data type: ${stats.dtype}`;
            dataTypeText.classList.remove('hidden');
            
            // Set input type based on data type for better UX
            if (stats.dtype.includes('int') || stats.dtype.includes('float')) {
                valueInput.type = 'number';
                valueInput.step = stats.dtype.includes('int') ? '1' : '0.1';
            } else {
                valueInput.type = 'text';
            }
        } else {
            dataTypeText.classList.add('hidden');
        }
    }
    
    columnSelect.addEventListener('change', updateFilterValueVisibility);
    operatorSelect.addEventListener('change', updateFilterValueVisibility);
    div.querySelector('.remove-filter-condition').addEventListener('click', function() {
        div.remove();
    });
    
    updateFilterValueVisibility();
}
// Add sort column
function addSortColumn() {
    const container = document.getElementById('sortColumns');
    const id = Date.now();
    
    const div = document.createElement('div');
    div.className = 'border border-gray-200 rounded-lg p-4';
    div.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Column</label>
                <select class="sort-column-select w-full border border-gray-300 rounded px-2 py-1 text-sm">
                    <option value="">Select column</option>
                    ${currentFilterSortDatasetColumns.map(col => 
                        `<option value="${col}">${col}</option>`
                    ).join('')}
                </select>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Order</label>
                <select class="sort-order-select w-full border border-gray-300 rounded px-2 py-1 text-sm">
                    <option value="asc">Ascending (A-Z, 0-9)</option>
                    <option value="desc">Descending (Z-A, 9-0)</option>
                </select>
            </div>
            <div>
                <button class="remove-sort-column text-red-600 hover:text-red-800 text-sm w-full py-1">
                    <i class="fas fa-times mr-1"></i> Remove
                </button>
            </div>
        </div>
    `;
    container.appendChild(div);
    
    // Add remove event listener
    div.querySelector('.remove-sort-column').addEventListener('click', function() {
        div.remove();
    });
}

// Preview filter & sort operation
async function previewFilterSortOperation() {
    const datasetId = document.getElementById('filterSortDataset').value;
    if (!datasetId || !currentFilterSortOperation) {
        showToast('Please select a dataset and operation', 'error');
        return;
    }
    
    try {
        showToast('Generating preview...', 'info');
        document.getElementById('filterSortStatus').textContent = 'Generating preview...';
        
        let operationParams;
        try {
            operationParams = getFilterSortParameters();
        } catch (paramError) {
            showToast(`Configuration error: ${paramError.message}`, 'error');
            document.getElementById('filterSortStatus').textContent = 'Configuration error';
            return;
        }
        
        const requestData = {
            dataset_id: datasetId,
            preview_only: true,
            operation_type: currentFilterSortOperation,
            ...operationParams
        };
        
        const response = await fetch('/api/assistant/api/filter-sort/preview/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        if (response.ok) {
            const result = await response.json();
            displayFilterSortPreview(result);
            document.getElementById('filterSortStatus').textContent = 'Preview ready';
            showToast('Preview generated', 'success');
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to generate preview');
        }
        
    } catch (error) {
        console.error('Error previewing operation:', error);
        showToast(`Error: ${error.message}`, 'error');
        document.getElementById('filterSortStatus').textContent = 'Error generating preview';
    }
}

// Get filter & sort parameters based on current operation
// Get filter & sort parameters based on current operation
function getFilterSortParameters() {
    const params = {};
    
    switch(currentFilterSortOperation) {
        case 'filter':
            params.filters = [];
            document.querySelectorAll('#filterConditions > div').forEach(filterDiv => {
                const columnSelect = filterDiv.querySelector('.filter-column-select');
                const operatorSelect = filterDiv.querySelector('.filter-operator-select');
                const valueInput = filterDiv.querySelector('.filter-value-input');
                
                if (columnSelect && columnSelect.value && operatorSelect && operatorSelect.value) {
                    const filterConfig = {
                        column: columnSelect.value,
                        operator: operatorSelect.value
                    };
                    
                    // Handle value based on operator
                    if (!['is_null', 'not_null'].includes(operatorSelect.value)) {
                        if (valueInput && valueInput.value) {
                            // Smart value conversion based on input
                            const convertValue = (val) => {
                                const trimmed = val.trim();
                                if (trimmed === '') return null;
                                
                                // Try to convert to number
                                if (!isNaN(trimmed) && trimmed !== '') {
                                    return Number(trimmed);
                                }
                                
                                // Try to convert to boolean
                                if (trimmed.toLowerCase() === 'true') return true;
                                if (trimmed.toLowerCase() === 'false') return false;
                                
                                // Return as string
                                return trimmed;
                            };
                            
                            if (['in_list', 'not_in_list'].includes(operatorSelect.value)) {
                                filterConfig.value = valueInput.value.split(',').map(convertValue);
                            } else if (operatorSelect.value === 'between') {
                                filterConfig.value = valueInput.value.split(',').map(convertValue).slice(0, 2);
                            } else {
                                filterConfig.value = convertValue(valueInput.value);
                            }
                        } else {
                            throw new Error('Filter value is required');
                        }
                    }
                    
                    params.filters.push(filterConfig);
                }
            });
            
            if (params.filters.length === 0) {
                showToast('Please add at least one filter condition', 'error');
                throw new Error('Filter conditions required');
            }
            break;
            
        case 'sort':
            params.sort_columns = [];
            document.querySelectorAll('#sortColumns > div').forEach(sortDiv => {
                const columnSelect = sortDiv.querySelector('.sort-column-select');
                const orderSelect = sortDiv.querySelector('.sort-order-select');
                
                if (columnSelect && columnSelect.value && orderSelect) {
                    params.sort_columns.push({
                        column: columnSelect.value,
                        order: orderSelect.value
                    });
                }
            });
            
            if (params.sort_columns.length === 0) {
                showToast('Please add at least one sort column', 'error');
                throw new Error('Sort columns required');
            }
            break;
            
        case 'top_n':
            const nRecords = document.getElementById('topNCount')?.value;
            const sortOrder = document.getElementById('topNOrder')?.value;
            const sortColumn = document.getElementById('topNColumn')?.value;
            
            if (!nRecords || nRecords < 1) {
                showToast('Please enter a valid number of records', 'error');
                throw new Error('Invalid record count');
            }
            
            if (!sortColumn) {
                showToast('Please select a column to sort by', 'error');
                throw new Error('Sort column required');
            }
            
            params.n_records = parseInt(nRecords);
            params.sort_by = sortColumn;
            params.sort_order = sortOrder || 'desc';
            break;
            
        case 'random_sample':
            const sampleSize = document.getElementById('sampleSize')?.value;
            const sampleType = document.getElementById('sampleType')?.value;
            const randomSeed = document.getElementById('randomSeed')?.value;
            
            if (!sampleSize || sampleSize < 1) {
                showToast('Please enter a valid sample size', 'error');
                throw new Error('Invalid sample size');
            }
            
            params.sample_size = parseInt(sampleSize);
            params.sample_type = sampleType || 'count';
            if (randomSeed) params.random_state = parseInt(randomSeed);
            break;
    }
    
    return params;
}


// Display filter & sort preview
function displayFilterSortPreview(result) {
    const previewSection = document.getElementById('filterSortPreview');
    const headersContainer = document.getElementById('filterSortPreviewHeaders');
    const bodyContainer = document.getElementById('filterSortPreviewBody');
    const previewInfo = document.getElementById('filterSortPreviewInfo');
    
    // Show preview section
    previewSection.classList.remove('hidden');
    
    // Update preview info
    let infoText = `Preview: ${result.preview_data.length} rows`;
    if (result.original_stats) {
        infoText += ` | Original: ${result.original_stats.total_rows} rows`;
    }
    if (result.result_stats) {
        infoText += ` | Result: ${result.result_stats.total_rows} rows`;
        if (result.result_stats.rows_removed !== undefined) {
            infoText += ` | Removed: ${result.result_stats.rows_removed} rows`;
        }
        if (result.result_stats.filter_efficiency) {
            infoText += ` | Efficiency: ${result.result_stats.filter_efficiency}`;
        }
        if (result.result_stats.sampling_rate) {
            infoText += ` | Sampling Rate: ${result.result_stats.sampling_rate}`;
        }
    }
    previewInfo.textContent = infoText;
    
    // Create headers
    headersContainer.innerHTML = '';
    result.columns.forEach(column => {
        const th = document.createElement('th');
        th.className = 'px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
        th.textContent = column;
        headersContainer.appendChild(th);
    });
    
    // Create rows
    bodyContainer.innerHTML = '';
    result.preview_data.forEach(row => {
        const tr = document.createElement('tr');
        result.columns.forEach(column => {
            const td = document.createElement('td');
            td.className = 'px-4 py-2 whitespace-nowrap text-sm text-gray-900 border-t';
            const value = row[column];
            td.textContent = value !== null && value !== undefined ? 
                (typeof value === 'object' ? JSON.stringify(value) : String(value)) : 
                'NULL';
            tr.appendChild(td);
        });
        bodyContainer.appendChild(tr);
    });
}

// Execute filter & sort operation
async function executeFilterSortOperation() {
    const datasetId = document.getElementById('filterSortDataset').value;
    if (!datasetId || !currentFilterSortOperation) {
        showToast('Please select a dataset and operation', 'error');
        return;
    }
    
    try {
        showToast('Executing operation...', 'info');
        document.getElementById('filterSortStatus').textContent = 'Executing...';
        document.getElementById('executeFilterSortBtn').disabled = true;
        
        let operationParams;
        try {
            operationParams = getFilterSortParameters();
        } catch (paramError) {
            showToast(`Configuration error: ${paramError.message}`, 'error');
            document.getElementById('filterSortStatus').textContent = 'Configuration error';
            document.getElementById('executeFilterSortBtn').disabled = false;
            return;
        }
        
        const requestData = {
            dataset_id: datasetId,
            operation_type: currentFilterSortOperation,
            ...operationParams
        };
        
        const response = await fetch('/api/assistant/api/filter-sort/execute/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        if (response.ok) {
            const result = await response.json();
            
            // Add to pipeline
            const step = {
                name: getFilterSortOperationName(currentFilterSortOperation),
                type: 'filter_sort',
                operation: currentFilterSortOperation,
                description: getFilterSortOperationDescription(currentFilterSortOperation),
                details: `Processed ${result.result_stats?.total_rows || 'unknown'} rows`
            };
            
            addPipelineStep(step);
            
            showToast('Operation completed successfully!', 'success');
            closeFilterSortModal();
            
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to execute operation');
        }
        
    } catch (error) {
        console.error('Error executing operation:', error);
        showToast(`Error: ${error.message}`, 'error');
        document.getElementById('filterSortStatus').textContent = 'Error executing operation';
    } finally {
        document.getElementById('executeFilterSortBtn').disabled = false;
    }
}

// Helper functions
function getFilterSortOperationName(operation) {
    const names = {
        'filter': 'Conditional Filtering',
        'sort': 'Multi-column Sorting',
        'top_n': 'Top N Records',
        'random_sample': 'Random Sampling'
    };
    return names[operation] || operation;
}

function getFilterSortOperationDescription(operation) {
    const descriptions = {
        'filter': 'Filter data based on conditional logic',
        'sort': 'Sort data by multiple columns',
        'top_n': 'Extract top or bottom records',
        'random_sample': 'Get random sample from dataset'
    };
    return descriptions[operation] || 'Apply data filtering and sorting';
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeFilterSort();
});
</script>



<!-- Feature Engineering Modal -->
<div id="featureEngineeringModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg w-full max-w-6xl mx-4 max-h-[90vh] overflow-hidden flex flex-col">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold text-gray-800" id="featureEngineeringModalTitle">Feature Engineering</h3>
            <button id="closeFeatureEngineeringModal" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6">
            <!-- Operation Selection -->
            <div id="featureEngineeringOperationSelection" class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">Select Feature Engineering Operation</label>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <button class="feature-eng-op-btn p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 text-left" data-operation="calculated_columns">
                        <div class="font-medium text-sm">Calculated Columns</div>
                        <div class="text-xs text-gray-500">Create new columns with formulas</div>
                    </button>
                    <button class="feature-eng-op-btn p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 text-left" data-operation="datetime_extraction">
                        <div class="font-medium text-sm">Date/Time Extraction</div>
                        <div class="text-xs text-gray-500">Extract components from dates</div>
                    </button>
                    <button class="feature-eng-op-btn p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 text-left" data-operation="text_processing">
                        <div class="font-medium text-sm">Text Processing</div>
                        <div class="text-xs text-gray-500">Transform and extract from text</div>
                    </button>
                    <button class="feature-eng-op-btn p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 text-left" data-operation="one_hot_encoding">
                        <div class="font-medium text-sm">One-Hot Encoding</div>
                        <div class="text-xs text-gray-500">Convert categories to binary</div>
                    </button>
                </div>
            </div>
            
            <!-- Dataset Selection -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Dataset</label>
                <select id="featureEngineeringDataset" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">Select a dataset</option>
                    {% for dataset in datasets %}
                    <option value="{{ dataset.id }}">{{ dataset.file_name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Column Statistics -->
            <div id="featureEngineeringColumnStats" class="mb-6 hidden">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-medium text-gray-800">Column Statistics</h4>
                    <button id="refreshFeatureEngineeringStats" class="text-sm text-indigo-600 hover:text-indigo-800">
                        <i class="fas fa-sync-alt mr-1"></i> Refresh
                    </button>
                </div>
                <div id="featureEngineeringStatsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-64 overflow-y-auto p-3 border border-gray-200 rounded-lg">
                    <!-- Statistics will be loaded here -->
                </div>
            </div>
            
            <!-- Operation Configuration -->
            <div id="featureEngineeringConfig"></div>
            
            <!-- Preview Section -->
            <div id="featureEngineeringPreview" class="hidden mt-6">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-medium text-gray-800">Preview</h4>
                    <button id="refreshFeatureEngineeringPreview" class="text-sm text-indigo-600 hover:text-indigo-800">
                        <i class="fas fa-sync-alt mr-1"></i> Refresh Preview
                    </button>
                </div>
                <div class="border border-gray-200 rounded-lg overflow-hidden">
                    <div class="bg-gray-50 px-4 py-2 border-b border-gray-200">
                        <div class="text-sm text-gray-600" id="featureEngineeringPreviewInfo">Preview: 20 rows</div>
                    </div>
                    <div class="overflow-x-auto max-h-64">
                        <table class="min-w-full divide-y divide-gray-200" id="featureEngineeringPreviewTable">
                            <thead class="bg-gray-50">
                                <tr id="featureEngineeringPreviewHeaders"></tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="featureEngineeringPreviewBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="p-4 border-t border-gray-200 bg-gray-50 flex justify-between items-center">
            <div class="text-sm text-gray-600" id="featureEngineeringStatus">Select an operation to begin</div>
            <div class="flex space-x-3">
                <button id="previewFeatureEngineeringBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 hidden">
                    Preview
                </button>
                <button id="executeFeatureEngineeringBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 hidden">
                    Execute Operation
                </button>
            </div>
        </div>
    </div>
</div>
<script>
    // Feature Engineering Functionality
let currentFeatureEngineeringOperation = null;
let currentFeatureEngineeringDatasetColumns = [];
let currentFeatureEngineeringColumnStats = {};

// Initialize feature engineering functionality
function initializeFeatureEngineering() {
    // Feature engineering operation buttons
    document.querySelectorAll('.transform-operation[data-type="feature"]').forEach(button => {
        button.addEventListener('click', function() {
            const operation = this.getAttribute('data-operation');
            openFeatureEngineeringModal(operation);
        });
    });
    
    // Modal events
    document.getElementById('closeFeatureEngineeringModal').addEventListener('click', closeFeatureEngineeringModal);
    document.getElementById('featureEngineeringModal').addEventListener('click', function(e) {
        if (e.target === this) closeFeatureEngineeringModal();
    });
    
    // Dataset selection
    document.getElementById('featureEngineeringDataset').addEventListener('change', function() {
        if (this.value) {
            loadDatasetColumnsForFeatureEngineering(this.value);
            loadFeatureEngineeringColumnStatistics(this.value);
        } else {
            currentFeatureEngineeringDatasetColumns = [];
            currentFeatureEngineeringColumnStats = {};
            document.getElementById('featureEngineeringColumnStats').classList.add('hidden');
        }
    });
    
    // Operation selection
    document.querySelectorAll('.feature-eng-op-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const operation = this.getAttribute('data-operation');
            selectFeatureEngineeringOperation(operation);
        });
    });
    
    // Action buttons
    document.getElementById('previewFeatureEngineeringBtn').addEventListener('click', previewFeatureEngineeringOperation);
    document.getElementById('executeFeatureEngineeringBtn').addEventListener('click', executeFeatureEngineeringOperation);
    document.getElementById('refreshFeatureEngineeringPreview').addEventListener('click', previewFeatureEngineeringOperation);
    document.getElementById('refreshFeatureEngineeringStats').addEventListener('click', function() {
        const datasetId = document.getElementById('featureEngineeringDataset').value;
        if (datasetId) loadFeatureEngineeringColumnStatistics(datasetId);
    });
}

// Open feature engineering modal
function openFeatureEngineeringModal(operation) {
    const modal = document.getElementById('featureEngineeringModal');
    modal.classList.remove('hidden');
    
    if (operation) {
        // Map the operation names from the button to the backend
        const operationMap = {
            'calculated': 'calculated_columns',
            'date': 'datetime_extraction',
            'text': 'text_processing',
            'encoding': 'one_hot_encoding'
        };
        
        selectFeatureEngineeringOperation(operationMap[operation] || operation);
    }
}

// Close feature engineering modal
function closeFeatureEngineeringModal() {
    document.getElementById('featureEngineeringModal').classList.add('hidden');
    resetFeatureEngineeringForm();
}

// Reset feature engineering form
function resetFeatureEngineeringForm() {
    document.getElementById('featureEngineeringDataset').value = '';
    document.getElementById('featureEngineeringConfig').innerHTML = '';
    document.getElementById('featureEngineeringPreview').classList.add('hidden');
    document.getElementById('featureEngineeringColumnStats').classList.add('hidden');
    document.getElementById('previewFeatureEngineeringBtn').classList.add('hidden');
    document.getElementById('executeFeatureEngineeringBtn').classList.add('hidden');
    document.getElementById('featureEngineeringStatus').textContent = 'Select an operation to begin';
    currentFeatureEngineeringOperation = null;
    currentFeatureEngineeringDatasetColumns = [];
    currentFeatureEngineeringColumnStats = {};
}

// Select feature engineering operation
function selectFeatureEngineeringOperation(operation) {
    currentFeatureEngineeringOperation = operation;
    
    // Update UI
    document.querySelectorAll('.feature-eng-op-btn').forEach(btn => {
        btn.classList.remove('border-indigo-500', 'bg-indigo-50');
        if (btn.getAttribute('data-operation') === operation) {
            btn.classList.add('border-indigo-500', 'bg-indigo-50');
        }
    });
    
    // Show operation-specific configuration
    renderFeatureEngineeringConfig(operation);
    
    // Update status
    document.getElementById('featureEngineeringStatus').textContent = `Configure ${getFeatureEngineeringOperationName(operation)}`;
    document.getElementById('featureEngineeringModalTitle').textContent = `${getFeatureEngineeringOperationName(operation)} - Feature Engineering`;
    
    // Show action buttons if dataset is selected
    if (document.getElementById('featureEngineeringDataset').value) {
        document.getElementById('previewFeatureEngineeringBtn').classList.remove('hidden');
        document.getElementById('executeFeatureEngineeringBtn').classList.remove('hidden');
    }
}

// Render operation-specific configuration
function renderFeatureEngineeringConfig(operation) {
    const configContainer = document.getElementById('featureEngineeringConfig');
    
    switch(operation) {
        case 'calculated_columns':
            configContainer.innerHTML = `
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Calculated Columns</label>
                        <div id="calculatedColumns" class="space-y-3">
                            <div class="text-sm text-gray-500">Create new columns using expressions</div>
                        </div>
                        <button id="addCalculatedColumn" class="mt-2 text-sm text-indigo-600 hover:text-indigo-800">
                            <i class="fas fa-plus mr-1"></i> Add Calculated Column
                        </button>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-start">
                            <i class="fas fa-info-circle text-blue-500 mt-1 mr-3"></i>
                            <div class="text-sm text-blue-700">
                                <strong>Expression Examples:</strong><br>
                                 <code>column1 + column2</code> - Add two columns<br>
                                 <code>column1 * 100</code> - Multiply by constant<br>
                                 <code>column1 > 50</code> - Boolean condition<br>
                                 <code>np.log(column1)</code> - Use numpy functions
                            </div>
                        </div>
                    </div>
                </div>
            `;
            break;
            
        case 'datetime_extraction':
            configContainer.innerHTML = `
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date/Time Columns</label>
                        <div id="datetimeColumns" class="space-y-3">
                            <div class="text-sm text-gray-500">Select datetime columns and components to extract</div>
                        </div>
                        <button id="addDatetimeColumn" class="mt-2 text-sm text-indigo-600 hover:text-indigo-800">
                            <i class="fas fa-plus mr-1"></i> Add Datetime Column
                        </button>
                    </div>
                </div>
            `;
            break;
            
        case 'text_processing':
            configContainer.innerHTML = `
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Text Columns</label>
                        <div id="textColumns" class="space-y-3">
                            <div class="text-sm text-gray-500">Select text columns and processing operations</div>
                        </div>
                        <button id="addTextColumn" class="mt-2 text-sm text-indigo-600 hover:text-indigo-800">
                            <i class="fas fa-plus mr-1"></i> Add Text Column
                        </button>
                    </div>
                </div>
            `;
            break;
            
        case 'one_hot_encoding':
            configContainer.innerHTML = `
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Categorical Columns</label>
                        <div id="categoricalColumns" class="space-y-2 max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-3">
                            <div class="text-sm text-gray-500">Select categorical columns to encode</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Encoding Options</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" id="dropFirst" class="mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="text-sm">Drop first category (avoid multicollinearity)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="usePrefix" class="mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked>
                                    <span class="text-sm">Use column name prefixes</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <div class="flex items-start">
                                <i class="fas fa-exclamation-triangle text-yellow-500 mt-1 mr-3"></i>
                                <div class="text-sm text-yellow-700">
                                    <strong>Note:</strong> One-hot encoding will create new binary columns for each unique category. This can significantly increase dataset size.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            break;
    }
    
    // Add event listeners for dynamic sections
    addFeatureEngineeringConfigEventListeners(operation);
}

// Add event listeners for feature engineering configuration
function addFeatureEngineeringConfigEventListeners(operation) {
    switch(operation) {
        case 'calculated_columns':
            document.getElementById('addCalculatedColumn').addEventListener('click', addCalculatedColumn);
            break;
        case 'datetime_extraction':
            document.getElementById('addDatetimeColumn').addEventListener('click', addDatetimeColumn);
            break;
        case 'text_processing':
            document.getElementById('addTextColumn').addEventListener('click', addTextColumn);
            break;
        case 'one_hot_encoding':
            updateCategoricalColumnOptions();
            break;
    }
}

// Load dataset columns for feature engineering
async function loadDatasetColumnsForFeatureEngineering(datasetId) {
    if (!datasetId) {
        currentFeatureEngineeringDatasetColumns = [];
        updateFeatureEngineeringColumnLists();
        return;
    }
    
    try {
        showToast('Loading dataset columns...', 'info');
        
        const response = await fetch(`/api/assistant/api/dataset/${datasetId}/columns/`, {
            method: "GET",
            headers: {
                "X-CSRFToken": getCsrfToken(),
                "Content-Type": "application/json"
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            currentFeatureEngineeringDatasetColumns = result.columns;
            
            updateFeatureEngineeringColumnLists();
            showToast('Dataset columns loaded', 'success');
            
            // Show column statistics
            document.getElementById('featureEngineeringColumnStats').classList.remove('hidden');
            
            // Show action buttons
            if (currentFeatureEngineeringOperation) {
                document.getElementById('previewFeatureEngineeringBtn').classList.remove('hidden');
                document.getElementById('executeFeatureEngineeringBtn').classList.remove('hidden');
            }
            
        } else {
            throw new Error('Failed to load columns');
        }
        
    } catch (error) {
        console.error('Error loading columns:', error);
        showToast('Error loading dataset columns', 'error');
    }
}

// Load column statistics for feature engineering
async function loadFeatureEngineeringColumnStatistics(datasetId) {
    try {
        const response = await fetch('/api/assistant/api/aggregation/statistics/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ dataset_id: datasetId })
        });
        
        if (response.ok) {
            const result = await response.json();
            currentFeatureEngineeringColumnStats = result.statistics;
            displayFeatureEngineeringColumnStatistics();
        }
    } catch (error) {
        console.error('Error loading statistics:', error);
    }
}

// Display column statistics for feature engineering
function displayFeatureEngineeringColumnStatistics() {
    const container = document.getElementById('featureEngineeringStatsContainer');
    container.innerHTML = '';
    
    Object.entries(currentFeatureEngineeringColumnStats).forEach(([column, stats]) => {
        const card = document.createElement('div');
        card.className = 'bg-white border border-gray-200 rounded-lg p-3';
        card.innerHTML = `
            <div class="font-medium text-sm text-gray-800 mb-2">${column}</div>
            <div class="text-xs space-y-1">
                <div class="flex justify-between">
                    <span class="text-gray-500">Type:</span>
                    <span class="font-medium">${stats.dtype}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">Non-null:</span>
                    <span class="font-medium">${stats.non_null_count}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">Unique:</span>
                    <span class="font-medium">${stats.unique_count}</span>
                </div>
                ${stats.mean !== undefined ? `
                    <div class="flex justify-between">
                        <span class="text-gray-500">Mean:</span>
                        <span class="font-medium">${stats.mean?.toFixed(2) || 'N/A'}</span>
                    </div>
                ` : ''}
            </div>
        `;
        container.appendChild(card);
    });
}

// Update column lists in feature engineering configuration
function updateFeatureEngineeringColumnLists() {
    if (!currentFeatureEngineeringOperation || currentFeatureEngineeringDatasetColumns.length === 0) return;
    
    switch(currentFeatureEngineeringOperation) {
        case 'one_hot_encoding':
            updateCategoricalColumnOptions();
            break;
    }
}

// Update categorical column options for one-hot encoding
function updateCategoricalColumnOptions() {
    const container = document.getElementById('categoricalColumns');
    if (!container) return;
    
    container.innerHTML = '';
    
    // Find categorical columns (object dtype or low cardinality numeric)
    const categoricalColumns = currentFeatureEngineeringDatasetColumns.filter(col => {
        const stats = currentFeatureEngineeringColumnStats[col];
        if (!stats) return false;
        
        return stats.dtype === 'object' || 
               (stats.dtype.includes('int') && stats.unique_count <= 10) ||
               (stats.dtype.includes('float') && stats.unique_count <= 10);
    });
    
    if (categoricalColumns.length === 0) {
        container.innerHTML = '<div class="text-sm text-gray-500">No categorical columns found (object dtype or low cardinality)</div>';
        return;
    }
    
    categoricalColumns.forEach(column => {
        const stats = currentFeatureEngineeringColumnStats[column];
        const div = document.createElement('div');
        div.className = 'flex items-center';
        div.innerHTML = `
            <input type="checkbox" id="cat_${column}" value="${column}" class="mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
            <label for="cat_${column}" class="text-sm text-gray-700">${column}</label>
            <span class="ml-2 text-xs text-gray-400">(${stats.unique_count} unique)</span>
        `;
        container.appendChild(div);
    });
}

// Add calculated column
function addCalculatedColumn() {
    const container = document.getElementById('calculatedColumns');
    const id = Date.now();
    
    const div = document.createElement('div');
    div.className = 'border border-gray-200 rounded-lg p-4';
    div.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">New Column Name</label>
                <input type="text" class="calc-col-name w-full border border-gray-300 rounded px-2 py-1 text-sm" placeholder="new_column">
            </div>
            <div class="md:col-span-2">
                <label class="block text-xs font-medium text-gray-700 mb-1">Expression</label>
                <input type="text" class="calc-expression w-full border border-gray-300 rounded px-2 py-1 text-sm" placeholder="column1 + column2">
            </div>
        </div>
        <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Data Type</label>
                <select class="calc-data-type w-full border border-gray-300 rounded px-2 py-1 text-sm">
                    <option value="auto">Auto-detect</option>
                    <option value="int">Integer</option>
                    <option value="float">Float</option>
                    <option value="string">String</option>
                    <option value="boolean">Boolean</option>
                </select>
            </div>
            <div class="flex items-end">
                <button class="remove-calc-column text-red-600 hover:text-red-800 text-sm w-full py-1">
                    <i class="fas fa-times mr-1"></i> Remove
                </button>
            </div>
        </div>
        <div class="mt-2 text-xs text-gray-500">
            Available columns: ${currentFeatureEngineeringDatasetColumns.join(', ')}
        </div>
    `;
    container.appendChild(div);
    
    // Add remove event listener
    div.querySelector('.remove-calc-column').addEventListener('click', function() {
        div.remove();
    });
}

// Add datetime column
function addDatetimeColumn() {
    const container = document.getElementById('datetimeColumns');
    const id = Date.now();
    
    const div = document.createElement('div');
    div.className = 'border border-gray-200 rounded-lg p-4';
    div.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 items-end">
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Source Column</label>
                <select class="datetime-source-col w-full border border-gray-300 rounded px-2 py-1 text-sm">
                    <option value="">Select datetime column</option>
                    ${currentFeatureEngineeringDatasetColumns.map(col => 
                        `<option value="${col}">${col}</option>`
                    ).join('')}
                </select>
            </div>
            <div>
                <button class="remove-datetime-column text-red-600 hover:text-red-800 text-sm w-full py-1">
                    <i class="fas fa-times mr-1"></i> Remove
                </button>
            </div>
        </div>
        
        <div class="mt-3">
            <label class="block text-xs font-medium text-gray-700 mb-2">Extract Components</label>
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2" id="datetimeExtractions_${id}">
                <!-- Extractions will be added here -->
            </div>
            <button class="add-datetime-extraction mt-2 text-xs text-indigo-600 hover:text-indigo-800" data-container="datetimeExtractions_${id}">
                <i class="fas fa-plus mr-1"></i> Add Extraction
            </button>
        </div>
    `;
    container.appendChild(div);
    
    // Add event listeners
    div.querySelector('.remove-datetime-column').addEventListener('click', function() {
        div.remove();
    });
    
    div.querySelector('.add-datetime-extraction').addEventListener('click', function() {
        const containerId = this.getAttribute('data-container');
        addDatetimeExtraction(containerId);
    });
    
    // Add one default extraction
    addDatetimeExtraction(`datetimeExtractions_${id}`);
}

// Add datetime extraction
function addDatetimeExtraction(containerId) {
    const container = document.getElementById(containerId);
    const extractionId = Date.now();
    
    const div = document.createElement('div');
    div.className = 'border border-gray-200 rounded p-2';
    div.innerHTML = `
        <div class="space-y-1">
            <select class="datetime-component w-full border border-gray-300 rounded px-1 py-1 text-xs">
                <option value="year">Year</option>
                <option value="month">Month</option>
                <option value="day">Day</option>
                <option value="hour">Hour</option>
                <option value="minute">Minute</option>
                <option value="second">Second</option>
                <option value="quarter">Quarter</option>
                <option value="dayofweek">Day of Week</option>
                <option value="dayofyear">Day of Year</option>
                <option value="week">Week</option>
                <option value="is_weekend">Is Weekend</option>
                <option value="month_name">Month Name</option>
                <option value="day_name">Day Name</option>
            </select>
            <input type="text" class="datetime-new-col w-full border border-gray-300 rounded px-1 py-1 text-xs" placeholder="auto">
            <button class="remove-datetime-extraction text-red-600 hover:text-red-800 text-xs w-full">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    container.appendChild(div);
    
    // Add event listeners
    const componentSelect = div.querySelector('.datetime-component');
    const newColInput = div.querySelector('.datetime-new-col');
    
    componentSelect.addEventListener('change', function() {
        const sourceSelect = div.closest('.border').querySelector('.datetime-source-col');
        const sourceCol = sourceSelect ? sourceSelect.value : 'datetime';
        newColInput.value = `${sourceCol}_${this.value}`;
    });
    
    div.querySelector('.remove-datetime-extraction').addEventListener('click', function() {
        div.remove();
    });
}

// Add text column
function addTextColumn() {
    const container = document.getElementById('textColumns');
    const id = Date.now();
    
    const div = document.createElement('div');
    div.className = 'border border-gray-200 rounded-lg p-4';
    div.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 items-end">
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Source Column</label>
                <select class="text-source-col w-full border border-gray-300 rounded px-2 py-1 text-sm">
                    <option value="">Select text column</option>
                    ${currentFeatureEngineeringDatasetColumns.map(col => 
                        `<option value="${col}">${col}</option>`
                    ).join('')}
                </select>
            </div>
            <div>
                <button class="remove-text-column text-red-600 hover:text-red-800 text-sm w-full py-1">
                    <i class="fas fa-times mr-1"></i> Remove
                </button>
            </div>
        </div>
        
        <div class="mt-3">
            <label class="block text-xs font-medium text-gray-700 mb-2">Text Operations</label>
            <div class="space-y-2" id="textOperations_${id}">
                <!-- Operations will be added here -->
            </div>
            <button class="add-text-operation mt-2 text-xs text-indigo-600 hover:text-indigo-800" data-container="textOperations_${id}">
                <i class="fas fa-plus mr-1"></i> Add Operation
            </button>
        </div>
    `;
    container.appendChild(div);
    
    // Add event listeners
    div.querySelector('.remove-text-column').addEventListener('click', function() {
        div.remove();
    });
    
    div.querySelector('.add-text-operation').addEventListener('click', function() {
        const containerId = this.getAttribute('data-container');
        addTextOperation(containerId);
    });
    
    // Add one default operation
    addTextOperation(`textOperations_${id}`);
}

// Add text operation
function addTextOperation(containerId) {
    const container = document.getElementById(containerId);
    const operationId = Date.now();
    
    const div = document.createElement('div');
    div.className = 'border border-gray-200 rounded p-3';
    div.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-end">
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Operation</label>
                <select class="text-operation-type w-full border border-gray-300 rounded px-2 py-1 text-sm">
                    <option value="lowercase">Lowercase</option>
                    <option value="uppercase">Uppercase</option>
                    <option value="title_case">Title Case</option>
                    <option value="capitalize">Capitalize</option>
                    <option value="strip">Strip Whitespace</option>
                    <option value="remove_extra_spaces">Remove Extra Spaces</option>
                    <option value="remove_special_chars">Remove Special Chars</option>
                    <option value="extract_numbers">Extract Numbers</option>
                    <option value="extract_letters">Extract Letters</option>
                    <option value="word_count">Word Count</option>
                    <option value="character_count">Character Count</option>
                    <option value="replace_text">Replace Text</option>
                    <option value="substring">Substring</option>
                </select>
            </div>
            <div class="text-operation-params">
                <!-- Parameters will be dynamically added here -->
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">New Column</label>
                <input type="text" class="text-new-col w-full border border-gray-300 rounded px-2 py-1 text-sm" placeholder="auto">
            </div>
        </div>
        <div class="mt-2 flex justify-end">
            <button class="remove-text-operation text-red-600 hover:text-red-800 text-xs">
                <i class="fas fa-times mr-1"></i> Remove
            </button>
        </div>
    `;
    container.appendChild(div);
    
    // Add event listeners
    const operationSelect = div.querySelector('.text-operation-type');
    const paramsContainer = div.querySelector('.text-operation-params');
    const newColInput = div.querySelector('.text-new-col');
    
    function updateTextOperationParams() {
        const opType = operationSelect.value;
        let paramsHTML = '';
        
        if (opType === 'replace_text') {
            paramsHTML = `
                <div class="space-y-1">
                    <label class="block text-xs font-medium text-gray-700">Old Text</label>
                    <input type="text" class="text-old-text w-full border border-gray-300 rounded px-2 py-1 text-sm" placeholder="old text">
                    <label class="block text-xs font-medium text-gray-700">New Text</label>
                    <input type="text" class="text-new-text w-full border border-gray-300 rounded px-2 py-1 text-sm" placeholder="new text">
                </div>
            `;
        } else if (opType === 'substring') {
            paramsHTML = `
                <div class="space-y-1">
                    <label class="block text-xs font-medium text-gray-700">Start</label>
                    <input type="number" class="text-start-pos w-full border border-gray-300 rounded px-2 py-1 text-sm" value="0" min="0">
                    <label class="block text-xs font-medium text-gray-700">End</label>
                    <input type="number" class="text-end-pos w-full border border-gray-300 rounded px-2 py-1 text-sm" placeholder="optional">
                </div>
            `;
        } else {
            paramsHTML = '<div class="h-10"></div>'; // Empty space for alignment
        }
        
        paramsContainer.innerHTML = paramsHTML;
        
        // Update new column name
        const sourceSelect = div.closest('.border').querySelector('.text-source-col');
        const sourceCol = sourceSelect ? sourceSelect.value : 'text';
        newColInput.value = `${sourceCol}_${opType}`;
    }
    
    operationSelect.addEventListener('change', updateTextOperationParams);
    div.querySelector('.remove-text-operation').addEventListener('click', function() {
        div.remove();
    });
    
    updateTextOperationParams();
}

// Preview feature engineering operation
async function previewFeatureEngineeringOperation() {
    const datasetId = document.getElementById('featureEngineeringDataset').value;
    if (!datasetId || !currentFeatureEngineeringOperation) {
        showToast('Please select a dataset and operation', 'error');
        return;
    }
    
    try {
        showToast('Generating preview...', 'info');
        document.getElementById('featureEngineeringStatus').textContent = 'Generating preview...';
        
        let operationParams;
        try {
            operationParams = getFeatureEngineeringParameters();
        } catch (paramError) {
            showToast(`Configuration error: ${paramError.message}`, 'error');
            document.getElementById('featureEngineeringStatus').textContent = 'Configuration error';
            return;
        }
        
        const requestData = {
            dataset_id: datasetId,
            preview_only: true,
            operation_type: currentFeatureEngineeringOperation,
            ...operationParams
        };
        
        const response = await fetch('/api/assistant/api/feature-engineering/preview/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        if (response.ok) {
            const result = await response.json();
            displayFeatureEngineeringPreview(result);
            document.getElementById('featureEngineeringStatus').textContent = 'Preview ready';
            showToast('Preview generated', 'success');
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to generate preview');
        }
        
    } catch (error) {
        console.error('Error previewing operation:', error);
        showToast(`Error: ${error.message}`, 'error');
        document.getElementById('featureEngineeringStatus').textContent = 'Error generating preview';
    }
}

// Get feature engineering parameters based on current operation
function getFeatureEngineeringParameters() {
    const params = {};
    
    switch(currentFeatureEngineeringOperation) {
        case 'calculated_columns':
            params.calculated_columns = [];
            document.querySelectorAll('#calculatedColumns > div').forEach(calcDiv => {
                const colName = calcDiv.querySelector('.calc-col-name')?.value;
                const expression = calcDiv.querySelector('.calc-expression')?.value;
                const dataType = calcDiv.querySelector('.calc-data-type')?.value;
                
                if (colName && expression) {
                    params.calculated_columns.push({
                        column_name: colName,
                        expression: expression,
                        data_type: dataType || 'auto'
                    });
                }
            });
            
            if (params.calculated_columns.length === 0) {
                showToast('Please add at least one calculated column', 'error');
                throw new Error('Calculated columns required');
            }
            break;
            
        case 'datetime_extraction':
            params.datetime_columns = [];
            document.querySelectorAll('#datetimeColumns > div').forEach(dtDiv => {
                const sourceCol = dtDiv.querySelector('.datetime-source-col')?.value;
                const extractions = [];
                
                if (sourceCol) {
                    const extractionContainer = dtDiv.querySelector('[id^="datetimeExtractions_"]');
                    if (extractionContainer) {
                        extractionContainer.querySelectorAll('> div').forEach(extDiv => {
                            const component = extDiv.querySelector('.datetime-component')?.value;
                            const newCol = extDiv.querySelector('.datetime-new-col')?.value;
                            
                            if (component) {
                                extractions.push({
                                    component: component,
                                    new_column_name: newCol || `${sourceCol}_${component}`
                                });
                            }
                        });
                    }
                    
                    if (extractions.length > 0) {
                        params.datetime_columns.push({
                            source_column: sourceCol,
                            extractions: extractions
                        });
                    }
                }
            });
            
            if (params.datetime_columns.length === 0) {
                showToast('Please add at least one datetime column with extractions', 'error');
                throw new Error('Datetime columns required');
            }
            break;
            
        case 'text_processing':
            params.text_columns = [];
            document.querySelectorAll('#textColumns > div').forEach(textDiv => {
                const sourceCol = textDiv.querySelector('.text-source-col')?.value;
                const operations = [];
                
                if (sourceCol) {
                    const operationContainer = textDiv.querySelector('[id^="textOperations_"]');
                    if (operationContainer) {
                        operationContainer.querySelectorAll('> div').forEach(opDiv => {
                            const opType = opDiv.querySelector('.text-operation-type')?.value;
                            const newCol = opDiv.querySelector('.text-new-col')?.value;
                            
                            if (opType) {
                                const operation = {
                                    type: opType,
                                    new_column_name: newCol || `${sourceCol}_${opType}`
                                };
                                
                                // Add operation-specific parameters
                                if (opType === 'replace_text') {
                                    const oldText = opDiv.querySelector('.text-old-text')?.value;
                                    const newText = opDiv.querySelector('.text-new-text')?.value;
                                    if (oldText !== undefined) operation.old_text = oldText;
                                    if (newText !== undefined) operation.new_text = newText;
                                } else if (opType === 'substring') {
                                    const start = opDiv.querySelector('.text-start-pos')?.value;
                                    const end = opDiv.querySelector('.text-end-pos')?.value;
                                    if (start !== undefined) operation.start = parseInt(start);
                                    if (end) operation.end = parseInt(end);
                                }
                                
                                operations.push(operation);
                            }
                        });
                    }
                    
                    if (operations.length > 0) {
                        params.text_columns.push({
                            source_column: sourceCol,
                            operations: operations
                        });
                    }
                }
            });
            
            if (params.text_columns.length === 0) {
                showToast('Please add at least one text column with operations', 'error');
                throw new Error('Text columns required');
            }
            break;
            
    case 'one_hot_encoding':
    const dropFirst = document.getElementById('dropFirst')?.checked || false;
    const usePrefix = document.getElementById('usePrefix')?.checked !== false; // Default true

    params.categorical_columns = Array.from(document.querySelectorAll('#categoricalColumns input:checked'))
        .map(cb => cb.value);
    params.drop_first = dropFirst;
    params.prefix = usePrefix; // This should be boolean true/false
    
    if (params.categorical_columns.length === 0) {
        showToast('Please select at least one categorical column', 'error');
        throw new Error('Categorical columns required');
    }
    break;
    }
    
    return params;
}

// Display feature engineering preview
function displayFeatureEngineeringPreview(result) {
    const previewSection = document.getElementById('featureEngineeringPreview');
    const headersContainer = document.getElementById('featureEngineeringPreviewHeaders');
    const bodyContainer = document.getElementById('featureEngineeringPreviewBody');
    const previewInfo = document.getElementById('featureEngineeringPreviewInfo');
    
    // Show preview section
    previewSection.classList.remove('hidden');
    
    // Update preview info
    let infoText = `Preview: ${result.preview_data.length} rows`;
    if (result.original_stats) {
        infoText += ` | Original: ${result.original_stats.total_rows} rows`;
    }
    if (result.result_stats) {
        infoText += ` | Result: ${result.result_stats.total_rows} rows`;
        if (result.result_stats.new_columns_added) {
            infoText += ` | New columns: ${result.result_stats.new_columns_added}`;
        }
    }
    previewInfo.textContent = infoText;
    
    // Create headers
    headersContainer.innerHTML = '';
    result.columns.forEach(column => {
        const th = document.createElement('th');
        th.className = 'px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
        th.textContent = column;
        headersContainer.appendChild(th);
    });
    
    // Create rows
    bodyContainer.innerHTML = '';
    result.preview_data.forEach(row => {
        const tr = document.createElement('tr');
        result.columns.forEach(column => {
            const td = document.createElement('td');
            td.className = 'px-4 py-2 whitespace-nowrap text-sm text-gray-900 border-t';
            const value = row[column];
            td.textContent = value !== null && value !== undefined ? 
                (typeof value === 'object' ? JSON.stringify(value) : String(value)) : 
                'NULL';
            tr.appendChild(td);
        });
        bodyContainer.appendChild(tr);
    });
}

// Execute feature engineering operation
async function executeFeatureEngineeringOperation() {
    const datasetId = document.getElementById('featureEngineeringDataset').value;
    if (!datasetId || !currentFeatureEngineeringOperation) {
        showToast('Please select a dataset and operation', 'error');
        return;
    }
    
    try {
        showToast('Executing operation...', 'info');
        document.getElementById('featureEngineeringStatus').textContent = 'Executing...';
        document.getElementById('executeFeatureEngineeringBtn').disabled = true;
        
        let operationParams;
        try {
            operationParams = getFeatureEngineeringParameters();
        } catch (paramError) {
            showToast(`Configuration error: ${paramError.message}`, 'error');
            document.getElementById('featureEngineeringStatus').textContent = 'Configuration error';
            document.getElementById('executeFeatureEngineeringBtn').disabled = false;
            return;
        }
        
        const requestData = {
            dataset_id: datasetId,
            operation_type: currentFeatureEngineeringOperation,
            ...operationParams
        };
        
        const response = await fetch('/api/assistant/api/feature-engineering/execute/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        if (response.ok) {
            const result = await response.json();
            
            // Add to pipeline
            const step = {
                name: getFeatureEngineeringOperationName(currentFeatureEngineeringOperation),
                type: 'feature_engineering',
                operation: currentFeatureEngineeringOperation,
                description: getFeatureEngineeringOperationDescription(currentFeatureEngineeringOperation),
                details: `Added ${result.result_stats?.new_columns_added || 'unknown'} new columns`
            };
            
            addPipelineStep(step);
            
            showToast('Feature engineering completed successfully!', 'success');
            closeFeatureEngineeringModal();
            
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to execute operation');
        }
        
    } catch (error) {
        console.error('Error executing operation:', error);
        showToast(`Error: ${error.message}`, 'error');
        document.getElementById('featureEngineeringStatus').textContent = 'Error executing operation';
    } finally {
        document.getElementById('executeFeatureEngineeringBtn').disabled = false;
    }
}

// Helper functions
function getFeatureEngineeringOperationName(operation) {
    const names = {
        'calculated_columns': 'Calculated Columns',
        'datetime_extraction': 'Date/Time Extraction',
        'text_processing': 'Text Processing',
        'one_hot_encoding': 'One-Hot Encoding'
    };
    return names[operation] || operation;
}

function getFeatureEngineeringOperationDescription(operation) {
    const descriptions = {
        'calculated_columns': 'Create new columns using mathematical expressions',
        'datetime_extraction': 'Extract components from datetime columns',
        'text_processing': 'Transform and extract features from text columns',
        'one_hot_encoding': 'Convert categorical variables to binary columns'
    };
    return descriptions[operation] || 'Apply feature engineering';
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeFeatureEngineering();
});
</script>


<!-- ML Preparation Modal -->
<div id="mlPreparationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg w-full max-w-6xl mx-4 max-h-[90vh] overflow-hidden flex flex-col">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold text-gray-800" id="mlPreparationModalTitle">ML Data Preparation</h3>
            <button id="closeMLPreparationModal" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6">
            <!-- Operation Selection -->
            <div id="mlPreparationOperationSelection" class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">Select ML Preparation Operation</label>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <button class="ml-prep-op-btn p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 text-left" data-operation="train_test_split">
                        <div class="font-medium text-sm">Train-Test Split</div>
                        <div class="text-xs text-gray-500">Split data for training and testing</div>
                    </button>
                    <button class="ml-prep-op-btn p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 text-left" data-operation="feature_scaling">
                        <div class="font-medium text-sm">Feature Scaling</div>
                        <div class="text-xs text-gray-500">Scale numeric features</div>
                    </button>
                    <button class="ml-prep-op-btn p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 text-left" data-operation="outlier_detection">
                        <div class="font-medium text-sm">Outlier Detection</div>
                        <div class="text-xs text-gray-500">Detect and handle outliers</div>
                    </button>
                    <button class="ml-prep-op-btn p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 text-left" data-operation="cross_validation">
                        <div class="font-medium text-sm">Cross-Validation</div>
                        <div class="text-xs text-gray-500">Evaluate model performance</div>
                    </button>
                </div>
            </div>
            
            <!-- Dataset Selection -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Dataset</label>
                <select id="mlPreparationDataset" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">Select a dataset</option>
                    {% for dataset in datasets %}
                    <option value="{{ dataset.id }}">{{ dataset.file_name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Column Statistics -->
            <div id="mlPreparationColumnStats" class="mb-6 hidden">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-medium text-gray-800">Column Statistics</h4>
                    <button id="refreshMLPreparationStats" class="text-sm text-indigo-600 hover:text-indigo-800">
                        <i class="fas fa-sync-alt mr-1"></i> Refresh
                    </button>
                </div>
                <div id="mlPreparationStatsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-64 overflow-y-auto p-3 border border-gray-200 rounded-lg">
                    <!-- Statistics will be loaded here -->
                </div>
            </div>
            
            <!-- Operation Configuration -->
            <div id="mlPreparationConfig"></div>
            
            <!-- Preview Section -->
            <div id="mlPreparationPreview" class="hidden mt-6">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-medium text-gray-800">Preview</h4>
                    <button id="refreshMLPreparationPreview" class="text-sm text-indigo-600 hover:text-indigo-800">
                        <i class="fas fa-sync-alt mr-1"></i> Refresh Preview
                    </button>
                </div>
                <div class="border border-gray-200 rounded-lg overflow-hidden">
                    <div class="bg-gray-50 px-4 py-2 border-b border-gray-200">
                        <div class="text-sm text-gray-600" id="mlPreparationPreviewInfo">Preview: 20 rows</div>
                    </div>
                    <div class="overflow-x-auto max-h-64">
                        <table class="min-w-full divide-y divide-gray-200" id="mlPreparationPreviewTable">
                            <thead class="bg-gray-50">
                                <tr id="mlPreparationPreviewHeaders"></tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="mlPreparationPreviewBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- CV Results Section (for cross-validation) -->
            <div id="cvResultsSection" class="hidden mt-6">
                <h4 class="font-medium text-gray-800 mb-3">Cross-Validation Results</h4>
                <div id="cvResultsContainer" class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                    <!-- CV results will be displayed here -->
                </div>
            </div>
        </div>
        
        <div class="p-4 border-t border-gray-200 bg-gray-50 flex justify-between items-center">
            <div class="text-sm text-gray-600" id="mlPreparationStatus">Select an operation to begin</div>
            <div class="flex space-x-3">
                <button id="previewMLPreparationBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 hidden">
                    Preview
                </button>
                <button id="executeMLPreparationBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 hidden">
                    Execute Operation
                </button>
            </div>
        </div>
    </div>
</div>
<script>
    // ML Preparation Functionality
let currentMLPreparationOperation = null;
let currentMLPreparationDatasetColumns = [];
let currentMLPreparationColumnStats = {};

// Initialize ML preparation functionality
function initializeMLPreparation() {
    // ML preparation operation buttons
    document.querySelectorAll('.transform-operation[data-type="ml"]').forEach(button => {
        button.addEventListener('click', function() {
            const operation = this.getAttribute('data-operation');
            openMLPreparationModal(operation);
        });
    });
    
    // Modal events
    document.getElementById('closeMLPreparationModal').addEventListener('click', closeMLPreparationModal);
    document.getElementById('mlPreparationModal').addEventListener('click', function(e) {
        if (e.target === this) closeMLPreparationModal();
    });
    
    // Dataset selection
    document.getElementById('mlPreparationDataset').addEventListener('change', function() {
        if (this.value) {
            loadDatasetColumnsForMLPreparation(this.value);
            loadMLPreparationColumnStatistics(this.value);
        } else {
            currentMLPreparationDatasetColumns = [];
            currentMLPreparationColumnStats = {};
            document.getElementById('mlPreparationColumnStats').classList.add('hidden');
        }
    });
    
    // Operation selection
    document.querySelectorAll('.ml-prep-op-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const operation = this.getAttribute('data-operation');
            selectMLPreparationOperation(operation);
        });
    });
    
    // Action buttons
    document.getElementById('previewMLPreparationBtn').addEventListener('click', previewMLPreparationOperation);
    document.getElementById('executeMLPreparationBtn').addEventListener('click', executeMLPreparationOperation);
    document.getElementById('refreshMLPreparationPreview').addEventListener('click', previewMLPreparationOperation);
    document.getElementById('refreshMLPreparationStats').addEventListener('click', function() {
        const datasetId = document.getElementById('mlPreparationDataset').value;
        if (datasetId) loadMLPreparationColumnStatistics(datasetId);
    });
}

// Open ML preparation modal
function openMLPreparationModal(operation) {
    const modal = document.getElementById('mlPreparationModal');
    modal.classList.remove('hidden');
    
    if (operation) {
        // Map the operation names from the button to the backend
        const operationMap = {
            'split': 'train_test_split',
            'scale': 'feature_scaling',
            'outlier': 'outlier_detection',
            'crossval': 'cross_validation'
        };
        
        selectMLPreparationOperation(operationMap[operation] || operation);
    }
}

// Close ML preparation modal
function closeMLPreparationModal() {
    document.getElementById('mlPreparationModal').classList.add('hidden');
    resetMLPreparationForm();
}

// Reset ML preparation form
function resetMLPreparationForm() {
    document.getElementById('mlPreparationDataset').value = '';
    document.getElementById('mlPreparationConfig').innerHTML = '';
    document.getElementById('mlPreparationPreview').classList.add('hidden');
    document.getElementById('mlPreparationColumnStats').classList.add('hidden');
    document.getElementById('cvResultsSection').classList.add('hidden');
    document.getElementById('previewMLPreparationBtn').classList.add('hidden');
    document.getElementById('executeMLPreparationBtn').classList.add('hidden');
    document.getElementById('mlPreparationStatus').textContent = 'Select an operation to begin';
    currentMLPreparationOperation = null;
    currentMLPreparationDatasetColumns = [];
    currentMLPreparationColumnStats = {};
}

// Select ML preparation operation
function selectMLPreparationOperation(operation) {
    currentMLPreparationOperation = operation;
    
    // Update UI
    document.querySelectorAll('.ml-prep-op-btn').forEach(btn => {
        btn.classList.remove('border-indigo-500', 'bg-indigo-50');
        if (btn.getAttribute('data-operation') === operation) {
            btn.classList.add('border-indigo-500', 'bg-indigo-50');
        }
    });
    
    // Show operation-specific configuration
    renderMLPreparationConfig(operation);
    
    // Update status
    document.getElementById('mlPreparationStatus').textContent = `Configure ${getMLPreparationOperationName(operation)}`;
    document.getElementById('mlPreparationModalTitle').textContent = `${getMLPreparationOperationName(operation)} - ML Preparation`;
    
    // Show action buttons if dataset is selected
    if (document.getElementById('mlPreparationDataset').value) {
        document.getElementById('previewMLPreparationBtn').classList.remove('hidden');
        document.getElementById('executeMLPreparationBtn').classList.remove('hidden');
    }
}

// Render operation-specific configuration
function renderMLPreparationConfig(operation) {
    const configContainer = document.getElementById('mlPreparationConfig');
    
    switch(operation) {
        case 'train_test_split':
            configContainer.innerHTML = `
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Target Column (Optional)</label>
                        <select id="targetColumn" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                            <option value="">No target column (unsupervised)</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Select target variable for supervised learning. Leave empty for unsupervised tasks.</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Test Size</label>
                            <div class="flex items-center space-x-2">
                                <input type="range" id="testSize" min="0.1" max="0.5" step="0.05" value="0.2" class="w-full">
                                <span id="testSizeValue" class="text-sm font-medium w-12">20%</span>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Random State</label>
                            <input type="number" id="randomState" value="42" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" id="shuffleData" class="mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked>
                                <span class="text-sm text-gray-700">Shuffle data before splitting</span>
                            </label>
                        </div>
                        
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" id="stratifySplit" class="mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                <span class="text-sm text-gray-700">Stratify by target</span>
                            </label>
                        </div>
                    </div>
                </div>
            `;
            break;
            
        case 'feature_scaling':
            configContainer.innerHTML = `
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Scaling Method</label>
                        <select id="scalingMethod" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                            <option value="standard">Standard Scaler (mean=0, std=1)</option>
                            <option value="minmax">Min-Max Scaler (range 0-1)</option>
                            <option value="robust">Robust Scaler (IQR-based)</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Numeric Columns to Scale</label>
                        <div class="text-sm text-gray-500 mb-2">All numeric columns will be scaled by default</div>
                        <div id="numericColumnsList" class="max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-3">
                            <!-- Numeric columns will be listed here -->
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Columns to Exclude</label>
                        <input type="text" id="excludeColumns" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm" placeholder="column1, column2, ...">
                        <p class="text-xs text-gray-500 mt-1">Comma-separated list of columns to exclude from scaling</p>
                    </div>
                </div>
            `;
            break;
            
        case 'outlier_detection':
            configContainer.innerHTML = `
                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Detection Method</label>
                            <select id="detectionMethod" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                <option value="iqr">IQR (Interquartile Range)</option>
                                <option value="zscore">Z-Score</option>
                                <option value="isolation_forest">Isolation Forest</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Handling Method</label>
                            <select id="handlingMethod" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                <option value="mark">Mark Outliers</option>
                                <option value="remove">Remove Outliers</option>
                                <option value="cap">Cap Outliers</option>
                                <option value="transform">Log Transform</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="detectionParams" class="grid grid-cols-2 gap-4">
                        <!-- Parameters will be dynamically shown based on detection method -->
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Numeric Columns to Analyze</label>
                        <div id="outlierColumnsList" class="max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-3">
                            <!-- Numeric columns will be listed here -->
                        </div>
                    </div>
                </div>
            `;
            break;
            
        case 'cross_validation':
            configContainer.innerHTML = `
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Target Column</label>
                        <select id="cvTargetColumn" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                            <option value="">Select target column</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">CV Method</label>
                            <select id="cvMethod" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                <option value="kfold">K-Fold</option>
                                <option value="stratified_kfold">Stratified K-Fold</option>
                                <option value="leave_one_out">Leave-One-Out</option>
                            </select>
                        </div>
                        
                        <div id="kfoldParams">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Number of Folds</label>
                            <input type="number" id="nSplits" value="5" min="2" max="20" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" id="cvShuffle" class="mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked>
                                <span class="text-sm text-gray-700">Shuffle data</span>
                            </label>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Random State</label>
                            <input type="number" id="cvRandomState" value="42" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        </div>
                    </div>
                </div>
            `;
            break;
    }
    
    // Add event listeners for dynamic sections
    addMLPreparationConfigEventListeners(operation);
}

// Add event listeners for ML preparation configuration
function addMLPreparationConfigEventListeners(operation) {
    switch(operation) {
        case 'train_test_split':
            // Update test size display
            const testSizeSlider = document.getElementById('testSize');
            const testSizeValue = document.getElementById('testSizeValue');
            
            testSizeSlider.addEventListener('input', function() {
                const value = (this.value * 100).toFixed(0);
                testSizeValue.textContent = `${value}%`;
            });
            
            // Update target column options
            updateTargetColumnOptions();
            break;
            
        case 'feature_scaling':
            updateNumericColumnsList();
            break;
            
        case 'outlier_detection':
            updateOutlierColumnsList();
            updateDetectionParams();
            
            // Update params when detection method changes
            document.getElementById('detectionMethod').addEventListener('change', updateDetectionParams);
            break;
            
        case 'cross_validation':
            updateCVTargetColumnOptions();
            
            // Show/hide kfold params based on method
            document.getElementById('cvMethod').addEventListener('change', function() {
                const kfoldParams = document.getElementById('kfoldParams');
                if (this.value === 'leave_one_out') {
                    kfoldParams.classList.add('hidden');
                } else {
                    kfoldParams.classList.remove('hidden');
                }
            });
            break;
    }
}

// Load dataset columns for ML preparation
async function loadDatasetColumnsForMLPreparation(datasetId) {
    if (!datasetId) {
        currentMLPreparationDatasetColumns = [];
        updateMLPreparationColumnLists();
        return;
    }
    
    try {
        showToast('Loading dataset columns...', 'info');
        
        const response = await fetch(`/api/assistant/api/dataset/${datasetId}/columns/`, {
            method: "GET",
            headers: {
                "X-CSRFToken": getCsrfToken(),
                "Content-Type": "application/json"
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            currentMLPreparationDatasetColumns = result.columns;
            
            updateMLPreparationColumnLists();
            showToast('Dataset columns loaded', 'success');
            
            // Show column statistics
            document.getElementById('mlPreparationColumnStats').classList.remove('hidden');
            
            // Show action buttons
            if (currentMLPreparationOperation) {
                document.getElementById('previewMLPreparationBtn').classList.remove('hidden');
                document.getElementById('executeMLPreparationBtn').classList.remove('hidden');
            }
            
        } else {
            throw new Error('Failed to load columns');
        }
        
    } catch (error) {
        console.error('Error loading columns:', error);
        showToast('Error loading dataset columns', 'error');
    }
}

// Load column statistics for ML preparation
async function loadMLPreparationColumnStatistics(datasetId) {
    try {
        const response = await fetch('/api/assistant/api/aggregation/statistics/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ dataset_id: datasetId })
        });
        
        if (response.ok) {
            const result = await response.json();
            currentMLPreparationColumnStats = result.statistics;
            displayMLPreparationColumnStatistics();
        }
    } catch (error) {
        console.error('Error loading statistics:', error);
    }
}

// Display column statistics for ML preparation
function displayMLPreparationColumnStatistics() {
    const container = document.getElementById('mlPreparationStatsContainer');
    container.innerHTML = '';
    
    Object.entries(currentMLPreparationColumnStats).forEach(([column, stats]) => {
        const card = document.createElement('div');
        card.className = 'bg-white border border-gray-200 rounded-lg p-3';
        card.innerHTML = `
            <div class="font-medium text-sm text-gray-800 mb-2">${column}</div>
            <div class="text-xs space-y-1">
                <div class="flex justify-between">
                    <span class="text-gray-500">Type:</span>
                    <span class="font-medium">${stats.dtype}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">Non-null:</span>
                    <span class="font-medium">${stats.non_null_count}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">Unique:</span>
                    <span class="font-medium">${stats.unique_count}</span>
                </div>
                ${stats.mean !== undefined ? `
                    <div class="flex justify-between">
                        <span class="text-gray-500">Mean:</span>
                        <span class="font-medium">${stats.mean?.toFixed(2) || 'N/A'}</span>
                    </div>
                ` : ''}
            </div>
        `;
        container.appendChild(card);
    });
}

// Update column lists in ML preparation configuration
function updateMLPreparationColumnLists() {
    if (!currentMLPreparationOperation || currentMLPreparationDatasetColumns.length === 0) return;
    
    switch(currentMLPreparationOperation) {
        case 'train_test_split':
            updateTargetColumnOptions();
            break;
        case 'feature_scaling':
            updateNumericColumnsList();
            break;
        case 'outlier_detection':
            updateOutlierColumnsList();
            break;
        case 'cross_validation':
            updateCVTargetColumnOptions();
            break;
    }
}

// Update target column options
function updateTargetColumnOptions() {
    const select = document.getElementById('targetColumn');
    if (!select) return;
    
    select.innerHTML = '<option value="">No target column (unsupervised)</option>';
    currentMLPreparationDatasetColumns.forEach(column => {
        const option = document.createElement('option');
        option.value = column;
        option.textContent = column;
        select.appendChild(option);
    });
}

// Update CV target column options
function updateCVTargetColumnOptions() {
    const select = document.getElementById('cvTargetColumn');
    if (!select) return;
    
    select.innerHTML = '<option value="">Select target column</option>';
    currentMLPreparationDatasetColumns.forEach(column => {
        const option = document.createElement('option');
        option.value = column;
        option.textContent = column;
        select.appendChild(option);
    });
}

// Update numeric columns list for feature scaling
function updateNumericColumnsList() {
    const container = document.getElementById('numericColumnsList');
    if (!container) return;
    
    // Find numeric columns
    const numericColumns = currentMLPreparationDatasetColumns.filter(col => {
        const stats = currentMLPreparationColumnStats[col];
        return stats && (stats.dtype.includes('int') || stats.dtype.includes('float'));
    });
    
    if (numericColumns.length === 0) {
        container.innerHTML = '<div class="text-sm text-gray-500">No numeric columns found</div>';
        return;
    }
    
    container.innerHTML = '';
    numericColumns.forEach(column => {
        const stats = currentMLPreparationColumnStats[column];
        const div = document.createElement('div');
        div.className = 'flex items-center py-1';
        div.innerHTML = `
            <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
            <span class="text-sm text-gray-700">${column}</span>
            <span class="ml-2 text-xs text-gray-400">(${stats.dtype})</span>
        `;
        container.appendChild(div);
    });
}

// Update outlier columns list
function updateOutlierColumnsList() {
    const container = document.getElementById('outlierColumnsList');
    if (!container) return;
    
    // Find numeric columns
    const numericColumns = currentMLPreparationDatasetColumns.filter(col => {
        const stats = currentMLPreparationColumnStats[col];
        return stats && (stats.dtype.includes('int') || stats.dtype.includes('float'));
    });
    
    if (numericColumns.length === 0) {
        container.innerHTML = '<div class="text-sm text-gray-500">No numeric columns found for outlier detection</div>';
        return;
    }
    
    container.innerHTML = '';
    numericColumns.forEach(column => {
        const stats = currentMLPreparationColumnStats[column];
        const div = document.createElement('div');
        div.className = 'flex items-center py-1';
        div.innerHTML = `
            <input type="checkbox" id="outlier_${column}" value="${column}" class="mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked>
            <label for="outlier_${column}" class="text-sm text-gray-700">${column}</label>
            <span class="ml-2 text-xs text-gray-400">mean: ${stats.mean?.toFixed(2) || 'N/A'}</span>
        `;
        container.appendChild(div);
    });
}

// Update detection parameters based on method
function updateDetectionParams() {
    const container = document.getElementById('detectionParams');
    const method = document.getElementById('detectionMethod')?.value;
    
    if (!container || !method) return;
    
    let paramsHTML = '';
    
    if (method === 'zscore') {
        paramsHTML = `
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Z-Score Threshold</label>
                <input type="number" id="zThreshold" value="3.0" step="0.1" min="1" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                <p class="text-xs text-gray-500 mt-1">Values beyond  threshold are outliers</p>
            </div>
            <div></div>
        `;
    } else if (method === 'iqr') {
        paramsHTML = `
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">IQR Multiplier</label>
                <input type="number" id="iqrMultiplier" value="1.5" step="0.1" min="1" max="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                <p class="text-xs text-gray-500 mt-1">Lower values detect more outliers</p>
            </div>
            <div></div>
        `;
    } else if (method === 'isolation_forest') {
        paramsHTML = `
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Contamination</label>
                <input type="number" id="contamination" value="0.1" step="0.05" min="0.01" max="0.5" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                <p class="text-xs text-gray-500 mt-1">Expected proportion of outliers</p>
            </div>
            <div></div>
        `;
    }
    
    container.innerHTML = paramsHTML;
}

// Preview ML preparation operation
async function previewMLPreparationOperation() {
    const datasetId = document.getElementById('mlPreparationDataset').value;
    if (!datasetId || !currentMLPreparationOperation) {
        showToast('Please select a dataset and operation', 'error');
        return;
    }
    
    try {
        showToast('Generating preview...', 'info');
        document.getElementById('mlPreparationStatus').textContent = 'Generating preview...';
        
        let operationParams;
        try {
            operationParams = getMLPreparationParameters();
        } catch (paramError) {
            showToast(`Configuration error: ${paramError.message}`, 'error');
            document.getElementById('mlPreparationStatus').textContent = 'Configuration error';
            return;
        }
        
        const requestData = {
            dataset_id: datasetId,
            preview_only: true,
            operation_type: currentMLPreparationOperation,
            ...operationParams
        };
        
        const response = await fetch('/api/assistant/api/ml-preparation/preview/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        if (response.ok) {
            const result = await response.json();
            displayMLPreparationPreview(result);
            document.getElementById('mlPreparationStatus').textContent = 'Preview ready';
            showToast('Preview generated', 'success');
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to generate preview');
        }
        
    } catch (error) {
        console.error('Error previewing operation:', error);
        showToast(`Error: ${error.message}`, 'error');
        document.getElementById('mlPreparationStatus').textContent = 'Error generating preview';
    }
}

// Get ML preparation parameters based on current operation
function getMLPreparationParameters() {
    const params = {};
    
    switch(currentMLPreparationOperation) {
        case 'train_test_split':
            const targetColumn = document.getElementById('targetColumn')?.value || null;
            const testSize = parseFloat(document.getElementById('testSize')?.value) || 0.2;
            const randomState = parseInt(document.getElementById('randomState')?.value) || 42;
            const shuffle = document.getElementById('shuffleData')?.checked !== false;
            const stratify = document.getElementById('stratifySplit')?.checked && targetColumn !== null;
            
            params.target_column = targetColumn;
            params.test_size = testSize;
            params.random_state = randomState;
            params.shuffle = shuffle;
            params.stratify = stratify;
            break;
            
        case 'feature_scaling':
            const scalingMethod = document.getElementById('scalingMethod')?.value || 'standard';
            const excludeColumns = document.getElementById('excludeColumns')?.value;
            
            params.scaling_method = scalingMethod;
            if (excludeColumns) {
                params.exclude_columns = excludeColumns.split(',').map(col => col.trim()).filter(col => col);
            }
            break;
            
        case 'outlier_detection':
            const detectionMethod = document.getElementById('detectionMethod')?.value || 'iqr';
            const handlingMethod = document.getElementById('handlingMethod')?.value || 'mark';
            
            params.detection_method = detectionMethod;
            params.handling_method = handlingMethod;
            
            // Get selected numeric columns
            params.numeric_columns = Array.from(document.querySelectorAll('#outlierColumnsList input:checked'))
                .map(cb => cb.value);
            
            // Add method-specific parameters
            if (detectionMethod === 'zscore') {
                params.z_threshold = parseFloat(document.getElementById('zThreshold')?.value) || 3.0;
            } else if (detectionMethod === 'iqr') {
                params.iqr_multiplier = parseFloat(document.getElementById('iqrMultiplier')?.value) || 1.5;
            }
            
            if (params.numeric_columns.length === 0) {
                showToast('Please select at least one numeric column', 'error');
                throw new Error('Numeric columns required');
            }
            break;
            
        case 'cross_validation':
            const cvTargetColumn = document.getElementById('cvTargetColumn')?.value;
            const cvMethod = document.getElementById('cvMethod')?.value || 'kfold';
            const nSplits = parseInt(document.getElementById('nSplits')?.value) || 5;
            const cvRandomState = parseInt(document.getElementById('cvRandomState')?.value) || 42;
            const cvShuffle = document.getElementById('cvShuffle')?.checked !== false;
            
            if (!cvTargetColumn) {
                showToast('Please select a target column', 'error');
                throw new Error('Target column required');
            }
            
            params.target_column = cvTargetColumn;
            params.cv_method = cvMethod;
            params.n_splits = nSplits;
            params.random_state = cvRandomState;
            params.shuffle = cvShuffle;
            break;
    }
    
    return params;
}

// Display ML preparation preview
function displayMLPreparationPreview(result) {
    const previewSection = document.getElementById('mlPreparationPreview');
    const headersContainer = document.getElementById('mlPreparationPreviewHeaders');
    const bodyContainer = document.getElementById('mlPreparationPreviewBody');
    const previewInfo = document.getElementById('mlPreparationPreviewInfo');
    
    // Show preview section
    previewSection.classList.remove('hidden');
    
    // Hide CV results section by default
    document.getElementById('cvResultsSection').classList.add('hidden');
    
    // Handle different preview types
    if (currentMLPreparationOperation === 'train_test_split') {
        // Show both train and test previews
        previewInfo.textContent = `Train: ${result.train_preview?.length || 0} rows | Test: ${result.test_preview?.length || 0} rows`;
        
        // Clear previous content
        headersContainer.innerHTML = '';
        bodyContainer.innerHTML = '';
        
        if (result.train_preview && result.train_preview.length > 0) {
            // Create headers from first train row
            const firstRow = result.train_preview[0];
            Object.keys(firstRow).forEach(column => {
                const th = document.createElement('th');
                th.className = 'px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                th.textContent = column;
                headersContainer.appendChild(th);
            });
            
            // Add train rows
            result.train_preview.forEach(row => {
                const tr = document.createElement('tr');
                Object.values(row).forEach(value => {
                    const td = document.createElement('td');
                    td.className = 'px-4 py-2 whitespace-nowrap text-sm text-gray-900 border-t';
                    td.textContent = value !== null && value !== undefined ? String(value) : 'NULL';
                    tr.appendChild(td);
                });
                bodyContainer.appendChild(tr);
            });
            
            // Add separator for test data
            const separator = document.createElement('tr');
            const separatorTd = document.createElement('td');
            separatorTd.colSpan = Object.keys(firstRow).length;
            separatorTd.className = 'px-4 py-2 bg-gray-100 text-xs font-medium text-gray-700';
            separatorTd.textContent = 'TEST SET (Next 10 rows)';
            separator.appendChild(separatorTd);
            bodyContainer.appendChild(separator);
            
            // Add test rows
            result.test_preview.forEach(row => {
                const tr = document.createElement('tr');
                Object.values(row).forEach(value => {
                    const td = document.createElement('td');
                    td.className = 'px-4 py-2 whitespace-nowrap text-sm text-gray-900 border-t';
                    td.textContent = value !== null && value !== undefined ? String(value) : 'NULL';
                    tr.appendChild(td);
                });
                bodyContainer.appendChild(tr);
            });
        }
        
    } else if (currentMLPreparationOperation === 'cross_validation' && result.cv_results) {
        // Show CV results
        displayCVResults(result.cv_results);
        
        // Also show data preview
        previewInfo.textContent = `CV Fold Data: ${result.preview_data?.length || 0} rows`;
        
        // Create headers
        headersContainer.innerHTML = '';
        if (result.columns && result.columns.length > 0) {
            result.columns.forEach(column => {
                const th = document.createElement('th');
                th.className = 'px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                th.textContent = column;
                headersContainer.appendChild(th);
            });
        }
        
        // Create rows
        bodyContainer.innerHTML = '';
        if (result.preview_data) {
            result.preview_data.forEach(row => {
                const tr = document.createElement('tr');
                result.columns.forEach(column => {
                    const td = document.createElement('td');
                    td.className = 'px-4 py-2 whitespace-nowrap text-sm text-gray-900 border-t';
                    const value = row[column];
                    td.textContent = value !== null && value !== undefined ? String(value) : 'NULL';
                    tr.appendChild(td);
                });
                bodyContainer.appendChild(tr);
            });
        }
        
    } else {
        // Standard preview for other operations
        let infoText = `Preview: ${result.preview_data?.length || 0} rows`;
        if (result.original_stats) {
            infoText += ` | Original: ${result.original_stats.total_rows} rows`;
        }
        if (result.result_stats) {
            if (result.result_stats.rows_removed) {
                infoText += ` | Removed: ${result.result_stats.rows_removed} rows`;
            }
            if (result.result_stats.new_columns_added) {
                infoText += ` | New columns: ${result.result_stats.new_columns_added}`;
            }
        }
        previewInfo.textContent = infoText;
        
        // Create headers
        headersContainer.innerHTML = '';
        if (result.columns && result.columns.length > 0) {
            result.columns.forEach(column => {
                const th = document.createElement('th');
                th.className = 'px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                th.textContent = column;
                headersContainer.appendChild(th);
            });
        }
        
        // Create rows
        bodyContainer.innerHTML = '';
        if (result.preview_data) {
            result.preview_data.forEach(row => {
                const tr = document.createElement('tr');
                result.columns.forEach(column => {
                    const td = document.createElement('td');
                    td.className = 'px-4 py-2 whitespace-nowrap text-sm text-gray-900 border-t';
                    const value = row[column];
                    td.textContent = value !== null && value !== undefined ? String(value) : 'NULL';
                    tr.appendChild(td);
                });
                bodyContainer.appendChild(tr);
            });
        }
    }
}

// Display cross-validation results
function displayCVResults(cvResults) {
    const container = document.getElementById('cvResultsContainer');
    container.innerHTML = '';
    
    document.getElementById('cvResultsSection').classList.remove('hidden');
    
    const resultsHTML = `
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
            <div class="text-center">
                <div class="text-2xl font-bold text-indigo-600">${(cvResults.mean_score * 100).toFixed(1)}%</div>
                <div class="text-xs text-gray-500">Mean Accuracy</div>
            </div>
            <div class="text-center">
                <div class="text-lg font-semibold text-gray-700">${(cvResults.std_score * 100).toFixed(1)}%</div>
                <div class="text-xs text-gray-500">Std Deviation</div>
            </div>
            <div class="text-center">
                <div class="text-lg font-semibold text-green-600">${(cvResults.max_score * 100).toFixed(1)}%</div>
                <div class="text-xs text-gray-500">Best Fold</div>
            </div>
            <div class="text-center">
                <div class="text-lg font-semibold text-red-600">${(cvResults.min_score * 100).toFixed(1)}%</div>
                <div class="text-xs text-gray-500">Worst Fold</div>
            </div>
        </div>
        
        <div class="border-t border-gray-200 pt-4">
            <h5 class="font-medium text-gray-700 mb-2">Fold-wise Scores:</h5>
            <div class="grid grid-cols-5 gap-2 text-xs">
                ${cvResults.fold_scores.map((score, index) => `
                    <div class="text-center p-2 bg-gray-100 rounded">
                        <div class="font-medium">Fold ${index + 1}</div>
                        <div class="text-indigo-600">${(score * 100).toFixed(1)}%</div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    
    container.innerHTML = resultsHTML;
}

// Execute ML preparation operation
async function executeMLPreparationOperation() {
    const datasetId = document.getElementById('mlPreparationDataset').value;
    if (!datasetId || !currentMLPreparationOperation) {
        showToast('Please select a dataset and operation', 'error');
        return;
    }
    
    try {
        showToast('Executing operation...', 'info');
        document.getElementById('mlPreparationStatus').textContent = 'Executing...';
        document.getElementById('executeMLPreparationBtn').disabled = true;
        
        let operationParams;
        try {
            operationParams = getMLPreparationParameters();
        } catch (paramError) {
            showToast(`Configuration error: ${paramError.message}`, 'error');
            document.getElementById('mlPreparationStatus').textContent = 'Configuration error';
            document.getElementById('executeMLPreparationBtn').disabled = false;
            return;
        }
        
        const requestData = {
            dataset_id: datasetId,
            operation_type: currentMLPreparationOperation,
            ...operationParams
        };
        
        const response = await fetch('/api/assistant/api/ml-preparation/execute/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        if (response.ok) {
            const result = await response.json();
            
            // Add to pipeline
            const step = {
                name: getMLPreparationOperationName(currentMLPreparationOperation),
                type: 'ml_preparation',
                operation: currentMLPreparationOperation,
                description: getMLPreparationOperationDescription(currentMLPreparationOperation),
                details: getMLPreparationOperationDetails(result)
            };
            
            addPipelineStep(step);
            
            showToast('ML preparation completed successfully!', 'success');
            closeMLPreparationModal();
            
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to execute operation');
        }
        
    } catch (error) {
        console.error('Error executing operation:', error);
        showToast(`Error: ${error.message}`, 'error');
        document.getElementById('mlPreparationStatus').textContent = 'Error executing operation';
    } finally {
        document.getElementById('executeMLPreparationBtn').disabled = false;
    }
}

// Helper functions
function getMLPreparationOperationName(operation) {
    const names = {
        'train_test_split': 'Train-Test Split',
        'feature_scaling': 'Feature Scaling',
        'outlier_detection': 'Outlier Detection',
        'cross_validation': 'Cross-Validation'
    };
    return names[operation] || operation;
}

function getMLPreparationOperationDescription(operation) {
    const descriptions = {
        'train_test_split': 'Split dataset into training and testing sets',
        'feature_scaling': 'Scale numeric features for machine learning',
        'outlier_detection': 'Detect and handle outliers in data',
        'cross_validation': 'Perform cross-validation for model evaluation'
    };
    return descriptions[operation] || 'Prepare data for machine learning';
}

function getMLPreparationOperationDetails(result) {
    if (!result.result_stats) return 'Operation completed';
    
    switch(currentMLPreparationOperation) {
        case 'train_test_split':
            return `Train: ${result.result_stats.train_rows} rows, Test: ${result.result_stats.test_rows} rows`;
        case 'feature_scaling':
            return `Scaled ${result.result_stats.scaled_columns?.length || 0} columns`;
        case 'outlier_detection':
            const totalOutliers = Object.values(result.result_stats.outlier_stats || {}).reduce((sum, stat) => sum + (stat.outlier_count || 0), 0);
            return `Detected ${totalOutliers} outliers across ${Object.keys(result.result_stats.outlier_stats || {}).length} columns`;
        case 'cross_validation':
            return `Mean accuracy: ${(result.cv_results?.mean_score * 100).toFixed(1)}%`;
        default:
            return 'Operation completed';
    }
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeMLPreparation();
});
</script>

<!-- Pipeline Modal -->
 <!-- Pipeline Modal -->
<!-- Replace your entire pipeline modal section with this fixed version -->
<!-- Pipeline Creation Modal -->

<div id="pipelineModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg w-full max-w-6xl mx-4 max-h-[90vh] overflow-hidden flex flex-col">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold text-gray-800">Create Transformation Pipeline</h3>
            <button id="closePipelineModal" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6">
            <!-- Pipeline Basic Info -->
            <div id="pipelineBasicInfo" class="mb-6">
                <h4 class="text-md font-medium text-gray-800 mb-3">Pipeline Information</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Pipeline Name *</label>
                        <input type="text" id="pipelineName" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" placeholder="My Data Pipeline">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <input type="text" id="pipelineDescription" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Brief description of this pipeline">
                    </div>
                </div>
            </div>

            <!-- Dataset Selection -->
            <div id="pipelineDatasetSelection" class="mb-6">
                <h4 class="text-md font-medium text-gray-800 mb-3">Input Dataset</h4>
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Input Dataset *</label>
                <div id="pipelineDatasetOptions" class="max-h-48 overflow-y-auto border border-gray-200 rounded-lg">
                    <!-- Datasets will be loaded here -->
                    <div class="text-center py-4 text-gray-500">
                        <i class="fas fa-spinner fa-spin"></i> Loading datasets...
                    </div>
                </div>
                <div class="mt-2 text-xs text-gray-500">
                    <i class="fas fa-info-circle mr-1"></i>
                    This dataset will be used as the starting point for all transformation steps
                </div>
            </div>

            <!-- Pipeline Steps Section -->
            <div id="pipelineStepsSection" class="mb-6">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="text-md font-medium text-gray-800">Transformation Steps</h4>
                    <button id="addStepInsideModalBtn" class="px-3 py-1.5 bg-indigo-600 text-white rounded text-xs font-medium hover:bg-indigo-700">
                        <i class="fas fa-plus mr-1"></i> Add Step
                    </button>
                </div>
                <!-- Steps Container -->
                <div id="pipelineStepsContainer" class="space-y-3">
                    <div id="emptyPipeline" class="text-center py-8 border-2 border-dashed border-gray-300 rounded-lg">
                        <i class="fas fa-stream text-gray-400 text-3xl mb-2"></i>
                        <p class="text-gray-500 text-sm">No steps added yet</p>
                        <p class="text-gray-400 text-xs mt-1">Click "Add Step" to start building your pipeline</p>
                    </div>
                </div>
            </div>

            <!-- Step Configuration Modal (Nested) -->
            <div id="stepConfigModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-60 hidden">
                <div class="bg-white rounded-lg w-full max-w-4xl mx-4 max-h-[80vh] overflow-hidden flex flex-col">
                    <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-800">Add Transformation Step</h3>
                        <button id="closeStepConfigModal" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto p-6">
                        <!-- Step Type Selection -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-3">Select Step Type</label>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                <button class="pipeline-step-type-btn p-3 border border-gray-300 rounded text-sm cursor-pointer hover:bg-gray-50 text-left transition-colors" data-type="cleaning">
                                    <div class="font-medium flex items-center">
                                        <i class="fas fa-broom text-blue-500 mr-2"></i>
                                        Data Cleaning
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">Clean and prepare data</div>
                                </button>
                                <button class="pipeline-step-type-btn p-3 border border-gray-300 rounded text-sm cursor-pointer hover:bg-gray-50 text-left transition-colors" data-type="aggregation">
                                    <div class="font-medium flex items-center">
                                        <i class="fas fa-chart-bar text-green-500 mr-2"></i>
                                        Aggregation
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">Summarize data</div>
                                </button>
                                <button class="pipeline-step-type-btn p-3 border border-gray-300 rounded text-sm cursor-pointer hover:bg-gray-50 text-left transition-colors" data-type="filter">
                                    <div class="font-medium flex items-center">
                                        <i class="fas fa-filter text-purple-500 mr-2"></i>
                                        Filter & Sort
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">Filter and organize</div>
                                </button>
                                <button class="pipeline-step-type-btn p-3 border border-gray-300 rounded text-sm cursor-pointer hover:bg-gray-50 text-left transition-colors" data-type="feature">
                                    <div class="font-medium flex items-center">
                                        <i class="fas fa-magic text-yellow-500 mr-2"></i>
                                        Feature Engineering
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">Create new features</div>
                                </button>
                                <button class="pipeline-step-type-btn p-3 border border-gray-300 rounded text-sm cursor-pointer hover:bg-gray-50 text-left transition-colors" data-type="join">
                                    <div class="font-medium flex items-center">
                                        <i class="fas fa-link text-red-500 mr-2"></i>
                                        Join Operations
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">Merge datasets</div>
                                </button>
                                <button class="pipeline-step-type-btn p-3 border border-gray-300 rounded text-sm cursor-pointer hover:bg-gray-50 text-left transition-colors" data-type="ml">
                                    <div class="font-medium flex items-center">
                                        <i class="fas fa-brain text-indigo-500 mr-2"></i>
                                        ML Preparation
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">Prepare for machine learning</div>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Operation Selection -->
                        <div id="pipelineOperationSelection" class="mb-6 hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-3">Select Operation</label>
                            <div id="pipelineOperationsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <!-- Operations will be loaded here based on step type -->
                            </div>
                        </div>
                        
                        <!-- Configuration -->
                        <div id="pipelineStepConfig" class="hidden">
                            <!-- Configuration will be loaded here based on operation -->
                        </div>
                        
                        <!-- Preview -->
                        <div id="pipelineStepPreview" class="hidden mt-6">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-medium text-gray-800 text-sm">Step Preview</h4>
                                <button id="refreshPipelinePreview" class="text-xs text-indigo-600 hover:text-indigo-800">
                                    <i class="fas fa-sync-alt mr-1"></i> Refresh
                                </button>
                            </div>
                            <div class="border border-gray-200 rounded-lg overflow-hidden">
                                <div class="bg-gray-50 px-3 py-2 border-b border-gray-200">
                                    <div class="text-xs text-gray-600" id="pipelinePreviewInfo">Preview: 20 rows</div>
                                </div>
                                <div class="overflow-x-auto max-h-48">
                                    <table class="min-w-full divide-y divide-gray-200 text-xs">
                                        <thead class="bg-gray-50">
                                            <tr id="pipelinePreviewHeaders"></tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="pipelinePreviewBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4 border-t border-gray-200 bg-gray-50 flex justify-between items-center">
                        <div class="text-sm text-gray-600" id="pipelineStepStatus">
                            Select a step type to begin
                        </div>
                        <div class="flex space-x-2">
                            <button id="previewPipelineStepBtn" class="px-4 py-2 border border-gray-300 rounded text-sm font-medium text-gray-700 hover:bg-gray-50 hidden">
                                <i class="fas fa-eye mr-1"></i> Preview
                            </button>
                            <button id="addPipelineStepBtn" class="px-4 py-2 bg-indigo-600 text-white rounded text-sm font-medium hover:bg-indigo-700 hidden">
                                <i class="fas fa-plus mr-1"></i> Add to Pipeline
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="p-4 border-t border-gray-200 bg-gray-50 flex justify-between items-center">
            <div class="text-sm text-gray-600">
                <span id="pipelineStatus">Ready to create pipeline</span>
                <span id="pipelineStepCount" class="ml-2 text-gray-400"></span>
            </div>
            <div class="flex space-x-3">
                <button id="cancelPipelineBtn" class="px-4 py-2 border border-gray-300 rounded text-sm font-medium text-gray-700 hover:bg-gray-50">
                    Cancel
                </button>
                <button id="savePipelineBtn" class="px-4 py-2 bg-indigo-600 text-white rounded text-sm font-medium hover:bg-indigo-700">
                    <i class="fas fa-save mr-1"></i> Create Pipeline
                </button>
            </div>
        </div>
    </div>
</div>


<script>
    // Global tracking variables
    let currentStepType = null;
    let currentOperation = null;
     currentDatasetColumns = [];

    // Open Pipeline Modal
    document.getElementById('addStepBtn').addEventListener('click', function() {
        const modal = document.getElementById('pipelineModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        
        // Load datasets when modal opens
        loadDatasets();
    });

    // Close Pipeline Modal
    document.getElementById('closePipelineModal').addEventListener('click', function() {
        const modal = document.getElementById('pipelineModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    });

    // Close modal when clicking outside content
    document.getElementById('pipelineModal').addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.add('hidden');
            this.classList.remove('flex');
        }
    });

    // Cancel button
    document.getElementById('cancelPipelineBtn').addEventListener('click', function() {
        const modal = document.getElementById('pipelineModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    });

    // Close Step Configuration Modal
    document.getElementById('closeStepConfigModal').addEventListener('click', function() {
        const modal = document.getElementById('stepConfigModal');
        modal.classList.add('hidden');
    });

    // Close step modal when clicking outside
    document.getElementById('stepConfigModal').addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.add('hidden');
        }
    });

    // Open Step Configuration Modal - FIXED: Changed to correct button ID
    document.getElementById('addStepInsideModalBtn').addEventListener('click', function() {
        const modal = document.getElementById('stepConfigModal');
        modal.classList.remove('hidden');
    });

    // Step type selection
    document.querySelectorAll('.pipeline-step-type-btn').forEach(button => {
        button.addEventListener('click', function() {
            const stepType = this.getAttribute('data-type');
            selectStepType(stepType);
        });
    });

    // Function to load datasets from backend
    async function loadDatasets() {
        const datasetContainer = document.getElementById('pipelineDatasetOptions');
        
        try {
            datasetContainer.innerHTML = `
                <div class="text-center py-4 text-gray-500">
                    <i class="fas fa-spinner fa-spin"></i> Loading datasets...
                </div>
            `;
            
            const response = await fetch('/api/assistant/api/datasets/', {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const result = await response.json();
                
                if (result.success && result.datasets && result.datasets.length > 0) {
                    datasetContainer.innerHTML = `
                        <div class="divide-y divide-gray-200">
                            ${result.datasets.map(dataset => `
                                <div class="p-3 hover:bg-gray-50 cursor-pointer" 
                                     data-dataset-id="${dataset.id}"
                                     data-dataset-name="${dataset.file_name}">
                                    <div class="font-medium text-sm text-gray-800">${dataset.file_name}</div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        ${dataset.row_count || 0} rows  ${dataset.column_count || 0} columns  
                                        Updated ${formatRelativeTime(dataset.updated_at || dataset.created_at)}
                                    </div>
                                    ${dataset.description ? `
                                        <div class="text-xs text-gray-400 mt-1">${dataset.description}</div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                    // Auto-select first dataset
                    const firstDataset = datasetContainer.querySelector('.p-3');
                    if (firstDataset) {
                        firstDataset.classList.add('border-l-indigo-500', 'bg-indigo-50');
                    }
                    
                } else {
                    datasetContainer.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-database text-3xl mb-2"></i>
                            <p class="text-sm">No datasets found</p>
                            <p class="text-xs mt-1">Upload a dataset to get started</p>
                        </div>
                    `;
                }
                
            } else {
                throw new Error('Failed to load datasets');
            }
            
        } catch (error) {
            console.error('Error loading datasets:', error);
            datasetContainer.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-exclamation-triangle text-3xl mb-2"></i>
                    <p class="text-sm">Error loading datasets</p>
                    <p class="text-xs mt-1">Please try again</p>
                </div>
            `;
        }
        
        // Add click handlers to dataset items
        datasetContainer.querySelectorAll('.p-3').forEach(item => {
            item.addEventListener('click', function() {
                // Remove selection from all items
                datasetContainer.querySelectorAll('.p-3').forEach(i => {
                    i.classList.remove('border-l-indigo-500', 'bg-indigo-50');
                });
                // Add selection to clicked item
                this.classList.add('border-l-indigo-500', 'bg-indigo-50');
            });
        });
    }

    // Helper function to format relative time
    function formatRelativeTime(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        
        if (diffDays === 0) return 'today';
        if (diffDays === 1) return 'yesterday';
        if (diffDays < 7) return `${diffDays} days ago`;
        if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
        return `${Math.floor(diffDays / 30)} months ago`;
    }

    // Function to handle step type selection
    function selectStepType(stepType) {
        currentStepType = stepType;
        const operationSection = document.getElementById('pipelineOperationSelection');
        const configSection = document.getElementById('pipelineStepConfig');
        const previewBtn = document.getElementById('previewPipelineStepBtn');
        const addBtn = document.getElementById('addPipelineStepBtn');
        const status = document.getElementById('pipelineStepStatus');
        
        // Show operation selection
        operationSection.classList.remove('hidden');
        
        // Update status
        status.textContent = `Selected: ${getStepTypeName(stepType)} - Choose an operation`;
        
        // Load operations based on step type
        loadOperations(stepType);
        
        // Show buttons
        previewBtn.classList.remove('hidden');
        addBtn.classList.remove('hidden');
    }

    // Function to get step type display name
    function getStepTypeName(stepType) {
        const names = {
            'cleaning': 'Data Cleaning',
            'aggregation': 'Aggregation',
            'filter': 'Filter & Sort',
            'feature': 'Feature Engineering',
            'join': 'Join Operations',
            'ml': 'ML Preparation'
        };
        return names[stepType] || stepType;
    }

// Load operations for step type
function loadOperations(stepType) {
    const operationsGrid = document.getElementById('pipelineOperationsGrid');
    
    const operations = {
        'cleaning': [
            { name: 'Handle Missing Values', icon: 'fa-exclamation-triangle', description: 'Fill or remove missing data' },
            { name: 'Remove Duplicates', icon: 'fa-copy', description: 'Remove duplicate rows' },
            { name: 'Data Type Conversion', icon: 'fa-exchange-alt', description: 'Convert column data types' },
            { name: 'Text Cleaning', icon: 'fa-font', description: 'Clean and normalize text' }
        ],
        'aggregation': [
            { name: 'Group By & Summarize', icon: 'fa-layer-group', description: 'Group data and calculate statistics' },
            { name: 'Pivot Tables', icon: 'fa-table', description: 'Reshape data from long to wide' },
            { name: 'Window Functions', icon: 'fa-chart-line', description: 'Calculate running totals, ranks' },
            { name: 'Rollup & Cube', icon: 'fa-cube', description: 'Multi-level aggregations' }
        ],
        'filter': [
            { name: 'Filter Rows', icon: 'fa-filter', description: 'Filter data based on conditions' },
            { name: 'Sort Data', icon: 'fa-sort', description: 'Sort by one or more columns' },
            { name: 'Select Columns', icon: 'fa-columns', description: 'Choose specific columns to keep' },
            { name: 'Remove Columns', icon: 'fa-times', description: 'Remove unwanted columns' },
            { name: 'Top N Records', icon: 'fa-chart-bar', description: 'Get top/bottom records' },
            { name: 'Random Sampling', icon: 'fa-random', description: 'Get random data sample' }
        ],
        'feature': [
            { name: 'Calculated Columns', icon: 'fa-calculator', description: 'Create new calculated columns' },
            { name: 'Datetime Extraction', icon: 'fa-calendar', description: 'Extract features from dates' },
            { name: 'Text Processing', icon: 'fa-font', description: 'Process and extract text features' },
            { name: 'One-Hot Encoding', icon: 'fa-barcode', description: 'Encode categorical variables' }
        ],
        'ml': [
            { name: 'Train Test Split', icon: 'fa-code-branch', description: 'Split data for ML training' },
            { name: 'Feature Scaling', icon: 'fa-balance-scale', description: 'Scale features for ML' },
            { name: 'Outlier Detection', icon: 'fa-radar', description: 'Detect and handle outliers' },
            { name: 'Cross Validation', icon: 'fa-retweet', description: 'Cross-validation for model evaluation' }
        ],
        'join': [
            { name: 'Inner Join', icon: 'fa-link', description: 'Join matching rows from both datasets' },
            { name: 'Left Join', icon: 'fa-arrow-left', description: 'All rows from left, matching from right' },
            { name: 'Right Join', icon: 'fa-arrow-right', description: 'All rows from right, matching from left' },
            { name: 'Full Join', icon: 'fa-arrows-alt-h', description: 'All rows from both datasets' }
        ]
    };
    
    const stepOperations = operations[stepType] || [
        { name: 'Basic Operation', icon: 'fa-cog', description: 'Configure this operation' }
    ];
    
    operationsGrid.innerHTML = stepOperations.map(op => `
        <button class="pipeline-operation-btn p-3 border border-gray-300 rounded text-sm cursor-pointer hover:bg-gray-50 text-left transition-colors" 
                data-operation="${op.name.toLowerCase().replace(/\s+/g, '-')}">
            <div class="font-medium flex items-center">
                <i class="fas ${op.icon} text-gray-500 mr-2"></i>
                ${op.name}
            </div>
            <div class="text-xs text-gray-500 mt-1">${op.description}</div>
        </button>
    `).join('');
    
    // Add click handlers to operation buttons
    document.querySelectorAll('.pipeline-operation-btn').forEach(button => {
        button.addEventListener('click', function() {
            const operation = this.getAttribute('data-operation');
            selectOperation(currentStepType, operation);
        });
    });
}

// Update the selectOperation function to handle aggregation operations
// In the main pipeline script, update the selectOperation function:
function selectOperation(stepType, operation) {
    currentStepType = stepType;
    currentOperation = operation;
    
    const configSection = document.getElementById('pipelineStepConfig');
    const status = document.getElementById('pipelineStepStatus');
    
    // Show configuration section
    configSection.classList.remove('hidden');
    
    // Update status
    status.textContent = `Configuring: ${getStepTypeName(stepType)} - ${getOperationDisplayName(operation)}`;
    
    // Handle different step types with proper configuration
    if (stepType === 'cleaning') {
        openPipelineDataCleaning(operation);
    } else if (stepType === 'aggregation') {
        console.log('Loading configuration for other step types');

        openPipelineAggregation(operation); // This should call the aggregation function
    } else {
        console.log('Loading configuration for other step types');
        // Use the basic configuration for other step types
        configSection.innerHTML = getBasicOperationConfig(stepType, operation);
    }
    
    // Debug log
    console.log('Selected operation:', stepType, operation);
    console.log('Current dataset ID:', currentDatasetId);
}

document.getElementById('previewPipelineStepBtn').addEventListener('click', function() {
    console.log('Preview button clicked - Step type:', currentStepType, 'Operation:', currentOperation);
    
    if (currentStepType === 'cleaning') {
        previewPipelineStep();
    } else if (currentStepType === 'aggregation') {
        previewPipelineAggregationStep();
    } else if (currentStepType === 'filter') {
        previewPipelineFilterStep();
    } else {
        alert('Preview functionality for this step type is coming soon!');
    }
});
// Function to handle aggregation operations
function openPipelineAggregation(operation) {
    currentOperation = operation;
    
    const configSection = document.getElementById('pipelineStepConfig');
    configSection.innerHTML = getPipelineAggregationConfig(operation);

    
    // Update status
    document.getElementById('pipelineStepStatus').textContent = `Configuring: ${getAggregationOperationName(operation)}`;
    
    // Load columns for the selected dataset
    const selectedDataset = document.querySelector('#pipelineDatasetOptions .border-l-indigo-500');
    if (selectedDataset) {
        const datasetId = selectedDataset.getAttribute('data-dataset-id');
        loadDatasetColumnsForPipelineAggregation(datasetId);
    }
    
    // Show preview button
    document.getElementById('previewPipelineStepBtn').classList.remove('hidden');
}

// Function to get aggregation configuration
function getPipelineAggregationConfig(operation) {
    switch(operation) {
        case 'group-by-&-summarize':
            return `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Step Name *</label>
                        <input type="text" id="stepNameInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" value="Group By & Summarize">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea id="stepDescriptionInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" rows="2">Group data and calculate aggregate statistics</textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Group By Columns</label>
                        <div id="pipelineGroupByColumns" class="space-y-2 max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-3">
                            <div class="text-sm text-gray-500">Loading columns...</div>
                        </div>
                        <div class="mt-2">
                            <label class="inline-flex items-center">
                                <input type="checkbox" id="pipelineNoGrouping" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                <span class="ml-2 text-sm text-gray-600">No grouping (aggregate entire dataset)</span>
                            </label>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Aggregation Operations</label>
                        <div id="pipelineAggregationColumns" class="space-y-3">
                            <div class="aggregation-column-entry border border-gray-200 rounded-lg p-3">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Column</label>
                                        <select class="aggregation-column-select w-full border border-gray-300 rounded px-2 py-1 text-sm">
                                            <option value="">Select column</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Operations</label>
                                        <select class="aggregation-operation-select w-full border border-gray-300 rounded px-2 py-1 text-sm" multiple>
                                            <option value="sum">Sum</option>
                                            <option value="mean">Mean</option>
                                            <option value="count">Count</option>
                                            <option value="min">Minimum</option>
                                            <option value="max">Maximum</option>
                                            <option value="median">Median</option>
                                            <option value="std">Standard Deviation</option>
                                            <option value="unique_count">Unique Count</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button id="addAggregationColumn" class="mt-2 px-3 py-1 bg-gray-100 text-gray-700 rounded text-sm font-medium hover:bg-gray-200">
                            <i class="fas fa-plus mr-1"></i> Add Aggregation Column
                        </button>
                    </div>
                </div>
            `;
            
        case 'pivot-tables':
            return `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Step Name *</label>
                        <input type="text" id="stepNameInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" value="Pivot Table">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea id="stepDescriptionInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" rows="2">Create pivot table from data</textarea>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Index (Rows)</label>
                            <select id="pipelinePivotIndex" class="w-full border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="">Select index column</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Columns</label>
                            <select id="pipelinePivotColumns" class="w-full border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="">Select column</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Values</label>
                            <select id="pipelinePivotValues" class="w-full border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="">Select value column</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Aggregation Function</label>
                        <select id="pipelinePivotAggFunc" class="w-full border border-gray-300 rounded px-3 py-2 text-sm">
                            <option value="mean">Mean</option>
                            <option value="sum">Sum</option>
                            <option value="count">Count</option>
                            <option value="min">Minimum</option>
                            <option value="max">Maximum</option>
                        </select>
                    </div>
                </div>
            `;
            
        // Add other aggregation operations (window functions, rollup, etc.)
        default:
            return `<div class="text-center py-4 text-gray-500">Configuration for ${operation} not available</div>`;
    }
}

// Helper functions
function getAggregationOperationName(operation) {
    const names = {
        'group-by-&-summarize': 'Group By & Summarize',
        'pivot-tables': 'Pivot Tables',
        'window-functions': 'Window Functions',
        'rollup-&-cube': 'Rollup & Cube'
    };
    return names[operation] || operation;
}

function getOperationDisplayName(operation) {
    const names = {
        'group-by-&-summarize': 'Group By & Summarize',
        'pivot-tables': 'Pivot Tables',
        'window-functions': 'Window Functions',
        'rollup-&-cube': 'Rollup & Cube',
        'handle-missing-values': 'Handle Missing Values',
        'remove-duplicates': 'Remove Duplicates',
        'data-type-conversion': 'Data Type Conversion',
        'text-cleaning': 'Text Cleaning'
    };
    return names[operation] || operation;
}

// Function to load dataset columns for aggregation
async function loadDatasetColumnsForPipelineAggregation(datasetId) {
    if (!datasetId) return;
    
    try {
        const response = await fetch(`/api/assistant/api/dataset/${datasetId}/columns/`, {
            method: "GET",
            headers: {
                "X-CSRFToken": getCsrfToken(),
                "Content-Type": "application/json"
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            currentDatasetColumns = result.columns;
            updatePipelineAggregationColumnLists();
        }
    } catch (error) {
        console.error('Error loading columns for pipeline aggregation:', error);
    }
}

// Function to update aggregation column lists
function updatePipelineAggregationColumnLists() {
    if (!currentOperation || currentDatasetColumns.length === 0) return;
    
    // Update group by columns
    const groupByContainer = document.getElementById('pipelineGroupByColumns');
    if (groupByContainer) {
        groupByContainer.innerHTML = '';
        currentDatasetColumns.forEach(column => {
            const div = document.createElement('div');
            div.className = 'flex items-center';
            div.innerHTML = `
                <input type="checkbox" id="pipeline_group_${column}" value="${column}" class="mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                <label for="pipeline_group_${column}" class="text-sm text-gray-700">${column}</label>
            `;
            groupByContainer.appendChild(div);
        });
    }
    
    // Update aggregation column selects
    document.querySelectorAll('.aggregation-column-select').forEach(select => {
        select.innerHTML = '<option value="">Select column</option>' + 
            currentDatasetColumns.map(col => `<option value="${col}">${col}</option>`).join('');
    });
    
    // Update pivot selects
    const pivotIndex = document.getElementById('pipelinePivotIndex');
    const pivotColumns = document.getElementById('pipelinePivotColumns');
    const pivotValues = document.getElementById('pipelinePivotValues');
    
    if (pivotIndex) {
        pivotIndex.innerHTML = '<option value="">Select index column</option>' + 
            currentDatasetColumns.map(col => `<option value="${col}">${col}</option>`).join('');
    }
    if (pivotColumns) {
        pivotColumns.innerHTML = '<option value="">Select column</option>' + 
            currentDatasetColumns.map(col => `<option value="${col}">${col}</option>`).join('');
    }
    if (pivotValues) {
        pivotValues.innerHTML = '<option value="">Select value column</option>' + 
            currentDatasetColumns.map(col => `<option value="${col}">${col}</option>`).join('');
    }
}
    // Function to get basic operation configuration (for non-cleaning operations)
    function getBasicOperationConfig(stepType, operation) {
        return `
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Step Name *</label>
                    <input type="text" id="stepNameInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., ${getStepTypeName(stepType)} Step">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="stepDescriptionInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" rows="2" placeholder="Describe what this step does"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Target Column</label>
                        <select id="targetColumnSelect" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">Select a column</option>
                            <option value="price">Price</option>
                            <option value="quantity">Quantity</option>
                            <option value="category">Category</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Operation Type</label>
                        <select id="operationTypeSelect" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="fill">Fill with value</option>
                            <option value="remove">Remove rows</option>
                            <option value="mean">Fill with mean</option>
                            <option value="median">Fill with median</option>
                        </select>
                    </div>
                </div>
                <div id="fillValueSection" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fill Value</label>
                    <input type="text" id="fillValueInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter value to fill">
                </div>
            </div>
        `;
    }

    // Data Cleaning Functions
    function openPipelineDataCleaning(operation) {
        currentOperation = operation;
        
        // Show advanced configuration for the selected cleaning operation
        const configSection = document.getElementById('pipelineStepConfig');
        configSection.innerHTML = getPipelineCleaningConfig(operation);
        
        // Update status
        document.getElementById('pipelineStepStatus').textContent = `Configuring: ${getCleaningOperationName(operation)}`;
        
        // Load columns for the selected dataset
        const selectedDataset = document.querySelector('#pipelineDatasetOptions .border-l-indigo-500');
        if (selectedDataset) {
            const datasetId = selectedDataset.getAttribute('data-dataset-id');
            loadDatasetColumnsForPipelineCleaning(datasetId);
        }
        
        // Add event listeners for dynamic sections
        setTimeout(() => {
            addPipelineCleaningEventListeners();
        }, 100);
    }

    function getPipelineCleaningConfig(operation) {
        switch(operation) {
            case 'handle-missing-values':
                return `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Step Name *</label>
                            <input type="text" id="stepNameInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" value="Handle Missing Values">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                            <textarea id="stepDescriptionInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" rows="2">Handle null or missing values in dataset</textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Columns to Process</label>
                            <div id="pipelineMissingValuesColumns" class="space-y-2 max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-3">
                                <div class="text-sm text-gray-500">Loading columns...</div>
                            </div>
                            <div class="mt-2">
                                <label class="inline-flex items-center">
                                    <input type="checkbox" id="pipelineProcessAllColumns" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked>
                                    <span class="ml-2 text-sm text-gray-600">Process all columns</span>
                                </label>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Handling Strategy</label>
                            <select id="pipelineMissingValuesStrategy" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="fill">Fill with value</option>
                                <option value="drop">Drop rows with missing values</option>
                                <option value="interpolate">Interpolate (numeric only)</option>
                            </select>
                        </div>
                        
                        <div id="pipelineFillValueSection">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Fill Value</label>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <label class="flex items-center p-2 border border-gray-300 rounded cursor-pointer hover:bg-gray-50">
                                    <input type="radio" name="pipelineFillValue" value="mean" class="mr-2" checked>
                                    <span class="text-sm">Mean</span>
                                </label>
                                <label class="flex items-center p-2 border border-gray-300 rounded cursor-pointer hover:bg-gray-50">
                                    <input type="radio" name="pipelineFillValue" value="median" class="mr-2">
                                    <span class="text-sm">Median</span>
                                </label>
                                <label class="flex items-center p-2 border border-gray-300 rounded cursor-pointer hover:bg-gray-50">
                                    <input type="radio" name="pipelineFillValue" value="mode" class="mr-2">
                                    <span class="text-sm">Mode</span>
                                </label>
                                <label class="flex items-center p-2 border border-gray-300 rounded cursor-pointer hover:bg-gray-50">
                                    <input type="radio" name="pipelineFillValue" value="custom" class="mr-2">
                                    <span class="text-sm">Custom</span>
                                </label>
                            </div>
                            <div id="pipelineCustomValueSection" class="mt-2 hidden">
                                <input type="text" id="pipelineCustomFillValue" placeholder="Enter custom value" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                            </div>
                        </div>
                    </div>
                `;
                
            case 'remove-duplicates':
                return `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Step Name *</label>
                            <input type="text" id="stepNameInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" value="Remove Duplicates">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                            <textarea id="stepDescriptionInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" rows="2">Remove duplicate rows based on selected criteria</textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Columns to Check for Duplicates</label>
                            <div id="pipelineDuplicateColumns" class="space-y-2 max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-3">
                                <div class="text-sm text-gray-500">Loading columns...</div>
                            </div>
                            <div class="mt-2">
                                <label class="inline-flex items-center">
                                    <input type="checkbox" id="pipelineCheckAllColumns" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked>
                                    <span class="ml-2 text-sm text-gray-600">Check all columns (consider entire row)</span>
                                </label>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Which Duplicates to Keep</label>
                            <select id="pipelineDuplicateKeep" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="first">Keep first occurrence</option>
                                <option value="last">Keep last occurrence</option>
                                <option value="false">Remove all duplicates</option>
                            </select>
                        </div>
                    </div>
                `;
                
            case 'data-type-conversion':
                return `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Step Name *</label>
                            <input type="text" id="stepNameInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" value="Data Type Conversion">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                            <textarea id="stepDescriptionInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" rows="2">Convert data types of selected columns</textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Column Type Conversions</label>
                            <div id="pipelineConversionColumns" class="space-y-3 max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-3">
                                <div class="text-sm text-gray-500">Loading columns...</div>
                            </div>
                        </div>
                    </div>
                `;
                
            case 'text-cleaning':
                return `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Step Name *</label>
                            <input type="text" id="stepNameInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" value="Text Cleaning">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                            <textarea id="stepDescriptionInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" rows="2">Clean and normalize text data</textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Columns to Clean</label>
                            <div id="pipelineTextColumns" class="space-y-2 max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-3">
                                <div class="text-sm text-gray-500">Loading columns...</div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Text Operations</label>
                            <div class="space-y-3">
                                <label class="inline-flex items-center">
                                    <input type="checkbox" id="pipelineTrimSpaces" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked>
                                    <span class="ml-2 text-sm text-gray-600">Trim leading/trailing spaces</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" id="pipelineRemoveExtraSpaces" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-2 text-sm text-gray-600">Remove extra spaces between words</span>
                                </label>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Case Conversion</label>
                                    <select id="pipelineTextCase" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                        <option value="">No change</option>
                                        <option value="lower">Convert to lowercase</option>
                                        <option value="upper">Convert to uppercase</option>
                                        <option value="title">Convert to title case</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
            default:
                return `<div class="text-center py-4 text-gray-500">Configuration for ${operation} not available</div>`;
        }
    }

    async function loadDatasetColumnsForPipelineCleaning(datasetId) {
        if (!datasetId) {
            currentDatasetColumns = [];
            updatePipelineCleaningColumnLists();
            return;
        }
        
        try {
            const response = await fetch(`/api/assistant/api/dataset/${datasetId}/columns/`, {
                method: "GET",
                headers: {
                    "X-CSRFToken": getCsrfToken(),
                    "Content-Type": "application/json"
                }
            });
            
            if (response.ok) {
                const result = await response.json();
                currentDatasetColumns = result.columns;
                updatePipelineCleaningColumnLists();
            }
            
        } catch (error) {
            console.error('Error loading columns for pipeline cleaning:', error);
        }
    }

    function updatePipelineCleaningColumnLists() {
        if (!currentOperation || currentDatasetColumns.length === 0) return;
        
        switch(currentOperation) {
            case 'handle-missing-values':
                updatePipelineMissingValuesColumnList();
                break;
            case 'remove-duplicates':
                updatePipelineDuplicateColumnsList();
                break;
            case 'data-type-conversion':
                updatePipelineConversionColumnsList();
                break;
            case 'text-cleaning':
                updatePipelineTextColumnsList();
                break;
        }
    }

    function updatePipelineMissingValuesColumnList() {
        const container = document.getElementById('pipelineMissingValuesColumns');
        if (!container) return;
        
        container.innerHTML = '';
        currentDatasetColumns.forEach(column => {
            const div = document.createElement('div');
            div.className = 'flex items-center';
            div.innerHTML = `
                <input type="checkbox" id="pipeline_mv_${column}" value="${column}" class="mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked>
                <label for="pipeline_mv_${column}" class="text-sm text-gray-700">${column}</label>
            `;
            container.appendChild(div);
        });
    }

    function updatePipelineDuplicateColumnsList() {
        const container = document.getElementById('pipelineDuplicateColumns');
        if (!container) return;
        
        container.innerHTML = '';
        currentDatasetColumns.forEach(column => {
            const div = document.createElement('div');
            div.className = 'flex items-center';
            div.innerHTML = `
                <input type="checkbox" id="pipeline_dup_${column}" value="${column}" class="mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                <label for="pipeline_dup_${column}" class="text-sm text-gray-700">${column}</label>
            `;
            container.appendChild(div);
        });
    }

    function updatePipelineConversionColumnsList() {
        const container = document.getElementById('pipelineConversionColumns');
        if (!container) return;
        
        container.innerHTML = '';
        currentDatasetColumns.forEach(column => {
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between p-2 border border-gray-200 rounded';
            div.innerHTML = `
                <div class="flex-1">
                    <div class="text-sm font-medium text-gray-700">${column}</div>
                </div>
                <select id="pipeline_conv_${column}" class="ml-3 border border-gray-300 rounded px-2 py-1 text-sm">
                    <option value="">No change</option>
                    <option value="string">String</option>
                    <option value="numeric">Numeric</option>
                    <option value="integer">Integer</option>
                    <option value="float">Float</option>
                    <option value="datetime">Date/Time</option>
                    <option value="boolean">Boolean</option>
                </select>
            `;
            container.appendChild(div);
        });
    }

    function updatePipelineTextColumnsList() {
        const container = document.getElementById('pipelineTextColumns');
        if (!container) return;
        
        container.innerHTML = '';
        currentDatasetColumns.forEach(column => {
            const div = document.createElement('div');
            div.className = 'flex items-center';
            div.innerHTML = `
                <input type="checkbox" id="pipeline_txt_${column}" value="${column}" class="mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked>
                <label for="pipeline_txt_${column}" class="text-sm text-gray-700">${column}</label>
            `;
            container.appendChild(div);
        });
    }

    function addPipelineCleaningEventListeners() {
        // Strategy change for missing values
        const strategySelect = document.getElementById('pipelineMissingValuesStrategy');
        if (strategySelect) {
            strategySelect.addEventListener('change', function() {
                const showFillValue = this.value === 'fill';
                const fillValueSection = document.getElementById('pipelineFillValueSection');
                if (fillValueSection) {
                    fillValueSection.style.display = showFillValue ? 'block' : 'none';
                }
            });
        }
        
        // Fill value type change
        document.querySelectorAll('input[name="pipelineFillValue"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const customSection = document.getElementById('pipelineCustomValueSection');
                if (customSection) {
                    customSection.style.display = this.value === 'custom' ? 'block' : 'none';
                }
            });
        });
    }

    function getPipelineCleaningParameters() {
        const params = {};
        
        switch(currentOperation) {
            case 'handle-missing-values':
                params.strategy = document.getElementById('pipelineMissingValuesStrategy')?.value || 'fill';
                
                if (params.strategy === 'fill') {
                    const fillValueRadio = document.querySelector('input[name="pipelineFillValue"]:checked');
                    params.fill_value = fillValueRadio ? fillValueRadio.value : 'mean';
                    
                    if (params.fill_value === 'custom') {
                        params.fill_value = document.getElementById('pipelineCustomFillValue')?.value || '';
                    }
                }
                
                if (!document.getElementById('pipelineProcessAllColumns')?.checked) {
                    params.columns = Array.from(document.querySelectorAll('#pipelineMissingValuesColumns input:checked'))
                        .map(cb => cb.value);
                }
                break;
                
            case 'remove-duplicates':
                params.keep = document.getElementById('pipelineDuplicateKeep')?.value || 'first';
                
                if (!document.getElementById('pipelineCheckAllColumns')?.checked) {
                    params.subset = Array.from(document.querySelectorAll('#pipelineDuplicateColumns input:checked'))
                        .map(cb => cb.value);
                }
                break;
                
            case 'data-type-conversion':
                params.conversions = {};
                currentDatasetColumns.forEach(column => {
                    const select = document.getElementById(`pipeline_conv_${column}`);
                    if (select && select.value) {
                        params.conversions[column] = select.value;
                    }
                });
                break;
                
            case 'text-cleaning':
                params.operations = {
                    trim: document.getElementById('pipelineTrimSpaces')?.checked || false,
                    remove_extra_spaces: document.getElementById('pipelineRemoveExtraSpaces')?.checked || false,
                    case: document.getElementById('pipelineTextCase')?.value || ''
                };
                
                params.columns = Array.from(document.querySelectorAll('#pipelineTextColumns input:checked'))
                    .map(cb => cb.value);
                break;
        }
        
        return params;
    }

    function getCleaningOperationName(operation) {
        const names = {
            'handle-missing-values': 'Handle Missing Values',
            'remove-duplicates': 'Remove Duplicates',
            'data-type-conversion': 'Data Type Conversion',
            'text-cleaning': 'Text Cleaning'
        };
        return names[operation] || operation;
    }

    // Add event listener for the "Add to Pipeline" button in step config
    document.getElementById('addPipelineStepBtn').addEventListener('click', function() {
        const stepName = document.getElementById('stepNameInput')?.value || 'Unnamed Step';
        const stepDescription = document.getElementById('stepDescriptionInput')?.value || '';
        
        let stepData = {
            name: stepName,
            description: stepDescription,
            type: getCurrentStepType(),
            operation: getCurrentOperation()
        };
        
        // Add parameters based on step type
        if (stepData.type === 'cleaning') {
            stepData.parameters = getPipelineCleaningParameters();
        } else {
            // Basic parameters for other step types
            const targetColumn = document.getElementById('targetColumnSelect')?.value || '';
            const operationType = document.getElementById('operationTypeSelect')?.value || '';
            const fillValue = document.getElementById('fillValueInput')?.value || '';
            
            stepData.parameters = {
                target_column: targetColumn,
                operation_type: operationType,
                fill_value: fillValue
            };
        }
        
        addStepToPipeline(stepData);
        // Close step config modal
        document.getElementById('stepConfigModal').classList.add('hidden');
    });

    // Function to get current step type - DYNAMIC
    function getCurrentStepType() {
        return currentStepType;
    }

    // Function to get current operation - DYNAMIC  
    function getCurrentOperation() {
        return currentOperation;
    }

    // Function to add step to pipeline - Enhanced to handle different step types
    function addStepToPipeline(stepData = {}) {
        const container = document.getElementById('pipelineStepsContainer');
        const emptyState = document.getElementById('emptyPipeline');
        
        // Hide empty state
        if (emptyState) {
            emptyState.style.display = 'none';
        }
        
        // Default step data
        const defaultStepData = {
            type: 'cleaning',
            operation: 'handle-missing-values',
            parameters: {},
            name: 'Data Cleaning Step',
            description: 'Handle missing values in selected columns'
        };
        
        const stepConfig = { ...defaultStepData, ...stepData };
        
        // Create step element with appropriate styling based on type
        const stepElement = document.createElement('div');
        stepElement.className = 'p-4 border border-gray-200 rounded-lg bg-white';
        stepElement.setAttribute('data-step-type', stepConfig.type);
        stepElement.setAttribute('data-operation', stepConfig.operation);
        stepElement.setAttribute('data-parameters', JSON.stringify(stepConfig.parameters));
        
        // Get appropriate icon and color based on step type
        const stepTypeConfig = getStepTypeConfig(stepConfig.type);
        
        stepElement.innerHTML = `
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <div class="flex items-center mb-2">
                        <i class="fas ${stepTypeConfig.icon} ${stepTypeConfig.color} mr-2"></i>
                        <h5 class="font-medium text-gray-800">${stepConfig.name}</h5>
                        <span class="ml-2 px-2 py-1 ${stepTypeConfig.bgColor} ${stepTypeConfig.textColor} text-xs rounded capitalize">${stepConfig.type}</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-2">${stepConfig.description}</p>
                    <div class="text-xs text-gray-500">
                        ${getStepDetailsHtml(stepConfig)}
                    </div>
                </div>
                <div class="flex space-x-2 ml-4">
                    <button class="edit-step-btn p-1 text-gray-400 hover:text-gray-600">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="delete-step-btn p-1 text-gray-400 hover:text-red-600">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        
        // Add to container
        container.appendChild(stepElement);
        
        // Add delete functionality
        stepElement.querySelector('.delete-step-btn').addEventListener('click', function() {
            stepElement.remove();
            updatePipelineStatus();
            
            // Show empty state if no steps left
            if (container.children.length === 0) {
                const emptyState = document.getElementById('emptyPipeline');
                if (emptyState) {
                    emptyState.style.display = 'block';
                }
            }
        });
        
        // Update pipeline status after adding step
        updatePipelineStatus();
        
        console.log("Step added to pipeline:", stepConfig);
    }

    // Helper function to get step type configuration
    function getStepTypeConfig(stepType) {
        const configs = {
            'cleaning': {
                icon: 'fa-broom',
                color: 'text-blue-500',
                bgColor: 'bg-blue-100',
                textColor: 'text-blue-800'
            },
            'filter': {
                icon: 'fa-filter',
                color: 'text-purple-500',
                bgColor: 'bg-purple-100',
                textColor: 'text-purple-800'
            },
            'aggregation': {
                icon: 'fa-chart-bar',
                color: 'text-green-500',
                bgColor: 'bg-green-100',
                textColor: 'text-green-800'
            },
            'feature': {
                icon: 'fa-magic',
                color: 'text-yellow-500',
                bgColor: 'bg-yellow-100',
                textColor: 'text-yellow-800'
            },
            'ml': {
                icon: 'fa-brain',
                color: 'text-indigo-500',
                bgColor: 'bg-indigo-100',
                textColor: 'text-indigo-800'
            },
            'join': {
                icon: 'fa-link',
                color: 'text-red-500',
                bgColor: 'bg-red-100',
                textColor: 'text-red-800'
            }
        };
        
        return configs[stepType] || configs.cleaning;
    }

    // Helper function to generate step details HTML
    function getStepDetailsHtml(stepConfig) {
        if (stepConfig.type === 'cleaning') {
            return getCleaningStepDetails(stepConfig);
        } else {
            return getBasicStepDetails(stepConfig);
        }
    }

    // Get cleaning step details HTML
    function getCleaningStepDetails(stepConfig) {
        const params = stepConfig.parameters;
        let details = '';
        
        switch(stepConfig.operation) {
            case 'handle-missing-values':
                details = `
                    <span class="inline-flex items-center mr-3">
                        <i class="fas fa-cog mr-1"></i> Strategy: ${params.strategy || 'fill'}
                    </span>
                    ${params.columns ? `
                    <span class="inline-flex items-center mr-3">
                        <i class="fas fa-columns mr-1"></i> Columns: ${params.columns.length}
                    </span>
                    ` : ''}
                `;
                break;
                
            case 'remove-duplicates':
                details = `
                    <span class="inline-flex items-center mr-3">
                        <i class="fas fa-copy mr-1"></i> Keep: ${params.keep || 'first'}
                    </span>
                    ${params.subset ? `
                    <span class="inline-flex items-center mr-3">
                        <i class="fas fa-columns mr-1"></i> Checked: ${params.subset.length} columns
                    </span>
                    ` : ''}
                `;
                break;
                
            case 'data-type-conversion':
                details = `
                    <span class="inline-flex items-center mr-3">
                        <i class="fas fa-exchange-alt mr-1"></i> Conversions: ${Object.keys(params.conversions || {}).length}
                    </span>
                `;
                break;
                
            case 'text-cleaning':
                details = `
                    <span class="inline-flex items-center mr-3">
                        <i class="fas fa-font mr-1"></i> Columns: ${params.columns?.length || 0}
                    </span>
                `;
                break;
        }
        
        return details;
    }

    // Get basic step details HTML
    function getBasicStepDetails(stepConfig) {
        const params = stepConfig.parameters;
        return `
            <span class="inline-flex items-center mr-3">
                <i class="fas fa-columns mr-1"></i> Target: ${params.target_column || 'N/A'}
            </span>
            <span class="inline-flex items-center">
                <i class="fas fa-cog mr-1"></i> Operation: ${params.operation_type || 'N/A'}
            </span>
            ${params.fill_value ? `
            <span class="inline-flex items-center ml-3">
                <i class="fas fa-fill-drip mr-1"></i> Fill: ${params.fill_value}
            </span>
            ` : ''}
        `;
    }

    // Function to update pipeline status
    function updatePipelineStatus() {
        let stepCount = document.getElementById('pipelineStepsContainer').children.length;
        const emptyState = document.getElementById('emptyPipeline');
        
        // Don't count the empty state if it's visible
        if (emptyState && emptyState.style.display !== 'none') {
            stepCount -= 1;
        }
        
        const status = document.getElementById('pipelineStatus');
        const stepCountElement = document.getElementById('pipelineStepCount');
        
        stepCountElement.textContent = `(${stepCount} steps)`;
        
        if (stepCount > 0) {
            status.textContent = 'Pipeline ready to be created';
        } else {
            status.textContent = 'Ready to create pipeline';
        }
    }

    // Add event listener for the Save Pipeline button
    document.getElementById('savePipelineBtn').addEventListener('click', function() {
        savePipeline();
    });

// Save pipeline function (make sure it's using the correct structure)
async function savePipeline() {
    const pipelineName = document.getElementById('pipelineName').value;
    const pipelineDescription = document.getElementById('pipelineDescription').value;
    const selectedDataset = document.querySelector('#pipelineDatasetOptions .border-l-indigo-500, #pipelineDatasetOptions .bg-indigo-50');
    
    if (!pipelineName) {
        alert('Please enter a pipeline name');
        return;
    }
    
    if (!selectedDataset) {
        alert('Please select an input dataset');
        return;
    }
    
    const datasetId = selectedDataset.getAttribute('data-dataset-id');
    const steps = getPipelineSteps(); // This should return the steps array
    
    const pipelineData = {
        name: pipelineName,
        description: pipelineDescription,
        input_dataset_id: datasetId,
        workspace_id: 'default-workspace', // or get from your context
        steps: steps.map((step, index) => ({
            step_number: index + 1,
            type: step.type,
            operation: step.operation,
            parameters: step.parameters // Make sure this contains the correct parameters
        }))
    };
    
    console.log('Saving pipeline:', pipelineData);
    
    try {
        const response = await fetch('/api/assistant/api/pipelines/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(pipelineData)
        });
        
        if (response.ok) {
            const result = await response.json();
            showToast('Pipeline created successfully!', 'success');
            closePipelineModal();
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to create pipeline');
        }
    } catch (error) {
        console.error('Error saving pipeline:', error);
        showToast(`Error: ${error.message}`, 'error');
    }
}

    // Function to get current workspace ID
    function getCurrentWorkspaceId() {
        // Try to get workspace ID from various sources:
        
        // 1. From URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const workspaceIdFromUrl = urlParams.get('workspace_id');
        if (workspaceIdFromUrl) return workspaceIdFromUrl;
        
        // 2. From data attribute on body or container
        const bodyWorkspaceId = document.body.getAttribute('data-workspace-id');
        if (bodyWorkspaceId) return bodyWorkspaceId;
        
        // 3. From global variable (if set by your template)
        if (typeof currentWorkspaceId !== 'undefined') {
            return currentWorkspaceId;
        }
        
        // 4. From localStorage (if previously set)
        const storedWorkspaceId = localStorage.getItem('current_workspace_id');
        if (storedWorkspaceId) return storedWorkspaceId;
        
        // 5. Default fallback
        console.warn('No workspace ID found, using default');
        return 'default-workspace';
    }

    // Function to display verification data
    function displayVerificationData(data) {
        const verificationDiv = document.createElement('div');
        verificationDiv.className = 'fixed bottom-4 right-4 bg-white p-4 rounded-lg shadow-lg border border-green-200 max-w-md z-50';
        verificationDiv.innerHTML = `
            <div class="flex justify-between items-start mb-2">
                <h4 class="font-semibold text-green-700"> Pipeline Created Successfully</h4>
                <button onclick="this.parentElement.parentElement.remove()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="text-sm space-y-1">
                <div><strong>Pipeline ID:</strong> ${data.pipeline_id}</div>
                <div><strong>Name:</strong> ${data.pipeline_name}</div>
                <div><strong>Steps:</strong> ${data.step_count}</div>
                <div class="mt-2 text-xs text-gray-600">
                    <strong>Stored in database with full step configuration.</strong>
                </div>
            </div>
            <div class="mt-3 text-xs">
                <button onclick="showDetailedVerification(${JSON.stringify(data).replace(/"/g, '&quot;')})" 
                        class="text-indigo-600 hover:text-indigo-800">
                    View Detailed Verification
                </button>
            </div>
        `;
        
        document.body.appendChild(verificationDiv);
        
        // Auto-remove after 10 seconds
        setTimeout(() => {
            if (verificationDiv.parentElement) {
                verificationDiv.remove();
            }
        }, 10000);
    }

    // Function to show detailed verification
    function showDetailedVerification(data) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-60';
        modal.innerHTML = `
            <div class="bg-white rounded-lg w-full max-w-4xl mx-4 max-h-[80vh] overflow-hidden flex flex-col">
                <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-800">Pipeline Creation Verification</h3>
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto p-6">
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-medium text-gray-800 mb-2">Pipeline Information</h4>
                            <pre class="bg-gray-50 p-3 rounded text-xs overflow-auto">${JSON.stringify(data.stored_data || data, null, 2)}</pre>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-800 mb-2">Server Response</h4>
                            <pre class="bg-gray-50 p-3 rounded text-xs overflow-auto">${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    </div>
                </div>
                <div class="p-4 border-t border-gray-200 bg-gray-50 flex justify-end">
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                            class="px-4 py-2 bg-indigo-600 text-white rounded text-sm font-medium hover:bg-indigo-700">
                        Close
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    }

    // Function to get CSRF token
    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }

    // Function to reset pipeline form
    function resetPipelineForm() {
        document.getElementById('pipelineName').value = '';
        document.getElementById('pipelineDescription').value = '';
        document.getElementById('pipelineStepsContainer').innerHTML = `
            <div id="emptyPipeline" class="text-center py-8 border-2 border-dashed border-gray-300 rounded-lg">
                <i class="fas fa-stream text-gray-400 text-3xl mb-2"></i>
                <p class="text-gray-500 text-sm">No steps added yet</p>
                <p class="text-gray-400 text-xs mt-1">Click "Add Step" to start building your pipeline</p>
            </div>
        `;
        updatePipelineStatus();
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        updatePipelineStatus();
    });
</script>




<script>
    // Global tracking variables
     currentStepType = null;
     currentOperation = null;
    let currentDatasetColumns = [];
    let currentColumnStats = {};
      currentDatasetId = null;
    let currentAggregationOperation = null;

    // Open Pipeline Modal
    document.getElementById('addStepBtn').addEventListener('click', function() {
        const modal = document.getElementById('pipelineModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        
        // Load datasets when modal opens
        loadDatasets();
    });

    // Close Pipeline Modal
    document.getElementById('closePipelineModal').addEventListener('click', function() {
        const modal = document.getElementById('pipelineModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    });

    // Close modal when clicking outside content
    document.getElementById('pipelineModal').addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.add('hidden');
            this.classList.remove('flex');
        }
    });

    // Cancel button
    document.getElementById('cancelPipelineBtn').addEventListener('click', function() {
        const modal = document.getElementById('pipelineModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    });

    // Close Step Configuration Modal
    document.getElementById('closeStepConfigModal').addEventListener('click', function() {
        const modal = document.getElementById('stepConfigModal');
        modal.classList.add('hidden');
    });

    // Close step modal when clicking outside
    document.getElementById('stepConfigModal').addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.add('hidden');
        }
    });

    // Open Step Configuration Modal
    document.getElementById('addStepInsideModalBtn').addEventListener('click', function() {
        const modal = document.getElementById('stepConfigModal');
        modal.classList.remove('hidden');
    });

    // Step type selection
    document.querySelectorAll('.pipeline-step-type-btn').forEach(button => {
        button.addEventListener('click', function() {
            const stepType = this.getAttribute('data-type');
            selectStepType(stepType);
        });
    });

    // Function to load datasets from backend
    async function loadDatasets() {
        const datasetContainer = document.getElementById('pipelineDatasetOptions');
        
        try {
            datasetContainer.innerHTML = `
                <div class="text-center py-4 text-gray-500">
                    <i class="fas fa-spinner fa-spin"></i> Loading datasets...
                </div>
            `;
            
            const response = await fetch('/api/assistant/api/datasets/', {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const result = await response.json();
                
                if (result.success && result.datasets && result.datasets.length > 0) {
                    datasetContainer.innerHTML = `
                        <div class="divide-y divide-gray-200">
                            ${result.datasets.map(dataset => `
                                <div class="p-3 hover:bg-gray-50 cursor-pointer" 
                                     data-dataset-id="${dataset.id}"
                                     data-dataset-name="${dataset.file_name}">
                                    <div class="font-medium text-sm text-gray-800">${dataset.file_name}</div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        ${dataset.row_count || 0} rows  ${dataset.column_count || 0} columns  
                                        Updated ${formatRelativeTime(dataset.updated_at || dataset.created_at)}
                                    </div>
                                    ${dataset.description ? `
                                        <div class="text-xs text-gray-400 mt-1">${dataset.description}</div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                    // Auto-select first dataset
                    const firstDataset = datasetContainer.querySelector('.p-3');
                    if (firstDataset) {
                        firstDataset.classList.add('border-l-indigo-500', 'bg-indigo-50');
                    }
                    
                } else {
                    datasetContainer.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-database text-3xl mb-2"></i>
                            <p class="text-sm">No datasets found</p>
                            <p class="text-xs mt-1">Upload a dataset to get started</p>
                        </div>
                    `;
                }
                
            } else {
                throw new Error('Failed to load datasets');
            }
            
        } catch (error) {
            console.error('Error loading datasets:', error);
            datasetContainer.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-exclamation-triangle text-3xl mb-2"></i>
                    <p class="text-sm">Error loading datasets</p>
                    <p class="text-xs mt-1">Please try again</p>
                </div>
            `;
        }
        
        // Add click handlers to dataset items
        datasetContainer.querySelectorAll('.p-3').forEach(item => {
            item.addEventListener('click', function() {
                // Remove selection from all items
                datasetContainer.querySelectorAll('.p-3').forEach(i => {
                    i.classList.remove('border-l-indigo-500', 'bg-indigo-50');
                });
                // Add selection to clicked item
                this.classList.add('border-l-indigo-500', 'bg-indigo-50');
            });
        });
    }

    // Helper function to format relative time
    function formatRelativeTime(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        
        if (diffDays === 0) return 'today';
        if (diffDays === 1) return 'yesterday';
        if (diffDays < 7) return `${diffDays} days ago`;
        if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
        return `${Math.floor(diffDays / 30)} months ago`;
    }

    // Function to handle step type selection
    function selectStepType(stepType) {
        currentStepType = stepType;
        const operationSection = document.getElementById('pipelineOperationSelection');
        const configSection = document.getElementById('pipelineStepConfig');
        const previewBtn = document.getElementById('previewPipelineStepBtn');
        const addBtn = document.getElementById('addPipelineStepBtn');
        const status = document.getElementById('pipelineStepStatus');
        
        // Show operation selection
        operationSection.classList.remove('hidden');
        
        // Update status
        status.textContent = `Selected: ${getStepTypeName(stepType)} - Choose an operation`;
        
        // Load operations based on step type
        loadOperations(stepType);
        
        // Show buttons
        previewBtn.classList.remove('hidden');
        addBtn.classList.remove('hidden');
    }

    // Function to get step type display name
    function getStepTypeName(stepType) {
        const names = {
            'cleaning': 'Data Cleaning',
            'aggregation': 'Aggregation',
            'filter': 'Filter & Sort',
            'feature': 'Feature Engineering',
            'join': 'Join Operations',
            'ml': 'ML Preparation'
        };
        return names[stepType] || stepType;
    }

// Load operations for step type
function loadOperations(stepType) {
    const operationsGrid = document.getElementById('pipelineOperationsGrid');
    
    const operations = {
        'cleaning': [
            { name: 'Handle Missing Values', icon: 'fa-exclamation-triangle', description: 'Fill or remove missing data' },
            { name: 'Remove Duplicates', icon: 'fa-copy', description: 'Remove duplicate rows' },
            { name: 'Data Type Conversion', icon: 'fa-exchange-alt', description: 'Convert column data types' },
            { name: 'Text Cleaning', icon: 'fa-font', description: 'Clean and normalize text' }
        ],
        'aggregation': [
            { name: 'Group By & Summarize', icon: 'fa-layer-group', description: 'Group data and calculate statistics' },
            { name: 'Pivot Tables', icon: 'fa-table', description: 'Reshape data from long to wide' },
            { name: 'Window Functions', icon: 'fa-chart-line', description: 'Calculate running totals, ranks' },
            { name: 'Rollup & Cube', icon: 'fa-cube', description: 'Multi-level aggregations' }
        ],
        'filter': [
            { name: 'Filter Rows', icon: 'fa-filter', description: 'Filter data based on conditions' },
            { name: 'Sort Data', icon: 'fa-sort', description: 'Sort by one or more columns' },
            { name: 'Select Columns', icon: 'fa-columns', description: 'Choose specific columns to keep' },
            { name: 'Remove Columns', icon: 'fa-times', description: 'Remove unwanted columns' },
            { name: 'Top N Records', icon: 'fa-chart-bar', description: 'Get top/bottom records' },
            { name: 'Random Sampling', icon: 'fa-random', description: 'Get random data sample' }
        ],
        'feature': [
            { name: 'Calculated Columns', icon: 'fa-calculator', description: 'Create new calculated columns' },
            { name: 'Datetime Extraction', icon: 'fa-calendar', description: 'Extract features from dates' },
            { name: 'Text Processing', icon: 'fa-font', description: 'Process and extract text features' },
            { name: 'One-Hot Encoding', icon: 'fa-barcode', description: 'Encode categorical variables' }
        ],
        'ml': [
            { name: 'Train Test Split', icon: 'fa-code-branch', description: 'Split data for ML training' },
            { name: 'Feature Scaling', icon: 'fa-balance-scale', description: 'Scale features for ML' },
            { name: 'Outlier Detection', icon: 'fa-radar', description: 'Detect and handle outliers' },
            { name: 'Cross Validation', icon: 'fa-retweet', description: 'Cross-validation for model evaluation' }
        ],
        'join': [
            { name: 'Inner Join', icon: 'fa-link', description: 'Join matching rows from both datasets' },
            { name: 'Left Join', icon: 'fa-arrow-left', description: 'All rows from left, matching from right' },
            { name: 'Right Join', icon: 'fa-arrow-right', description: 'All rows from right, matching from left' },
            { name: 'Full Join', icon: 'fa-arrows-alt-h', description: 'All rows from both datasets' }
        ]
    };
    
    const stepOperations = operations[stepType] || [
        { name: 'Basic Operation', icon: 'fa-cog', description: 'Configure this operation' }
    ];
    
    operationsGrid.innerHTML = stepOperations.map(op => `
        <button class="pipeline-operation-btn p-3 border border-gray-300 rounded text-sm cursor-pointer hover:bg-gray-50 text-left transition-colors" 
                data-operation="${op.name.toLowerCase().replace(/\s+/g, '-')}">
            <div class="font-medium flex items-center">
                <i class="fas ${op.icon} text-gray-500 mr-2"></i>
                ${op.name}
            </div>
            <div class="text-xs text-gray-500 mt-1">${op.description}</div>
        </button>
    `).join('');
    
    // Add click handlers to operation buttons
    document.querySelectorAll('.pipeline-operation-btn').forEach(button => {
        button.addEventListener('click', function() {
            const operation = this.getAttribute('data-operation');
            selectOperation(currentStepType, operation);
        });
    });
}
    // Function to select operation
function selectOperation(stepType, operation) {
    currentStepType = stepType;
    currentOperation = operation;
    
    const configSection = document.getElementById('pipelineStepConfig');
    const status = document.getElementById('pipelineStepStatus');
    
    // Show configuration section
    configSection.classList.remove('hidden');
    
    // Update status
    status.textContent = `Configuring: ${getStepTypeName(stepType)} - ${getOperationDisplayName(operation)}`;
    
    // Handle different step types
    if (stepType === 'cleaning') {
        openPipelineDataCleaning(operation);
    } else if (stepType === 'aggregation') {
        openPipelineAggregation(operation);
    } else if (stepType === 'filter') {
        openPipelineFilterOperation(operation);
    } else {
        console.log('this is calledf');
        // Use the basic configuration for other step types
        configSection.innerHTML = getBasicOperationConfig(stepType, operation);
    }
    
    console.log('Selected operation:', stepType, operation);
}
// Get top N configuration for pipeline
function getPipelineTopNConfig() {
    return `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Step Name *</label>
                <input type="text" id="stepNameInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" value="Top N Records">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                <textarea id="stepDescriptionInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" rows="2">Get top or bottom records</textarea>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Number of Records</label>
                    <input type="number" id="pipelineTopNCount" value="10" min="1" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Sort Order</label>
                    <select id="pipelineTopNOrder" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="desc">Top (Descending)</option>
                        <option value="asc">Bottom (Ascending)</option>
                    </select>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Sort By Column</label>
                <select id="pipelineTopNColumn" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                    <option value="">Select column</option>
                </select>
            </div>
        </div>
    `;
}

// Get sampling configuration for pipeline
function getPipelineSamplingConfig() {
    return `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Step Name *</label>
                <input type="text" id="stepNameInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" value="Random Sampling">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                <textarea id="stepDescriptionInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" rows="2">Get random sample from dataset</textarea>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Sample Size</label>
                    <input type="number" id="pipelineSampleSize" value="100" min="1" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Sample Type</label>
                    <select id="pipelineSampleType" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="count">Fixed Count</option>
                        <option value="percentage">Percentage</option>
                    </select>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Random Seed (Optional)</label>
                <input type="number" id="pipelineRandomSeed" value="42" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm" placeholder="42">
                <p class="text-xs text-gray-500 mt-1">Same seed produces same random sample for reproducibility</p>
            </div>
        </div>
    `;
}
// Open filter operation configuration in pipeline context
function openPipelineFilterOperation(operation) {
    const configSection = document.getElementById('pipelineStepConfig');
    
    switch(operation) {
        case 'filter-rows':
            configSection.innerHTML = getPipelineFilterConfig();
            break;
        case 'sort-data':
            configSection.innerHTML = getPipelineSortConfig();
            break;
        case 'select-columns':
            configSection.innerHTML = getPipelineSelectColumnsConfig();
            break;
        case 'remove-columns':
            configSection.innerHTML = getPipelineRemoveColumnsConfig();
            break;
        case 'top-n-records':
            configSection.innerHTML = getPipelineTopNConfig();
            break;
        case 'random-sampling':
            configSection.innerHTML = getPipelineSamplingConfig();
            break;
        default:
            configSection.innerHTML = `<div class="text-center py-4 text-gray-500">Configuration for ${operation} coming soon</div>`;
    }
    
    // Load columns for the selected dataset
    const selectedDataset = document.querySelector('#pipelineDatasetOptions .border-l-indigo-500, #pipelineDatasetOptions .bg-indigo-50');
    if (selectedDataset) {
        currentDatasetId = selectedDataset.getAttribute('data-dataset-id');
        loadDatasetColumnsForPipelineFilter(currentDatasetId);
    }
    
    // Show preview button
    document.getElementById('previewPipelineStepBtn').classList.remove('hidden');
    
    // Add event listeners for dynamic sections
    setTimeout(() => {
        addPipelineFilterEventListeners(operation);
    }, 100);
}

// Get filter configuration for pipeline
function getPipelineFilterConfig() {
    return `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Step Name *</label>
                <input type="text" id="stepNameInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" value="Filter Rows">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                <textarea id="stepDescriptionInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" rows="2">Filter data based on conditions</textarea>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Filter Conditions</label>
                <div id="pipelineFilterConditions" class="space-y-3">
                    <div class="text-sm text-gray-500">Add conditions to filter your data</div>
                </div>
                <button id="addPipelineFilterCondition" class="mt-2 text-sm text-indigo-600 hover:text-indigo-800">
                    <i class="fas fa-plus mr-1"></i> Add Filter Condition
                </button>
            </div>
        </div>
    `;
}

// Get sort configuration for pipeline
function getPipelineSortConfig() {
    return `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Step Name *</label>
                <input type="text" id="stepNameInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" value="Sort Data">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                <textarea id="stepDescriptionInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" rows="2">Sort data by multiple columns</textarea>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Sort Columns</label>
                <div id="pipelineSortColumns" class="space-y-3">
                    <div class="text-sm text-gray-500">Add columns to sort by priority</div>
                </div>
                <button id="addPipelineSortColumn" class="mt-2 text-sm text-indigo-600 hover:text-indigo-800">
                    <i class="fas fa-plus mr-1"></i> Add Sort Column
                </button>
            </div>
        </div>
    `;
}

// Get select columns configuration for pipeline
function getPipelineSelectColumnsConfig() {
    return `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Step Name *</label>
                <input type="text" id="stepNameInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" value="Select Columns">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                <textarea id="stepDescriptionInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" rows="2">Choose specific columns to keep</textarea>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Columns to Keep</label>
                <div id="pipelineSelectColumns" class="space-y-2 max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-3">
                    <div class="text-sm text-gray-500">Select columns to include in the output</div>
                </div>
                <div class="mt-2">
                    <button id="selectAllColumns" class="text-sm text-indigo-600 hover:text-indigo-800 mr-3">
                        <i class="fas fa-check-square mr-1"></i> Select All
                    </button>
                    <button id="deselectAllColumns" class="text-sm text-indigo-600 hover:text-indigo-800">
                        <i class="fas fa-square mr-1"></i> Deselect All
                    </button>
                </div>
            </div>
        </div>
    `;
}

// Get remove columns configuration for pipeline
function getPipelineRemoveColumnsConfig() {
    return `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Step Name *</label>
                <input type="text" id="stepNameInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" value="Remove Columns">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                <textarea id="stepDescriptionInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" rows="2">Remove unwanted columns</textarea>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Columns to Remove</label>
                <div id="pipelineRemoveColumns" class="space-y-2 max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-3">
                    <div class="text-sm text-gray-500">Select columns to remove from the dataset</div>
                </div>
                <div class="mt-2">
                    <button id="selectAllRemoveColumns" class="text-sm text-indigo-600 hover:text-indigo-800 mr-3">
                        <i class="fas fa-check-square mr-1"></i> Select All
                    </button>
                    <button id="deselectAllRemoveColumns" class="text-sm text-indigo-600 hover:text-indigo-800">
                        <i class="fas fa-square mr-1"></i> Deselect All
                    </button>
                </div>
            </div>
        </div>
    `;
}

// Add event listeners for pipeline filter operations
function addPipelineFilterEventListeners(operation) {
    switch(operation) {
        case 'filter-rows':
            document.getElementById('addPipelineFilterCondition').addEventListener('click', function() {
                addPipelineFilterCondition();
            });
            break;
        case 'sort-data':
            document.getElementById('addPipelineSortColumn').addEventListener('click', function() {
                addPipelineSortColumn();
            });
            break;
        case 'select-columns':
            document.getElementById('selectAllColumns').addEventListener('click', function() {
                document.querySelectorAll('#pipelineSelectColumns input[type="checkbox"]').forEach(cb => {
                    cb.checked = true;
                });
            });
            document.getElementById('deselectAllColumns').addEventListener('click', function() {
                document.querySelectorAll('#pipelineSelectColumns input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                });
            });
            break;
        case 'remove-columns':
            document.getElementById('selectAllRemoveColumns').addEventListener('click', function() {
                document.querySelectorAll('#pipelineRemoveColumns input[type="checkbox"]').forEach(cb => {
                    cb.checked = true;
                });
            });
            document.getElementById('deselectAllRemoveColumns').addEventListener('click', function() {
                document.querySelectorAll('#pipelineRemoveColumns input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                });
            });
            break;
        case 'top-n-records':
        case 'random-sampling':
            // No additional event listeners needed for these operations
            break;
    }
}
// Get pipeline step parameters - CORRECTED VERSION
function getPipelineStepParameters() {
    const stepName = document.getElementById('stepNameInput')?.value || 'Unnamed Step';
    const stepDescription = document.getElementById('stepDescriptionInput')?.value || '';
    
    let parameters = {};
    
    // Add operation-specific parameters
    switch(currentOperation) {
        case 'filter-rows':
            parameters = getPipelineFilterParameters();
            break;
        case 'sort-data':
            parameters = getPipelineSortParameters();
            break;
        case 'select-columns':
            parameters = getPipelineSelectColumnsParameters();
            break;
        case 'remove-columns':
            parameters = getPipelineRemoveColumnsParameters();
            break;
        case 'top-n-records':
            parameters = getPipelineTopNParameters();
            break;
        case 'random-sampling':
            parameters = getPipelineSamplingParameters();
            break;
        default:
            // For other operations, use basic parameters
            const targetColumn = document.getElementById('targetColumnSelect')?.value || '';
            const operationType = document.getElementById('operationTypeSelect')?.value || '';
            const fillValue = document.getElementById('fillValueInput')?.value || '';
            
            parameters = {
                target_column: targetColumn,
                operation_type: operationType,
                fill_value: fillValue
            };
    }
    
    return {
        step_name: stepName,
        step_description: stepDescription,
        operation_type: currentOperation,
        parameters: parameters
    };
}

// Get top N parameters
function getPipelineTopNParameters() {
    const count = document.getElementById('pipelineTopNCount')?.value;
    const order = document.getElementById('pipelineTopNOrder')?.value;
    const column = document.getElementById('pipelineTopNColumn')?.value;
    
    if (!count || count < 1) {
        throw new Error('Please enter a valid number of records');
    }
    
    if (!column) {
        throw new Error('Please select a column to sort by');
    }
    
    return {
        n_records: parseInt(count),
        sort_order: order || 'desc',
        sort_by: column
    };
}

// Get sampling parameters
function getPipelineSamplingParameters() {
    const sampleSize = document.getElementById('pipelineSampleSize')?.value;
    const sampleType = document.getElementById('pipelineSampleType')?.value;
    const randomSeed = document.getElementById('pipelineRandomSeed')?.value;
    
    if (!sampleSize || sampleSize < 1) {
        throw new Error('Please enter a valid sample size');
    }
    
    const params = {
        sample_size: parseInt(sampleSize),
        sample_type: sampleType || 'count'
    };
    
    if (randomSeed) {
        params.random_state = parseInt(randomSeed);
    }
    
    return params;
}
// Load dataset columns for pipeline filter operations
async function loadDatasetColumnsForPipelineFilter(datasetId) {
    if (!datasetId) {
        currentDatasetColumns = [];
        updatePipelineFilterColumnLists();
        return;
    }
    
    try {
        const response = await fetch(`/api/assistant/api/dataset/${datasetId}/columns/`, {
            method: "GET",
            headers: {
                "X-CSRFToken": getCsrfToken(),
                "Content-Type": "application/json"
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            currentDatasetColumns = result.columns;
            
            // Load column statistics
            await loadPipelineColumnStatistics(datasetId);
            
            updatePipelineFilterColumnLists();
        }
        
    } catch (error) {
        console.error('Error loading columns for pipeline filter:', error);
    }
}

// Update column lists for filter operations
function updatePipelineFilterColumnLists() {
    if (!currentOperation || currentDatasetColumns.length === 0) return;
    
    switch(currentOperation) {
        case 'filter-rows':
            // Initialize filter conditions if empty
            const filterContainer = document.getElementById('pipelineFilterConditions');
            if (filterContainer && filterContainer.children.length <= 1) {
                filterContainer.innerHTML = '';
                addPipelineFilterCondition();
            }
            break;
        case 'sort-data':
            // Initialize sort columns if empty
            const sortContainer = document.getElementById('pipelineSortColumns');
            if (sortContainer && sortContainer.children.length <= 1) {
                sortContainer.innerHTML = '';
                addPipelineSortColumn();
            }
            break;
        case 'select-columns':
            updatePipelineSelectColumnsList();
            break;
        case 'remove-columns':
            updatePipelineRemoveColumnsList();
            break;
        case 'top-n-records':
            updatePipelineTopNColumnOptions();
            break;
        case 'random-sampling':
            // No column list updates needed for sampling
            break;
    }
}

// Update top N column options
function updatePipelineTopNColumnOptions() {
    const select = document.getElementById('pipelineTopNColumn');
    if (!select) return;
    
    select.innerHTML = '<option value="">Select column</option>';
    currentDatasetColumns.forEach(column => {
        const option = document.createElement('option');
        option.value = column;
        option.textContent = column;
        select.appendChild(option);
    });
}
// Add pipeline filter condition
function addPipelineFilterCondition() {
    const container = document.getElementById('pipelineFilterConditions');
    const id = Date.now();
    
    const div = document.createElement('div');
    div.className = 'border border-gray-200 rounded-lg p-4';
    div.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-end">
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Column</label>
                <select class="pipeline-filter-column-select w-full border border-gray-300 rounded px-2 py-1 text-sm">
                    <option value="">Select column</option>
                    ${currentDatasetColumns.map(col => {
                        const stats = currentColumnStats[col];
                        const typeInfo = stats ? ` (${stats.dtype})` : '';
                        return `<option value="${col}">${col}${typeInfo}</option>`;
                    }).join('')}
                </select>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Operator</label>
                <select class="pipeline-filter-operator-select w-full border border-gray-300 rounded px-2 py-1 text-sm">
                    <option value="equals">Equals</option>
                    <option value="not_equals">Not Equals</option>
                    <option value="contains">Contains</option>
                    <option value="starts_with">Starts With</option>
                    <option value="ends_with">Ends With</option>
                    <option value="greater_than">Greater Than</option>
                    <option value="less_than">Less Than</option>
                    <option value="greater_than_equal">Greater Than or Equal</option>
                    <option value="less_than_equal">Less Than or Equal</option>
                    <option value="is_null">Is Null</option>
                    <option value="not_null">Is Not Null</option>
                    <option value="in_list">In List</option>
                    <option value="not_in_list">Not In List</option>
                    <option value="between">Between</option>
                </select>
            </div>
            <div class="pipeline-filter-value-container">
                <label class="block text-xs font-medium text-gray-700 mb-1">Value</label>
                <input type="text" class="pipeline-filter-value-input w-full border border-gray-300 rounded px-2 py-1 text-sm" placeholder="Enter value">
                <div class="pipeline-filter-value-help text-xs text-gray-500 mt-1 hidden"></div>
                <div class="pipeline-filter-data-type text-xs text-blue-600 mt-1 hidden"></div>
            </div>
            <div>
                <button class="pipeline-remove-filter-condition text-red-600 hover:text-red-800 text-sm w-full py-1">
                    <i class="fas fa-times mr-1"></i> Remove
                </button>
            </div>
        </div>
    `;
    container.appendChild(div);
    
    // Add event listeners
    const columnSelect = div.querySelector('.pipeline-filter-column-select');
    const operatorSelect = div.querySelector('.pipeline-filter-operator-select');
    const valueContainer = div.querySelector('.pipeline-filter-value-container');
    const valueInput = div.querySelector('.pipeline-filter-value-input');
    const helpText = div.querySelector('.pipeline-filter-value-help');
    const dataTypeText = div.querySelector('.pipeline-filter-data-type');
    
    function updateFilterValueVisibility() {
        const operator = operatorSelect.value;
        const showValue = !['is_null', 'not_null'].includes(operator);
        valueContainer.style.display = showValue ? 'block' : 'none';
        
        // Update help text
        if (operator === 'in_list' || operator === 'not_in_list') {
            helpText.textContent = 'Enter comma-separated values';
            helpText.classList.remove('hidden');
        } else if (operator === 'between') {
            helpText.textContent = 'Enter two values separated by comma';
            helpText.classList.remove('hidden');
        } else {
            helpText.classList.add('hidden');
        }
        
        // Update data type info
        const selectedColumn = columnSelect.value;
        if (selectedColumn && currentColumnStats[selectedColumn]) {
            const stats = currentColumnStats[selectedColumn];
            dataTypeText.textContent = `Data type: ${stats.dtype}`;
            dataTypeText.classList.remove('hidden');
            
            // Set input type based on data type for better UX
            if (stats.dtype.includes('int') || stats.dtype.includes('float')) {
                valueInput.type = 'number';
                valueInput.step = stats.dtype.includes('int') ? '1' : '0.1';
            } else {
                valueInput.type = 'text';
            }
        } else {
            dataTypeText.classList.add('hidden');
        }
    }
    
    columnSelect.addEventListener('change', updateFilterValueVisibility);
    operatorSelect.addEventListener('change', updateFilterValueVisibility);
    div.querySelector('.pipeline-remove-filter-condition').addEventListener('click', function() {
        div.remove();
    });
    
    updateFilterValueVisibility();
}

// Add pipeline sort column
function addPipelineSortColumn() {
    const container = document.getElementById('pipelineSortColumns');
    const id = Date.now();
    
    const div = document.createElement('div');
    div.className = 'border border-gray-200 rounded-lg p-4';
    div.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Column</label>
                <select class="pipeline-sort-column-select w-full border border-gray-300 rounded px-2 py-1 text-sm">
                    <option value="">Select column</option>
                    ${currentDatasetColumns.map(col => 
                        `<option value="${col}">${col}</option>`
                    ).join('')}
                </select>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Order</label>
                <select class="pipeline-sort-order-select w-full border border-gray-300 rounded px-2 py-1 text-sm">
                    <option value="asc">Ascending (A-Z, 0-9)</option>
                    <option value="desc">Descending (Z-A, 9-0)</option>
                </select>
            </div>
            <div>
                <button class="pipeline-remove-sort-column text-red-600 hover:text-red-800 text-sm w-full py-1">
                    <i class="fas fa-times mr-1"></i> Remove
                </button>
            </div>
        </div>
    `;
    container.appendChild(div);
    
    // Add remove event listener
    div.querySelector('.pipeline-remove-sort-column').addEventListener('click', function() {
        div.remove();
    });
}

// Update select columns list
function updatePipelineSelectColumnsList() {
    const container = document.getElementById('pipelineSelectColumns');
    if (!container) return;
    
    container.innerHTML = '';
    
    currentDatasetColumns.forEach(column => {
        const div = document.createElement('div');
        div.className = 'flex items-center';
        div.innerHTML = `
            <input type="checkbox" id="select_col_${column}" value="${column}" class="mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked>
            <label for="select_col_${column}" class="text-sm text-gray-700">${column}</label>
        `;
        container.appendChild(div);
    });
}

// Update remove columns list
function updatePipelineRemoveColumnsList() {
    const container = document.getElementById('pipelineRemoveColumns');
    if (!container) return;
    
    container.innerHTML = '';
    
    currentDatasetColumns.forEach(column => {
        const div = document.createElement('div');
        div.className = 'flex items-center';
        div.innerHTML = `
            <input type="checkbox" id="remove_col_${column}" value="${column}" class="mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
            <label for="remove_col_${column}" class="text-sm text-gray-700">${column}</label>
        `;
        container.appendChild(div);
    });
}

function getOperationDisplayName(operation) {
    const names = {
        'group-by-&-summarize': 'Group By & Summarize',
        'pivot-tables': 'Pivot Tables',
        'window-functions': 'Window Functions',
        'rollup-&-cube': 'Rollup & Cube',
        'handle-missing-values': 'Handle Missing Values',
        'remove-duplicates': 'Remove Duplicates',
        'data-type-conversion': 'Data Type Conversion',
        'text-cleaning': 'Text Cleaning',
        'filter-rows': 'Filter Rows',
        'sort-data': 'Sort Data',
        'select-columns': 'Select Columns',
        'remove-columns': 'Remove Columns',
        'top-n-records': 'Top N Records',
        'random-sampling': 'Random Sampling'
    };
    return names[operation] || operation;
}

    // AGGREGATION FUNCTIONS

    // Open aggregation configuration in pipeline context
    function openPipelineAggregation(operation) {
        currentAggregationOperation = operation;
        
        const configSection = document.getElementById('pipelineStepConfig');
        configSection.innerHTML = getPipelineAggregationConfig(operation);
        
        // Update status
        document.getElementById('pipelineStepStatus').textContent = `Configuring: ${getAggregationOperationName(operation)}`;
        
        // Load columns for the selected dataset
        const selectedDataset = document.querySelector('#pipelineDatasetOptions .border-l-indigo-500, #pipelineDatasetOptions .bg-indigo-50');
        if (selectedDataset) {
            currentDatasetId = selectedDataset.getAttribute('data-dataset-id');
            console.log('Selected dataset ID for aggregation:', currentDatasetId);
            loadDatasetColumnsForPipelineAggregation(currentDatasetId);
        } else {
            console.warn('No dataset selected for aggregation');
            document.getElementById('pipelineStepStatus').textContent = 'Error: Please select a dataset first';
            return;
        }
        
        // Show preview button
        document.getElementById('previewPipelineStepBtn').classList.remove('hidden');
        
        // Add event listeners for dynamic sections
        setTimeout(() => {
            addPipelineAggregationEventListeners(operation);
        }, 100);
    }

    // Get pipeline-specific aggregation configuration
    function getPipelineAggregationConfig(operation) {
        switch(operation) {
            case 'group-by-&-summarize':
                return `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Step Name *</label>
                            <input type="text" id="stepNameInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" value="Group By & Summarize">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                            <textarea id="stepDescriptionInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" rows="2">Group data and calculate aggregate statistics</textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Group By Columns</label>
                            <div class="mb-3">
                                <label class="flex items-center">
                                    <input type="checkbox" id="pipelineNoGrouping" class="mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="text-sm text-gray-700">No grouping (aggregate entire dataset)</span>
                                </label>
                            </div>
                            <div id="pipelineGroupByColumns" class="space-y-2 max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-3">
                                <div class="text-sm text-gray-500">Loading columns...</div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Aggregation Operations</label>
                            <div id="pipelineAggregationOperations" class="space-y-3">
                                <div class="text-sm text-gray-500">Select columns and operations for aggregation</div>
                            </div>
                            <button id="addAggregationColumn" class="mt-2 text-sm text-indigo-600 hover:text-indigo-800">
                                <i class="fas fa-plus mr-1"></i> Add Aggregation Column
                            </button>
                        </div>
                    </div>
                `;
                
            case 'pivot-tables':
                return `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Step Name *</label>
                            <input type="text" id="stepNameInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" value="Pivot Table">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                            <textarea id="stepDescriptionInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" rows="2">Create pivot table from data</textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Index Columns (Rows)</label>
                            <div id="pipelinePivotIndexColumns" class="space-y-2 max-h-32 overflow-y-auto border border-gray-200 rounded-lg p-3">
                                <div class="text-sm text-gray-500">Select rows for pivot table</div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Column Columns (Columns)</label>
                            <div id="pipelinePivotColumnColumns" class="space-y-2 max-h-32 overflow-y-auto border border-gray-200 rounded-lg p-3">
                                <div class="text-sm text-gray-500">Select columns for pivot table headers (optional)</div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Value Columns</label>
                            <div id="pipelinePivotValueColumns" class="space-y-2 max-h-32 overflow-y-auto border border-gray-200 rounded-lg p-3">
                                <div class="text-sm text-gray-500">Select numeric columns to aggregate</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Aggregation Function</label>
                                <select id="pipelinePivotAggFunc" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                    <option value="mean">Mean</option>
                                    <option value="sum">Sum</option>
                                    <option value="count">Count</option>
                                    <option value="min">Minimum</option>
                                    <option value="max">Maximum</option>
                                    <option value="median">Median</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Fill Missing Values With</label>
                                <input type="text" id="pipelinePivotFillValue" value="0" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                            </div>
                        </div>
                    </div>
                `;
                
            default:
                return `<div class="text-center py-4 text-gray-500">Configuration for ${operation} not available</div>`;
        }
    }

    // Load dataset columns for pipeline aggregation
    async function loadDatasetColumnsForPipelineAggregation(datasetId) {
        if (!datasetId) {
            console.error('No dataset ID provided for aggregation');
            currentDatasetColumns = [];
            updatePipelineAggregationColumnLists();
            return;
        }
        
        try {
            // Load columns
            const columnsResponse = await fetch(`/api/assistant/api/dataset/${datasetId}/columns/`, {
                method: "GET",
                headers: {
                    "X-CSRFToken": getCsrfToken(),
                    "Content-Type": "application/json"
                }
            });
            
            if (columnsResponse.ok) {
                const result = await columnsResponse.json();
                currentDatasetColumns = result.columns;
                console.log('Loaded columns for aggregation:', currentDatasetColumns);
                
                // Load column statistics
                await loadPipelineColumnStatistics(datasetId);
                
                updatePipelineAggregationColumnLists();
            } else {
                console.error('Failed to load columns for dataset:', datasetId);
            }
            
        } catch (error) {
            console.error('Error loading columns for pipeline aggregation:', error);
        }
    }

    // Load column statistics for pipeline
    async function loadPipelineColumnStatistics(datasetId) {
        try {
            const response = await fetch('/api/assistant/api/aggregation/statistics/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ dataset_id: datasetId })
            });
            
            if (response.ok) {
                const result = await response.json();
                currentColumnStats = result.statistics || {};
                console.log('Loaded column statistics:', currentColumnStats);
            }
        } catch (error) {
            console.error('Error loading statistics:', error);
            currentColumnStats = {};
        }
    }

    // Update column lists in pipeline aggregation configuration
    function updatePipelineAggregationColumnLists() {
        if (!currentAggregationOperation || currentDatasetColumns.length === 0) {
            console.warn('Cannot update aggregation columns: no operation or columns available');
            return;
        }
        
        const numericColumns = currentDatasetColumns.filter(col => {
            const stats = currentColumnStats[col];
            return stats && (stats.dtype.includes('int') || stats.dtype.includes('float'));
        });
        
        const textColumns = currentDatasetColumns.filter(col => {
            const stats = currentColumnStats[col];
            return stats && stats.dtype === 'object';
        });
        
        console.log('Numeric columns:', numericColumns);
        console.log('Text columns:', textColumns);
        
        switch(currentAggregationOperation) {
            case 'group-by-&-summarize':
                updatePipelineGroupByColumnLists(numericColumns, textColumns);
                break;
            case 'pivot-tables':
                updatePipelinePivotColumnLists(numericColumns, textColumns);
                break;
        }
    }

    // Update group by column lists
// FIXED: Update group by column lists - Ensure default aggregation
function updatePipelineGroupByColumnLists(numericColumns, textColumns) {
    // Group by columns (all columns)
    const groupContainer = document.getElementById('pipelineGroupByColumns');
    if (groupContainer) {
        groupContainer.innerHTML = '';
        
        currentDatasetColumns.forEach(column => {
            const div = document.createElement('div');
            div.className = 'flex items-center';
            div.innerHTML = `
                <input type="checkbox" id="pipeline_gb_${column}" value="${column}" class="mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                <label for="pipeline_gb_${column}" class="text-sm text-gray-700">${column}</label>
            `;
            groupContainer.appendChild(div);
        });
    }
    
    // Aggregation operations - CLEAR and CREATE at least one
    const aggContainer = document.getElementById('pipelineAggregationOperations');
    if (aggContainer) {
        aggContainer.innerHTML = ''; // Clear existing
        
        // Always add at least one aggregation column
        const defaultColumn = numericColumns.length > 0 ? numericColumns[0] : 
                            currentDatasetColumns.length > 0 ? currentDatasetColumns[0] : '';
        
        if (defaultColumn) {
            addPipelineAggregationColumn(defaultColumn);
        } else {
            // If no columns available yet, add empty one
            addPipelineAggregationColumn();
        }
    }
}


    // Add aggregation column with default operations
// FIXED: Add aggregation column with proper default operations
function addPipelineAggregationColumn(defaultColumn = '') {
    const container = document.getElementById('pipelineAggregationOperations');
    const id = Date.now();
    
    // If no default column provided, try to find one
    if (!defaultColumn && currentDatasetColumns.length > 0) {
        // Prefer numeric columns for aggregation
        const numericColumns = currentDatasetColumns.filter(col => {
            const stats = currentColumnStats[col];
            return stats && (stats.dtype.includes('int') || stats.dtype.includes('float'));
        });
        defaultColumn = numericColumns.length > 0 ? numericColumns[0] : currentDatasetColumns[0];
    }
    
    const div = document.createElement('div');
    div.className = 'border border-gray-200 rounded-lg p-3';
    div.innerHTML = `
        <div class="flex items-start space-x-3">
            <div class="flex-1">
                <label class="block text-xs font-medium text-gray-700 mb-1">Column *</label>
                <select class="pipeline-agg-column-select w-full border border-gray-300 rounded px-2 py-1 text-sm" required>
                    <option value="">Select column</option>
                    ${currentDatasetColumns.map(col => 
                        `<option value="${col}" ${col === defaultColumn ? 'selected' : ''}>${col}</option>`
                    ).join('')}
                </select>
            </div>
            <div class="flex-1">
                <label class="block text-xs font-medium text-gray-700 mb-1">Operations *</label>
                <div class="space-y-1 max-h-32 overflow-y-auto border border-gray-200 rounded p-2">
                    ${[
                        {value: 'sum', label: 'Sum', default: false},
                        {value: 'mean', label: 'Mean', default: false},
                        {value: 'count', label: 'Count', default: true},
                        {value: 'min', label: 'Minimum', default: false},
                        {value: 'max', label: 'Maximum', default: false},
                        {value: 'median', label: 'Median', default: false},
                        {value: 'std', label: 'Standard Deviation', default: false},
                        {value: 'unique_count', label: 'Unique Count', default: false}
                    ].map(op => `
                        <label class="flex items-center">
                            <input type="checkbox" value="${op.value}" 
                                   class="mr-1 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" 
                                   ${op.default ? 'checked' : ''}>
                            <span class="text-xs">${op.label}</span>
                        </label>
                    `).join('')}
                </div>
                <div class="text-xs text-gray-500 mt-1">At least one operation required</div>
            </div>
            <button class="pipeline-remove-agg-column text-red-600 hover:text-red-800 mt-6" type="button">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    container.appendChild(div);
    
    // Add remove event listener, but don't allow removal if it's the only one
    const removeBtn = div.querySelector('.pipeline-remove-agg-column');
    removeBtn.addEventListener('click', function() {
        if (container.children.length > 1) {
            div.remove();
        } else {
            alert('At least one aggregation column is required');
        }
    });
    
    // Add validation on column change
    const columnSelect = div.querySelector('.pipeline-agg-column-select');
    columnSelect.addEventListener('change', function() {
        if (!this.value) {
            this.classList.add('border-red-300');
        } else {
            this.classList.remove('border-red-300');
        }
    });
}

    // Update pivot column lists
    function updatePipelinePivotColumnLists(numericColumns, textColumns) {
        // Index columns (typically text columns)
        const indexContainer = document.getElementById('pipelinePivotIndexColumns');
        if (indexContainer) {
            indexContainer.innerHTML = '';
            
            textColumns.forEach(column => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                div.innerHTML = `
                    <input type="checkbox" id="pipeline_pivot_idx_${column}" value="${column}" class="mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                    <label for="pipeline_pivot_idx_${column}" class="text-sm text-gray-700">${column}</label>
                `;
                indexContainer.appendChild(div);
            });
        }
        
        // Column columns (typically text columns with few unique values)
        const colContainer = document.getElementById('pipelinePivotColumnColumns');
        if (colContainer) {
            colContainer.innerHTML = '';
            
            textColumns.forEach(column => {
                const stats = currentColumnStats[column];
                const div = document.createElement('div');
                div.className = 'flex items-center';
                div.innerHTML = `
                    <input type="checkbox" id="pipeline_pivot_col_${column}" value="${column}" class="mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                    <label for="pipeline_pivot_col_${column}" class="text-sm text-gray-700">${column}</label>
                    <span class="ml-2 text-xs text-gray-400">(${stats?.unique_count || '?'} unique)</span>
                `;
                colContainer.appendChild(div);
            });
        }
        
        // Value columns (numeric columns)
        const valueContainer = document.getElementById('pipelinePivotValueColumns');
        if (valueContainer) {
            valueContainer.innerHTML = '';
            
            numericColumns.forEach(column => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                div.innerHTML = `
                    <input type="checkbox" id="pipeline_pivot_val_${column}" value="${column}" class="mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                    <label for="pipeline_pivot_val_${column}" class="text-sm text-gray-700">${column}</label>
                `;
                valueContainer.appendChild(div);
            });
        }
    }

    // Add event listeners for pipeline aggregation configuration
    function addPipelineAggregationEventListeners(operation) {
        switch(operation) {
            case 'group-by-&-summarize':
                document.getElementById('addAggregationColumn').addEventListener('click', function() {
                    addPipelineAggregationColumn();
                });
                
                // No grouping checkbox
                const noGroupingCheckbox = document.getElementById('pipelineNoGrouping');
                if (noGroupingCheckbox) {
                    noGroupingCheckbox.addEventListener('change', function() {
                        const groupContainer = document.getElementById('pipelineGroupByColumns');
                        if (groupContainer) {
                            if (this.checked) {
                                groupContainer.style.opacity = '0.5';
                                groupContainer.style.pointerEvents = 'none';
                                // Uncheck all group columns
                                document.querySelectorAll('#pipelineGroupByColumns input[type="checkbox"]').forEach(cb => {
                                    cb.checked = false;
                                });
                            } else {
                                groupContainer.style.opacity = '1';
                                groupContainer.style.pointerEvents = 'auto';
                            }
                        }
                    });
                }
                break;
        }
    }

    // Get aggregation parameters for pipeline step
// FIXED: Get aggregation parameters for pipeline step
function getPipelineAggregationParameters() {
    const params = {};
    
    switch(currentAggregationOperation) {
        case 'group-by-&-summarize':
            // Get group by columns
            const noGrouping = document.getElementById('pipelineNoGrouping')?.checked;
            if (!noGrouping) {
                const groupColumns = Array.from(document.querySelectorAll('#pipelineGroupByColumns input:checked'))
                    .map(cb => cb.value)
                    .filter(col => col && col !== 'undefined'); // Remove empty and undefined values
                
                if (groupColumns.length > 0) {
                    params.group_columns = groupColumns;
                }
            }
            
            // Get aggregation operations - FIXED: Properly collect from checkboxes
            params.aggregations = [];
            
            // Get all aggregation entries
            const aggregationEntries = document.querySelectorAll('#pipelineAggregationOperations .border-gray-200');
            
            aggregationEntries.forEach(entry => {
                const columnSelect = entry.querySelector('.pipeline-agg-column-select');
                const column = columnSelect ? columnSelect.value : '';
                
                if (column && column !== '') {
                    // Get all checked operation checkboxes within this entry
                    const operationCheckboxes = entry.querySelectorAll('input[type="checkbox"]:checked');
                    const operations = Array.from(operationCheckboxes)
                        .map(cb => cb.value)
                        .filter(op => op && op !== 'undefined'); // Remove empty values
                    
                    console.log(`Column: ${column}, Operations found:`, operations);
                    
                    if (operations.length > 0) {
                        params.aggregations.push({
                            column: column,
                            operations: operations
                        });
                    } else {
                        // If no operations selected, default to count
                        params.aggregations.push({
                            column: column,
                            operations: ['count']
                        });
                    }
                }
            });
            
            // DEBUG: Log what we collected
            console.log('DEBUG - Aggregations collected:', params.aggregations);
            console.log('DEBUG - Number of aggregation entries found:', aggregationEntries.length);
            
            // If no aggregations found after processing, throw error
            if (!params.aggregations || params.aggregations.length === 0) {
                throw new Error('At least one aggregation operation is required. Please select a column and operations.');
            }
            
            console.log('Final Group By Parameters:', params);
            break;
            
        case 'pivot-tables':
            params.index_columns = Array.from(document.querySelectorAll('#pipelinePivotIndexColumns input:checked'))
                .map(cb => cb.value)
                .filter(col => col && col !== 'undefined');
                
            params.column_columns = Array.from(document.querySelectorAll('#pipelinePivotColumnColumns input:checked'))
                .map(cb => cb.value)
                .filter(col => col && col !== 'undefined');
                
            params.value_columns = Array.from(document.querySelectorAll('#pipelinePivotValueColumns input:checked'))
                .map(cb => cb.value)
                .filter(col => col && col !== 'undefined');
                
            params.agg_func = document.getElementById('pipelinePivotAggFunc')?.value || 'mean';
            params.fill_value = document.getElementById('pipelinePivotFillValue')?.value || '0';
            
            // Add validation for pivot tables
            if (params.index_columns.length === 0) {
                throw new Error('Please select at least one index column for the pivot table');
            }
            if (params.value_columns.length === 0) {
                throw new Error('Please select at least one value column for the pivot table');
            }
            
            console.log('Pivot Table Parameters:', params);
            break;
            
        case 'window-functions':
            params.partition_columns = Array.from(document.querySelectorAll('#pipelineWindowPartitionColumns input:checked'))
                .map(cb => cb.value)
                .filter(col => col && col !== 'undefined');
                
            params.order_columns = Array.from(document.querySelectorAll('#pipelineWindowOrderColumns input:checked'))
                .map(cb => cb.value)
                .filter(col => col && col !== 'undefined');
            
            params.window_functions = [];
            document.querySelectorAll('#pipelineWindowFunctions .border-gray-200').forEach(entry => {
                const targetSelect = entry.querySelector('.pipeline-win-target-select');
                const functionSelect = entry.querySelector('.pipeline-win-function-select');
                const newColInput = entry.querySelector('.pipeline-win-new-col');
                
                const target = targetSelect ? targetSelect.value : '';
                const funcType = functionSelect ? functionSelect.value : '';
                const newCol = newColInput ? newColInput.value : '';
                
                if (target && target !== '' && funcType && funcType !== '') {
                    const functionConfig = {
                        target_column: target,
                        function_type: funcType,
                        new_column_name: newCol || `${target}_${funcType}`
                    };
                    
                    // Add parameters
                    if (['lag', 'lead'].includes(funcType)) {
                        const periodsInput = entry.querySelector('input[type="number"]');
                        functionConfig.periods = periodsInput ? parseInt(periodsInput.value) || 1 : 1;
                    } else if (['rolling_mean', 'rolling_sum'].includes(funcType)) {
                        const windowSizeInput = entry.querySelector('input[type="number"]');
                        functionConfig.window_size = windowSizeInput ? parseInt(windowSizeInput.value) || 3 : 3;
                    }
                    
                    params.window_functions.push(functionConfig);
                }
            });
            
            // Add validation for window functions
            if (params.window_functions.length === 0) {
                throw new Error('Please add at least one window function');
            }
            
            console.log('Window Functions Parameters:', params);
            break;
    }
    
    return params;
}

    // Preview functionality for pipeline aggregation
    async function previewPipelineAggregationStep() {
        const selectedDataset = document.querySelector('#pipelineDatasetOptions .border-l-indigo-500, #pipelineDatasetOptions .bg-indigo-50');
        if (!selectedDataset) {
            alert('Please select a dataset first');
            return;
        }
        
        const datasetId = selectedDataset.getAttribute('data-dataset-id');
        if (!datasetId || !currentAggregationOperation) {
            alert('Please select a dataset and configure the operation first');
            return;
        }
        
        console.log('Preview aggregation - Dataset ID:', datasetId, 'Operation:', currentAggregationOperation);
        
        try {
            document.getElementById('pipelineStepStatus').textContent = 'Generating preview...';
            document.getElementById('previewPipelineStepBtn').disabled = true;
            
            let aggregationParams;
            try {
                aggregationParams = getPipelineAggregationParameters();
            } catch (paramError) {
                alert(`Configuration Error: ${paramError.message}`);
                document.getElementById('pipelineStepStatus').textContent = 'Configuration error';
                return;
            }
            
            const requestData = {
                dataset_id: datasetId,
                preview_only: true,
                operation_type: mapPipelineAggregationToBackend(currentAggregationOperation),
                ...aggregationParams
            };
            
            console.log('Sending aggregation preview request:', requestData);
            
            const response = await fetch('/api/assistant/api/aggregation/preview/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });
            
            if (response.ok) {
                const result = await response.json();
                displayPipelinePreview(result);
                document.getElementById('pipelineStepStatus').textContent = 'Preview ready';
            } else {
                const errorData = await response.json();
                throw new Error(errorData.error || `Server error: ${response.status}`);
            }
            
        } catch (error) {
            console.error('Error previewing aggregation step:', error);
            alert(`Error generating preview: ${error.message}`);
            document.getElementById('pipelineStepStatus').textContent = 'Error generating preview';
        } finally {
            document.getElementById('previewPipelineStepBtn').disabled = false;
        }
    }

    // Map pipeline aggregation operations to backend operations
    function mapPipelineAggregationToBackend(pipelineOperation) {
        const mapping = {
            'group-by-&-summarize': 'groupby',
            'pivot-tables': 'pivot',
            'window-functions': 'window',
            'rollup-&-cube': 'rollup'
        };
        return mapping[pipelineOperation] || pipelineOperation;
    }

// Display pipeline preview results
function displayPipelinePreview(result) {
    const previewSection = document.getElementById('pipelineStepPreview');
    const headersContainer = document.getElementById('pipelinePreviewHeaders');
    const bodyContainer = document.getElementById('pipelinePreviewBody');
    const previewInfo = document.getElementById('pipelinePreviewInfo');
    
    // Show preview section
    previewSection.classList.remove('hidden');
    
    // Update preview info
    let infoText = `Preview: ${result.preview_data?.length || 0} rows`;
    if (result.original_stats) {
        infoText += ` | Original: ${result.original_stats.total_rows} rows`;
    }
    if (result.result_stats) {
        infoText += ` | Result: ${result.result_stats.total_rows} rows`;
        if (result.result_stats.rows_removed !== undefined) {
            infoText += ` | Removed: ${result.result_stats.rows_removed} rows`;
        }
        if (result.result_stats.filter_efficiency) {
            infoText += ` | Efficiency: ${result.result_stats.filter_efficiency}`;
        }
        if (result.result_stats.sampling_rate) {
            infoText += ` | Sampling Rate: ${result.result_stats.sampling_rate}`;
        }
    }
    previewInfo.textContent = infoText;
    
    // Create headers
    headersContainer.innerHTML = '';
    if (result.columns && result.columns.length > 0) {
        result.columns.forEach(column => {
            const th = document.createElement('th');
            th.className = 'px-3 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
            th.textContent = column;
            headersContainer.appendChild(th);
        });
    }
    
    // Create rows
    bodyContainer.innerHTML = '';
    if (result.preview_data && result.preview_data.length > 0) {
        result.preview_data.forEach(row => {
            const tr = document.createElement('tr');
            result.columns.forEach(column => {
                const td = document.createElement('td');
                td.className = 'px-3 py-1 whitespace-nowrap text-xs text-gray-900 border-t';
                const value = row[column];
                td.textContent = value !== null && value !== undefined ? 
                    (typeof value === 'object' ? JSON.stringify(value) : String(value)) : 
                    'NULL';
                tr.appendChild(td);
            });
            bodyContainer.appendChild(tr);
        });
    } else {
        // No data to display
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = result.columns?.length || 1;
        td.className = 'px-3 py-2 text-center text-xs text-gray-500';
        td.textContent = 'No preview data available';
        tr.appendChild(td);
        bodyContainer.appendChild(tr);
    }
}
    // Helper functions
    function getAggregationOperationName(operation) {
        const names = {
            'group-by-&-summarize': 'Group By & Summarize',
            'pivot-tables': 'Pivot Tables',
            'window-functions': 'Window Functions',
            'rollup-&-cube': 'Rollup & Cube'
        };
        return names[operation] || operation;
    }

    function getOperationDisplayName(operation) {
        const names = {
            'group-by-&-summarize': 'Group By & Summarize',
            'pivot-tables': 'Pivot Tables',
            'window-functions': 'Window Functions',
            'rollup-&-cube': 'Rollup & Cube',
            'handle-missing-values': 'Handle Missing Values',
            'remove-duplicates': 'Remove Duplicates',
            'data-type-conversion': 'Data Type Conversion',
            'text-cleaning': 'Text Cleaning'
        };
        return names[operation] || operation;
    }

    // Update the main preview button handler to include aggregation
    document.getElementById('previewPipelineStepBtn').addEventListener('click', function() {
        console.log('Preview button clicked - Step type:', currentStepType, 'Operation:', currentOperation);
        
        if (currentStepType === 'cleaning') {
            previewPipelineStep();
        } else if (currentStepType === 'aggregation') {
            previewPipelineAggregationStep();
        } else {
            alert('Preview functionality for this step type is coming soon!');
        }
    });

    // Update refresh preview button for aggregation
// Update refresh preview button for filter operations
document.getElementById('refreshPipelinePreview').addEventListener('click', function() {
    if (currentStepType === 'cleaning') {
        previewPipelineStep();
    } else if (currentStepType === 'aggregation') {
        previewPipelineAggregationStep();
    } else if (currentStepType === 'filter') {
        previewPipelineFilterStep();
    }
});

    // [Rest of your existing functions for cleaning, pipeline management, etc.]
    // ... include all your existing functions like getPipelineCleaningConfig, addStepToPipeline, savePipeline, etc.

    // Function to get basic operation configuration (for non-cleaning operations)
    function getBasicOperationConfig(stepType, operation) {
        return `
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Step Name *</label>
                    <input type="text" id="stepNameInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., ${getStepTypeName(stepType)} Step">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="stepDescriptionInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" rows="2" placeholder="Describe what this step does"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Target Column</label>
                        <select id="targetColumnSelect" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">Select a column</option>
                            <option value="price">Price</option>
                            <option value="quantity">Quantity</option>
                            <option value="category">Category</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Operation Type</label>
                        <select id="operationTypeSelect" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="fill">Fill with value</option>
                            <option value="remove">Remove rows</option>
                            <option value="mean">Fill with mean</option>
                            <option value="median">Fill with median</option>
                        </select>
                    </div>
                </div>
                <div id="fillValueSection" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fill Value</label>
                    <input type="text" id="fillValueInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter value to fill">
                </div>
            </div>
        `;
    }

    // [Include all your existing data cleaning functions here...]
    // openPipelineDataCleaning, getPipelineCleaningConfig, loadDatasetColumnsForPipelineCleaning, etc.

    // Update the add step button to handle aggregation parameters
    document.getElementById('addPipelineStepBtn').addEventListener('click', function() {
        const stepName = document.getElementById('stepNameInput')?.value || 'Unnamed Step';
        const stepDescription = document.getElementById('stepDescriptionInput')?.value || '';
        
        let stepData = {
            name: stepName,
            description: stepDescription,
            type: getCurrentStepType(),
            operation: getCurrentOperation()
        };
        
        // Add parameters based on step type
        if (stepData.type === 'cleaning') {
            stepData.parameters = getPipelineCleaningParameters();
        } else if (stepData.type === 'aggregation') {
            stepData.parameters = getPipelineAggregationParameters();
        } else {
            // Basic parameters for other step types
            const targetColumn = document.getElementById('targetColumnSelect')?.value || '';
            const operationType = document.getElementById('operationTypeSelect')?.value || '';
            const fillValue = document.getElementById('fillValueInput')?.value || '';
            
            stepData.parameters = {
                target_column: targetColumn,
                operation_type: operationType,
                fill_value: fillValue
            };
        }
        
        addStepToPipeline(stepData);
        // Close step config modal
        document.getElementById('stepConfigModal').classList.add('hidden');
    });


    
    // Function to get current step type
    function getCurrentStepType() {
        return currentStepType;
    }

    // Function to get current operation  
    function getCurrentOperation() {
        return currentOperation;
    }

    // [Include all your remaining existing functions...]
    // addStepToPipeline, updatePipelineStatus, savePipeline, getCsrfToken, etc.

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        updatePipelineStatus();
    });
</script>

<script>
    // Data Cleaning Functions for Pipeline Integration with Preview
    let currentCleaningOperation = null;
     currentDatasetColumns = [];
    let currentDatasetId = null;

    // Open data cleaning configuration in pipeline context
    function openPipelineDataCleaning(operation) {
        currentCleaningOperation = operation;
        
        // Show advanced configuration for the selected cleaning operation
        const configSection = document.getElementById('pipelineStepConfig');
        configSection.innerHTML = getPipelineCleaningConfig(operation);
        
        // Update status
        document.getElementById('pipelineStepStatus').textContent = `Configuring: ${getCleaningOperationName(operation)}`;
        
        // Load columns for the selected dataset
        const selectedDataset = document.querySelector('#pipelineDatasetOptions .border-l-indigo-500');
        if (selectedDataset) {
            currentDatasetId = selectedDataset.getAttribute('data-dataset-id');
            loadDatasetColumnsForPipelineCleaning(currentDatasetId);
        }
        
        // Show preview button
        document.getElementById('previewPipelineStepBtn').classList.remove('hidden');
    }

    // Get pipeline-specific cleaning configuration
    function getPipelineCleaningConfig(operation) {
        switch(operation) {
            case 'handle-missing-values':
                return `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Step Name *</label>
                            <input type="text" id="stepNameInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" value="Handle Missing Values">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                            <textarea id="stepDescriptionInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" rows="2">Handle null or missing values in dataset</textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Columns to Process</label>
                            <div id="pipelineMissingValuesColumns" class="space-y-2 max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-3">
                                <div class="text-sm text-gray-500">Loading columns...</div>
                            </div>
                            <div class="mt-2">
                                <label class="inline-flex items-center">
                                    <input type="checkbox" id="pipelineProcessAllColumns" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked>
                                    <span class="ml-2 text-sm text-gray-600">Process all columns</span>
                                </label>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Handling Strategy</label>
                            <select id="pipelineMissingValuesStrategy" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="fill">Fill with value</option>
                                <option value="drop">Drop rows with missing values</option>
                                <option value="interpolate">Interpolate (numeric only)</option>
                            </select>
                        </div>
                        
                        <div id="pipelineFillValueSection">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Fill Value</label>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <label class="flex items-center p-2 border border-gray-300 rounded cursor-pointer hover:bg-gray-50">
                                    <input type="radio" name="pipelineFillValue" value="mean" class="mr-2" checked>
                                    <span class="text-sm">Mean</span>
                                </label>
                                <label class="flex items-center p-2 border border-gray-300 rounded cursor-pointer hover:bg-gray-50">
                                    <input type="radio" name="pipelineFillValue" value="median" class="mr-2">
                                    <span class="text-sm">Median</span>
                                </label>
                                <label class="flex items-center p-2 border border-gray-300 rounded cursor-pointer hover:bg-gray-50">
                                    <input type="radio" name="pipelineFillValue" value="mode" class="mr-2">
                                    <span class="text-sm">Mode</span>
                                </label>
                                <label class="flex items-center p-2 border border-gray-300 rounded cursor-pointer hover:bg-gray-50">
                                    <input type="radio" name="pipelineFillValue" value="custom" class="mr-2">
                                    <span class="text-sm">Custom</span>
                                </label>
                            </div>
                            <div id="pipelineCustomValueSection" class="mt-2 hidden">
                                <input type="text" id="pipelineCustomFillValue" placeholder="Enter custom value" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                            </div>
                        </div>
                    </div>
                `;
                
            case 'remove-duplicates':
                return `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Step Name *</label>
                            <input type="text" id="stepNameInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" value="Remove Duplicates">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                            <textarea id="stepDescriptionInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" rows="2">Remove duplicate rows based on selected criteria</textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Columns to Check for Duplicates</label>
                            <div id="pipelineDuplicateColumns" class="space-y-2 max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-3">
                                <div class="text-sm text-gray-500">Loading columns...</div>
                            </div>
                            <div class="mt-2">
                                <label class="inline-flex items-center">
                                    <input type="checkbox" id="pipelineCheckAllColumns" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked>
                                    <span class="ml-2 text-sm text-gray-600">Check all columns (consider entire row)</span>
                                </label>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Which Duplicates to Keep</label>
                            <select id="pipelineDuplicateKeep" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="first">Keep first occurrence</option>
                                <option value="last">Keep last occurrence</option>
                                <option value="false">Remove all duplicates</option>
                            </select>
                        </div>
                    </div>
                `;
                
            case 'data-type-conversion':
                return `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Step Name *</label>
                            <input type="text" id="stepNameInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" value="Data Type Conversion">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                            <textarea id="stepDescriptionInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" rows="2">Convert data types of selected columns</textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Column Type Conversions</label>
                            <div id="pipelineConversionColumns" class="space-y-3 max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-3">
                                <div class="text-sm text-gray-500">Loading columns...</div>
                            </div>
                        </div>
                    </div>
                `;
                
            case 'text-cleaning':
                return `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Step Name *</label>
                            <input type="text" id="stepNameInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" value="Text Cleaning">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                            <textarea id="stepDescriptionInput" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" rows="2">Clean and normalize text data</textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Columns to Clean</label>
                            <div id="pipelineTextColumns" class="space-y-2 max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-3">
                                <div class="text-sm text-gray-500">Loading columns...</div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Text Operations</label>
                            <div class="space-y-3">
                                <label class="inline-flex items-center">
                                    <input type="checkbox" id="pipelineTrimSpaces" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked>
                                    <span class="ml-2 text-sm text-gray-600">Trim leading/trailing spaces</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" id="pipelineRemoveExtraSpaces" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-2 text-sm text-gray-600">Remove extra spaces between words</span>
                                </label>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Case Conversion</label>
                                    <select id="pipelineTextCase" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                        <option value="">No change</option>
                                        <option value="lower">Convert to lowercase</option>
                                        <option value="upper">Convert to uppercase</option>
                                        <option value="title">Convert to title case</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
            default:
                return `<div class="text-center py-4 text-gray-500">Configuration for ${operation} not available</div>`;
        }
    }

    // Load dataset columns for pipeline cleaning
    async function loadDatasetColumnsForPipelineCleaning(datasetId) {
        if (!datasetId) {
            currentDatasetColumns = [];
            updatePipelineCleaningColumnLists();
            return;
        }
        
        try {
            const response = await fetch(`/api/assistant/api/dataset/${datasetId}/columns/`, {
                method: "GET",
                headers: {
                    "X-CSRFToken": getCsrfToken(),
                    "Content-Type": "application/json"
                }
            });
            
            if (response.ok) {
                const result = await response.json();
                currentDatasetColumns = result.columns;
                updatePipelineCleaningColumnLists();
            }
            
        } catch (error) {
            console.error('Error loading columns for pipeline cleaning:', error);
        }
    }

    // Update column lists in pipeline cleaning configuration
    function updatePipelineCleaningColumnLists() {
        if (!currentCleaningOperation || currentDatasetColumns.length === 0) return;
        
        switch(currentCleaningOperation) {
            case 'handle-missing-values':
                updatePipelineMissingValuesColumnList();
                break;
            case 'remove-duplicates':
                updatePipelineDuplicateColumnsList();
                break;
            case 'data-type-conversion':
                updatePipelineConversionColumnsList();
                break;
            case 'text-cleaning':
                updatePipelineTextColumnsList();
                break;
        }
        
        // Add event listeners for dynamic sections
        addPipelineCleaningEventListeners();
    }

    // Update missing values column list for pipeline
    function updatePipelineMissingValuesColumnList() {
        const container = document.getElementById('pipelineMissingValuesColumns');
        if (!container) return;
        
        container.innerHTML = '';
        currentDatasetColumns.forEach(column => {
            const div = document.createElement('div');
            div.className = 'flex items-center';
            div.innerHTML = `
                <input type="checkbox" id="pipeline_mv_${column}" value="${column}" class="mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked>
                <label for="pipeline_mv_${column}" class="text-sm text-gray-700">${column}</label>
            `;
            container.appendChild(div);
        });
    }

    // Update duplicate columns list for pipeline
    function updatePipelineDuplicateColumnsList() {
        const container = document.getElementById('pipelineDuplicateColumns');
        if (!container) return;
        
        container.innerHTML = '';
        currentDatasetColumns.forEach(column => {
            const div = document.createElement('div');
            div.className = 'flex items-center';
            div.innerHTML = `
                <input type="checkbox" id="pipeline_dup_${column}" value="${column}" class="mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                <label for="pipeline_dup_${column}" class="text-sm text-gray-700">${column}</label>
            `;
            container.appendChild(div);
        });
    }

    // Update conversion columns list for pipeline
    function updatePipelineConversionColumnsList() {
        const container = document.getElementById('pipelineConversionColumns');
        if (!container) return;
        
        container.innerHTML = '';
        currentDatasetColumns.forEach(column => {
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between p-2 border border-gray-200 rounded';
            div.innerHTML = `
                <div class="flex-1">
                    <div class="text-sm font-medium text-gray-700">${column}</div>
                </div>
                <select id="pipeline_conv_${column}" class="ml-3 border border-gray-300 rounded px-2 py-1 text-sm">
                    <option value="">No change</option>
                    <option value="string">String</option>
                    <option value="numeric">Numeric</option>
                    <option value="integer">Integer</option>
                    <option value="float">Float</option>
                    <option value="datetime">Date/Time</option>
                    <option value="boolean">Boolean</option>
                </select>
            `;
            container.appendChild(div);
        });
    }

    // Update text columns list for pipeline
    function updatePipelineTextColumnsList() {
        const container = document.getElementById('pipelineTextColumns');
        if (!container) return;
        
        container.innerHTML = '';
        currentDatasetColumns.forEach(column => {
            const div = document.createElement('div');
            div.className = 'flex items-center';
            div.innerHTML = `
                <input type="checkbox" id="pipeline_txt_${column}" value="${column}" class="mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked>
                <label for="pipeline_txt_${column}" class="text-sm text-gray-700">${column}</label>
            `;
            container.appendChild(div);
        });
    }

    // Add event listeners for pipeline cleaning configuration
    function addPipelineCleaningEventListeners() {
        // Strategy change for missing values
        const strategySelect = document.getElementById('pipelineMissingValuesStrategy');
        if (strategySelect) {
            strategySelect.addEventListener('change', function() {
                const showFillValue = this.value === 'fill';
                const fillValueSection = document.getElementById('pipelineFillValueSection');
                if (fillValueSection) {
                    fillValueSection.style.display = showFillValue ? 'block' : 'none';
                }
            });
        }
        
        // Fill value type change
        document.querySelectorAll('input[name="pipelineFillValue"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const customSection = document.getElementById('pipelineCustomValueSection');
                if (customSection) {
                    customSection.style.display = this.value === 'custom' ? 'block' : 'none';
                }
            });
        });
    }

    // PREVIEW FUNCTIONALITY FOR PIPELINE
    async function previewPipelineStep() {
        if (!currentDatasetId || !currentCleaningOperation) {
            alert('Please select a dataset and configure the operation first');
            return;
        }
        
        try {
            // Show loading state
            document.getElementById('pipelineStepStatus').textContent = 'Generating preview...';
            document.getElementById('previewPipelineStepBtn').disabled = true;
            
            const requestData = {
                dataset_id: currentDatasetId,
                preview_only: true,
                operation_type: mapPipelineOperationToBackend(currentCleaningOperation),
                ...getPipelineCleaningParameters()
            };
            
            const response = await fetch('/api/assistant/api/cleaning/preview/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });
            
            if (response.ok) {
                const result = await response.json();
                displayPipelinePreview(result);
                document.getElementById('pipelineStepStatus').textContent = 'Preview ready';
            } else {
                const error = await response.json();
                throw new Error(error.error || 'Failed to generate preview');
            }
            
        } catch (error) {
            console.error('Error previewing pipeline step:', error);
            alert(`Error generating preview: ${error.message}`);
            document.getElementById('pipelineStepStatus').textContent = 'Error generating preview';
        } finally {
            document.getElementById('previewPipelineStepBtn').disabled = false;
        }
    }

// Display pipeline preview results
function displayPipelinePreview(result) {
    const previewSection = document.getElementById('pipelineStepPreview');
    const headersContainer = document.getElementById('pipelinePreviewHeaders');
    const bodyContainer = document.getElementById('pipelinePreviewBody');
    const previewInfo = document.getElementById('pipelinePreviewInfo');
    
    // Show preview section
    previewSection.classList.remove('hidden');
    
    // Update preview info
    let infoText = `Preview: ${result.preview_data?.length || 0} rows`;
    if (result.original_stats) {
        infoText += ` | Original: ${result.original_stats.total_rows} rows`;
    }
    if (result.result_stats) {
        infoText += ` | Result: ${result.result_stats.total_rows} rows`;
        if (result.result_stats.rows_removed !== undefined) {
            infoText += ` | Removed: ${result.result_stats.rows_removed} rows`;
        }
        if (result.result_stats.filter_efficiency) {
            infoText += ` | Efficiency: ${result.result_stats.filter_efficiency}`;
        }
        if (result.result_stats.sampling_rate) {
            infoText += ` | Sampling Rate: ${result.result_stats.sampling_rate}`;
        }
    }
    previewInfo.textContent = infoText;
    
    // Create headers
    headersContainer.innerHTML = '';
    if (result.columns && result.columns.length > 0) {
        result.columns.forEach(column => {
            const th = document.createElement('th');
            th.className = 'px-3 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
            th.textContent = column;
            headersContainer.appendChild(th);
        });
    }
    
    // Create rows
    bodyContainer.innerHTML = '';
    if (result.preview_data && result.preview_data.length > 0) {
        result.preview_data.forEach(row => {
            const tr = document.createElement('tr');
            result.columns.forEach(column => {
                const td = document.createElement('td');
                td.className = 'px-3 py-1 whitespace-nowrap text-xs text-gray-900 border-t';
                const value = row[column];
                td.textContent = value !== null && value !== undefined ? 
                    (typeof value === 'object' ? JSON.stringify(value) : String(value)) : 
                    'NULL';
                tr.appendChild(td);
            });
            bodyContainer.appendChild(tr);
        });
    } else {
        // No data to display
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = result.columns?.length || 1;
        td.className = 'px-3 py-2 text-center text-xs text-gray-500';
        td.textContent = 'No preview data available';
        tr.appendChild(td);
        bodyContainer.appendChild(tr);
    }
}
    // Map pipeline operation names to backend operation names
    function mapPipelineOperationToBackend(pipelineOperation) {
        const mapping = {
            'handle-missing-values': 'missing_values',
            'remove-duplicates': 'remove_duplicates',
            'data-type-conversion': 'convert_data_types',
            'text-cleaning': 'standardize_formats'
        };
        return mapping[pipelineOperation] || pipelineOperation;
    }

    // Get cleaning parameters for pipeline step
    function getPipelineCleaningParameters() {
        const params = {};
        
        switch(currentCleaningOperation) {
            case 'handle-missing-values':
                params.strategy = document.getElementById('pipelineMissingValuesStrategy')?.value || 'fill';
                
                if (params.strategy === 'fill') {
                    const fillValueRadio = document.querySelector('input[name="pipelineFillValue"]:checked');
                    params.fill_value = fillValueRadio ? fillValueRadio.value : 'mean';
                    
                    if (params.fill_value === 'custom') {
                        params.fill_value = document.getElementById('pipelineCustomFillValue')?.value || '';
                    }
                }
                
                if (!document.getElementById('pipelineProcessAllColumns')?.checked) {
                    params.columns = Array.from(document.querySelectorAll('#pipelineMissingValuesColumns input:checked'))
                        .map(cb => cb.value);
                }
                break;
                
            case 'remove-duplicates':
                params.keep = document.getElementById('pipelineDuplicateKeep')?.value || 'first';
                
                if (!document.getElementById('pipelineCheckAllColumns')?.checked) {
                    params.subset = Array.from(document.querySelectorAll('#pipelineDuplicateColumns input:checked'))
                        .map(cb => cb.value);
                }
                break;
                
            case 'data-type-conversion':
                params.conversions = {};
                currentDatasetColumns.forEach(column => {
                    const select = document.getElementById(`pipeline_conv_${column}`);
                    if (select && select.value) {
                        params.conversions[column] = select.value;
                    }
                });
                break;
                
            case 'text-cleaning':
                params.operations = {
                    trim: document.getElementById('pipelineTrimSpaces')?.checked || false,
                    remove_extra_spaces: document.getElementById('pipelineRemoveExtraSpaces')?.checked || false,
                    case: document.getElementById('pipelineTextCase')?.value || ''
                };
                
                params.columns = Array.from(document.querySelectorAll('#pipelineTextColumns input:checked'))
                    .map(cb => cb.value);
                break;
        }
        
        return params;
    }

    // Helper functions
    function getCleaningOperationName(operation) {
        const names = {
            'handle-missing-values': 'Handle Missing Values',
            'remove-duplicates': 'Remove Duplicates',
            'data-type-conversion': 'Data Type Conversion',
            'text-cleaning': 'Text Cleaning'
        };
        return names[operation] || operation;
    }

    function getCleaningOperationDescription(operation) {
        const descriptions = {
            'handle-missing-values': 'Handle null or missing values in dataset',
            'remove-duplicates': 'Remove duplicate rows based on selected criteria',
            'data-type-conversion': 'Convert data types of selected columns',
            'text-cleaning': 'Clean and normalize text data'
        };
        return descriptions[operation] || 'Apply data cleaning operation';
    }

    // Add event listener for preview button in the main script
    document.getElementById('previewPipelineStepBtn').addEventListener('click', function() {
        if (currentStepType === 'cleaning') {
            previewPipelineStep();
        } else {
            // Handle preview for other step types
            alert('Preview functionality for this step type is coming soon!');
        }
    });

    // Add event listener for refresh preview button
// Update refresh preview button for filter operations
document.getElementById('refreshPipelinePreview').addEventListener('click', function() {
    if (currentStepType === 'cleaning') {
        previewPipelineStep();
    } else if (currentStepType === 'aggregation') {
        previewPipelineAggregationStep();
    } else if (currentStepType === 'filter') {
        previewPipelineFilterStep();
    }
});
</script>
<script>
    // Preview functionality for pipeline filter operations
async function previewPipelineFilterStep() {
    const selectedDataset = document.querySelector('#pipelineDatasetOptions .border-l-indigo-500, #pipelineDatasetOptions .bg-indigo-50');
    if (!selectedDataset) {
        alert('Please select a dataset first');
        return;
    }
    
    const datasetId = selectedDataset.getAttribute('data-dataset-id');
    if (!datasetId || !currentOperation) {
        alert('Please select a dataset and configure the operation first');
        return;
    }
    
    console.log('Preview filter operation - Dataset ID:', datasetId, 'Operation:', currentOperation);
    
    try {
        document.getElementById('pipelineStepStatus').textContent = 'Generating preview...';
        document.getElementById('previewPipelineStepBtn').disabled = true;
        
        let operationParams;
        try {
            // FIXED: Call the correct function based on current operation
            operationParams = getPipelineFilterStepParameters();
        } catch (paramError) {
            alert(`Configuration Error: ${paramError.message}`);
            document.getElementById('pipelineStepStatus').textContent = 'Configuration error';
            return;
        }
        
        const requestData = {
            dataset_id: datasetId,
            preview_only: true,
            operation_type: mapPipelineFilterToBackend(currentOperation),
            ...operationParams
        };
        
        console.log('Sending filter preview request:', requestData);
        
        const response = await fetch('/api/assistant/api/filter-sort/preview/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        if (response.ok) {
            const result = await response.json();
            displayPipelinePreview(result);
            document.getElementById('pipelineStepStatus').textContent = 'Preview ready';
        } else {
            const errorData = await response.json();
            throw new Error(errorData.error || `Server error: ${response.status}`);
        }
        
    } catch (error) {
        console.error('Error previewing filter step:', error);
        alert(`Error generating preview: ${error.message}`);
        document.getElementById('pipelineStepStatus').textContent = 'Error generating preview';
    } finally {
        document.getElementById('previewPipelineStepBtn').disabled = false;
    }
}

// Map pipeline filter operations to backend operations
function mapPipelineFilterToBackend(pipelineOperation) {
    const mapping = {
        'filter-rows': 'filter',
        'sort-data': 'sort',
        'top-n-records': 'top_n',
        'random-sampling': 'random_sample',
        'select-columns': 'select_columns',
        'remove-columns': 'remove_columns'
    };
    return mapping[pipelineOperation] || pipelineOperation;
}

// Get pipeline filter step parameters - ROUTES TO CORRECT FUNCTION
function getPipelineFilterStepParameters() {
    switch(currentOperation) {
        case 'filter-rows':
            return getPipelineFilterParameters();
        case 'sort-data':
            return getPipelineSortParameters();
        case 'select-columns':
            return getPipelineSelectColumnsParameters();
        case 'remove-columns':
            return getPipelineRemoveColumnsParameters();
        case 'top-n-records':
            return getPipelineTopNParameters();
        case 'random-sampling':
            return getPipelineSamplingParameters();
        default:
            throw new Error(`Unsupported filter operation: ${currentOperation}`);
    }
}

// Get filter parameters - ONLY for filter-rows operation
function getPipelineFilterParameters() {
    const filters = [];
    document.querySelectorAll('#pipelineFilterConditions > div').forEach(filterDiv => {
        const columnSelect = filterDiv.querySelector('.pipeline-filter-column-select');
        const operatorSelect = filterDiv.querySelector('.pipeline-filter-operator-select');
        const valueInput = filterDiv.querySelector('.pipeline-filter-value-input');
        
        if (columnSelect && columnSelect.value && operatorSelect && operatorSelect.value) {
            const filterConfig = {
                column: columnSelect.value,
                operator: operatorSelect.value
            };
            
            // Handle value based on operator
            if (!['is_null', 'not_null'].includes(operatorSelect.value)) {
                if (valueInput && valueInput.value) {
                    // Smart value conversion based on input
                    const convertValue = (val) => {
                        const trimmed = val.trim();
                        if (trimmed === '') return null;
                        
                        // Try to convert to number
                        if (!isNaN(trimmed) && trimmed !== '') {
                            return Number(trimmed);
                        }
                        
                        // Try to convert to boolean
                        if (trimmed.toLowerCase() === 'true') return true;
                        if (trimmed.toLowerCase() === 'false') return false;
                        
                        // Return as string
                        return trimmed;
                    };
                    
                    if (['in_list', 'not_in_list'].includes(operatorSelect.value)) {
                        filterConfig.value = valueInput.value.split(',').map(convertValue);
                    } else if (operatorSelect.value === 'between') {
                        filterConfig.value = valueInput.value.split(',').map(convertValue).slice(0, 2);
                    } else {
                        filterConfig.value = convertValue(valueInput.value);
                    }
                } else {
                    throw new Error('Filter value is required');
                }
            }
            
            filters.push(filterConfig);
        }
    });
    
    if (filters.length === 0) {
        throw new Error('Please add at least one filter condition');
    }
    
    return { filters: filters };
}

// Get sort parameters - ONLY for sort-data operation
function getPipelineSortParameters() {
    const sort_columns = [];
    document.querySelectorAll('#pipelineSortColumns > div').forEach(sortDiv => {
        const columnSelect = sortDiv.querySelector('.pipeline-sort-column-select');
        const orderSelect = sortDiv.querySelector('.pipeline-sort-order-select');
        
        if (columnSelect && columnSelect.value && orderSelect) {
            sort_columns.push({
                column: columnSelect.value,
                order: orderSelect.value
            });
        }
    });
    
    if (sort_columns.length === 0) {
        throw new Error('Please add at least one sort column');
    }
    
    return { sort_columns: sort_columns };
}

// Get select columns parameters - ONLY for select-columns operation
function getPipelineSelectColumnsParameters() {
    const selected_columns = Array.from(document.querySelectorAll('#pipelineSelectColumns input:checked'))
        .map(cb => cb.value)
        .filter(col => col && col !== 'undefined');
    
    if (selected_columns.length === 0) {
        throw new Error('Please select at least one column to keep');
    }
    
    return { selected_columns: selected_columns };
}

// Get remove columns parameters - ONLY for remove-columns operation
function getPipelineRemoveColumnsParameters() {
    const removed_columns = Array.from(document.querySelectorAll('#pipelineRemoveColumns input:checked'))
        .map(cb => cb.value)
        .filter(col => col && col !== 'undefined');
    
    if (removed_columns.length === 0) {
        throw new Error('Please select at least one column to remove');
    }
    
    return { removed_columns: removed_columns };
}

// Get top N parameters - ONLY for top-n-records operation
function getPipelineTopNParameters() {
    const count = document.getElementById('pipelineTopNCount')?.value;
    const order = document.getElementById('pipelineTopNOrder')?.value;
    const column = document.getElementById('pipelineTopNColumn')?.value;
    
    if (!count || count < 1) {
        throw new Error('Please enter a valid number of records');
    }
    
    if (!column) {
        throw new Error('Please select a column to sort by');
    }
    
    return {
        n_records: parseInt(count),
        sort_order: order || 'desc',
        sort_by: column
    };
}

// Get sampling parameters - ONLY for random-sampling operation
function getPipelineSamplingParameters() {
    const sampleSize = document.getElementById('pipelineSampleSize')?.value;
    const sampleType = document.getElementById('pipelineSampleType')?.value;
    const randomSeed = document.getElementById('pipelineRandomSeed')?.value;
    
    if (!sampleSize || sampleSize < 1) {
        throw new Error('Please enter a valid sample size');
    }
    
    const params = {
        sample_size: parseInt(sampleSize),
        sample_type: sampleType || 'count'
    };
    
    if (randomSeed) {
        params.random_state = parseInt(randomSeed);
    }
    
    return params;
}
</script>

<script>
    // Get pipeline steps from the UI
function getPipelineSteps() {
    const stepsContainer = document.getElementById('pipelineStepsContainer');
    const steps = [];
    
    // Get all step elements
    const stepElements = stepsContainer.querySelectorAll('.pipeline-step');
    
    stepElements.forEach(stepElement => {
        const stepData = JSON.parse(stepElement.getAttribute('data-step'));
        steps.push(stepData);
    });
    
    return steps;
}

// Save pipeline function
async function savePipeline() {
    const pipelineName = document.getElementById('pipelineName').value;
    const pipelineDescription = document.getElementById('pipelineDescription').value;
    const selectedDataset = document.querySelector('#pipelineDatasetOptions .border-l-indigo-500, #pipelineDatasetOptions .bg-indigo-50');
    
    if (!pipelineName) {
        alert('Please enter a pipeline name');
        return;
    }
    
    if (!selectedDataset) {
        alert('Please select an input dataset');
        return;
    }
    
    const datasetId = selectedDataset.getAttribute('data-dataset-id');
    const steps = getPipelineSteps(); // This should return the steps array
    
    const pipelineData = {
        name: pipelineName,
        description: pipelineDescription,
        input_dataset_id: datasetId,
        workspace_id: 'default-workspace', // or get from your context
        steps: steps.map((step, index) => ({
            step_number: index + 1,
            type: step.type,
            operation: step.operation,
            parameters: step.parameters // Make sure this contains the correct parameters
        }))
    };
    
    console.log('Saving pipeline:', pipelineData);
    
    try {
        const response = await fetch('/api/assistant/api/pipelines/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(pipelineData)
        });
        
        if (response.ok) {
            const result = await response.json();
            showToast('Pipeline created successfully!', 'success');
            closePipelineModal();
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to create pipeline');
        }
    } catch (error) {
        console.error('Error saving pipeline:', error);
        showToast(`Error: ${error.message}`, 'error');
    }
}

// Add step to pipeline
function addStepToPipeline(stepData) {
    const stepsContainer = document.getElementById('pipelineStepsContainer');
    const emptyPipeline = document.getElementById('emptyPipeline');
    
    // Hide empty pipeline message
    if (emptyPipeline) {
        emptyPipeline.style.display = 'none';
    }
    
    const stepId = 'step_' + Date.now();
    const stepNumber = stepsContainer.children.length + 1;
    
    const stepElement = document.createElement('div');
    stepElement.className = 'pipeline-step bg-white border border-gray-200 rounded-lg p-4';
    stepElement.setAttribute('data-step', JSON.stringify(stepData));
    stepElement.innerHTML = `
        <div class="flex justify-between items-start">
            <div class="flex-1">
                <div class="flex items-center mb-2">
                    <span class="bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-0.5 rounded mr-2">Step ${stepNumber}</span>
                    <h4 class="font-medium text-gray-800">${stepData.name}</h4>
                </div>
                <p class="text-sm text-gray-600 mb-2">${stepData.description || 'No description'}</p>
                <div class="text-xs text-gray-500">
                    <span class="bg-gray-100 px-2 py-1 rounded">${stepData.type}</span>
                    <span class="bg-gray-100 px-2 py-1 rounded ml-1">${stepData.operation}</span>
                </div>
            </div>
            <div class="flex space-x-2">
                <button class="edit-step text-indigo-600 hover:text-indigo-800" data-step-id="${stepId}">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="remove-step text-red-600 hover:text-red-800" data-step-id="${stepId}">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    stepsContainer.appendChild(stepElement);
    
    // Add event listeners for edit and remove buttons
    stepElement.querySelector('.edit-step').addEventListener('click', function() {
        editPipelineStep(stepId, stepData);
    });
    
    stepElement.querySelector('.remove-step').addEventListener('click', function() {
        removePipelineStep(stepId);
    });
    
    // Update pipeline status
    updatePipelineStatus();
}

// Remove step from pipeline
function removePipelineStep(stepId) {
    const stepElement = document.querySelector(`[data-step-id="${stepId}"]`).closest('.pipeline-step');
    stepElement.remove();
    
    // Update step numbers
    updatePipelineStepNumbers();
    
    // Show empty message if no steps
    const stepsContainer = document.getElementById('pipelineStepsContainer');
    const emptyPipeline = document.getElementById('emptyPipeline');
    
    if (stepsContainer.children.length === 0 && emptyPipeline) {
        emptyPipeline.style.display = 'block';
    }
    
    updatePipelineStatus();
}

// Update step numbers after removal
function updatePipelineStepNumbers() {
    const stepsContainer = document.getElementById('pipelineStepsContainer');
    const stepElements = stepsContainer.querySelectorAll('.pipeline-step');
    
    stepElements.forEach((stepElement, index) => {
        const stepNumberElement = stepElement.querySelector('.bg-indigo-100');
        if (stepNumberElement) {
            stepNumberElement.textContent = `Step ${index + 1}`;
        }
    });
}

// Edit pipeline step (placeholder - you can implement this)
function editPipelineStep(stepId, stepData) {
    // You can implement step editing functionality here
    console.log('Edit step:', stepId, stepData);
    alert('Step editing functionality coming soon!');
}

// Update pipeline status
function updatePipelineStatus() {
    const stepsContainer = document.getElementById('pipelineStepsContainer');
    const stepCount = stepsContainer.querySelectorAll('.pipeline-step').length;
    const statusElement = document.getElementById('pipelineStatus');
    const stepCountElement = document.getElementById('pipelineStepCount');
    
    if (stepCount === 0) {
        statusElement.textContent = 'Ready to create pipeline';
    } else {
        statusElement.textContent = `Pipeline has ${stepCount} step${stepCount !== 1 ? 's' : ''}`;
    }
    
    stepCountElement.textContent = stepCount > 0 ? `(${stepCount} step${stepCount !== 1 ? 's' : ''})` : '';
}

// Close pipeline modal
function closePipelineModal() {
    const modal = document.getElementById('pipelineModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    
    // Reset form
    resetPipelineForm();
}

// Reset pipeline form
function resetPipelineForm() {
    document.getElementById('pipelineName').value = '';
    document.getElementById('pipelineDescription').value = '';
    document.getElementById('pipelineStepsContainer').innerHTML = `
        <div id="emptyPipeline" class="text-center py-8 border-2 border-dashed border-gray-300 rounded-lg">
            <i class="fas fa-stream text-gray-400 text-3xl mb-2"></i>
            <p class="text-gray-500 text-sm">No steps added yet</p>
            <p class="text-gray-400 text-xs mt-1">Click "Add Step" to start building your pipeline</p>
        </div>
    `;
    updatePipelineStatus();
}

// Add event listener for save button
document.getElementById('savePipelineBtn').addEventListener('click', savePipeline);

// Add event listener for cancel button
document.getElementById('cancelPipelineBtn').addEventListener('click', function() {
    closePipelineModal();
});
</script>
<script>
    // Preview functionality for pipeline filter operations
async function previewPipelineFilterStep() {
    const selectedDataset = document.querySelector('#pipelineDatasetOptions .border-l-indigo-500, #pipelineDatasetOptions .bg-indigo-50');
    if (!selectedDataset) {
        alert('Please select a dataset first');
        return;
    }
    
    const datasetId = selectedDataset.getAttribute('data-dataset-id');
    if (!datasetId || !currentOperation) {
        alert('Please select a dataset and configure the operation first');
        return;
    }
    
    console.log('Preview filter operation - Dataset ID:', datasetId, 'Operation:', currentOperation);
    
    try {
        document.getElementById('pipelineStepStatus').textContent = 'Generating preview...';
        document.getElementById('previewPipelineStepBtn').disabled = true;
        
        let operationParams;
        try {
            operationParams = getPipelineFilterParameters();
        } catch (paramError) {
            alert(`Configuration Error: ${paramError.message}`);
            document.getElementById('pipelineStepStatus').textContent = 'Configuration error';
            return;
        }
        
        const requestData = {
            dataset_id: datasetId,
            preview_only: true,
            operation_type: mapPipelineFilterToBackend(currentOperation),
            ...operationParams
        };
        
        console.log('Sending filter preview request:', requestData);
        
        const response = await fetch('/api/assistant/api/filter-sort/preview/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        if (response.ok) {
            const result = await response.json();
            displayPipelinePreview(result);
            document.getElementById('pipelineStepStatus').textContent = 'Preview ready';
        } else {
            const errorData = await response.json();
            throw new Error(errorData.error || `Server error: ${response.status}`);
        }
        
    } catch (error) {
        console.error('Error previewing filter step:', error);
        alert(`Error generating preview: ${error.message}`);
        document.getElementById('pipelineStepStatus').textContent = 'Error generating preview';
    } finally {
        document.getElementById('previewPipelineStepBtn').disabled = false;
    }
}


// Map pipeline filter operations to backend operations
function mapPipelineFilterToBackend(pipelineOperation) {
    const mapping = {
        'filter-rows': 'filter',
        'sort-data': 'sort',
        'top-n-records': 'top_n',
        'random-sampling': 'random_sample',
        'select-columns': 'select_columns',
        'remove-columns': 'remove_columns'
    };
    return mapping[pipelineOperation] || pipelineOperation;
}
// Get filter parameters
function getPipelineFilterParameters() {
    const filters = [];
    document.querySelectorAll('#pipelineFilterConditions > div').forEach(filterDiv => {
        const columnSelect = filterDiv.querySelector('.pipeline-filter-column-select');
        const operatorSelect = filterDiv.querySelector('.pipeline-filter-operator-select');
        const valueInput = filterDiv.querySelector('.pipeline-filter-value-input');
        
        if (columnSelect && columnSelect.value && operatorSelect && operatorSelect.value) {
            const filterConfig = {
                column: columnSelect.value,
                operator: operatorSelect.value
            };
            
            // Handle value based on operator
            if (!['is_null', 'not_null'].includes(operatorSelect.value)) {
                if (valueInput && valueInput.value) {
                    // Smart value conversion based on input
                    const convertValue = (val) => {
                        const trimmed = val.trim();
                        if (trimmed === '') return null;
                        
                        // Try to convert to number
                        if (!isNaN(trimmed) && trimmed !== '') {
                            return Number(trimmed);
                        }
                        
                        // Try to convert to boolean
                        if (trimmed.toLowerCase() === 'true') return true;
                        if (trimmed.toLowerCase() === 'false') return false;
                        
                        // Return as string
                        return trimmed;
                    };
                    
                    if (['in_list', 'not_in_list'].includes(operatorSelect.value)) {
                        filterConfig.value = valueInput.value.split(',').map(convertValue);
                    } else if (operatorSelect.value === 'between') {
                        filterConfig.value = valueInput.value.split(',').map(convertValue).slice(0, 2);
                    } else {
                        filterConfig.value = convertValue(valueInput.value);
                    }
                } else {
                    throw new Error('Filter value is required');
                }
            }
            
            filters.push(filterConfig);
        }
    });
    
    if (filters.length === 0) {
        throw new Error('Please add at least one filter condition');
    }
    
    return { filters: filters };
}

// Get sort parameters
function getPipelineSortParameters() {
    const sort_columns = [];
    document.querySelectorAll('#pipelineSortColumns > div').forEach(sortDiv => {
        const columnSelect = sortDiv.querySelector('.pipeline-sort-column-select');
        const orderSelect = sortDiv.querySelector('.pipeline-sort-order-select');
        
        if (columnSelect && columnSelect.value && orderSelect) {
            sort_columns.push({
                column: columnSelect.value,
                order: orderSelect.value
            });
        }
    });
    
    if (sort_columns.length === 0) {
        throw new Error('Please add at least one sort column');
    }
    
    return { sort_columns: sort_columns };
}

// Get select columns parameters
function getPipelineSelectColumnsParameters() {
    const selected_columns = Array.from(document.querySelectorAll('#pipelineSelectColumns input:checked'))
        .map(cb => cb.value)
        .filter(col => col && col !== 'undefined');
    
    if (selected_columns.length === 0) {
        throw new Error('Please select at least one column to keep');
    }
    
    return { selected_columns: selected_columns };
}

// Get remove columns parameters
function getPipelineRemoveColumnsParameters() {
    const removed_columns = Array.from(document.querySelectorAll('#pipelineRemoveColumns input:checked'))
        .map(cb => cb.value)
        .filter(col => col && col !== 'undefined');
    
    if (removed_columns.length === 0) {
        throw new Error('Please select at least one column to remove');
    }
    
    return { removed_columns: removed_columns };
}

// Get top N parameters
function getPipelineTopNParameters() {
    const count = document.getElementById('pipelineTopNCount')?.value;
    const order = document.getElementById('pipelineTopNOrder')?.value;
    const column = document.getElementById('pipelineTopNColumn')?.value;
    
    if (!count || count < 1) {
        throw new Error('Please enter a valid number of records');
    }
    
    if (!column) {
        throw new Error('Please select a column to sort by');
    }
    
    return {
        n_records: parseInt(count),
        sort_order: order || 'desc',
        sort_by: column
    };
}

// Get sampling parameters
function getPipelineSamplingParameters() {
    const sampleSize = document.getElementById('pipelineSampleSize')?.value;
    const sampleType = document.getElementById('pipelineSampleType')?.value;
    const randomSeed = document.getElementById('pipelineRandomSeed')?.value;
    
    if (!sampleSize || sampleSize < 1) {
        throw new Error('Please enter a valid sample size');
    }
    
    const params = {
        sample_size: parseInt(sampleSize),
        sample_type: sampleType || 'count'
    };
    
    if (randomSeed) {
        params.random_state = parseInt(randomSeed);
    }
    
    return params;
}
</script>


<script>
    // Function to load and display pipelines
// Updated loadPipelines function with better error handling
async function loadPipelines() {
    try {
        const response = await fetch('/api/assistant/api/pipelines/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                displayPipelines(result.pipelines);
                
                // Update pipeline status text
                const statusElement = document.getElementById('pipelineStatus');
                if (statusElement && result.pipelines && result.pipelines.length > 0) {
                    statusElement.textContent = `${result.pipelines.length} pipeline(s) loaded`;
                    statusElement.className = 'font-medium text-green-600';
                }
            } else {
                throw new Error(result.error || 'Failed to load pipelines');
            }
        } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    } catch (error) {
        console.error('Error loading pipelines:', error);
        showEmptyPipelineState();
        showToast('Error loading pipelines', 'error');
    }
}
// Function to display pipelines in the UI
function displayPipelines(pipelines) {
    const container = document.getElementById('pipelineSteps');
    const emptyState = document.getElementById('emptyPipeline');
    
    if (!pipelines || pipelines.length === 0) {
        showEmptyPipelineState();
        return;
    }
    
    // Hide empty state
    if (emptyState) {
        emptyState.style.display = 'none';
    }
    
    // Clear existing content
    container.innerHTML = '';
    
    // Create pipeline cards
    pipelines.forEach(pipeline => {
        const pipelineCard = createPipelineCard(pipeline);
        container.appendChild(pipelineCard);
    });
}

// Function to create individual pipeline card
function createPipelineCard(pipeline) {
    const card = document.createElement('div');
    card.className = 'pipeline-card bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow';
    card.innerHTML = `
        <div class="flex justify-between items-start mb-3">
            <div class="flex-1">
                <h4 class="font-semibold text-gray-800">${pipeline.name}</h4>
                ${pipeline.description ? `<p class="text-sm text-gray-600 mt-1">${pipeline.description}</p>` : ''}
            </div>
            <span class="status-badge px-2 py-1 rounded-full text-xs font-medium ${getStatusColor(pipeline.status)}">
                ${pipeline.status}
            </span>
        </div>
        
        <div class="flex items-center justify-between text-sm text-gray-500 mb-3">
            <div class="flex items-center space-x-4">
                <span><i class="fas fa-steps mr-1"></i> ${pipeline.total_steps} steps</span>
                <span><i class="fas fa-calendar mr-1"></i> ${formatDate(pipeline.created_at)}</span>
            </div>
        </div>
        
        <!-- Step Preview -->
        ${pipeline.step_summary && pipeline.step_summary.length > 0 ? `
        <div class="step-preview border-t pt-3">
            <div class="flex flex-wrap gap-1">
                ${pipeline.step_summary.map(step => `
                    <span class="step-tag px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">
                        ${step.type}.${step.operation}
                    </span>
                `).join('')}
                ${pipeline.total_steps > 3 ? `<span class="text-xs text-gray-500">+${pipeline.total_steps - 3} more</span>` : ''}
            </div>
        </div>
        ` : ''}
        
        <div class="flex justify-end space-x-2 mt-3">
            <button class="run-pipeline-btn px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700" 
                    data-pipeline-id="${pipeline.id}">
                <i class="fas fa-play mr-1"></i> Run
            </button>
            <button class="edit-pipeline-btn px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700" 
                    data-pipeline-id="${pipeline.id}">
                <i class="fas fa-edit mr-1"></i> Edit
            </button>
            <button class="delete-pipeline-btn px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700" 
                    data-pipeline-id="${pipeline.id}">
                <i class="fas fa-trash mr-1"></i> Delete
            </button>
        </div>
    `;
    
    // Add event listeners
    addPipelineCardEventListeners(card, pipeline);
    return card;
}
function getStatusColor(status) {
    const colors = {
        'draft': 'bg-gray-100 text-gray-800',
        'running': 'bg-yellow-100 text-yellow-800',
        'completed': 'bg-green-100 text-green-800',
        'failed': 'bg-red-100 text-red-800'
    };
    return colors[status] || 'bg-gray-100 text-gray-800';
}

function formatDate(dateString) {
    // Add date formatting logic
    return new Date(dateString).toLocaleDateString();
}
// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadPipelines();
    
    // Add event listener for reset button if needed
    const resetBtn = document.getElementById('resetPipelineBtn');
    if (resetBtn) {
        resetBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to reset? This will clear all pipelines from view.')) {
                showEmptyPipelineState();
            }
        });
    }
    
    // Add event listener for execute button if needed
    const executeBtn = document.getElementById('executePipelineBtn');
    if (executeBtn) {
        executeBtn.addEventListener('click', function() {
            showToast('Use the "Run" button on individual pipelines to execute them.', 'info');
        });
    }
});
// Function to add event listeners to pipeline card buttons
function addPipelineCardEventListeners(card, pipeline) {
    // Run pipeline button
    const runBtn = card.querySelector('.run-pipeline-btn');
    if (runBtn) {
        runBtn.addEventListener('click', function() {
            runPipeline(pipeline.id);
        });
    }
    
    // Edit pipeline button
    const editBtn = card.querySelector('.edit-pipeline-btn');
    if (editBtn) {
        editBtn.addEventListener('click', function() {
            editPipeline(pipeline.id);
        });
    }
    
    // Delete pipeline button
    const deleteBtn = card.querySelector('.delete-pipeline-btn');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', function() {
            deletePipeline(pipeline.id, pipeline.name);
        });
    }
}

// Function to show empty pipeline state
function showEmptyPipelineState() {
    const container = document.getElementById('pipelineSteps');
    const emptyState = document.getElementById('emptyPipeline');
    
    if (container) {
        container.innerHTML = '';
    }
    
    if (emptyState) {
        emptyState.style.display = 'block';
    }
    
    // Update pipeline status
    const statusElement = document.getElementById('pipelineStatus');
    if (statusElement) {
        statusElement.textContent = 'No pipelines created yet';
        statusElement.className = 'font-medium text-gray-600';
    }
}

// Function to run a pipeline
// Updated deletePipeline function with better error handling
async function deletePipeline(pipelineId, pipelineName) {
    if (!confirm(`Are you sure you want to delete pipeline "${pipelineName}"?`)) {
        return;
    }
    
    try {
        showToast('Deleting pipeline...', 'info');
        
        const response = await fetch(`/api/assistant/api/pipeline/${pipelineId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                showToast('Pipeline deleted successfully!', 'success');
                loadPipelines();
            } else {
                throw new Error(result.error || 'Delete failed');
            }
        } else if (response.status === 404) {
            throw new Error('Delete endpoint not found (404). Please check backend implementation.');
        } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    } catch (error) {
        console.error('Error deleting pipeline:', error);
        showToast(`Delete failed: ${error.message}`, 'error');
    }
}

// Updated runPipeline function
async function runPipeline(pipelineId) {
    try {
        showToast('Starting pipeline execution...', 'info');
        
        const response = await fetch(`/api/assistant/api/pipeline/${pipelineId}/run/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                showToast('Pipeline execution started!', 'success');
                loadPipelines(); // Refresh to show updated status
            } else {
                throw new Error(result.error || 'Execution failed');
            }
        } else if (response.status === 404) {
            throw new Error('Run endpoint not found (404). Please check backend implementation.');
        } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    } catch (error) {
        console.error('Error running pipeline:', error);
        showToast(`Execution failed: ${error.message}`, 'error');
    }
}

// Updated editPipeline function
async function editPipeline(pipelineId) {
    try {
        const response = await fetch(`/api/assistant/api/pipeline/${pipelineId}/edit/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                // Open pipeline in edit mode
                openPipelineEditor(result.pipeline);
            } else {
                throw new Error(result.error || 'Edit failed');
            }
        } else if (response.status === 404) {
            showToast('Edit functionality coming soon!', 'info');
        } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    } catch (error) {
        console.error('Error editing pipeline:', error);
        showToast('Edit functionality coming soon!', 'info');
    }
}

// Placeholder function for pipeline editor
function openPipelineEditor(pipelineData) {
    console.log('Editing pipeline:', pipelineData);
    showToast('Pipeline editor opening soon!', 'info');
    // Implement your pipeline editor modal or page navigation here
}

// Helper function to show toast messages (if not already defined)
function showToast(message, type = 'info') {
    // Create or use your existing toast notification system
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white text-sm font-medium z-50 ${
        type === 'success' ? 'bg-green-500' :
        type === 'error' ? 'bg-red-500' :
        type === 'warning' ? 'bg-yellow-500' :
        'bg-blue-500'
    }`;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 3000);
}

// Also add this date formatting helper if missing:
function formatDate(dateString) {
    if (!dateString) return 'Unknown date';
    
    const date = new Date(dateString);
    const now = new Date();
    const diffTime = Math.abs(now - date);
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays === 0) {
        return 'Today';
    } else if (diffDays === 1) {
        return 'Yesterday';
    } else if (diffDays < 7) {
        return `${diffDays} days ago`;
    } else {
        return date.toLocaleDateString();
    }
}

// Status color helper function
function getStatusColor(status) {
    const colors = {
        'draft': 'bg-gray-100 text-gray-800',
        'running': 'bg-yellow-100 text-yellow-800',
        'completed': 'bg-green-100 text-green-800',
        'failed': 'bg-red-100 text-red-800',
        'pending': 'bg-blue-100 text-blue-800'
    };
    return colors[status] || 'bg-gray-100 text-gray-800';
}
</script>


</body>
</html>