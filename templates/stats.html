<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyze | DataPilot AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
            height: 100vh;
            overflow: hidden;
        }
        
        .sidebar {
            transition: all 0.3s ease;
        }
        
        .card-hover {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .file-item.selected {
            background-color: #f1f5f9;
        }
        
        .tab-active {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
        }
        
        .mobile-menu {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .mobile-menu.open {
            transform: translateX(0);
        }
        
        .backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        
        /* Table specific styles */
        .data-table {
            border-collapse: collapse;
            width: 100%;
        }
        
        .data-table th {
            position: sticky;
            top: 0;
            background-color: #f8fafc;
            z-index: 10;
            border: 1px solid #e2e8f0;
        }
        
        .data-table th, .data-table td {
            border: 1px solid #e2e8f0;
            padding: 0.75rem;
            text-align: left;
        }
        
        .data-table th {
            font-weight: 600;
            background-color: #f9fafb;
        }
        
        .column-resize-handle {
            position: absolute;
            top: 0;
            right: 0;
            width: 5px;
            height: 100%;
            cursor: col-resize;
            background-color: transparent;
        }
        
        .column-resize-handle:hover {
            background-color: #3b82f6;
        }
        
        .filter-pill {
            display: inline-flex;
            align-items: center;
            background-color: #e0f2fe;
            color: #0369a1;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .insight-card {
            border-left: 4px solid;
        }
        
        .insight-trend {
            border-left-color: #10b981;
        }
        
        .insight-anomaly {
            border-left-color: #ef4444;
        }
        
        .insight-outlier {
            border-left-color: #f59e0b;
        }
        
        .insight-schema {
            border-left-color: #8b5cf6;
        }
        
        /* Animation for insights */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">
    
    <!-- Top Navigation Bar -->
    <header class="bg-white border-b border-gray-200 py-3 px-4 flex items-center justify-between flex-shrink-0">
        <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2">
                <div class="bg-indigo-600 p-1.5 rounded">
                    <i class="fas fa-rocket text-white text-sm"></i>
                </div>
                <h1 class="text-lg font-semibold text-gray-800">DataPilot AI</h1>
                <span class="text-gray-400">/</span>
                <div class="flex items-center space-x-2">
                    <a href="{% url 'assistant_workspace' %}" class="text-gray-700 font-medium text-sm hover:text-indigo-600">Workspace</a>
                    <span class="text-gray-400">/</span>
                    <span class="text-gray-700 font-medium text-sm">Analyze</span>
                </div>
            </div>
            
            <div class="hidden md:flex items-center space-x-1">
                <button class="px-3 py-1.5 text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded">Save Analysis</button>
                <button class="px-3 py-1.5 text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded">Export Data</button>
                <button class="px-3 py-1.5 text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded">Share</button>
            </div>
        </div>
        
        <div class="flex items-center space-x-3">
            <div class="relative hidden md:block">
                <input type="text" placeholder="Search dataset..." class="pl-9 pr-4 py-1.5 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 w-64">
                <i class="fas fa-search absolute left-3 top-2 text-gray-400 text-sm"></i>
            </div>
            
            <button class="relative p-1.5 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded">
                <i class="fas fa-bell text-sm"></i>
                <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
            </button>
            
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 text-sm font-semibold">
                    {{ user_initials }}
                </div>
                <span class="hidden md:inline text-sm text-gray-700">{{ username }}</span>
            </div>
        </div>
    </header>
    
    <!-- Mobile Menu Button -->
    <div class="md:hidden bg-white border-b border-gray-200 p-3 flex justify-between items-center flex-shrink-0">
        <button id="mobileMenuButton" class="p-1.5 text-gray-500">
            <i class="fas fa-bars"></i>
        </button>
        <div class="relative flex-1 mx-4">
            <input type="text" placeholder="Search..." class="pl-8 pr-4 py-1.5 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 w-full">
            <i class="fas fa-search absolute left-2.5 top-2 text-gray-400 text-sm"></i>
        </div>
    </div>
    
    <!-- Main Content Area -->
    <div class="flex flex-1 overflow-hidden">
        <!-- Left Sidebar - Dataset Navigator -->
        <div class="sidebar bg-white border-r border-gray-200 w-64 flex-col flex-shrink-0 hidden md:flex overflow-y-auto">
            <div class="p-4 border-b border-gray-200">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">Dataset</h2>
                    <button class="text-xs text-indigo-600 hover:text-indigo-800 font-medium" onclick="refreshDatasets()">Refresh</button>
                </div>
                
                <a href="{% url 'upload_dataset' %}" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-3 rounded text-sm font-medium flex items-center justify-center mb-3">
                    <i class="fas fa-plus mr-2"></i>
                    New Dataset
                </a>
                
<div class="flex space-x-2 mb-3">
    <button class="flex-1 bg-indigo-100 text-indigo-800 py-1.5 px-2 rounded text-xs font-medium filter-btn" onclick="filterDatasetsByType('all')">
        All Datasets
    </button>
    <button class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-1.5 px-2 rounded text-xs font-medium filter-btn" onclick="filterDatasetsByType('recent')">
        Recent
    </button>
</div>
<div class="relative">
    <input type="text" placeholder="Search datasets..." class="pl-8 pr-3 py-1.5 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 w-full text-xs" id="datasetSearch">
    <i class="fas fa-search absolute left-2.5 top-2 text-gray-400 text-xs"></i>
</div>
            </div>
            
            <div class="flex-1 p-2 overflow-y-auto">
<div class="mb-4">
    <h3 class="text-xs font-medium text-gray-500 uppercase tracking-wide px-2 mb-2">Datasets</h3>
    <ul class="space-y-1" id="datasetList">
        {% for dataset in datasets %}
        <li class="dataset-item">
            <div class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer {% if selected_dataset and dataset.id == selected_dataset.id %}bg-indigo-50 border border-indigo-200{% endif %}" 
                 onclick="loadDatasetAnalysis('{{ dataset.id }}')">
                <i class="fas fa-database text-indigo-600 mr-2 text-sm"></i>
                <span class="text-sm text-gray-700 truncate dataset-name">{{ dataset.file_name }}</span>
            </div>
        </li>
        {% empty %}
        <li class="px-2 py-4 text-center text-gray-500">
            <i class="fas fa-database text-2xl mb-2"></i>
            <p class="text-sm">No datasets available</p>
            <a href="{% url 'upload_dataset' %}" class="text-indigo-600 hover:text-indigo-800 text-xs">Upload your first dataset</a>
        </li>
        {% endfor %}
    </ul>
    <div id="noDatasetsMessage" class="px-2 py-4 text-center text-gray-500 hidden">
        <i class="fas fa-search text-2xl mb-2"></i>
        <p class="text-sm">No datasets match your search</p>
    </div>
</div>

<script>
    // Dataset search functionality
document.getElementById('datasetSearch').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase().trim();
    const datasetItems = document.querySelectorAll('#datasetList .dataset-item');
    const noDatasetsMessage = document.getElementById('noDatasetsMessage');
    
    let visibleCount = 0;
    
    datasetItems.forEach(item => {
        const datasetName = item.querySelector('.dataset-name').textContent.toLowerCase();
        if (datasetName.includes(searchTerm)) {
            item.style.display = 'block';
            visibleCount++;
        } else {
            item.style.display = 'none';
        }
    });
    
    // Show/hide no results message
    if (visibleCount === 0 && searchTerm !== '') {
        noDatasetsMessage.classList.remove('hidden');
    } else {
        noDatasetsMessage.classList.add('hidden');
    }
});

// Filter datasets by type (All/Recent)
function filterDatasetsByType(type) {
    const datasetItems = document.querySelectorAll('#datasetList .dataset-item');
    const searchInput = document.getElementById('datasetSearch');
    const searchTerm = searchInput.value.toLowerCase().trim();
    
    datasetItems.forEach(item => {
        const datasetName = item.querySelector('.dataset-name').textContent.toLowerCase();
        const matchesSearch = datasetName.includes(searchTerm);
        
        if (type === 'all') {
            item.style.display = matchesSearch ? 'block' : 'none';
        } else if (type === 'recent') {
            // For demo purposes, we'll consider datasets with "sales" or "2023" as recent
            const isRecent = datasetName.includes('sales') || datasetName.includes('2023');
            item.style.display = (isRecent && matchesSearch) ? 'block' : 'none';
        }
    });
    
    // Update button states
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('bg-indigo-100', 'text-indigo-800');
        btn.classList.add('bg-gray-100', 'text-gray-700');
    });
    
    event.target.classList.add('bg-indigo-100', 'text-indigo-800');
    event.target.classList.remove('bg-gray-100', 'text-gray-700');
}
</script>
                
                <div class="mb-4">
                    <h3 class="text-xs font-medium text-gray-500 uppercase tracking-wide px-2 mb-2">Analysis Views</h3>
                    <ul class="space-y-1">
                        <li>
                            <div class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                <i class="fas fa-chart-bar text-red-600 mr-2 text-sm"></i>
                                <span class="text-sm text-gray-700 truncate">Sales Performance</span>
                            </div>
                        </li>
                        <li>
                            <div class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                <i class="fas fa-chart-line text-orange-600 mr-2 text-sm"></i>
                                <span class="text-sm text-gray-700 truncate">Customer Trends</span>
                            </div>
                        </li>
                    </ul>
                </div>
                
                <div>
                    <h3 class="text-xs font-medium text-gray-500 uppercase tracking-wide px-2 mb-2">Analysis Actions</h3>
                    <div class="space-y-1 px-2">
                        <div class="flex items-center text-xs text-gray-600 hover:text-gray-800 py-1 cursor-pointer" onclick="refreshAnalysis()">
                            <i class="fas fa-sync-alt text-indigo-500 mr-2"></i>
                            <span>Refresh Data</span>
                        </div>
                        <div class="flex items-center text-xs text-gray-600 hover:text-gray-800 py-1 cursor-pointer" onclick="generateInsights()">
                            <i class="fas fa-lightbulb text-green-500 mr-2"></i>
                            <span>Generate Insights</span>
                        </div>
                        <div class="flex items-center text-xs text-gray-600 hover:text-gray-800 py-1 cursor-pointer" onclick="exportAnalysis()">
                            <i class="fas fa-file-export text-blue-500 mr-2"></i>
                            <span>Export Analysis</span>
                        </div>
                    </div>
                </div>
            </div>

            
        </div>
        
        <!-- Center Panel - Analysis Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Toolbar -->
            <div class="bg-white border-b border-gray-200 p-3 flex-shrink-0">
                <div class="flex flex-wrap items-center justify-between gap-3">
                    <div class="flex items-center space-x-2">
                        <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded text-sm font-medium inline-flex items-center" onclick="showFilterModal()">
                            <i class="fas fa-filter mr-1.5 text-xs"></i>
                            Add Filter
                        </button>
                        
                        <button class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-sm font-medium inline-flex items-center" onclick="applyFilters()">
                            <i class="fas fa-play mr-1.5 text-xs"></i>
                            Apply Filters
                        </button>
                        
                        <button class="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded text-sm font-medium inline-flex items-center" onclick="clearAllFilters()">
                            <i class="fas fa-times mr-1.5 text-xs"></i>
                            Clear All
                        </button>
                        
                        <button class="bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 px-3 py-1.5 rounded text-sm font-medium inline-flex items-center" onclick="generateInsights()">
                            <i class="fas fa-lightbulb mr-1.5 text-xs"></i>
                            Auto Insights
                        </button>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded text-sm font-medium inline-flex items-center">
                            <i class="fas fa-save mr-1.5 text-xs"></i>
                            Save Analysis
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Tabs - Navigation to different pages -->
            <div class="bg-white border-b border-gray-200 flex-shrink-0">
                <div class="flex overflow-x-auto">
                    <a href="{% url 'assistant_table' %}" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800 whitespace-nowrap">
                        <i class="fas fa-table mr-1.5"></i>
                        Table View
                    </a>
                    <a href="{% url 'assistant_schema' %}" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800 whitespace-nowrap">
                        <i class="fas fa-project-diagram mr-1.5"></i>
                        Schema
                    </a>
                    <a href="#" class="tab-active px-4 py-3 text-sm font-medium whitespace-nowrap">
                        <i class="fas fa-chart-bar mr-1.5"></i>
                        Analyze
                    </a>
                    <a href="{% url 'assistant_transformation' %}" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800 whitespace-nowrap">
                        <i class="fas fa-sync-alt mr-1.5"></i>
                        Transformations
                    </a>
                    <a href="{% url 'history' %}" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800 whitespace-nowrap">
                        <i class="fas fa-history mr-1.5"></i>
                        History
                    </a>
                    <a href="{% url 'notes' %}" class="px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-800 whitespace-nowrap">
                        <i class="fas fa-sticky-note mr-1.5"></i>
                        Notes
                    </a>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="flex-1 overflow-auto p-6">
                <!-- Dataset Overview -->
                <div class="mb-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h2 class="text-xl font-semibold text-gray-800 mb-2">
                                {% if selected_dataset %}
                                    {{ selected_dataset.file_name }} Analysis
                                {% else %}
                                    Dataset Analysis
                                {% endif %}
                            </h2>
                            <p class="text-gray-600">Explore, filter, and analyze your dataset with powerful tools</p>
                        </div>
                        <div class="flex space-x-2">
                            <button class="bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 px-3 py-1.5 rounded text-sm font-medium" onclick="exportAnalysis()">
                                <i class="fas fa-download mr-1.5"></i>
                                Export
                            </button>
                            <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded text-sm font-medium" onclick="refreshAnalysis()">
                                <i class="fas fa-sync-alt mr-1.5"></i>
                                Refresh
                            </button>
                        </div>
                    </div>
                    
                    <!-- Dataset Stats Cards -->
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 mb-6">
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <p class="text-sm text-gray-500 mb-1">Total Records</p>
                            <p class="text-xl font-semibold text-gray-800">{{ dataset_stats.total_records|default:"0" }}</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <p class="text-sm text-gray-500 mb-1">Total Features</p>
                            <p class="text-xl font-semibold text-gray-800">{{ dataset_stats.total_features|default:"0" }}</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <p class="text-sm text-gray-500 mb-1">Last Updated</p>
                            <p class="text-xl font-semibold text-gray-800">{{ dataset_stats.last_updated|default:"Never" }}</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <p class="text-sm text-gray-500 mb-1">Missing Data</p>
                            <p class="text-xl font-semibold text-gray-800">{{ dataset_stats.missing_data_percentage|default:"0" }}%</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <p class="text-sm text-gray-500 mb-1">Duplicate Rows</p>
                            <p class="text-xl font-semibold text-gray-800">{{ dataset_stats.duplicate_rows|default:"0" }}</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <p class="text-sm text-gray-500 mb-1">Data Size</p>
                            <p class="text-xl font-semibold text-gray-800">{{ dataset_stats.data_size_mb|default:"0" }} MB</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <p class="text-sm text-gray-500 mb-1">Data Quality</p>
                            <p class="text-xl font-semibold text-green-600">{{ dataset_stats.data_quality_percentage|default:"0" }}%</p>
                        </div>
                    </div>
                </div>
                
                <!-- Filter Panel -->
                <div class="bg-white border border-gray-200 rounded-lg overflow-hidden mb-6">
                    <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                        <h3 class="font-medium text-gray-800">Active Filters</h3>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-600" id="activeFilterCount">
                                {{ active_filters|length }} active filter(s)
                            </span>
                        </div>
                    </div>
                    
                    <div class="p-4">
                        <!-- Active Filters Display -->
                        <div class="mb-4">

<!-- In the active filters section -->
<div class="flex flex-wrap" id="activeFiltersContainer">
    {% for filter in active_filters %}
    <div class="filter-pill">
        <span>{{ filter.column }} {{ filter.operator|title }} {{ filter.value }}{% if filter.value2 %} and {{ filter.value2 }}{% endif %}</span>
        <button class="ml-1 text-gray-500 hover:text-gray-700" onclick="removeActiveFilter({{ forloop.counter0 }})">
            <i class="fas fa-times text-xs"></i>
        </button>
    </div>
    {% empty %}
    <div class="text-gray-500 text-sm">
        No active filters. Click "Add Filter" to start filtering your data.
    </div>
    {% endfor %}
</div>

                        </div>
                        
                        <!-- Global Search -->
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Global Search</label>
                            <div class="relative">
                                <input type="text" placeholder="Search across all columns..." class="w-full pl-9 pr-4 py-2 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" id="globalSearch" value="{{ global_search|default:'' }}">
                                <i class="fas fa-search absolute left-3 top-2.5 text-gray-400 text-sm"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Data Table and Insights -->
                <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                    <!-- Data Table -->
                    <div class="xl:col-span-2">
                        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                                <h3 class="font-medium text-gray-800">Dataset Preview</h3>
                                <div class="flex items-center space-x-2">
                                    <span class="text-sm text-gray-600">
                                        Showing {{ table_data.rows|length }} of {{ dataset_stats.total_records }} rows
                                        {% if total_pages > 1 %}
                                            (Page {{ current_page }} of {{ total_pages }})
                                        {% endif %}
                                    </span>
                                    <div class="flex space-x-1">
                                        <button class="pagination-btn text-sm text-gray-600 hover:text-gray-800 flex items-center {% if current_page <= 1 %}opacity-50 cursor-not-allowed{% endif %}" 
                                                onclick="changePage({{ current_page|add:'-1' }})" {% if current_page <= 1 %}disabled{% endif %}>
                                            <i class="fas fa-chevron-left mr-1"></i>
                                        </button>
                                        <button class="pagination-btn text-sm text-gray-600 hover:text-gray-800 flex items-center {% if current_page >= total_pages %}opacity-50 cursor-not-allowed{% endif %}" 
                                                onclick="changePage({{ current_page|add:'1' }})" {% if current_page >= total_pages %}disabled{% endif %}>
                                            <i class="fas fa-chevron-right mr-1"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="overflow-x-auto">
                                {% if table_data.headers %}
                                <table class="data-table min-w-full">
                                    <thead>
                                        <tr>
                                            {% for header in table_data.headers %}
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-50 relative" onclick="sortTable('{{ header }}')">
                                                {{ header }}
                                                <span class="absolute right-2 top-3.5 text-gray-400">
                                                    <i class="fas fa-sort"></i>
                                                </span>
                                                <div class="column-resize-handle"></div>
                                            </th>
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        {% for row in table_data.rows %}
                                        <tr class="hover:bg-gray-50">
                                            {% for cell in row %}
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">{{ cell }}</td>
                                            {% endfor %}
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                                {% else %}
                                <div class="p-8 text-center text-gray-500">
                                    <i class="fas fa-table text-2xl mb-2"></i>
                                    <p>No data available for preview</p>
                                    <p class="text-sm">Select a dataset to view its contents</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Insights Panel -->
                    <div class="xl:col-span-1">
                        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden h-full">
                            <div class="p-4 border-b border-gray-200">
                                <h3 class="font-medium text-gray-800">Auto-Generated Insights</h3>
                                <p class="text-sm text-gray-600 mt-1">Patterns and anomalies detected in your data</p>
                            </div>
                            
                            <div class="p-4 overflow-y-auto max-h-96">
                                <div class="space-y-4">
                                    {% for insight in insights %}
                                    <div class="insight-card insight-{{ insight.type }} bg-white p-4 rounded border border-gray-200 fade-in">
                                        <div class="flex items-start">
                                            <div class="bg-{{ insight.color }}-100 p-2 rounded mr-3">
                                                <i class="fas fa-{{ insight.icon }} text-{{ insight.color }}-600"></i>
                                            </div>
                                            <div>
                                                <h4 class="font-medium text-gray-800 mb-1">{{ insight.title }}</h4>
                                                <p class="text-sm text-gray-600">{{ insight.description }}</p>
                                            </div>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="text-center text-gray-500 py-8">
                                        <i class="fas fa-lightbulb text-2xl mb-2"></i>
                                        <p>No insights available</p>
                                        <p class="text-sm">Select a dataset to generate insights</p>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Statistical Summary and Column Insights -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                    <!-- Statistical Summary -->
                    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                        <div class="p-4 border-b border-gray-200">
                            <h3 class="font-medium text-gray-800">Statistical Summary</h3>
                            <p class="text-sm text-gray-600 mt-1">Key metrics for numerical columns</p>
                        </div>
                        
                        <div class="p-4 overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Column</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Count</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mean</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Min</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Max</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Std Dev</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    {% for stat in statistical_summary %}
                                    <tr>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">{{ stat.column }}</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">{{ stat.count }}</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">{{ stat.mean }}</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">{{ stat.min }}</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">{{ stat.max }}</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">{{ stat.std_dev }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                                            <i class="fas fa-chart-bar text-xl mb-2"></i>
                                            <p>No statistical data available</p>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Column Insights -->
                    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                        <div class="p-4 border-b border-gray-200">
                            <h3 class="font-medium text-gray-800">Column Insights</h3>
                            <p class="text-sm text-gray-600 mt-1">Data dictionary and column statistics</p>
                        </div>
                        
                        <div class="p-4 overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Column</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data Type</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unique Values</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Null %</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sample Values</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    {% for column in column_stats %}
                                    <tr>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">{{ column.name }}</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">{{ column.data_type }}</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">{{ column.unique_values }}</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">{{ column.null_percentage }}%</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">{{ column.sample_values }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                                            <i class="fas fa-columns text-xl mb-2"></i>
                                            <p>No column data available</p>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filter Modal -->
    <div id="filterModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Add New Filter</h3>
                <button onclick="closeFilterModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <!-- Column Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Select Column</label>
                    <select class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" id="filterColumn">
                        <option value="">Choose a column...</option>
                        {% for column in available_columns %}
                        <option value="{{ column.name }}">{{ column.name }} ({{ column.data_type }})</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Filter Type -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Filter Type</label>
                    <select class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" id="filterOperator">
                        <option value="">Select filter type...</option>
                        <option value="equals">Equals</option>
                        <option value="contains">Contains</option>
                        <option value="greater_than">Greater Than</option>
                        <option value="less_than">Less Than</option>
                        <option value="between">Between</option>
                        <option value="starts_with">Starts With</option>
                        <option value="ends_with">Ends With</option>
                    </select>
                </div>
                
                <!-- Filter Value -->
                <div id="filterValueContainer">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Filter Value</label>
                    <input type="text" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" id="filterValue" placeholder="Enter value...">
                </div>
                
                <!-- Second Value for Between -->
                <div id="filterValue2Container" style="display: none;">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Second Value</label>
                    <input type="text" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" id="filterValue2" placeholder="Enter second value...">
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeFilterModal()" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 border border-gray-300 rounded">
                    Cancel
                </button>
                <button onclick="addNewFilter()" class="px-4 py-2 text-sm bg-indigo-600 hover:bg-indigo-700 text-white rounded">
                    Add Filter
                </button>
            </div>
        </div>
    </div>
    
    <!-- Mobile Menu Overlay -->
    <div id="mobileMenu" class="mobile-menu fixed inset-0 z-50 flex md:hidden">
        <div class="backdrop fixed inset-0" id="mobileBackdrop"></div>
        <div class="sidebar bg-white w-64 h-full relative z-10 flex flex-col">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="bg-indigo-600 p-1.5 rounded">
                        <i class="fas fa-rocket text-white text-sm"></i>
                    </div>
                    <h1 class="text-lg font-semibold">DataPilot AI</h1>
                </div>
                <button id="closeMobileMenu" class="p-2">
                    <i class="fas fa-times text-gray-500"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-4">
                <ul class="space-y-1">
                    <li><a href="{% url 'assistant_workspace' %}" class="block p-3 text-gray-700">Workspaces</a></li>
                    <li><a href="{% url 'assistant_table' %}" class="block p-3 text-gray-700">Table View</a></li>
                    <li><a href="{% url 'assistant_schema' %}" class="block p-3 text-gray-700">Schema</a></li>
                    <li><a href="#" class="block p-3 bg-indigo-50 text-indigo-700 font-medium">Analyze</a></li>
                    <li><a href="{% url 'assistant_transformation' %}" class="block p-3 text-gray-700">Transformations</a></li>
                    <li><a href="{% url 'history' %}" class="block p-3 text-gray-700">History</a></li>
                    <li><a href="{% url 'notes' %}" class="block p-3 text-gray-700">Notes</a></li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Mobile menu functionality
        const mobileMenuButton = document.getElementById('mobileMenuButton');
        const mobileMenu = document.getElementById('mobileMenu');
        const closeMobileMenu = document.getElementById('closeMobileMenu');
        const mobileBackdrop = document.getElementById('mobileBackdrop');
        
        if (mobileMenuButton) {
            mobileMenuButton.addEventListener('click', function() {
                mobileMenu.classList.add('open');
            });
        }
        
        if (closeMobileMenu) {
            closeMobileMenu.addEventListener('click', function() {
                mobileMenu.classList.remove('open');
            });
        }
        
        if (mobileBackdrop) {
            mobileBackdrop.addEventListener('click', function() {
                mobileMenu.classList.remove('open');
            });
        }
        
        // Filter Modal Functions
        function showFilterModal() {
            document.getElementById('filterModal').style.display = 'block';
            // Reset form
            document.getElementById('filterColumn').value = '';
            document.getElementById('filterOperator').value = '';
            document.getElementById('filterValue').value = '';
            document.getElementById('filterValue2').value = '';
            document.getElementById('filterValue2Container').style.display = 'none';
        }
        
        function closeFilterModal() {
            document.getElementById('filterModal').style.display = 'none';
        }
        
        function addNewFilter() {
            const column = document.getElementById('filterColumn').value;
            const operator = document.getElementById('filterOperator').value;
            const value = document.getElementById('filterValue').value;
            const value2 = document.getElementById('filterValue2').value;
            
            if (!column || !operator || !value) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Create filter object
            const filter = {
                column: column,
                operator: operator,
                value: value
            };
            
            if (operator === 'between' && value2) {
                filter.value2 = value2;
            }
            
            // Add filter to URL and reload
            addFilterToURL(filter);
        }
        
        function addFilterToURL(filter) {
            const url = new URL(window.location);
            
            // Get current filter count
            let filterCount = 0;
            for (const key of url.searchParams.keys()) {
                if (key.startsWith('filter_') && key.endsWith('_column')) {
                    filterCount++;
                }
            }
            
            // Add new filter
            const filterIndex = filterCount;
            url.searchParams.set(`filter_${filterIndex}_column`, filter.column);
            url.searchParams.set(`filter_${filterIndex}_operator`, filter.operator);
            url.searchParams.set(`filter_${filterIndex}_value`, filter.value);
            
            if (filter.value2) {
                url.searchParams.set(`filter_${filterIndex}_value2`, filter.value2);
            }
            
            // Reset to first page when adding new filter
            url.searchParams.set('page', '1');
            
            window.location.href = url.toString();
        }
        
        function removeActiveFilter(index) {
            const url = new URL(window.location);
            
            // Remove the specific filter
            url.searchParams.delete(`filter_${index}_column`);
            url.searchParams.delete(`filter_${index}_operator`);
            url.searchParams.delete(`filter_${index}_value`);
            url.searchParams.delete(`filter_${index}_value2`);
            
            // Reindex remaining filters
            const filters = [];
            for (const key of url.searchParams.keys()) {
                if (key.startsWith('filter_') && key.endsWith('_column')) {
                    const oldIndex = key.replace('filter_', '').replace('_column', '');
                    filters.push({
                        index: parseInt(oldIndex),
                        column: url.searchParams.get(`filter_${oldIndex}_column`),
                        operator: url.searchParams.get(`filter_${oldIndex}_operator`),
                        value: url.searchParams.get(`filter_${oldIndex}_value`),
                        value2: url.searchParams.get(`filter_${oldIndex}_value2`)
                    });
                }
            }
            
            // Remove all filter parameters
            for (const key of url.searchParams.keys()) {
                if (key.startsWith('filter_')) {
                    url.searchParams.delete(key);
                }
            }
            
            // Add back filters with new indices
            filters.forEach((filter, newIndex) => {
                if (filter.index !== index) {
                    url.searchParams.set(`filter_${newIndex}_column`, filter.column);
                    url.searchParams.set(`filter_${newIndex}_operator`, filter.operator);
                    url.searchParams.set(`filter_${newIndex}_value`, filter.value);
                    if (filter.value2) {
                        url.searchParams.set(`filter_${newIndex}_value2`, filter.value2);
                    }
                }
            });
            
            window.location.href = url.toString();
        }
        
        function applyFilters() {
            // Filters are already applied via URL parameters, just reload
            window.location.reload();
        }
        
        function clearAllFilters() {
            const url = new URL(window.location);
            
            // Remove all filter parameters
            for (const key of url.searchParams.keys()) {
                if (key.startsWith('filter_')) {
                    url.searchParams.delete(key);
                }
            }
            
            // Remove global search
            url.searchParams.delete('search');
            
            // Reset to first page
            url.searchParams.set('page', '1');
            
            window.location.href = url.toString();
        }
        
        // Update filter UI based on operator selection
        document.getElementById('filterOperator').addEventListener('change', function() {
            const operator = this.value;
            const value2Container = document.getElementById('filterValue2Container');
            
            if (operator === 'between') {
                value2Container.style.display = 'block';
            } else {
                value2Container.style.display = 'none';
            }
        });
        
        // Global search functionality
        document.getElementById('globalSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const searchTerm = this.value;
                const url = new URL(window.location);
                
                if (searchTerm) {
                    url.searchParams.set('search', searchTerm);
                } else {
                    url.searchParams.delete('search');
                }
                
                // Reset to first page when searching
                url.searchParams.set('page', '1');
                
                window.location.href = url.toString();
            }
        });
        
        // Table sorting functionality
        const tableHeaders = document.querySelectorAll('.data-table th');
        tableHeaders.forEach(header => {
            header.addEventListener('click', function() {
                const columnName = this.textContent.trim();
                sortTable(columnName);
            });
        });
        
        // Load dataset analysis
        function loadDatasetAnalysis(datasetId) {
            const url = new URL(window.location);
            url.searchParams.set('dataset', datasetId);
            url.searchParams.set('page', '1'); // Reset to first page
            window.location.href = url.toString();
        }
        
        // Refresh analysis
        function refreshAnalysis() {
            window.location.reload();
        }
        
        // Refresh datasets list
        function refreshDatasets() {
            window.location.reload();
        }
        
        // Generate insights
        function generateInsights() {
            alert('Generating new insights...');
            refreshAnalysis();
        }
        
        // Export analysis
        function exportAnalysis() {
            alert('Exporting analysis data...');
        }
        
        // Change page
        function changePage(page) {
            if (page < 1 || page > {{ total_pages }}) return;
            
            const url = new URL(window.location);
            url.searchParams.set('page', page.toString());
            window.location.href = url.toString();
        }
        
        // Table sorting
        function sortTable(columnName) {
            const url = new URL(window.location);
            const currentSort = url.searchParams.get('sort');
            const currentOrder = url.searchParams.get('order');
            
            let newOrder = 'asc';
            if (currentSort === columnName && currentOrder === 'asc') {
                newOrder = 'desc';
            }
            
            url.searchParams.set('sort', columnName);
            url.searchParams.set('order', newOrder);
            url.searchParams.set('page', '1');
            
            window.location.href = url.toString();
        }
        
        // Simulate loading insights with animation
        document.addEventListener('DOMContentLoaded', function() {
            const insights = document.querySelectorAll('.fade-in');
            insights.forEach((insight, index) => {
                setTimeout(() => {
                    insight.style.opacity = '1';
                    insight.style.transform = 'translateY(0)';
                }, index * 200);
            });
            
            // Update active filter count
            const activeFilters = document.querySelectorAll('.filter-pill');
            document.getElementById('activeFilterCount').textContent = `${activeFilters.length} active filter(s)`;
        });

        // Close modal when clicking outside
        document.getElementById('filterModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeFilterModal();
            }
        });
    </script>
</body>
</html>