<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Dataset | DataPilot AI</title>
    <style>
        .section { display:none; margin-top:15px; padding:12px; border:1px solid #ddd; border-radius:8px; }
        label { font-size: 14px; font-weight: 600; }
        input, textarea, select { width: 100%; padding: 8px; margin-top: 4px; margin-bottom: 12px; font-size: 14px; }
        h4 { margin-bottom: 10px; }
        .info-box { background:#f5faff; border-left:4px solid #007bff; padding:10px; margin-bottom:15px; }
        .warning { background:#fff7e6; border-left:4px solid #ff9900; padding:10px; margin-bottom:15px; }
        .success-section { background:#d4edda; border:2px solid #c3e6cb; border-radius:8px; padding:20px; margin:20px 0; }
        .endpoint-box { background:#f8f9fa; border:2px dashed #28a745; padding:15px; border-radius:6px; margin:15px 0; font-family: monospace; word-break: break-all; }
        .copy-btn { background:#28a745; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer; margin-left:10px; }
        .example-code { background:#2d2d2d; color:#f8f9fa; padding:12px; border-radius:4px; margin:10px 0; font-family: monospace; font-size:12px; }
    </style>
</head>
<body>

<h2><strong>Add Dataset</strong></h2>
<p><a href="{% url 'assistant_workspace' %}">‚Üê Back to Workspace</a></p>
<hr><br>

<!-- SUCCESS MESSAGE FOR API DATASET -->
{% if show_api_success %}
<div class="success-section">
    <h3 style="color: #155724; margin-top: 0;">‚úÖ API Endpoint Created Successfully!</h3>
    <p><strong>Dataset "{{ dataset_name }}" is ready to receive data!</strong></p>
    
    <h4>Your Unique API Endpoint:</h4>
    <div class="endpoint-box" id="endpointUrl">
        {{ endpoint_url }}
    </div>
    <button class="copy-btn" onclick="copyEndpoint()">üìã Copy URL</button>
    
    <!-- NEW: Show allowed website -->
    <div style="margin-top: 15px; padding: 10px; background: #e7f3ff; border-radius: 4px;">
        <strong>üåê Allowed Website:</strong> {{ website_url }}<br>
        <small>Only this website can send data to your endpoint</small>
    </div>
    
    <div style="margin-top: 20px;">
        <h4>üìñ How to use this endpoint:</h4>
        <p><strong>HTTP Method:</strong> POST</p>
        <p><strong>Content-Type:</strong> application/json</p>
        
        <h5>Example JavaScript for your website:</h5>
        <div class="example-code">
            // On your website: {{ website_url }}<br>
            fetch("{{ endpoint_url }}", {<br>
            &nbsp;&nbsp;method: "POST",<br>
            &nbsp;&nbsp;headers: { <br>
            &nbsp;&nbsp;&nbsp;&nbsp;"Content-Type": "application/json"<br>
            &nbsp;&nbsp;&nbsp;&nbsp;// "X-API-Token": "your_token_here" // if you set one<br>
            &nbsp;&nbsp;},<br>
            &nbsp;&nbsp;body: JSON.stringify({<br>
            &nbsp;&nbsp;&nbsp;&nbsp;order_id: "123",<br>
            &nbsp;&nbsp;&nbsp;&nbsp;amount: 99.99,<br>
            &nbsp;&nbsp;&nbsp;&nbsp;customer: "John Doe"<br>
            &nbsp;&nbsp;})<br>
            })
        </div>
    </div>
    
    <div style="margin-top: 20px;">
        <a href="{% url 'dashboard' %}" style="background: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px; margin-right: 10px;">üìä Go to Dashboard</a>
        <a href="{% url 'upload_dataset' %}" style="background: #6c757d; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px;">‚ûï Add Another Dataset</a>
    </div>
</div>
{% endif %}

<!-- MAIN FORM -->
<form method="POST" enctype="multipart/form-data" {% if show_api_success %}style="display: none;"{% endif %}>
    {% csrf_token %}

    <label>Dataset Name</label>
    <input type="text" name="name" required placeholder="Ex: Sales 2025" value="{{ request.POST.name }}">

    <label>Description (Optional)</label>
    <textarea name="description" rows="3" placeholder="Describe your dataset">{{ request.POST.description }}</textarea>

    <label>Select Data Source</label>
    <select name="data_source" id="data_source" onchange="toggleSources()" required>
        <option value="file">üìÅ Upload File</option>
        <option value="mongodb">üçÄ MongoDB</option>
        <option value="postgresql">üêò PostgreSQL</option>
        <option value="mysql">üõ¢ MySQL</option>
        <option value="api">üîó Send Data To Our Endpoint (Webhook)</option>
    </select>

    <!-- FILE -->
    <div id="file" class="section">
        <label>Select File</label>
        <input type="file" name="file" accept=".csv,.xlsx,.xls,.json,.txt,.tsv,.parquet">
    </div>

    <!-- MONGODB -->
    <div id="mongodb" class="section">
        <h4>MongoDB Connection</h4>
        <label>Connection URI</label>
        <input type="text" name="mongo_uri" placeholder="mongodb+srv://user:pass@cluster.mongodb.net/?retryWrites=true&w=majority" value="{{ request.POST.mongo_uri }}">
        <label>Database Name</label>
        <input type="text" name="mongo_db" placeholder="database_name" value="{{ request.POST.mongo_db }}">
        <label>Collection Name</label>
        <input type="text" name="mongo_collection" placeholder="collection_name" value="{{ request.POST.mongo_collection }}">
    </div>

    <!-- POSTGRESQL -->
    <div id="postgresql" class="section">
        <h4>PostgreSQL Connection</h4>
        <label>Host</label>
        <input type="text" name="pg_host" value="{{ request.POST.pg_host }}">
        <label>Port</label>
        <input type="text" name="pg_port" placeholder="5432" value="{{ request.POST.pg_port }}">
        <label>Database Name</label>
        <input type="text" name="pg_db" value="{{ request.POST.pg_db }}">
        <label>User</label>
        <input type="text" name="pg_user" value="{{ request.POST.pg_user }}">
        <label>Password</label>
        <input type="password" name="pg_password" value="{{ request.POST.pg_password }}">
        <label>Schema (Optional)</label>
        <input type="text" name="pg_schema" placeholder="public" value="{{ request.POST.pg_schema }}">
        <label>Table</label>
        <input type="text" name="pg_table" value="{{ request.POST.pg_table }}">
    </div>

    <!-- MYSQL -->
    <div id="mysql" class="section">
        <h4>MySQL Connection</h4>
        <label>Host</label>
        <input type="text" name="my_host" value="{{ request.POST.my_host }}">
        <label>Port</label>
        <input type="text" name="my_port" placeholder="3306" value="{{ request.POST.my_port }}">
        <label>Database Name</label>
        <input type="text" name="my_db" value="{{ request.POST.my_db }}">
        <label>User</label>
        <input type="text" name="my_user" value="{{ request.POST.my_user }}">
        <label>Password</label>
        <input type="password" name="my_password" value="{{ request.POST.my_password }}">
        <label>Table</label>
        <input type="text" name="my_table" value="{{ request.POST.my_table }}">
    </div>

    <!-- API (WEBHOOK PUSH ENDPOINT) -->
    <div id="api" class="section">
        <h4>Webhook-Based Dataset (Send Data to Our Endpoint)</h4>
        <div class="info-box">
            After you save the dataset, an <strong>API Endpoint URL</strong> will be generated for you.<br>
            When your website sends JSON data to the URL, we will store it securely under this dataset.
        </div>

        <!-- ‚úÖ FIXED: Website URL is now only required when API is selected -->
        <label id="website_url_label">Your Website URL (Required for CORS) *</label>
        <input type="url" name="website_url" 
               placeholder="https://yourwebsite.com" 
               value="{{ request.POST.website_url }}"
               pattern="https?://.+" 
               title="Include http:// or https://"
               id="website_url_input">
        <small style="color: #666;">This website will be allowed to send data to your endpoint</small>

        <label>Authentication Token (Optional)</label>
        <input type="text" name="api_auth" placeholder="Custom token to validate incoming push" value="{{ request.POST.api_auth }}">

        <label>Expected JSON Schema (Optional - for validation)</label>
        <textarea name="api_schema" rows="3" placeholder='{"order_id": "string", "amount": "number"}'>{{ request.POST.api_schema }}</textarea>

        <div class="warning">
            You do NOT need to fetch API data here.  
            Your website will <strong>send data to us</strong>, and we will store it.
        </div>
    </div>

    <button type="submit" style="padding:10px 20px; font-size:16px;">Save Dataset</button>
</form>

<!-- SHOW FORM AGAIN LINK (when success is shown) -->
{% if show_api_success %}
<div style="text-align: center; margin-top: 20px;">
    <a href="#" onclick="showFormAgain()" style="color: #007bff; text-decoration: none;">‚Üê Back to form</a>
</div>
{% endif %}

<script>
function toggleSources() {
    const sources = ["file","mongodb","postgresql","mysql","api"];
    const selected = document.getElementById("data_source").value;
    
    // Hide all sections first
    sources.forEach(s => document.getElementById(s).style.display = "none");
    
    // Show selected section
    document.getElementById(selected).style.display = "block";
    
    // ‚úÖ FIX: Handle required attribute for website_url dynamically
    const websiteUrlInput = document.getElementById('website_url_input');
    const websiteUrlLabel = document.getElementById('website_url_label');
    
    if (selected === 'api') {
        // Only require website_url when API is selected
        websiteUrlInput.setAttribute('required', 'required');
        websiteUrlLabel.innerHTML = 'Your Website URL (Required for CORS) *';
        websiteUrlInput.style.display = 'block';
    } else {
        // Remove required attribute for other data sources
        websiteUrlInput.removeAttribute('required');
        websiteUrlLabel.innerHTML = 'Your Website URL (Optional)';
        websiteUrlInput.style.display = 'none';
    }
}

function copyEndpoint() {
    const endpoint = document.getElementById('endpointUrl').textContent;
    navigator.clipboard.writeText(endpoint).then(() => {
        const btn = event.target;
        btn.textContent = '‚úÖ Copied!';
        setTimeout(() => btn.textContent = 'üìã Copy URL', 2000);
    });
}

function showFormAgain() {
    document.querySelector('form').style.display = 'block';
    document.querySelector('.success-section').style.display = 'none';
    document.querySelector('div[style*="text-align: center"]').style.display = 'none';
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    toggleSources();
    
    // Preselect API if we're coming back from success and want to see the form again
    {% if request.POST.data_source == 'api' and not show_api_success %}
    document.getElementById('data_source').value = 'api';
    toggleSources();
    {% endif %}
});
</script>

</body>
</html>